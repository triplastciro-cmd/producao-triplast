<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triplast - Sistema de Produção</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body { 
            background-color: #eef2f6; 
            font-family: 'Inter', sans-serif; 
            margin: 0; padding: 0;
            color: #1f2937;
        }

        /* --- VISUAL ORIGINAL (LOGIN E LAYOUT) --- */
        .glass-login {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .aba-conteudo { display: none; animation: fadeIn 0.3s; }
        .aba-ativa { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Botões Laterais */
        .nav-btn {
            text-align: left; padding: 12px 16px; width: 100%;
            border-radius: 8px; font-weight: 600; color: #4b5563;
            transition: all 0.2s; margin-bottom: 4px; display: flex; items-center: center; gap: 10px;
        }
        .nav-btn:hover { background-color: #e0e7ff; color: #3730a3; }
        .nav-btn.active { background-color: #4338ca; color: white; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        /* Status Máquina (Bolinhas e Botões) */
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .bg-produzindo { background-color: #10b981; }
        .bg-parada { background-color: #ef4444; }
        .bg-setup { background-color: #f59e0b; }
        .bg-desligada { background-color: #9ca3af; }

        /* Botões de Ação na Máquina */
        .btn-acao { 
            padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 0.85rem; 
            transition: transform 0.1s; border: 2px solid transparent; opacity: 0.7;
        }
        .btn-acao:hover { transform: scale(1.05); opacity: 0.9; }
        .btn-acao.selected { opacity: 1; border-color: #374151; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transform: scale(1.05); }

        /* Tabela */
        table th { text-align: left; padding: 12px; background: #f3f4f6; color: #6b7280; font-size: 0.75rem; text-transform: uppercase; font-weight: 800; }
        table td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <div id="tela-login" class="fixed inset-0 z-50 flex items-center justify-center bg-[#eef2f6]">
        <div class="glass-login p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
            <div class="mb-6 flex justify-center">
                <div class="w-16 h-16 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-industry text-3xl text-white"></i>
                </div>
            </div>
            <h1 class="text-2xl font-black text-gray-800 mb-1">TRIPLAST</h1>
            <p class="text-sm text-gray-500 mb-8 font-medium">Sistema Integrado de Produção</p>
            
            <form onsubmit="realizarLogin(event)" class="space-y-4">
                <input type="password" id="senha-input" placeholder="Senha de Acesso" 
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition font-bold text-center text-lg tracking-widest">
                <button type="submit" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition transform active:scale-95">
                    ENTRAR
                </button>
            </form>
            <p class="mt-6 text-xs text-gray-400">© 2026 Triplast System v2.0</p>
        </div>
    </div>

    <div id="sistema-principal" class="hidden flex-1 flex h-full">
        
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20 shadow-sm">
            <div class="h-16 flex items-center px-6 border-b border-gray-100">
                <i class="fa-solid fa-industry text-blue-600 mr-2"></i>
                <span class="font-black text-xl tracking-tight text-gray-800">TRIPLAST</span>
            </div>

            <nav class="flex-1 p-4 overflow-y-auto space-y-1">
                <p class="text-xs font-bold text-gray-400 uppercase mb-2 mt-2 px-2">Monitoramento</p>
                <button onclick="mudarAba('dashboard', this)" class="nav-btn active">
                    <i class="fa-solid fa-chart-pie w-5"></i> Dashboard
                </button>

                <p class="text-xs font-bold text-gray-400 uppercase mb-2 mt-6 px-2">Produção</p>
                <button onclick="mudarAba('calculadora', this)" class="nav-btn">
                    <i class="fa-solid fa-calculator w-5"></i> Calc. & Pedidos
                </button>
                <div id="lista-maquinas-nav">
                    </div>

                <p class="text-xs font-bold text-gray-400 uppercase mb-2 mt-6 px-2">Gestão</p>
                <button onclick="mudarAba('operadores', this)" class="nav-btn">
                    <i class="fa-solid fa-users-gear w-5"></i> Operadores
                </button>
            </nav>

            <div class="p-4 border-t border-gray-100 bg-gray-50">
                <div class="flex items-center justify-between">
                    <span class="text-xs font-bold text-green-600 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Online</span>
                    <button onclick="salvarDadosManual()" class="text-blue-600 hover:text-blue-800"><i class="fa-solid fa-cloud-arrow-up"></i></button>
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-[#eef2f6] overflow-hidden flex flex-col relative">
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shadow-sm">
                <h2 id="titulo-pagina" class="text-lg font-bold text-gray-700">Visão Geral</h2>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p id="relogio" class="text-xl font-bold text-gray-800 leading-none">00:00</p>
                        <p class="text-xs text-gray-400 font-bold uppercase">Hora Local</p>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-8">
                
                <div id="aba-dashboard" class="aba-conteudo aba-ativa space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <span class="text-xs font-bold text-gray-400 uppercase">Produção Hoje</span>
                            <div class="text-3xl font-black text-blue-600 mt-2" id="dash-total">0</div>
                            <span class="text-xs text-gray-500">Peças Totais</span>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <span class="text-xs font-bold text-gray-400 uppercase">Eficiência Global</span>
                            <div class="text-3xl font-black text-purple-600 mt-2" id="dash-eficiencia">0%</div>
                            <span class="text-xs text-gray-500">Meta vs Realizado</span>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <span class="text-xs font-bold text-gray-400 uppercase">Máquinas Ativas</span>
                            <div class="text-3xl font-black text-green-500 mt-2" id="dash-ativas">0</div>
                            <span class="text-xs text-gray-500">Produzindo agora</span>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <span class="text-xs font-bold text-gray-400 uppercase">Paradas/Off</span>
                            <div class="text-3xl font-black text-red-500 mt-2" id="dash-paradas">0</div>
                            <span class="text-xs text-gray-500">Requer atenção</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-700 mb-4">Produção por Máquina</h3>
                            <div class="h-64"><canvas id="graficoBarras"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-700 mb-4">Status & Tempo (Horas)</h3>
                            <div class="h-64 relative">
                                <canvas id="graficoRosca"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                            <h3 class="font-bold text-gray-700">Status em Tempo Real</h3>
                        </div>
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>Máquina</th>
                                    <th>Status</th>
                                    <th>Operador</th>
                                    <th>Pedido</th>
                                    <th class="text-right">Progresso</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-dashboard">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="aba-calculadora" class="aba-conteudo space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        <div class="lg:col-span-5 bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
                            <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-100">
                                <div class="bg-blue-100 text-blue-600 p-2 rounded-lg"><i class="fa-solid fa-calculator"></i></div>
                                <h3 class="text-lg font-bold text-gray-800">Calculadora Técnica</h3>
                            </div>

                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Peso da Peça (g)</label>
                                        <input type="number" id="calc-peso" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="Ex: 20">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ciclo (seg)</label>
                                        <input type="number" id="calc-ciclo" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="Ex: 20">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Cavidades</label>
                                        <input type="number" id="calc-cav" class="w-full border border-gray-300 rounded p-2 text-sm" value="1">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pigmento (%)</label>
                                        <input type="number" id="calc-pig" class="w-full border border-gray-300 rounded p-2 text-sm" value="2">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Quantidade Meta (Peças)</label>
                                    <input type="number" id="calc-meta" class="w-full border-2 border-blue-500 rounded p-3 text-lg font-bold text-gray-700" placeholder="Ex: 2000">
                                </div>

                                <button onclick="calcularProducao()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg hover:bg-gray-900 transition">CALCULAR</button>

                                <div id="res-container" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-100 mt-4">
                                    <div class="grid grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <span class="text-xs text-gray-500 block">Horas Necessárias</span>
                                            <span class="text-xl font-black text-blue-700" id="res-horas">0h</span>
                                        </div>
                                        <div>
                                            <span class="text-xs text-gray-500 block">Peças / Hora</span>
                                            <span class="text-xl font-black text-blue-700" id="res-pph">0</span>
                                        </div>
                                    </div>
                                    <div class="border-t border-blue-200 pt-2 grid grid-cols-2 gap-4">
                                        <div>
                                            <span class="text-xs text-gray-500 block">Material Total</span>
                                            <span class="font-bold text-gray-700" id="res-mat">0 kg</span>
                                        </div>
                                        <div>
                                            <span class="text-xs text-gray-500 block">Pigmento</span>
                                            <span class="font-bold text-pink-600" id="res-pigment">0 kg</span>
                                        </div>
                                    </div>
                                    <button onclick="salvarComoPedido()" class="w-full mt-3 bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 rounded shadow-sm"><i class="fa-solid fa-plus"></i> CRIAR PEDIDO</button>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-7 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                                <h3 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-clipboard-list text-blue-600 mr-2"></i> Pedidos Cadastrados</h3>
                                <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-full" id="contador-pedidos">0</span>
                            </div>
                            <div class="overflow-y-auto h-[500px] space-y-3" id="lista-pedidos">
                                </div>
                        </div>
                    </div>
                </div>

                <div id="aba-operadores" class="aba-conteudo max-w-4xl mx-auto space-y-6">
                    <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b border-gray-100 pb-4">Registro de Operadores</h2>
                        
                        <div class="flex gap-4 mb-8">
                            <input type="text" id="novo-operador" placeholder="Nome completo do operador" class="flex-1 border border-gray-300 rounded-lg p-3 outline-none focus:border-blue-500">
                            <button onclick="adicionarOperador()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md">ADICIONAR</button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="grid-operadores">
                            </div>
                    </div>
                </div>

                <div id="aba-maquina" class="aba-conteudo space-y-6">
                    </div>

            </div>
        </main>
    </div>

    <script>
        // CONFIGURAÇÃO SUPABASE
        const CONFIG = {
            url: 'https://hgqnlqtvjiyuwxwypxhh.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhncW5scXR2aml5dXdud3lweHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjE1MDcsImV4cCI6MjA4NjQzNzUwN30.njSVfWDpIJK49IpRSgyMf6e5MEmJ-AROVT7-nOTZD9Y'
        };
        const sb = supabase.createClient(CONFIG.url, CONFIG.key);

        // ESTADO GLOBAL DO SISTEMA
        let Sistema = {
            maquinas: [
                { id: 1, nome: "Injetora 01", status: "desligada", operador: "", pedido: null, dados: { meta: 0, realizado: 0, ciclo: 20, cav: 1 }, tempos: { run: 0, stop: 0, setup: 0, off: 0 } },
                { id: 2, nome: "Injetora 02", status: "desligada", operador: "", pedido: null, dados: { meta: 0, realizado: 0, ciclo: 20, cav: 1 }, tempos: { run: 0, stop: 0, setup: 0, off: 0 } },
                { id: 3, nome: "Injetora 03", status: "desligada", operador: "", pedido: null, dados: { meta: 0, realizado: 0, ciclo: 20, cav: 1 }, tempos: { run: 0, stop: 0, setup: 0, off: 0 } },
                { id: 4, nome: "Injetora 04", status: "desligada", operador: "", pedido: null, dados: { meta: 0, realizado: 0, ciclo: 20, cav: 1 }, tempos: { run: 0, stop: 0, setup: 0, off: 0 } }
            ],
            pedidos: [],
            operadores: ["João Silva", "Maria Souza", "Carlos Lima"],
            maquinaSelecionada: 1
        };

        // --- FUNÇÕES DE LOGIN ---
        function realizarLogin(e) {
            e.preventDefault();
            const senha = document.getElementById('senha-input').value;
            if(senha === '2026') {
                document.getElementById('tela-login').classList.add('hidden');
                document.getElementById('sistema-principal').classList.remove('hidden');
                inicializarSistema();
            } else {
                alert("Senha Incorreta!");
                document.getElementById('senha-input').value = '';
            }
        }

        // --- INICIALIZAÇÃO ---
        async function inicializarSistema() {
            // Carregar dados (simulado do Supabase ou Local)
            try {
                let { data } = await sb.from('sistema').select('*').eq('id', 1).single();
                if(data && data.conteudo) {
                    Sistema = { ...Sistema, ...data.conteudo };
                }
            } catch(error) { console.log("Usando dados locais iniciais"); }

            atualizarRelogio();
            renderizarMenuMaquinas();
            atualizarDashboard();
            
            // Loop de salvar e relogio
            setInterval(atualizarRelogio, 1000);
            setInterval(contabilizarTempo, 5000); // Conta horas a cada 5s
            setInterval(salvarDadosManual, 60000); // Auto-save 1min
        }

        function atualizarRelogio() {
            const agora = new Date();
            document.getElementById('relogio').innerText = agora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
        }

        // --- RENDERIZAÇÃO DA INTERFACE ---
        function mudarAba(abaNome, btnElement) {
            // Esconder todas as abas
            document.querySelectorAll('.aba-conteudo').forEach(el => el.classList.remove('aba-ativa'));
            // Mostrar a desejada
            document.getElementById(`aba-${abaNome}`).classList.add('aba-ativa');
            
            // Atualizar botões do menu
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');

            // Atualizar Titulo
            document.getElementById('titulo-pagina').innerText = abaNome.charAt(0).toUpperCase() + abaNome.slice(1);

            // Se for aba específica, renderiza conteudo
            if(abaNome === 'dashboard') atualizarDashboard();
            if(abaNome === 'pedidos' || abaNome === 'calculadora') renderizarPedidos();
            if(abaNome === 'operadores') renderizarOperadores();
            if(abaNome === 'maquina') renderizarDetalheMaquina();
        }

        function renderizarMenuMaquinas() {
            const container = document.getElementById('lista-maquinas-nav');
            container.innerHTML = '';
            Sistema.maquinas.forEach(m => {
                let corDot = m.status === 'produzindo' ? 'bg-produzindo' : m.status === 'parada' ? 'bg-parada' : m.status === 'setup' ? 'bg-setup' : 'bg-desligada';
                container.innerHTML += `
                    <button onclick="selecionarMaquina(${m.id}, this)" class="nav-btn pl-6 text-sm">
                        <span class="status-dot ${corDot}"></span> ${m.nome}
                    </button>
                `;
            });
        }

        function selecionarMaquina(id, btn) {
            Sistema.maquinaSelecionada = id;
            mudarAba('maquina', btn); // Vai para a aba maquina
        }

        // --- LÓGICA DO DASHBOARD ---
        let chartBarras = null;
        let chartRosca = null;

        function atualizarDashboard() {
            let totalPecas = 0, ativas = 0, paradas = 0;
            let somaMeta = 0, somaReal = 0;
            let tempoTotal = { run: 0, stop: 0, setup: 0, off: 0 };

            const tbody = document.getElementById('tabela-dashboard');
            tbody.innerHTML = '';

            Sistema.maquinas.forEach(m => {
                totalPecas += m.dados.realizado;
                if(m.status === 'produzindo') ativas++;
                else if(m.status !== 'setup') paradas++;

                somaMeta += m.dados.meta;
                somaReal += m.dados.realizado;

                tempoTotal.run += m.tempos.run;
                tempoTotal.stop += m.tempos.stop;
                tempoTotal.setup += m.tempos.setup;
                tempoTotal.off += m.tempos.off;

                // Linha Tabela
                let corTexto = m.status === 'produzindo' ? 'text-green-600' : m.status === 'parada' ? 'text-red-600' : 'text-gray-400';
                let pct = m.dados.meta > 0 ? Math.round((m.dados.realizado/m.dados.meta)*100) : 0;
                
                tbody.innerHTML += `
                    <tr>
                        <td class="font-bold text-gray-800">${m.nome}</td>
                        <td class="uppercase text-xs font-bold ${corTexto}">${m.status}</td>
                        <td>${m.operador || '-'}</td>
                        <td>${m.pedido ? m.pedido.produto : '-'}</td>
                        <td class="text-right font-mono">${pct}%</td>
                    </tr>
                `;
            });

            // Cards
            document.getElementById('dash-total').innerText = totalPecas;
            document.getElementById('dash-ativas').innerText = ativas;
            document.getElementById('dash-paradas').innerText = paradas;
            document.getElementById('dash-eficiencia').innerText = somaMeta > 0 ? Math.round((somaReal/somaMeta)*100)+'%' : '0%';

            // Gráficos
            atualizarGraficos(tempoTotal);
        }

        function atualizarGraficos(tempos) {
            // Gráfico Barras (Produção)
            const ctxBar = document.getElementById('graficoBarras').getContext('2d');
            if(chartBarras) chartBarras.destroy();
            chartBarras = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: Sistema.maquinas.map(m => m.nome),
                    datasets: [{
                        label: 'Peças Produzidas',
                        data: Sistema.maquinas.map(m => m.dados.realizado),
                        backgroundColor: '#3b82f6', borderRadius: 6
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
            });

            // Gráfico Rosca (Tempo)
            const ctxPie = document.getElementById('graficoRosca').getContext('2d');
            if(chartRosca) chartRosca.destroy();
            chartRosca = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['Produzindo', 'Parada', 'Setup', 'Desligada'],
                    datasets: [{
                        data: [tempos.run, tempos.stop, tempos.setup, tempos.off],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#9ca3af'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: {position:'right'} } }
            });
        }

        // --- CALCULADORA E PEDIDOS ---
        let ultimoCalculo = null;

        function calcularProducao() {
            const peso = parseFloat(document.getElementById('calc-peso').value) || 0;
            const ciclo = parseFloat(document.getElementById('calc-ciclo').value) || 0;
            const cav = parseFloat(document.getElementById('calc-cav').value) || 1;
            const meta = parseFloat(document.getElementById('calc-meta').value) || 0;
            const pigPct = parseFloat(document.getElementById('calc-pig').value) || 0;

            if(ciclo <= 0) return alert("Ciclo inválido");

            // Fórmulas
            // 1. PPH = (3600 / Ciclo) * Cav
            const pph = (3600 / ciclo) * cav;
            // 2. Horas = Meta / PPH
            const horas = meta / pph;
            // 3. Material (kg) = (Peso * Meta) / 1000
            const materialKg = (peso * meta) / 1000;
            // 4. Pigmento (kg) = Material * %
            const pigmentoKg = materialKg * (pigPct / 100);

            // Exibir
            document.getElementById('res-horas').innerText = horas.toFixed(1) + 'h';
            document.getElementById('res-pph').innerText = Math.round(pph);
            document.getElementById('res-mat').innerText = materialKg.toFixed(2) + ' kg';
            document.getElementById('res-pigment').innerText = pigmentoKg.toFixed(3) + ' kg';

            document.getElementById('res-container').classList.remove('hidden');

            ultimoCalculo = { meta, ciclo, cav, horas, materialKg, pigmentoKg };
        }

        function salvarComoPedido() {
            if(!ultimoCalculo) return;
            const nomeProduto = prompt("Digite o nome do Produto/Cliente:");
            if(nomeProduto) {
                Sistema.pedidos.push({
                    id: Date.now(),
                    produto: nomeProduto,
                    ...ultimoCalculo,
                    data: new Date().toLocaleDateString()
                });
                salvarDadosManual();
                renderizarPedidos();
                alert("Pedido salvo com sucesso!");
            }
        }

        function renderizarPedidos() {
            const lista = document.getElementById('lista-pedidos');
            lista.innerHTML = '';
            Sistema.pedidos.forEach((p, idx) => {
                lista.innerHTML += `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex justify-between items-center group hover:bg-white hover:shadow-md transition">
                        <div>
                            <p class="font-bold text-gray-800">${p.produto}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fa-solid fa-bullseye"></i> ${p.meta} un | 
                                <i class="fa-solid fa-clock"></i> ${p.horas.toFixed(1)}h |
                                <i class="fa-solid fa-cube"></i> ${p.materialKg.toFixed(1)}kg
                            </p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="carregarPedidoEmMaquina(${idx})" class="text-blue-500 hover:text-blue-700 bg-white p-2 rounded shadow-sm text-xs font-bold" title="Usar na Máquina">USAR</button>
                             <button onclick="removerPedido(${idx})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('contador-pedidos').innerText = Sistema.pedidos.length;
        }

        function removerPedido(idx) {
            if(confirm("Apagar este pedido?")) {
                Sistema.pedidos.splice(idx, 1);
                salvarDadosManual();
                renderizarPedidos();
            }
        }

        // --- OPERADORES ---
        function renderizarOperadores() {
            const grid = document.getElementById('grid-operadores');
            grid.innerHTML = '';
            Sistema.operadores.forEach((op, idx) => {
                grid.innerHTML += `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">${op.charAt(0)}</div>
                            <span class="font-bold text-gray-700">${op}</span>
                        </div>
                        <button onclick="removerOperador(${idx})" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                    </div>
                `;
            });
        }

        function adicionarOperador() {
            const nome = document.getElementById('novo-operador').value;
            if(nome) {
                Sistema.operadores.push(nome);
                document.getElementById('novo-operador').value = '';
                salvarDadosManual();
                renderizarOperadores();
            }
        }

        function removerOperador(idx) {
            Sistema.operadores.splice(idx, 1);
            salvarDadosManual();
            renderizarOperadores();
        }

        // --- DETALHE DA MÁQUINA (FUNCIONALIDADE COMPLETA) ---
        function renderizarDetalheMaquina() {
            const m = Sistema.maquinas.find(x => x.id === Sistema.maquinaSelecionada);
            const container = document.getElementById('aba-maquina');
            
            // Gerar Options de Operadores
            let optionsOp = '<option value="">Selecionar Operador...</option>';
            Sistema.operadores.forEach(op => {
                optionsOp += `<option value="${op}" ${m.operador === op ? 'selected' : ''}>${op}</option>`;
            });

            // Classes para botões de status
            const getBtnClass = (status, type) => {
                let base = "btn-acao flex-1 h-14 flex items-center justify-center gap-2 ";
                if(status === type) return base + "selected " + (type==='produzindo'?'bg-green-100 text-green-700 border-green-500':type==='parada'?'bg-red-100 text-red-700 border-red-500':type==='setup'?'bg-yellow-100 text-yellow-700 border-yellow-500':'bg-gray-200 text-gray-700 border-gray-500');
                return base + "bg-white text-gray-400 hover:bg-gray-50";
            };

            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <div class="bg-gray-800 text-white p-6 flex flex-col md:flex-row justify-between items-center">
                        <div>
                            <h2 class="text-3xl font-black tracking-tight">${m.nome}</h2>
                            <div class="flex items-center gap-3 mt-2 bg-gray-700 p-2 rounded lg:w-96">
                                <i class="fa-solid fa-user-gear text-gray-400"></i>
                                <select onchange="setarOperador(this.value)" class="bg-transparent text-white font-bold w-full outline-none">
                                    ${optionsOp}
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 md:mt-0 text-right bg-gray-700 p-4 rounded-lg">
                            <span class="block text-xs text-gray-400 uppercase font-bold">Produção Atual</span>
                            <span class="block text-5xl font-mono font-bold">${m.dados.realizado}</span>
                        </div>
                    </div>

                    <div class="p-8 grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <div class="space-y-6">
                            <div>
                                <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">Controle de Status</h4>
                                <div class="flex gap-2 mb-2">
                                    <button onclick="setarStatus('produzindo')" class="${getBtnClass(m.status, 'produzindo')}"><i class="fa-solid fa-play"></i> PRODUZINDO</button>
                                    <button onclick="setarStatus('parada')" class="${getBtnClass(m.status, 'parada')}"><i class="fa-solid fa-stop"></i> PARADA</button>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="setarStatus('setup')" class="${getBtnClass(m.status, 'setup')}"><i class="fa-solid fa-tools"></i> SETUP</button>
                                    <button onclick="setarStatus('desligada')" class="${getBtnClass(m.status, 'desligada')}"><i class="fa-solid fa-power-off"></i> OFF</button>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-sm font-bold text-gray-700 uppercase">Configuração Técnica</h4>
                                    <button onclick="alert('Vá para a aba PEDIDOS e clique em USAR para carregar um pedido aqui.')" class="text-xs text-blue-600 font-bold hover:underline">Carregar Pedido</button>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-[10px] uppercase text-gray-400 font-bold">Produto</label><input class="w-full bg-white border border-gray-300 rounded p-2 font-bold text-gray-700" value="${m.pedido ? m.pedido.produto : 'Sem pedido'}" readonly></div>
                                    <div><label class="text-[10px] uppercase text-gray-400 font-bold">Meta</label><input type="number" onchange="atualizarDadoManual('meta', this.value)" class="w-full bg-white border border-gray-300 rounded p-2" value="${m.dados.meta}"></div>
                                    <div><label class="text-[10px] uppercase text-gray-400 font-bold">Ciclo (s)</label><input type="number" onchange="atualizarDadoManual('ciclo', this.value)" class="w-full bg-white border border-gray-300 rounded p-2" value="${m.dados.ciclo}"></div>
                                    <div><label class="text-[10px] uppercase text-gray-400 font-bold">Cavidades</label><input type="number" onchange="atualizarDadoManual('cav', this.value)" class="w-full bg-white border border-gray-300 rounded p-2" value="${m.dados.cav}"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col items-center justify-center bg-gray-50 rounded-2xl border border-gray-200 p-8">
                            <button onclick="registrarCiclo()" class="w-full py-10 bg-gradient-to-br from-blue-600 to-blue-800 text-white rounded-2xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all active:scale-95 group">
                                <div class="text-sm uppercase font-bold text-blue-200 mb-2">Registrar Ciclo Manual</div>
                                <div class="text-4xl font-black flex items-center justify-center gap-3">
                                    <i class="fa-solid fa-plus-circle group-hover:rotate-90 transition duration-300"></i>
                                    <span>+${m.dados.cav}</span>
                                </div>
                            </button>

                            <div class="mt-8 w-full">
                                <div class="flex justify-between text-xs text-gray-500 font-bold uppercase mb-1">
                                    <span>Progresso da Meta</span>
                                    <span>${Math.round((m.dados.realizado/m.dados.meta)*100) || 0}%</span>
                                </div>
                                <div class="w-full bg-gray-300 h-4 rounded-full overflow-hidden">
                                    <div class="h-full bg-green-500 transition-all duration-500" style="width: ${Math.min(100, (m.dados.realizado/m.dados.meta)*100) || 0}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- AÇÕES DA MÁQUINA ---
        function setarOperador(nome) {
            const m = Sistema.maquinas.find(x => x.id === Sistema.maquinaSelecionada);
            m.operador = nome;
            salvarDadosManual();
        }

        function setarStatus(status) {
            const m = Sistema.maquinas.find(x => x.id === Sistema.maquinaSelecionada);
            m.status = status;
            salvarDadosManual();
            renderizarDetalheMaquina(); // Atualiza botões
            renderizarMenuMaquinas(); // Atualiza bolinha sidebar
        }

        function atualizarDadoManual(campo, valor) {
            const m = Sistema.maquinas.find(x => x.id === Sistema.maquinaSelecionada);
            if(campo === 'meta' || campo === 'cav') m.dados[campo] = parseInt(valor);
            else m.dados[campo] = parseFloat(valor);
            salvarDadosManual();
        }

        function registrarCiclo() {
            const m = Sistema.maquinas.find(x => x.id === Sistema.maquinaSelecionada);
            if(m.status !== 'produzindo') {
                if(!confirm("Máquina não está em 'Produzindo'. Registrar mesmo assim?")) return;
            }
            m.dados.realizado += m.dados.cav;
            salvarDadosManual();
            renderizarDetalheMaquina();
        }

        function carregarPedidoEmMaquina(idxPedido) {
            const p = Sistema.pedidos[idxPedido];
            if(!p) return;
            
            // Pede qual maquina
            const idMaq = prompt("Digite o número da máquina (1 a 4) para carregar este pedido:");
            const m = Sistema.maquinas.find(x => x.id == idMaq);
            
            if(m) {
                m.pedido = p;
                m.dados.meta = p.meta;
                m.dados.ciclo = p.ciclo;
                m.dados.cav = p.cav;
                m.dados.realizado = 0; // Reseta contador
                salvarDadosManual();
                alert(`Pedido carregado na ${m.nome}`);
            } else {
                alert("Máquina inválida");
            }
        }

        // --- SISTEMA DE TEMPO E SAVE ---
        function contabilizarTempo() {
            // Roda a cada 5s, adiciona 5s (em horas = 5/3600)
            const incremento = 5/3600;
            Sistema.maquinas.forEach(m => {
                if(m.status === 'produzindo') m.tempos.run += incremento;
                else if(m.status === 'parada') m.tempos.stop += incremento;
                else if(m.status === 'setup') m.tempos.setup += incremento;
                else m.tempos.off += incremento;
            });
            // Se estiver na aba dashboard, atualiza grafico em tempo real
            if(document.getElementById('aba-dashboard').classList.contains('aba-ativa')) {
                atualizarDashboard(); 
            }
        }

        async function salvarDadosManual() {
            const btn = document.querySelector('.fa-cloud-arrow-up');
            if(btn) btn.classList.add('fa-fade');
            
            try {
                await sb.from('sistema').update({ conteudo: Sistema }).eq('id', 1);
            } catch(e) { console.error("Erro ao salvar nuvem", e); }
            
            if(btn) btn.classList.remove('fa-fade');
        }

    </script>
</body>
</html>,
