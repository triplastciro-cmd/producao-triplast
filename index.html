<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Triplast - Sistema de Gest√£o Industrial (Enterprise V23)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* =================================================================
           ESTILIZA√á√ÉO PROFISSIONAL (CSS)
           ================================================================= */
        body { 
            background-color: #f8fafc; /* Fundo suave */
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 0; 
            -webkit-font-smoothing: antialiased;
            color: #1e293b;
            padding-bottom: 80px;
        }
        
        /* Transi√ß√µes Suaves */
        .transicao-suave { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Sistema de Abas */
        .aba-conteudo { 
            display: none; 
            animation: fadeIn 0.4s ease-out;
        }
        
        .aba-ativa { 
            display: block !important; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Notifica√ß√£o Toast (Estilo Enterprise) */
        #notificacao-toast {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(-150%);
            background-color: #0f172a;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            font-weight: 600;
            border-left: 4px solid #3b82f6;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }

        #notificacao-toast.mostrar {
            transform: translateX(-50%) translateY(0);
        }

        /* Card da M√°quina (Estilo Clean) */
        .cartao-maquina {
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            border-left-width: 6px;
            transition: all 0.2s ease; 
            position: relative;
        }

        .cartao-maquina:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        
        /* Cores de Status Profissionais */
        .borda-status-produzindo { border-left-color: #10b981 !important; } /* Emerald 500 */
        .borda-status-atencao { border-left-color: #f59e0b !important; } /* Amber 500 */
        .borda-status-parado { border-left-color: #ef4444 !important; } /* Red 500 */
        .borda-status-neutro { border-left-color: #64748b !important; } /* Slate 500 */

        /* Bot√µes de Navega√ß√£o (Pills) */
        .botao-aba {
            padding: 10px 20px; 
            border-radius: 6px;
            font-weight: 600; 
            font-size: 13px; 
            color: #64748b;
            background: transparent;
            transition: all 0.2s;
            border: 1px solid transparent;
            cursor: pointer;
        }
        
        .botao-aba:hover { background-color: #f1f5f9; color: #0f172a; }
        
        .botao-aba.ativo { 
            background-color: #fff; 
            color: #2563eb; 
            border-color: #e2e8f0;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* Scrollbars Personalizadas */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Utilit√°rio para Carrossel */
        .wrapper-scroll-horizontal {
            display: flex;
            overflow-x: auto;
            gap: 16px;
            padding-bottom: 16px;
            scroll-behavior: smooth;
        }
        
        /* Elementos de Formul√°rio */
        .input-profissional {
            width: 100%;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            color: #334155;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-profissional:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

    </style>
</head>
<body>

    <div id="notificacao-toast">
        <i class="fa-solid fa-circle-check text-green-400"></i>
        <span id="mensagem-toast">SISTEMA PRONTO</span>
    </div>

    <div id="modal-gerenciar-maquinas" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[250] hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg border border-slate-200">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-server text-blue-600"></i> Configura√ß√£o do Parque de M√°quinas
                </h3>
                <button onclick="fecharModalGerenciamento()" class="text-slate-400 hover:text-red-500 text-xl transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6 flex items-start gap-3">
                <i class="fa-solid fa-circle-info text-blue-600 mt-1"></i>
                <div class="text-sm text-blue-800">
                    <p class="font-bold mb-1">Credenciais de Acesso Autom√°ticas:</p>
                    <p>Ao criar uma m√°quina, o login ser√° gerado automaticamente.</p>
                    <p class="mt-1 font-mono text-xs bg-blue-100 p-1 rounded inline-block">Senha = "m" + ID (Exemplo: M√°quina 5 -> Senha: <strong>m5</strong>)</p>
                </div>
            </div>

            <div class="mb-4">
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">M√°quinas Ativas</label>
                <div id="lista-maquinas-configuracao" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    </div>
            </div>

            <button onclick="adicionarNovaMaquina()" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-lg shadow transition-all flex items-center justify-center gap-2 text-sm uppercase tracking-wide">
                <i class="fa-solid fa-plus-circle"></i> Adicionar Nova Injetora
            </button>
        </div>
    </div>

    <div id="modal-ficha-tecnica" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[200] hidden items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl border border-slate-200 relative my-auto">
            
            <div class="flex justify-between items-start mb-6 border-b border-slate-100 pb-4">
                <div>
                    <h3 class="font-bold text-2xl text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-list text-blue-600"></i> Ficha T√©cnica de Processo
                    </h3>
                    <p class="text-sm text-slate-500 mt-1">Preencha os dados da Ordem de Produ√ß√£o (O.P)</p>
                </div>
                <button onclick="fecharModalFicha()" class="text-slate-400 hover:text-red-500 text-2xl transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <input type="hidden" id="input-maquina-id">
            <input type="hidden" id="input-op-index">
            <input type="hidden" id="input-modo-edicao" value="false"> 
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">M√°quina Selecionada</label>
                        <select id="input-op-maquina" class="input-profissional bg-slate-50 font-bold" disabled></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">N√∫mero da O.P.</label>
                        <input type="text" id="input-op-numero" class="input-profissional" placeholder="Ex: 102030">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Meta de Produ√ß√£o</label>
                        <input type="number" id="input-op-quantidade" class="input-profissional" placeholder="0">
                    </div>
                </div>

                <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cliente</label>
                        <input type="text" id="input-op-cliente" class="input-profissional" placeholder="Nome do Cliente">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Produto / Pe√ßa</label>
                        <div class="flex gap-2">
                            <select id="input-op-produto" class="input-profissional flex-1"></select>
                            <button onclick="adicionarNovoProdutoCatalogo()" class="bg-blue-100 text-blue-600 px-3 rounded-lg hover:bg-blue-200"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-3 bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <h4 class="text-xs font-black text-slate-700 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-flask text-blue-500"></i> Especifica√ß√µes de Material
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">Resina/Material</label>
                            <input type="text" id="input-op-material" class="input-profissional text-xs" placeholder="Ex: PP, PEAD">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">Qtd Material</label>
                            <input type="text" id="input-op-material-qtd" class="input-profissional text-xs" placeholder="Ex: 25kg">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">Master/Pigmento</label>
                            <input type="text" id="input-op-pigmento" class="input-profissional text-xs" placeholder="C√≥digo Cor">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">% Porcentagem</label>
                            <input type="text" id="input-op-porcentagem" class="input-profissional text-xs" placeholder="Ex: 2%">
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2 bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <h4 class="text-xs font-black text-slate-700 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-box-open text-orange-500"></i> Embalagem
                    </h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">Caixa Padr√£o</label>
                            <input type="text" id="input-op-caixa" class="input-profissional text-xs">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">Saco Pl√°stico</label>
                            <input type="text" id="input-op-saco" class="input-profissional text-xs">
                        </div>
                    </div>
                </div>

                <div class="md:col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Operador Respons√°vel</label>
                    <div class="flex gap-2">
                        <select id="input-op-operador" class="input-profissional flex-1"></select>
                        <button onclick="adicionarNovoOperador()" class="bg-green-100 text-green-600 px-3 rounded-lg hover:bg-green-200"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
            </div>

            <div class="flex gap-4 pt-4 border-t border-slate-100">
                <button onclick="fecharModalFicha()" class="flex-1 py-3 rounded-lg font-bold text-slate-600 hover:bg-slate-100 transition-colors text-sm uppercase">Cancelar</button>
                <button onclick="salvarFichaTecnica()" id="botao-salvar-op" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition-all transform active:scale-95 text-sm uppercase tracking-wide flex items-center justify-center gap-2">
                    <i class="fa-solid fa-save"></i> Salvar Ordem de Produ√ß√£o
                </button>
            </div>
        </div>
    </div>

    <div id="tela-carregamento" class="fixed inset-0 bg-slate-900 z-[300] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="mb-8 text-center">
            <h1 class="text-6xl font-black italic tracking-tighter text-white mb-2">TRI<span class="text-blue-500">PLAST</span></h1>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-[0.3em]">Sistema de Gest√£o Industrial</p>
        </div>
        
        <div id="spinner-loading" class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-slate-500 font-medium text-sm animate-pulse">Sincronizando banco de dados...</p>
        </div>

        <div id="acao-pos-loading" class="hidden flex-col items-center text-center px-4 animate-fadeIn">
            <p class="text-green-400 mb-6 font-bold text-sm uppercase flex items-center justify-center gap-2">
                <i class="fa-solid fa-circle-check"></i> Sistema Online
            </p>
            <button onclick="exibirTelaLogin()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-10 rounded-full shadow-lg transition-all transform hover:scale-105 active:scale-95 text-sm uppercase tracking-wider">
                Iniciar Sess√£o
            </button>
        </div>
    </div>

    <div id="tela-login" class="fixed inset-0 bg-slate-50 z-[100] flex items-center justify-center hidden">
        <div class="bg-white p-10 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
            <div class="text-center mb-10">
                <h2 class="text-4xl font-black italic tracking-tighter text-slate-900">TRI<span class="text-blue-600">PLAST</span></h2>
                <p class="text-slate-400 text-xs font-bold uppercase mt-2">Autentica√ß√£o Segura V23</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Selecione o Usu√°rio</label>
                    <div class="relative">
                        <i class="fa-solid fa-user absolute left-4 top-3.5 text-slate-400"></i>
                        <select id="select-login-usuario" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500 appearance-none cursor-pointer">
                            <option value="admin">Administrador (Ger√™ncia)</option>
                            </select>
                        <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-slate-400 text-xs pointer-events-none"></i>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Chave de Acesso</label>
                    <div class="relative">
                        <i class="fa-solid fa-lock absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="password" id="input-login-senha" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500 placeholder:text-slate-300 transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>
                
                <button onclick="realizarLogin()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-lg shadow-lg transition-all transform active:scale-95 text-sm uppercase tracking-wider flex justify-center items-center gap-2">
                    Entrar no Painel <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="painel-principal" class="hidden min-h-screen">
        
        <header class="bg-slate-900 text-white sticky top-0 z-40 shadow-md">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-6 w-full md:w-auto justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl font-black italic tracking-tighter">TRI<span class="text-blue-500">PLAST</span></span>
                            <div class="h-6 w-px bg-slate-700 hidden sm:block"></div>
                            <span id="relogio-sistema" class="font-mono text-slate-400 text-sm hidden sm:block">00:00:00</span>
                        </div>
                        <button onclick="realizarLogout()" class="text-xs bg-slate-800 hover:bg-red-600 text-slate-300 hover:text-white px-3 py-1.5 rounded transition-colors border border-slate-700">
                            <i class="fa-solid fa-power-off mr-1"></i> SAIR
                        </button>
                    </div>

                    <div class="flex items-center gap-3 bg-slate-800 p-1.5 rounded-lg border border-slate-700">
                        <div class="flex flex-col px-2">
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Turno Atual</span>
                            <select id="select-turno-global" onchange="alterarTurnoManual(this.value)" class="bg-transparent text-white font-bold text-xs outline-none border-none cursor-pointer">
                                <option value="1">1¬∫ Turno (Manh√£)</option>
                                <option value="2">2¬∫ Turno (Tarde)</option>
                                <option value="3">3¬∫ Turno (Noite)</option>
                            </select>
                        </div>
                        <div class="h-8 w-px bg-slate-700"></div>
                        <button id="btn-pausa-sistema" onclick="alternarPausaSistema()" class="text-[10px] font-bold px-3 py-1.5 rounded bg-yellow-500/10 text-yellow-500 border border-yellow-500/30 hover:bg-yellow-500 hover:text-white transition-all uppercase">
                            <i class="fa-solid fa-pause mr-1"></i> Pausa
                        </button>
                        <button id="btn-hora-extra" onclick="alternarHoraExtra()" class="text-[10px] font-bold px-3 py-1.5 rounded bg-purple-500/10 text-purple-400 border border-purple-500/30 hover:bg-purple-600 hover:text-white transition-all uppercase">
                            <i class="fa-solid fa-bolt mr-1"></i> Extra
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <nav class="max-w-7xl mx-auto px-4 mt-6 mb-6">
            <div class="bg-white p-1.5 rounded-lg shadow-sm border border-slate-200 inline-flex gap-1 overflow-x-auto max-w-full">
                <button onclick="navegarParaAba('monitoramento')" id="tab-monitoramento" class="botao-aba ativo">
                    <i class="fa-solid fa-table-columns mr-2"></i> Monitoramento
                </button>
                <button onclick="navegarParaAba('pedidos')" id="tab-pedidos" class="botao-aba">
                    <i class="fa-solid fa-list-check mr-2"></i> Gest√£o de Pedidos
                </button>
                <button onclick="navegarParaAba('graficos')" id="tab-graficos" class="botao-aba">
                    <i class="fa-solid fa-chart-pie mr-2"></i> Indicadores
                </button>
                <button onclick="navegarParaAba('resumo')" id="tab-resumo" class="botao-aba">
                    <i class="fa-solid fa-file-invoice mr-2"></i> Relat√≥rios
                </button>
            </div>
        </nav>

        <div id="aba-monitoramento" class="aba-conteudo aba-ativa px-4 max-w-7xl mx-auto pb-20">
            
            <div id="painel-admin-ferramentas" class="mb-6 flex justify-end">
                <button onclick="abrirModalGerenciamento()" class="bg-white hover:bg-slate-50 text-slate-600 hover:text-blue-600 font-bold py-2 px-4 rounded-lg shadow-sm border border-slate-200 transition-all text-xs uppercase flex items-center gap-2">
                    <i class="fa-solid fa-gears"></i> Gerenciar M√°quinas
                </button>
            </div>

            <div id="grid-maquinas-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>
        </div>

        <div id="aba-pedidos" class="aba-conteudo px-4 max-w-7xl mx-auto pb-20">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-4 z-30">
                <div class="relative w-full md:w-96">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400"></i>
                    <input type="text" id="busca-pedidos" oninput="renderizarFilasPedidos()" placeholder="Buscar O.P, Cliente ou Produto..." class="pl-10 pr-4 py-2.5 w-full bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium outline-none focus:border-blue-500 transition-colors">
                </div>
                <button onclick="abrirModalCriacaoOP()" class="bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-6 rounded-lg font-bold text-sm shadow-md transition-transform active:scale-95 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> NOVA ORDEM
                </button>
            </div>

            <div id="container-filas-producao" class="space-y-6">
                </div>
        </div>

        <div id="aba-graficos" class="aba-conteudo px-4 max-w-7xl mx-auto pb-20">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 lg:col-span-2">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                        <h3 class="font-bold text-slate-800 text-lg">Efici√™ncia Global (OEE)</h3>
                        <select id="filtro-grafico-maquina" onchange="atualizarGraficos()" class="text-sm border-none bg-slate-100 rounded px-2 py-1 font-bold text-slate-600 outline-none cursor-pointer"></select>
                    </div>
                    <div class="flex flex-col md:flex-row items-center justify-around gap-8">
                        <div class="w-64 h-64 relative">
                            <canvas id="grafico-oee"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <div class="text-center">
                                    <span class="text-xs text-slate-400 font-bold">STATUS</span>
                                    <p class="text-2xl font-black text-slate-800">AGORA</p>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 w-full md:w-auto">
                            <div class="bg-green-50 p-4 rounded-lg border border-green-100 text-center w-32">
                                <span class="text-[10px] font-black text-green-600 uppercase">Produzindo</span>
                                <p id="tempo-prod-total" class="text-xl font-bold text-slate-800">00:00</p>
                            </div>
                            <div class="bg-orange-50 p-4 rounded-lg border border-orange-100 text-center w-32">
                                <span class="text-[10px] font-black text-orange-500 uppercase">Baixa Efic.</span>
                                <p id="tempo-baixa-total" class="text-xl font-bold text-slate-800">00:00</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg border border-red-100 text-center w-32">
                                <span class="text-[10px] font-black text-red-500 uppercase">Parado</span>
                                <p id="tempo-parado-total" class="text-xl font-bold text-slate-800">00:00</p>
                            </div>
                            <div class="bg-slate-100 p-4 rounded-lg border border-slate-200 text-center w-32">
                                <span class="text-[10px] font-black text-slate-500 uppercase">Neutro</span>
                                <p id="tempo-neutro-total" class="text-xl font-bold text-slate-800">00:00</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-clock text-blue-500"></i> Horas Trabalhadas (M√™s)</h4>
                    <div class="h-64"><canvas id="grafico-horas"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation text-red-500"></i> Principais Paradas</h4>
                    <div class="h-64"><canvas id="grafico-paradas"></canvas></div>
                </div>
            </div>
        </div>

        <div id="aba-resumo" class="aba-conteudo px-4 max-w-7xl mx-auto pb-20">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold text-slate-800">Apontamento de Produ√ß√£o</h2>
                        <select id="filtro-resumo-turno" onchange="renderizarTabelaResumo()" class="bg-slate-100 text-slate-700 font-bold py-1 px-3 rounded text-xs border-none outline-none cursor-pointer">
                            <option value="todas">Acumulado Geral</option>
                            <option value="1">Turno Manh√£</option>
                            <option value="2">Turno Tarde</option>
                            <option value="3">Turno Noite</option>
                        </select>
                    </div>
                    <button onclick="resetarDadosTurno()" class="text-red-500 hover:text-white hover:bg-red-500 border border-red-200 font-bold py-2 px-4 rounded-lg text-xs uppercase transition-all flex items-center gap-2">
                        <i class="fa-solid fa-trash-can"></i> Zerar Turno
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 text-slate-500 uppercase text-[10px] font-bold tracking-wider border-b border-slate-200">
                                <th class="p-4">M√°quina</th>
                                <th class="p-4">O.P Atual</th>
                                <th class="p-4 text-right text-green-600">Pe√ßas Boas</th>
                                <th class="p-4 text-right text-red-500">Refugo</th>
                                <th class="p-4 text-right">% Perda</th>
                                <th class="p-4 text-center">Produzindo</th>
                                <th class="p-4 text-center">Parado</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-resumo-corpo" class="text-sm font-medium text-slate-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div> <script>
        // --- CONFIGURA√á√ÉO DO BANCO DE DADOS (SUPABASE) ---
        const SUPABASE_URL = 'https://hgqnlqtvjiyuwnwypxxh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhncW5scXR2aml5dXdud3lweHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjE1MDcsImV4cCI6MjA4NjQzNzUwN30.njSVfWDpIJK49IpRSgyMf6e5MEmJ-AROVT7-nOTZD9Y';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- VARI√ÅVEIS DE ESTADO GLOBAL (NOMES CLAROS) ---
        let maquinas = []; // Array principal de objetos de m√°quina
        let historicoOperacoes = [];
        let catalogoCores = ["Natural", "Preto", "Branco", "Azul", "Vermelho"];
        let equipeOperadores = ["Operador Padr√£o"];
        let catalogoProdutos = ["Produto Gen√©rico"];
        
        let metricasMensais = { tempoProducao: 0, tempoHoraExtra: 0 };
        
        // Controles de Sistema
        let modoManualAtivo = false;
        let modoHoraExtraAtivo = false;
        let sistemaPausado = false;
        let usuarioLogado = null; // 'admin' ou ID da m√°quina (inteiro)
        let timerSalvamento = null;
        let timerRelogio = null;
        let filtroGraficoAtual = 'todas';
        let fimDeSemanaAtivo = false;
        let timestampUltimaAtualizacaoLocal = 0;

        // Inst√¢ncias dos Gr√°ficos
        let chartInstances = { oee: null, paradas: null, refugos: null, horas: null };

        // --- LISTAS DE STATUS PADRONIZADOS (PROFISSIONAL) ---
        const LISTA_MOTIVOS_PARADA = [
            "04 - PRODU√á√ÉO NORMAL",
            "21 - BAIXA EFICI√äNCIA / CICLO ALTO",
            "01 - TROCA DE MOLDE (SETUP)",
            "02 - TROCA DE POSTI√áO",
            "03 - ABASTECIMENTO / FALTA MAT√âRIA-PRIMA",
            "05 - AQUECIMENTO DE M√ÅQUINA",
            "06 - TROCA DE COR / LIMPEZA DO CILINDRO",
            "07 - MANUTEN√á√ÉO PERIF√âRICOS (GELADEIRA/MOINHO)",
            "08 - HOR√ÅRIO DE REFEI√á√ÉO",
            "09 - LIMPEZA GERAL / 5S",
            "10 - PE√áA PRESA NO MOLDE",
            "11 - IN√çCIO DE PROCESSO / AJUSTE",
            "12 - FALTA DE ENERGIA EL√âTRICA",
            "13 - MANUTEN√á√ÉO DE MOLDE (CORRETIVA)",
            "14 - MANUTEN√á√ÉO DE M√ÅQUINA (MEC/EL√âT)",
            "15 - PROBLEMA DE AR COMPRIMIDO",
            "16 - PROBLEMA C√ÇMARA QUENTE",
            "17 - TROCA DE BICO DE INJE√á√ÉO",
            "18 - AGUARDANDO OPERADOR",
            "19 - MANUTEN√á√ÉO EL√âTRICA MOLDE",
            "20 - OUTROS MOTIVOS (JUSTIFICAR)",
            "22 - SEM PROGRAMA√á√ÉO DE PRODU√á√ÉO",
            "23 - F√ÅBRICA FECHADA / FERIADO",
            "24 - PARADA PROGRAMADA (PREVENTIVA)"
        ];

        const LISTA_TIPOS_REFUGO = [
            "Falha de Inje√ß√£o (Incompleta)",
            "Manchas / Sujeira",
            "Rebarbas Excessivas",
            "Deforma√ß√£o / Empeno",
            "Queimado / Degrada√ß√£o",
            "Cor Fora do Padr√£o",
            "Trincas / Quebras",
            "Marcas de Fluxo",
            "Contamina√ß√£o de Material",
            "Outros Defeitos"
        ];

        // --- FUN√á√ïES UTILIT√ÅRIAS ---
        function obterDataHoraBrasilia() {
            return new Date(new Date().toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
        }

        function formatarTempo(segundos) {
            if (isNaN(segundos)) return "00:00:00";
            segundos = Math.floor(segundos);
            const h = Math.floor(segundos / 3600);
            const m = Math.floor((segundos % 3600) / 60);
            const s = segundos % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function criarObjetoMetricasVazio() {
            return { 
                pecasBoas: 0, 
                pecasRefugo: 0, 
                tempoParadas: 0, 
                tempoProducao: 0, 
                tempoBaixaEficiencia: 0, 
                tempoSemProgramacao: 0 
            };
        }

        function verificarFimDeSemana(data) {
            const diaSemana = data.getDay(); // 0=Dom, 6=Sab
            const minutosDoDia = data.getHours() * 60 + data.getMinutes();
            
            // Regra: Sexta ap√≥s 23:36 at√© Segunda 05:00
            if (diaSemana === 5 && minutosDoDia >= 1416) return true; // Sexta noite
            if (diaSemana === 6 || diaSemana === 0) return true; // S√°b e Dom
            if (diaSemana === 1 && minutosDoDia < 300) return true; // Seg madrugada
            return false;
        }

        function exibirNotificacao(mensagem, tipo = 'sucesso') {
            const toast = document.getElementById('notificacao-toast');
            const texto = document.getElementById('mensagem-toast');
            const icone = toast.querySelector('i');
            
            texto.innerText = mensagem;
            
            // Configura cores baseadas no tipo
            if(tipo === 'salvando') {
                icone.className = "fa-solid fa-circle-notch fa-spin text-yellow-400";
                toast.classList.remove('bg-slate-800');
                toast.classList.add('bg-slate-900');
            } else if(tipo === 'erro') {
                icone.className = "fa-solid fa-triangle-exclamation text-red-500";
            } else {
                icone.className = "fa-solid fa-circle-check text-green-400";
            }

            toast.classList.add('mostrar');
            
            if(tipo !== 'salvando') {
                setTimeout(() => {
                    toast.classList.remove('mostrar');
                }, 3000);
            }
        }

        // --- SISTEMA DE DADOS (CARREGAMENTO E SALVAMENTO) ---
        
        // Garante que n√£o existam valores NaN ou undefined nos contadores
        function sanitizarDados() {
            if (!metricasMensais) metricasMensais = { tempoProducao: 0, tempoHoraExtra: 0 };
            
            maquinas.forEach(maq => {
                maq.tempoAcumuladoStatus = Number(maq.tempoAcumuladoStatus) || 0;
                
                if (!maq.dadosTurno) maq.dadosTurno = {};
                if (!maq.resumoTurno) maq.resumoTurno = {};

                [1, 2, 3].forEach(turno => {
                    if (!maq.dadosTurno[turno]) maq.dadosTurno[turno] = criarObjetoMetricasVazio();
                    if (!maq.resumoTurno[turno]) maq.resumoTurno[turno] = criarObjetoMetricasVazio();

                    // For√ßa convers√£o para n√∫mero
                    const metricas = maq.dadosTurno[turno];
                    metricas.pecasBoas = Number(metricas.pecasBoas) || 0;
                    metricas.pecasRefugo = Number(metricas.pecasRefugo) || 0;
                    metricas.tempoProducao = Number(metricas.tempoProducao) || 0;
                    metricas.tempoParadas = Number(metricas.tempoParadas) || 0;
                    metricas.tempoBaixaEficiencia = Number(metricas.tempoBaixaEficiencia) || 0;
                    metricas.tempoSemProgramacao = Number(metricas.tempoSemProgramacao) || 0;
                });
            });
        }

        async function inicializarSistema() {
            // Timeout de seguran√ßa para n√£o travar na tela de loading
            const promessaTimeout = new Promise((_, reject) => 
                setTimeout(() => reject(new Error("Tempo limite excedido")), 5000)
            );

            const promessaBanco = async () => {
                let { data, error } = await sb.from('sistema').select('*').eq('id', 1).single();
                
                // Se n√£o existir dados, cria o padr√£o com 4 M√ÅQUINAS
                if (error || !data) {
                    const dadosPadrao = {
                        id: 1,
                        conteudo: {
                            maquinas: Array.from({length: 4}, (_, i) => criarNovaEstruturaMaquina(i + 1)),
                            cores: catalogoCores,
                            operadores: equipeOperadores,
                            produtos: catalogoProdutos,
                            historico: [],
                            metricasMensais: { tempoProducao: 0 },
                            timestampAtualizacao: Date.now()
                        }
                    };
                    await sb.from('sistema').upsert(dadosPadrao);
                    return dadosPadrao;
                }
                return data;
            };

            try {
                const resultado = await Promise.race([promessaBanco(), promessaTimeout]);
                carregarEstadoGlobal(resultado.conteudo);
            } catch (erro) {
                console.error("Entrando em modo offline/recovery:", erro);
                // Carrega estrutura padr√£o em caso de erro
                carregarEstadoGlobal({
                    maquinas: Array.from({length: 4}, (_, i) => criarNovaEstruturaMaquina(i + 1)),
                    cores: catalogoCores,
                    operadores: equipeOperadores,
                    produtos: catalogoProdutos,
                    historico: [],
                    metricasMensais: { tempoProducao: 0 },
                    timestampAtualizacao: Date.now()
                });
            } finally {
                // Remove tela de loading
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('acao-pos-loading').classList.remove('hidden');
                document.getElementById('acao-pos-loading').classList.add('flex');
                
                // Inicia loops de tempo
                iniciarRelogioSistema();
                setInterval(sincronizarDadosNuvem, 3000); // Sync a cada 3s
            }
        }

        function criarNovaEstruturaMaquina(id) {
            return {
                id: id,
                nome: `Injetora ${id}`, // Nome profissional
                status: "22 - SEM PROGRAMA√á√ÉO DE PRODU√á√ÉO",
                filaProducao: [],
                dadosTurno: { 1: criarObjetoMetricasVazio(), 2: criarObjetoMetricasVazio(), 3: criarObjetoMetricasVazio() },
                resumoTurno: { 1: criarObjetoMetricasVazio(), 2: criarObjetoMetricasVazio(), 3: criarObjetoMetricasVazio() },
                tempoAcumuladoStatus: 0,
                ultimoStatusChange: Date.now()
            };
        }

        function carregarEstadoGlobal(dados) {
            maquinas = dados.maquinas || [];
            catalogoCores = dados.cores || catalogoCores;
            equipeOperadores = dados.operadores || equipeOperadores;
            catalogoProdutos = dados.produtos || catalogoProdutos;
            historicoOperacoes = dados.historico || [];
            metricasMensais = dados.metricasMensais || { tempoProducao: 0, tempoHoraExtra: 0 };
            modoHoraExtraAtivo = dados.modoHoraExtra || false;
            timestampUltimaAtualizacaoLocal = dados.timestampAtualizacao || 0;

            // Preenche Select de Login Dinamicamente
            atualizarSelectLogin();
            
            // Preenche selects dos modais
            atualizarDropdownsFormularios();
            
            // Verifica tempo offline para compensar contadores
            const agora = Date.now();
            const segundosOffline = Math.floor((agora - timestampUltimaAtualizacaoLocal) / 1000);
            if (segundosOffline > 0 && segundosOffline < 86400) { // Limite de 24h para compensa√ß√£o
                compensarTempoOffline(segundosOffline);
            }

            sanitizarDados();
            verificarTurnoAutomatico();
            
            // Se j√° estiver logado, atualiza a interface
            if (usuarioLogado) {
                renderizarPainelPrincipal();
                if (usuarioLogado === 'admin') {
                    renderizarFilasPedidos();
                    renderizarTabelaResumo();
                }
                atualizarTimersNaTela();
            }
        }

        // Atualiza a lista de usu√°rios no login baseado nas m√°quinas existentes
        function atualizarSelectLogin() {
            const select = document.getElementById('select-login-usuario');
            // Mant√©m o admin e reconstr√≥i o resto
            let html = '<option value="admin">Administrador (Ger√™ncia)</option>';
            maquinas.forEach(m => {
                html += `<option value="${m.id}">üè≠ ${m.nome}</option>`;
            });
            select.innerHTML = html;
            
            // Atualiza tamb√©m filtros de gr√°ficos
            const filtroGraf = document.getElementById('filtro-grafico-maquina');
            if(filtroGraf) {
                filtroGraf.innerHTML = '<option value="todas">Todas as M√°quinas</option>' + 
                    maquinas.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
            }
        }

        async function salvarDadosNuvem() {
            if (timerSalvamento) clearTimeout(timerSalvamento);
            exibirNotificacao("Salvando dados...", "salvando");
            
            const payload = {
                maquinas,
                cores: catalogoCores,
                operadores: equipeOperadores,
                produtos: catalogoProdutos,
                historico: historicoOperacoes,
                metricasMensais,
                modoHoraExtra: modoHoraExtraAtivo,
                timestampAtualizacao: Date.now()
            };

            const { error } = await sb.from('sistema').upsert({ id: 1, conteudo: payload });

            if (error) {
                console.error(error);
                exibirNotificacao("Erro ao salvar!", "erro");
            } else {
                timestampUltimaAtualizacaoLocal = payload.timestampAtualizacao;
                exibirNotificacao("Dados Salvos", "sucesso");
                document.getElementById('status-nuvem').innerText = "‚òÅÔ∏è";
            }
        }

        function agendarSalvamentoAutomatico() {
            document.getElementById('status-nuvem').innerText = "‚è≥";
            if (timerSalvamento) clearTimeout(timerSalvamento);
            timerSalvamento = setTimeout(salvarDadosNuvem, 2000);
        }

        async function sincronizarDadosNuvem() {
            // N√£o sincroniza se estiver editando algo (para n√£o perder o input)
            if (document.getElementById('modal-editar-op').style.display === 'flex' || 
                document.getElementById('modal-gerenciar-maquinas').style.display === 'flex') {
                return;
            }

            const { data } = await sb.from('sistema').select('conteudo').eq('id', 1).single();
            if (data && data.conteudo) {
                // S√≥ atualiza se a vers√£o do servidor for mais nova
                if ((data.conteudo.timestampAtualizacao || 0) > timestampUltimaAtualizacaoLocal + 2000) {
                    console.log("Recebendo atualiza√ß√£o remota...");
                    carregarEstadoGlobal(data.conteudo);
                }
            }
        }

        // --- GERENCIAMENTO DE M√ÅQUINAS (ADICIONAR / REMOVER) ---
        
        function abrirModalGerenciamento() {
            document.getElementById('modal-gerenciar-maquinas').style.display = 'flex';
            renderizarListaMaquinasConfig();
        }

        function fecharModalGerenciamento() {
            document.getElementById('modal-gerenciar-maquinas').style.display = 'none';
        }

        function renderizarListaMaquinasConfig() {
            const container = document.getElementById('lista-maquinas-configuracao');
            container.innerHTML = maquinas.map(m => `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 text-blue-700 font-bold w-8 h-8 flex items-center justify-center rounded text-xs">
                            ${m.id}
                        </div>
                        <input type="text" value="${m.nome}" 
                            onchange="renomearMaquina(${m.id}, this.value)" 
                            class="bg-white border border-slate-300 rounded px-2 py-1 text-sm text-slate-700 font-medium focus:border-blue-500 outline-none w-48">
                    </div>
                    <button onclick="removerMaquina(${m.id})" class="text-slate-400 hover:text-red-500 transition-colors p-2" title="Excluir M√°quina">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            `).join('');
        }

        function adicionarNovaMaquina() {
            // Gera um novo ID baseado no maior existente + 1
            const novoId = maquinas.length > 0 ? Math.max(...maquinas.map(m => m.id)) + 1 : 1;
            
            const novaMaquina = criarNovaEstruturaMaquina(novoId);
            maquinas.push(novaMaquina);
            
            renderizarListaMaquinasConfig();
            atualizarSelectLogin(); // Atualiza tela de login
            renderizarPainelPrincipal(); // Atualiza dashboard
            
            agendarSalvamentoAutomatico();
        }

        function removerMaquina(id) {
            if (confirm(`ATEN√á√ÉO: Voc√™ est√° prestes a excluir a M√°quina ID ${id}.\nIsso apagar√° o hist√≥rico de produ√ß√£o dela no turno atual.\n\nDeseja continuar?`)) {
                maquinas = maquinas.filter(m => m.id !== id);
                
                renderizarListaMaquinasConfig();
                atualizarSelectLogin();
                renderizarPainelPrincipal();
                
                agendarSalvamentoAutomatico();
            }
        }

        function renomearMaquina(id, novoNome) {
            const maquina = maquinas.find(m => m.id === id);
            if (maquina) {
                maquina.nome = novoNome;
                agendarSalvamentoAutomatico();
                renderizarPainelPrincipal();
                atualizarSelectLogin();
            }
        }

        // --- L√ìGICA DE TEMPO E COMPENSA√á√ÉO ---
        function compensarTempoOffline(segundos) {
            // Distribui o tempo que o sistema ficou fechado
            const turno = document.getElementById('select-turno-global').value;
            maquinas.forEach(m => {
                if (m.status.includes("PRODU√á√ÉO")) {
                    m.dadosTurno[turno].tempoProducao += segundos;
                    metricasMensais.tempoProducao += segundos;
                } else if (m.status.includes("BAIXA") || m.status.includes("MAT√âRIA")) {
                    m.dadosTurno[turno].tempoBaixaEficiencia += segundos;
                    metricasMensais.tempoProducao += segundos; // Conta como hora trabalhada
                } else if (m.status.includes("SEM") || m.status.includes("FECHADA")) {
                    m.dadosTurno[turno].tempoSemProgramacao += segundos;
                } else {
                    m.dadosTurno[turno].tempoParadas += segundos;
                }
            });
        }

        function iniciarRelogioSistema() {
            if (timerRelogio) clearInterval(timerRelogio);
            timerRelogio = setInterval(() => {
                const agora = obterDataHoraBrasilia();
                document.getElementById('relogio-sistema').innerText = agora.toLocaleTimeString('pt-BR');
                
                // L√≥gica de Fim de Semana / Pausa Autom√°tica
                const ehFDS = verificarFimDeSemana(agora);
                
                if (ehFDS && !fimDeSemanaAtivo && !modoHoraExtraAtivo) {
                    fimDeSemanaAtivo = true;
                    // Congela contadores acumulando tempo no buffer
                    maquinas.forEach(m => {
                        if (m.ultimoStatusChange) {
                            m.tempoAcumuladoStatus += (Date.now() - m.ultimoStatusChange);
                            m.ultimoStatusChange = null; // Pausa o contador
                        }
                    });
                    agendarSalvamentoAutomatico();
                } else if (!ehFDS && fimDeSemanaAtivo) {
                    fimDeSemanaAtivo = false;
                    // Retoma contadores
                    maquinas.forEach(m => m.ultimoStatusChange = Date.now());
                    agendarSalvamentoAutomatico();
                }

                // Atualiza visual dos bot√µes
                const badge = document.getElementById('badge-auto');
                if (ehFDS && !modoHoraExtraAtivo) {
                    badge.innerText = "FDS PAUSA";
                    badge.className = "bg-yellow-500 text-[9px] px-2 py-1 rounded font-black text-white";
                    return; // N√£o conta tempo
                }
                
                if (sistemaPausado) {
                    badge.innerText = "PAUSADO";
                    badge.className = "bg-orange-500 text-[9px] px-2 py-1 rounded font-black text-white";
                    return; // N√£o conta tempo
                }

                if (modoHoraExtraAtivo) {
                    badge.innerText = "EXTRA ON";
                    badge.className = "bg-purple-600 text-[9px] px-2 py-1 rounded font-black animate-pulse text-white";
                } else {
                    badge.innerText = modoManualAtivo ? "MANUAL" : "AUTO";
                    badge.className = modoManualAtivo ? "bg-blue-500 text-[9px] px-2 py-1 rounded font-black text-white" : "bg-green-500 text-[9px] px-2 py-1 rounded font-black animate-pulse text-white";
                }

                verificarTurnoAutomatico();
                processarContadoresTempo();
                
                if (usuarioLogado) {
                    atualizarTimersNaTela();
                    if (usuarioLogado === 'admin' && document.getElementById('aba-graficos').classList.contains('aba-ativa')) {
                        // Atualiza gr√°ficos em tempo real se a aba estiver aberta
                        atualizarGraficos();
                    }
                }

            }, 1000);
        }

        function verificarTurnoAutomatico() {
            if (modoManualAtivo) return;
            const data = obterDataHoraBrasilia();
            const minutos = data.getHours() * 60 + data.getMinutes();
            let turno = 3;
            // 05:00 (300) at√© 14:18 (858) = Turno 1
            if (minutos >= 300 && minutos < 858) turno = 1;
            // 14:18 (858) at√© 23:36 (1416) = Turno 2
            else if (minutos >= 858 && minutos < 1416) turno = 2;
            
            const select = document.getElementById('select-turno-global');
            if (select.value != turno) {
                select.value = turno;
                if (usuarioLogado) renderizarPainelPrincipal();
            }
        }

        function processarContadoresTempo() {
            const turno = document.getElementById('select-turno-global').value;
            
            maquinas.forEach(m => {
                if (m.status === "23 - F√ÅBRICA FECHADA / FERIADO") return;

                if (m.status.includes("SEM") || m.status.includes("PARADA PROGRAMADA")) {
                    m.dadosTurno[turno].tempoSemProgramacao++;
                    return;
                }

                // Tempo Produtivo (para meta mensal)
                if (m.status.includes("PRODU√á√ÉO") || m.status.includes("BAIXA") || m.status.includes("MAT√âRIA")) {
                    if (fimDeSemanaAtivo && modoHoraExtraAtivo) {
                        metricasMensais.tempoHoraExtra++;
                    } else {
                        metricasMensais.tempoProducao++;
                    }
                }

                // Contadores Espec√≠ficos
                if (m.status.includes("PRODU√á√ÉO")) {
                    m.dadosTurno[turno].tempoProducao++;
                } else if (m.status.includes("BAIXA") || m.status.includes("MAT√âRIA")) {
                    m.dadosTurno[turno].tempoBaixaEficiencia++;
                } else {
                    m.dadosTurno[turno].tempoParadas++;
                }
            });
        }

        // --- SISTEMA DE LOGIN E NAVEGA√á√ÉO ---
        
        function exibirTelaLogin() {
            document.getElementById('tela-carregamento').style.display = 'none';
            
            const usuarioSalvo = localStorage.getItem('triplast_user_v23');
            if (usuarioSalvo) {
                // Tenta logar automaticamente se existir sess√£o
                usuarioLogado = usuarioSalvo === 'admin' ? 'admin' : parseInt(usuarioSalvo);
                acessarSistema();
            } else {
                document.getElementById('tela-login').style.display = 'flex';
            }
        }

        function realizarLogin() {
            const tipo = document.getElementById('select-login-usuario').value;
            const senha = document.getElementById('input-login-senha').value.trim().toLowerCase();
            
            // Senha Admin: 2026
            // Senha M√°quina: "m" + ID (ex: m5)
            let senhaCorreta = false;
            
            if (tipo === 'admin' && senha === '2026') senhaCorreta = true;
            else if (tipo !== 'admin' && senha === ('m' + tipo)) senhaCorreta = true;

            if (senhaCorreta) {
                usuarioLogado = tipo === 'admin' ? 'admin' : parseInt(tipo);
                localStorage.setItem('triplast_user_v23', tipo);
                acessarSistema();
            } else {
                alert("Senha incorreta. Tente novamente.");
            }
        }

        function acessarSistema() {
            document.getElementById('tela-login').style.display = 'none';
            document.getElementById('painel-principal').style.display = 'block';
            document.getElementById('painel-principal').classList.remove('hidden');
            
            // Ajusta visibilidade baseada no n√≠vel de acesso
            const elementosAdmin = ['area-admin-painel', 'header-eficiencia', 'btn-pausa-sistema', 'btn-hora-extra'];
            
            if (usuarioLogado === 'admin') {
                elementosAdmin.forEach(id => document.getElementById(id).style.display = 'block');
                document.getElementById('tab-pedidos').style.display = 'inline-block';
                document.getElementById('tab-resumo').style.display = 'inline-block';
                document.getElementById('tab-graficos').style.display = 'inline-block';
            } else {
                // Modo Operador (Apenas v√™ sua m√°quina)
                elementosAdmin.forEach(id => document.getElementById(id).style.display = 'none');
                // Esconde abas de gest√£o
                document.getElementById('tab-pedidos').style.display = 'none';
                document.getElementById('tab-resumo').style.display = 'none';
                document.getElementById('tab-graficos').style.display = 'none';
            }

            navegarParaAba('monitoramento');
            renderizarPainelPrincipal();
        }

        function realizarLogout() {
            usuarioLogado = null;
            localStorage.removeItem('triplast_user_v23');
            location.reload();
        }

        function navegarParaAba(idAba) {
            // Remove classe ativa de todas as abas
            document.querySelectorAll('.aba-conteudo').forEach(el => el.classList.remove('aba-ativa'));
            document.querySelectorAll('.botao-aba').forEach(el => el.classList.remove('ativo'));
            
            // Ativa a selecionada
            document.getElementById(`aba-${idAba}`).classList.add('aba-ativa');
            document.getElementById(`tab-${idAba}`).classList.add('ativo');
            
            // Carrega dados espec√≠ficos da aba
            if (idAba === 'pedidos') renderizarFilasPedidos();
            if (idAba === 'graficos') inicializarGraficos();
            if (idAba === 'resumo') renderizarTabelaResumo();
        }

        // --- RENDERIZA√á√ÉO DO PAINEL PRINCIPAL ---
        
        function renderizarPainelPrincipal() {
            const turno = document.getElementById('select-turno-global').value;
            const container = document.getElementById('grid-maquinas-container');
            
            // Filtra qual m√°quina mostrar (todas se admin, ou s√≥ a pr√≥pria se operador)
            const listaParaRenderizar = (usuarioLogado === 'admin') 
                ? maquinas 
                : maquinas.filter(m => m.id === usuarioLogado);

            container.innerHTML = listaParaRenderizar.map(m => {
                const op = m.filaProducao[0] || { op: '---', produto: 'AGUARDANDO PROGRAMA√á√ÉO', quantidade: 0 };
                const metricas = m.dadosTurno[turno] || criarObjetoMetricasVazio();
                
                // C√°lculo de progresso
                const progresso = op.quantidade > 0 ? Math.min((metricas.pecasBoas / op.quantidade) * 100, 100) : 0;
                
                // Define cor da borda baseada no status
                let classeBorda = "borda-status-parado"; // Padr√£o vermelho
                if (m.status.includes("PRODU√á√ÉO")) classeBorda = "borda-status-produzindo";
                else if (m.status.includes("BAIXA") || m.status.includes("MAT√âRIA")) classeBorda = "borda-status-atencao";
                else if (m.status.includes("SEM") || m.status.includes("FECHADA")) classeBorda = "borda-status-neutro";

                return `
                <div class="cartao-maquina ${classeBorda} p-5">
                    <div class="flex justify-between items-start mb-3">
                        <span class="bg-slate-800 text-white px-3 py-1 rounded-md font-black text-lg shadow-sm">${m.nome}</span>
                        <div class="text-right">
                            <span id="timer-display-${m.id}" class="text-xs font-mono font-bold block text-slate-500">00:00:00</span>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 mb-4">
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs font-bold text-slate-400 uppercase">Ordem de Produ√ß√£o</span>
                            <span class="font-black text-lg text-slate-800">${op.op}</span>
                        </div>
                        <div class="text-sm font-bold text-blue-600 truncate mb-3 w-full" title="${op.produto}">
                            ${op.produto}
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div class="bg-white p-2 rounded border border-slate-200 text-center">
                                <span class="block text-[10px] font-bold text-green-600 uppercase">Produzido</span>
                                <span class="block text-xl font-black text-slate-800">${metricas.pecasBoas}</span>
                            </div>
                            <div class="bg-white p-2 rounded border border-slate-200 text-center">
                                <span class="block text-[10px] font-bold text-red-500 uppercase">Refugo</span>
                                <span class="block text-xl font-black text-slate-800">${metricas.pecasRefugo}</span>
                            </div>
                        </div>

                        <div class="w-full bg-slate-200 h-2.5 rounded-full overflow-hidden">
                            <div class="bg-blue-500 h-full transition-all duration-500" style="width: ${progresso}%"></div>
                        </div>
                        <div class="text-right text-[10px] font-bold text-slate-400 mt-1">${progresso.toFixed(1)}% Conclu√≠do</div>
                    </div>

                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <input type="number" id="input-prod-${m.id}" class="flex-1 input-profissional text-center font-bold text-lg h-10 p-0" placeholder="Qtd">
                            <button onclick="registrarProducaoManual(${m.id})" class="bg-blue-600 hover:bg-blue-500 text-white w-12 rounded-lg font-bold text-xl shadow-sm active:scale-95 transition-all">+</button>
                        </div>

                        <div class="flex gap-2 items-center bg-red-50 p-2 rounded-lg border border-red-100">
                            <i class="fa-solid fa-trash-can text-red-400 ml-1"></i>
                            <select id="select-refugo-${m.id}" class="flex-1 bg-transparent border-none text-xs font-bold text-slate-600 outline-none">
                                ${LISTA_TIPOS_REFUGO.map(r => `<option value="${r}">${r}</option>`).join('')}
                            </select>
                            <button onclick="registrarRefugo(${m.id})" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded font-bold text-sm shadow-sm transition-colors">+</button>
                        </div>

                        <div class="relative">
                            <i class="fa-solid fa-traffic-light absolute left-3 top-3 text-slate-400 text-xs"></i>
                            <select onchange="alterarStatusMaquina(${m.id}, this.value)" class="w-full pl-8 pr-2 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold text-slate-700 outline-none focus:border-blue-500 cursor-pointer">
                                ${LISTA_MOTIVOS_PARADA.map(s => `<option value="${s}" ${m.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    ${usuarioLogado === 'admin' ? `
                        <button onclick="finalizarOrdemProducao(${m.id})" class="w-full mt-3 text-[10px] font-bold text-slate-400 hover:text-red-600 uppercase tracking-wider transition-colors border-t border-slate-100 pt-2">
                            <i class="fa-solid fa-flag-checkered mr-1"></i> Finalizar O.P Atual
                        </button>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        function atualizarTimersNaTela() {
            const agora = Date.now();
            const lista = (usuarioLogado === 'admin') ? maquinas : maquinas.filter(m => m.id === usuarioLogado);
            
            lista.forEach(m => {
                const el = document.getElementById(`timer-display-${m.id}`);
                if (el) {
                    let diff = (m.tempoAcumuladoStatus || 0);
                    if (m.ultimoStatusChange) {
                        diff += (agora - m.ultimoStatusChange);
                    }
                    
                    const tempoFormatado = formatarTempo(diff / 1000);
                    
                    if (m.status.includes('PRODU√á√ÉO')) {
                        el.innerHTML = `<span class="text-green-600 flex items-center justify-end gap-1"><i class="fa-solid fa-gear fa-spin"></i> ${tempoFormatado}</span>`;
                    } else if (m.status.includes('PARADA') || m.status.includes('FECHADA') || m.status.includes('SEM')) {
                        el.innerHTML = `<span class="text-slate-400">${tempoFormatado}</span>`;
                    } else {
                        // Paradas de aten√ß√£o (vermelho)
                        el.innerHTML = `<span class="text-red-500 animate-pulse">${tempoFormatado}</span>`;
                    }
                }
            });
        }

        // --- FUN√á√ïES DE PRODU√á√ÉO ---
        
        function registrarProducaoManual(idMaquina) {
            const input = document.getElementById(`input-prod-${idMaquina}`);
            const qtd = parseInt(input.value);
            
            if (qtd > 0) {
                const maquina = maquinas.find(m => m.id === idMaquina);
                const turno = document.getElementById('select-turno-global').value;
                
                maquina.dadosTurno[turno].pecasBoas += qtd;
                input.value = '';
                
                renderizarPainelPrincipal();
                agendarSalvamentoAutomatico();
            }
        }

        function registrarRefugo(idMaquina) {
            const maquina = maquinas.find(m => m.id === idMaquina);
            const turno = document.getElementById('select-turno-global').value;
            
            maquina.dadosTurno[turno].pecasRefugo++;
            
            renderizarPainelPrincipal();
            agendarSalvamentoAutomatico();
        }

        function alterarStatusMaquina(idMaquina, novoStatus) {
            const maquina = maquinas.find(m => m.id === idMaquina);
            
            // Consolida tempo do status anterior
            const agora = Date.now();
            if (maquina.ultimoStatusChange) {
                maquina.tempoAcumuladoStatus += (agora - maquina.ultimoStatusChange);
            }
            
            // Reseta para o novo status
            maquina.status = novoStatus;
            maquina.ultimoStatusChange = agora;
            maquina.tempoAcumuladoStatus = 0;
            
            renderizarPainelPrincipal();
            agendarSalvamentoAutomatico();
        }

        function finalizarOrdemProducao(idMaquina) {
            if (confirm("Deseja realmente finalizar a Ordem de Produ√ß√£o atual?")) {
                const maquina = maquinas.find(m => m.id === idMaquina);
                const opAtual = maquina.filaProducao.shift(); // Remove a primeira da fila
                
                if (opAtual) {
                    const turno = document.getElementById('select-turno-global').value;
                    // Salva no hist√≥rico
                    historicoOperacoes.push({
                        ...opAtual,
                        dataFinalizacao: new Date().toISOString(),
                        maquina: maquina.nome,
                        qtdProduzida: maquina.dadosTurno[turno].pecasBoas,
                        status: 'CONCLU√çDO'
                    });
                }
                
                // Zera contadores do turno para a nova OP
                const turno = document.getElementById('select-turno-global').value;
                maquina.dadosTurno[turno] = criarObjetoMetricasVazio();
                
                renderizarPainelPrincipal();
                if (usuarioLogado === 'admin') renderizarFilasPedidos();
                agendarSalvamentoAutomatico();
            }
        }

        // --- GEST√ÉO DE O.P (FILAS) ---
        
        function renderizarFilasPedidos() {
            const container = document.getElementById('container-filas-producao');
            const termoBusca = document.getElementById('busca-pedidos').value.toLowerCase();
            
            container.innerHTML = maquinas.map(m => {
                const filaFiltrada = m.filaProducao.filter(op => 
                    op.op.toLowerCase().includes(termoBusca) || 
                    op.cliente.toLowerCase().includes(termoBusca) || 
                    op.produto.toLowerCase().includes(termoBusca)
                );

                if (filaFiltrada.length === 0 && termoBusca !== "") return ""; 

                return `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-3 mb-4 border-b border-slate-100 pb-3">
                        <div class="bg-blue-100 text-blue-700 font-black w-8 h-8 rounded flex items-center justify-center">${m.id}</div>
                        <h3 class="font-bold text-lg text-slate-800">${m.nome}</h3>
                    </div>
                    <div class="wrapper-scroll-horizontal">
                        ${filaFiltrada.map((op, i) => `
                        <div class="ticket-card group shrink-0 w-80 bg-white border border-slate-200 rounded-lg shadow-sm hover:shadow-md transition-all flex flex-col">
                            <div class="bg-slate-50 p-3 border-b border-slate-200 flex justify-between items-center">
                                <span class="text-xs font-black text-slate-400">POSI√á√ÉO #${i+1}</span>
                                <button onclick="deletarOP(${m.id}, ${i})" class="text-slate-300 hover:text-red-500 transition-colors px-2">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                            <div class="p-4 flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-black text-xl text-blue-600">${op.op}</span>
                                    <span class="font-bold text-slate-600 bg-slate-100 px-2 py-1 rounded text-xs">${op.qtd} un</span>
                                </div>
                                <p class="text-xs font-bold text-slate-500 uppercase mb-1 truncate">${op.cliente}</p>
                                <p class="text-sm font-bold text-slate-800 truncate border-b border-slate-100 pb-2 mb-2">${op.produto}</p>
                                
                                <div class="grid grid-cols-2 gap-2 text-[10px] text-slate-500 font-medium">
                                    <div>Mat: ${op.material || '-'}</div>
                                    <div>Cor: ${op.pigmento || '-'}</div>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-3 border-t border-slate-200 flex justify-between items-center">
                                <button onclick="abrirModalEdicao(${m.id}, ${i})" class="text-blue-600 font-bold text-xs uppercase hover:underline">Editar</button>
                                <div class="flex gap-1">
                                    <button onclick="moverNaFila(${m.id}, ${i}, -1)" class="w-6 h-6 flex items-center justify-center rounded bg-white border border-slate-300 text-slate-500 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200">
                                        <i class="fa-solid fa-chevron-left text-[10px]"></i>
                                    </button>
                                    <button onclick="moverNaFila(${m.id}, ${i}, 1)" class="w-6 h-6 flex items-center justify-center rounded bg-white border border-slate-300 text-slate-500 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200">
                                        <i class="fa-solid fa-chevron-right text-[10px]"></i>
                                    </button>
                                </div>
                            </div>
                        </div>`).join('') || '<span class="text-slate-400 text-sm font-medium italic p-2">Nenhuma ordem programada.</span>'}
                    </div>
                </div>`;
            }).join('');
        }

        function abrirModalCriacaoOP() {
            document.getElementById('modal-ficha-tecnica').style.display = 'flex';
            document.getElementById('input-modo-edicao').value = "false";
            // Limpa campos
            ['input-op-numero','input-op-cliente','input-op-quantidade','input-op-material','input-op-material-qtd','input-op-pigmento','input-op-porcentagem','input-op-caixa','input-op-saco'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('input-op-maquina').disabled = false;
        }

        function abrirModalEdicao(idMaquina, index) {
            const maquina = maquinas.find(m => m.id === idMaquina);
            const op = maquina.filaProducao[index];
            
            document.getElementById('modal-ficha-tecnica').style.display = 'flex';
            document.getElementById('input-modo-edicao').value = "true";
            document.getElementById('input-maquina-id').value = idMaquina;
            document.getElementById('input-op-index').value = index;
            
            document.getElementById('input-op-maquina').value = maquina.nome; // Apenas visual
            document.getElementById('input-op-maquina').disabled = true; // N√£o pode mudar m√°quina na edi√ß√£o direto
            
            document.getElementById('input-op-numero').value = op.op;
            document.getElementById('input-op-cliente').value = op.cliente;
            document.getElementById('input-op-quantidade').value = op.qtd;
            document.getElementById('input-op-produto').value = op.produto;
            document.getElementById('input-op-material').value = op.material || '';
            document.getElementById('input-op-material-qtd').value = op.materialQtd || '';
            document.getElementById('input-op-pigmento').value = op.pigmento || '';
            document.getElementById('input-op-porcentagem').value = op.porcentagem || '';
            document.getElementById('input-op-caixa').value = op.caixa || '';
            document.getElementById('input-op-saco').value = op.saco || '';
            document.getElementById('input-op-operador').value = op.operador;
        }

        function fecharModalFicha() {
            document.getElementById('modal-ficha-tecnica').style.display = 'none';
        }

        function salvarFichaTecnica() {
            const modoEdicao = document.getElementById('input-modo-edicao').value === "true";
            
            // Se for novo, pega do select. Se for edi√ß√£o, pega do hidden id
            let idMaquina;
            if (modoEdicao) {
                idMaquina = parseInt(document.getElementById('input-maquina-id').value);
            } else {
                // Para nova OP, precisamos achar o ID baseado no nome selecionado no select
                const nomeSelecionado = document.getElementById('input-op-maquina').value;
                const maquinaEncontrada = maquinas.find(m => m.nome === nomeSelecionado);
                idMaquina = maquinaEncontrada ? maquinaEncontrada.id : null;
            }

            if (!idMaquina) { alert("Erro ao identificar m√°quina."); return; }

            const maquina = maquinas.find(m => m.id === idMaquina);
            
            const novaOp = {
                op: document.getElementById('input-op-numero').value,
                cliente: document.getElementById('input-op-cliente').value,
                produto: document.getElementById('input-op-produto').value,
                qtd: parseInt(document.getElementById('input-op-quantidade').value) || 0,
                material: document.getElementById('input-op-material').value,
                materialQtd: document.getElementById('input-op-material-qtd').value,
                pigmento: document.getElementById('input-op-pigmento').value,
                porcentagem: document.getElementById('input-op-porcentagem').value,
                caixa: document.getElementById('input-op-caixa').value,
                saco: document.getElementById('input-op-saco').value,
                operador: document.getElementById('input-op-operador').value
            };

            if (modoEdicao) {
                const index = parseInt(document.getElementById('input-op-index').value);
                maquina.filaProducao[index] = novaOp;
            } else {
                maquina.filaProducao.push(novaOp);
            }

            agendarSalvamentoAutomatico();
            fecharModalFicha();
            renderizarFilasPedidos();
            renderizarPainelPrincipal(); // Atualiza painel caso seja a primeira OP
        }

        function moverNaFila(idMaquina, index, direcao) {
            const maquina = maquinas.find(m => m.id === idMaquina);
            const novaPosicao = index + direcao;
            
            if (novaPosicao >= 0 && novaPosicao < maquina.filaProducao.length) {
                const item = maquina.filaProducao.splice(index, 1)[0];
                maquina.filaProducao.splice(novaPosicao, 0, item);
                
                renderizarFilasPedidos();
                agendarSalvamentoAutomatico();
            }
        }

        function deletarOP(idMaquina, index) {
            if (confirm("Tem certeza que deseja excluir esta Ordem de Produ√ß√£o?")) {
                const maquina = maquinas.find(m => m.id === idMaquina);
                const op = maquina.filaProducao.splice(index, 1)[0];
                
                // Registra cancelamento no hist√≥rico
                historicoOperacoes.push({ 
                    ...op, 
                    dataFinalizacao: new Date().toISOString(), 
                    maquina: maquina.nome, 
                    status: 'CANCELADO' 
                });
                
                renderizarFilasPedidos();
                agendarSalvamentoAutomatico();
            }
        }

        // --- ATUALIZA√á√ÉO DE DROPDOWNS ---
        function atualizarDropdownsFormularios() {
            // M√°quinas
            const selectMaquinas = document.getElementById('input-op-maquina');
            selectMaquinas.innerHTML = maquinas.map(m => `<option value="${m.nome}">${m.nome}</option>`).join('');

            // Operadores
            const htmlOps = equipeOperadores.map(op => `<option value="${op}">${op}</option>`).join('');
            document.getElementById('input-op-operador').innerHTML = htmlOps;

            // Produtos
            const htmlProds = catalogoProdutos.map(p => `<option value="${p}">${p}</option>`).join('');
            document.getElementById('input-op-produto').innerHTML = htmlProds;
        }

        // --- SISTEMA DE GR√ÅFICOS (CHART.JS) ---
        function inicializarGraficos() {
            const ctxOEE = document.getElementById('grafico-oee');
            if (!ctxOEE || chartInstances.oee) return; // J√° existe ou n√£o est√° na tela

            // Gr√°fico Donut (OEE)
            chartInstances.oee = new Chart(ctxOEE, {
                type: 'doughnut',
                data: {
                    labels: ['Produzindo', 'Baixa Efic.', 'Parado', 'Neutro'],
                    datasets: [{
                        data: [0, 0, 0, 1],
                        backgroundColor: ['#22c55e', '#f97316', '#ef4444', '#cbd5e1'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false }
                    }
                }
            });

            // Gr√°fico Barras (Horas)
            const ctxHoras = document.getElementById('grafico-horas');
            chartInstances.horas = new Chart(ctxHoras, {
                type: 'bar',
                data: {
                    labels: ['Acumulado'],
                    datasets: [
                        { label: 'Normal', data: [0], backgroundColor: '#3b82f6' },
                        { label: 'Extra', data: [0], backgroundColor: '#9333ea' }
                    ]
                },
                options: { indexAxis: 'y', responsive: true }
            });
        }

        function atualizarGraficos() {
            if (!chartInstances.oee) return;

            const filtroId = document.getElementById('filtro-grafico-maquina').value; // ID ou 'todas'
            const turno = document.getElementById('select-turno-global').value;
            
            let dados = { prod: 0, baixa: 0, parada: 0, neutro: 0 };

            maquinas.forEach(m => {
                if (filtroId === 'todas' || m.id == filtroId) {
                    dados.prod += m.resumoTurno[turno].tempoProducao;
                    dados.baixa += m.resumoTurno[turno].tempoBaixaEficiencia;
                    dados.parada += m.resumoTurno[turno].tempoParadas;
                    dados.neutro += m.resumoTurno[turno].tempoSemProgramacao;
                }
            });

            // Atualiza Donut
            chartInstances.oee.data.datasets[0].data = [dados.prod, dados.baixa, dados.parada, dados.neutro];
            chartInstances.oee.update();

            // Atualiza Legendas de Texto
            document.getElementById('tempo-prod-total').innerText = formatarTempo(dados.prod);
            document.getElementById('tempo-baixa-total').innerText = formatarTempo(dados.baixa);
            document.getElementById('tempo-parado-total').innerText = formatarTempo(dados.parada);
            document.getElementById('tempo-neutro-total').innerText = formatarTempo(dados.neutro);

            // Atualiza Horas Mensais
            const horasNormais = (metricasMensais.tempoProducao || 0) / 3600;
            const horasExtras = (metricasMensais.tempoHoraExtra || 0) / 3600;
            if (chartInstances.horas) {
                chartInstances.horas.data.datasets[0].data = [horasNormais];
                chartInstances.horas.data.datasets[1].data = [horasExtras];
                chartInstances.horas.update();
            }
        }

        function calcEficienciaGlobal() {
            const totalSegundos = (metricasMensais.tempoProducao || 0) + (metricasMensais.tempoHoraExtra || 0);
            const horasTrabalhadas = totalSegundos / 3600;
            
            document.getElementById('horas-trabalhadas-mes').innerText = horasTrabalhadas.toFixed(1) + "h";
            
            const meta = 1628; // Meta hardcoded no prompt original
            const porcentagem = (horasTrabalhadas / meta) * 100;
            document.getElementById('meta-global').innerText = porcentagem.toFixed(1) + "%";
        }

        // --- RELAT√ìRIOS (TABELA DE RESUMO) ---
        function renderizarTabelaResumo() {
            const turno = document.getElementById('filtro-resumo-turno').value;
            const tbody = document.getElementById('tabela-resumo-corpo');
            
            tbody.innerHTML = maquinas.map(m => {
                let dados = { boas:0, refugo:0, tempoProducao:0, paradas:0, tempoBaixa:0, tempoSemProg:0 };
                
                if (turno === 'todas') {
                    // Soma todos os turnos
                    [1, 2, 3].forEach(t => {
                        dados.boas += m.dadosTurno[t].pecasBoas;
                        dados.refugo += m.dadosTurno[t].pecasRefugo;
                        dados.tempoProducao += m.dadosTurno[t].tempoProducao;
                        dados.paradas += m.dadosTurno[t].tempoParadas;
                    });
                } else {
                    dados = m.dadosTurno[turno];
                }

                const totalPecas = dados.boas + dados.refugo;
                const percentualPerda = totalPecas > 0 ? ((dados.refugo / totalPecas) * 100).toFixed(1) : 0;

                return `
                <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                    <td class="p-4 font-bold text-slate-800">${m.nome}</td>
                    <td class="p-4 text-xs text-slate-500 font-mono">${m.filaProducao[0]?.op || '-'}</td>
                    <td class="p-4 text-right font-bold text-green-600 text-lg">${dados.boas}</td>
                    <td class="p-4 text-right font-bold text-red-500">${dados.refugo}</td>
                    <td class="p-4 text-right text-xs font-bold text-slate-400">${percentualPerda}%</td>
                    <td class="p-4 text-center font-mono text-xs bg-green-50 text-green-700 rounded">${formatarTempo(dados.tempoProducao)}</td>
                    <td class="p-4 text-center font-mono text-xs bg-red-50 text-red-700 rounded">${formatarTempo(dados.paradas)}</td>
                </tr>
                `;
            }).join('');
        }

        function resetarTurnoCompleto() {
            const turno = document.getElementById('filtro-resumo-turno').value;
            if (turno === 'todas') {
                alert("Por favor, selecione um turno espec√≠fico para zerar.");
                return;
            }
            
            if (confirm(`Tem certeza que deseja zerar TODOS os dados do Turno ${turno}?`)) {
                maquinas.forEach(m => {
                    m.dadosTurno[turno] = criarObjetoMetricasVazio();
                });
                renderizarTabelaResumo();
                renderizarPainelPrincipal();
                agendarSalvamentoAutomatico();
            }
        }

        // --- CATALOGOS GERAIS ---
        function adicionarNovoOperador() {
            const nome = prompt("Nome do novo operador:");
            if (nome && !equipeOperadores.includes(nome)) {
                equipeOperadores.push(nome);
                atualizarDropdownsFormularios();
                agendarSalvamentoAutomatico();
            }
        }

        function adicionarNovoProdutoCatalogo() {
            const nome = prompt("Nome do novo produto:");
            if (nome && !catalogoProdutos.includes(nome)) {
                catalogoProdutos.push(nome);
                atualizarDropdownsFormularios();
                agendarSalvamentoAutomatico();
            }
        }

        // --- CONTROLES GLOBAIS ---
        function alternarPausaSistema() {
            sistemaPausado = !sistemaPausado;
            const btn = document.getElementById('btn-pausa-sistema');
            if (sistemaPausado) {
                btn.innerHTML = '<i class="fa-solid fa-play mr-1"></i> RETOMAR';
                btn.className = "text-[10px] font-bold px-3 py-1.5 rounded bg-green-500/10 text-green-600 border border-green-500/30 hover:bg-green-500 hover:text-white transition-all uppercase";
            } else {
                btn.innerHTML = '<i class="fa-solid fa-pause mr-1"></i> PAUSA';
                btn.className = "text-[10px] font-bold px-3 py-1.5 rounded bg-yellow-500/10 text-yellow-500 border border-yellow-500/30 hover:bg-yellow-500 hover:text-white transition-all uppercase";
            }
            agendarSalvamentoAutomatico();
        }

        function alternarHoraExtra() {
            if (!verificarFimDeSemana(obterDataHoraBrasilia())) {
                alert("Hora extra autom√°tica s√≥ permitida em Finais de Semana.");
                return;
            }
            modoHoraExtraAtivo = !modoHoraExtraAtivo;
            renderBotaoExtra(); // Atualiza visual
            agendarSalvamentoAutomatico();
        }

        function alterarTurnoManual(valor) {
            modoManualAtivo = true;
            document.getElementById('badge-auto').style.display = 'none'; // Some o badge auto
            if (usuarioLogado) renderizarPainelPrincipal();
        }

        function resetarMes() {
            if (confirm("Zerar acumulado de horas mensal?")) {
                metricasMensais.tempoProducao = 0;
                metricasMensais.tempoHoraExtra = 0;
                calcEficienciaGlobal();
                agendarSalvamentoAutomatico();
            }
        }

        // --- INICIALIZA√á√ÉO ---
        
        // Garante salvamento ao fechar a aba
        window.addEventListener('beforeunload', () => {
            salvarDadosNuvem();
        });

        // Inicia o sistema
        inicializarSistema();

    </script>
</body>
</html>
