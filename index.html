<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Triplast - Sistema Monitorado</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        
        body { background-color: #eef2f6; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        .aba-conteudo { display: none !important; }
        .aba-ativa { display: block !important; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card-producao {
            background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); border-left: 12px solid #cbd5e1;
            transition: 0.3s; overflow: hidden; display: flex; flex-direction: column; width: 100%; max-width: 1250px; margin: 0 auto;
        }
        
        @media (min-width: 1024px) {
            .card-producao { flex-direction: row; }
            .card-esq { flex: 1; padding: 32px; }
            .card-dir { width: 440px; background: #f8fafc; border-left: 1px solid #e2e8f0; padding: 24px; display: flex; flex-direction: column;}
        }
        
        @media (max-width: 1023px) {
            .card-esq { padding: 16px; }
            .card-dir { padding: 16px; background: #f8fafc; border-top: 1px solid #e2e8f0; }
        }

        .status-produzindo { border-left-color: #22c55e !important; } 
        .status-baixa { border-left-color: #f97316 !important; } 
        .status-sem-prog { border-left-color: #94a3b8 !important; } 
        .status-parada { border-left-color: #ef4444 !important; } 
        .status-fds { border-left-color: #475569 !important; background-color: #f1f5f9; }

        .info-badge { background: #ffffff; padding: 16px; border-radius: 16px; border: 2px solid #e2e8f0; text-align: center; display: flex; flex-direction: column; justify-content: space-between; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        .fila-scroll-vertical { flex: 1; overflow-y: auto; gap: 12px; display: flex; flex-direction: column; padding-right: 5px; scrollbar-width: thin; max-height: 500px; }
        .tab-btn { background: white; padding: 12px 24px; border-radius: 16px; font-weight: 900; font-size: 12px; color: #64748b; transition: 0.2s; border: 2px solid transparent; text-transform: uppercase; white-space: nowrap; }
        .tab-btn.active { background: #3b82f6; color: white; border-color: #2563eb; box-shadow: 0 4px 10px rgba(37,99,235,0.3); }

        .input-industrial { font-size: 1.5rem; font-weight: 900; text-align: center; border: 2px solid #cbd5e1; border-radius: 12px; padding: 10px; width: 100%; outline: none; }
        .input-industrial:focus { border-color: #3b82f6; }
        input[type="number"]::-webkit-inner-spin-button { display: none; }
    </style>
</head>
<body>

    <div id="tela-loading" class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center transition-all duration-500">
        <h1 class="text-6xl font-black italic tracking-tighter mb-8 text-white">TRI<span class="text-blue-500">PLAST</span></h1>
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-blue-400 font-bold text-sm tracking-widest uppercase animate-pulse">Sincronizando com a Nuvem...</p>
    </div>

    <div id="toast-notification" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-green-400 px-6 py-3 rounded-full shadow-2xl z-[999] hidden flex items-center gap-2 border border-slate-600 transition-all">
        <span id="status-nuvem" class="text-lg">‚òÅÔ∏è</span>
        <span class="text-[10px] font-black uppercase tracking-widest" id="toast-msg">Nuvem Atualizada</span>
    </div>

    <div id="tela-login" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4 hidden opacity-0 transition-all duration-500">
        <div class="bg-white p-10 rounded-[32px] shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-4xl font-black italic tracking-tighter mb-2 text-slate-800">TRI<span class="text-blue-600">PLAST</span></h1>
            <div class="space-y-4 text-left mt-8">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase block mb-1">Usu√°rio / M√°quina</label>
                    <select id="login-user" class="w-full p-4 bg-slate-50 border rounded-xl font-bold outline-none focus:border-blue-500">
                        <option value="admin">üë®‚Äçüíª Gest√£o Triplast (Admin)</option>
                        <option value="m1">üè≠ Injetora M1</option>
                        <option value="m2">üè≠ Injetora M2</option>
                        <option value="m3">üè≠ Injetora M3</option>
                        <option value="m4">üè≠ Injetora M4</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase block mb-1">Senha</label>
                    <input type="password" id="login-pass" placeholder="****" class="w-full p-4 bg-slate-50 border rounded-xl font-bold outline-none focus:border-blue-500">
                </div>
                <button onclick="autenticar()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-xl text-lg shadow-lg active:scale-95 transition-all mt-4">ENTRAR</button>
            </div>
        </div>
    </div>

    <div id="app-content" class="hidden">
        <header class="bg-slate-900 text-white px-4 md:px-6 py-4 rounded-b-[32px] shadow-lg mb-6 max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4 border-b border-slate-800">
            <div class="flex items-center gap-4 md:gap-8 w-full md:w-auto justify-between md:justify-start">
                <span class="text-2xl md:text-3xl font-black italic tracking-tighter">TRI<span class="text-blue-500">PLAST</span></span>
                <div class="relative bg-slate-800 border border-slate-700 px-4 py-2 rounded-xl flex items-center gap-3 shadow-inner">
                    <i class="fa-solid fa-clock text-blue-400 text-lg"></i>
                    <div class="flex flex-col text-left">
                        <div id="relogio" class="font-mono text-white font-black text-sm md:text-lg leading-none mb-1">00:00:00</div>
                        <select id="select-turno" onchange="forcarTurno(this.value)" class="bg-transparent text-[10px] font-bold text-slate-400 outline-none cursor-pointer hover:text-white transition-colors uppercase appearance-none min-w-[170px]">
                            <option value="auto" id="opt-auto" class="bg-slate-800 text-slate-200">Buscando Turno...</option>
                            <option value="1" class="bg-slate-800 text-slate-200">For√ßar Turno 1 (05h - 14h)</option>
                            <option value="2" class="bg-slate-800 text-slate-200">For√ßar Turno 2 (14h - 23h)</option>
                            <option value="3" class="bg-slate-800 text-slate-200">For√ßar Turno 3 (23h - 05h)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-end">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 px-5 py-3 rounded-xl flex-1 md:min-w-[260px] shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-blue-500 opacity-10 rounded-full blur-xl -mr-4 -mt-4"></div>
                    <div class="flex justify-between items-center mb-1 relative z-10">
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center"><i class="fa-solid fa-bullseye text-blue-500 mr-2"></i> Meta do M√™s</span>
                        <button onclick="zerarMeta()" class="text-[9px] bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white border border-red-500/20 px-2 py-0.5 rounded transition-colors hidden md:block uppercase font-bold">Zerar</button>
                    </div>
                    <div class="flex justify-between text-sm font-black text-white mb-2 relative z-10 items-end">
                        <span id="horas-mensal-txt" class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300 text-lg leading-none">0,0h</span>
                        <span class="text-slate-400 text-[10px] uppercase">/ 1.628h</span>
                    </div>
                    <div class="w-full bg-slate-950 rounded-full h-2 relative z-10 border border-slate-700 shadow-inner">
                        <div id="barra-mensal" class="bg-gradient-to-r from-blue-600 to-cyan-400 h-full rounded-full transition-all duration-500 shadow-[0_0_8px_rgba(56,189,248,0.5)]" style="width: 0%"></div>
                    </div>
                </div>

                <div class="text-center flex flex-col items-center hidden md:flex">
                    <button id="btn-hora-extra" onclick="toggleHoraExtra()" class="bg-slate-800 text-slate-400 hover:text-white border border-slate-700 px-4 py-3 rounded-xl text-[10px] font-black uppercase transition-all shadow-md whitespace-nowrap flex items-center">
                        <i class="fa-solid fa-bolt mr-2"></i> Extra (Off)
                    </button>
                    <span id="badge-fds" class="hidden mt-1 bg-red-500 text-white text-[9px] font-black px-2 py-0.5 rounded animate-pulse shadow-lg shadow-red-500/50">EMPRESA FECHADA</span>
                </div>
                <button onclick="fazerLogout()" class="bg-red-500/10 border border-red-500/20 text-red-400 hover:bg-red-500 hover:text-white p-3 md:px-5 md:py-3 rounded-xl font-black text-sm uppercase transition-colors" title="Sair da Conta"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <nav id="nav-menus" class="max-w-7xl mx-auto px-4 flex gap-2 md:gap-3 overflow-x-auto mb-6 pb-2" style="-webkit-overflow-scrolling: touch;">
            <button onclick="trocarAba('painel')" id="btn-painel" class="tab-btn active shadow-sm"><i class="fa-solid fa-industry mr-1 md:mr-2"></i> M√ÅQUINAS</button>
            <button onclick="trocarAba('op')" id="btn-op" class="tab-btn shadow-sm"><i class="fa-solid fa-file-signature mr-1 md:mr-2"></i> Gest√£o O.P</button>
            <button onclick="trocarAba('resumo')" id="btn-resumo" class="tab-btn shadow-sm"><i class="fa-solid fa-table-list mr-1 md:mr-2"></i> RESUMO</button>
            <button onclick="trocarAba('historico')" id="btn-historico" class="tab-btn shadow-sm"><i class="fa-solid fa-clock-rotate-left mr-1 md:mr-2"></i> HIST√ìRICO</button>
            <button onclick="trocarAba('graficos')" id="btn-graficos" class="tab-btn shadow-sm"><i class="fa-solid fa-chart-pie mr-1 md:mr-2"></i> TEL√ÉO (Gr√°ficos)</button>
            <button onclick="abrirModalOperadores()" id="btn-operadores" class="tab-btn bg-slate-200 text-slate-700 shadow-sm border-none"><i class="fa-solid fa-users mr-1 md:mr-2"></i> EQUIPE</button>
        </nav>

        <main class="max-w-7xl mx-auto px-2 md:px-4 pb-16">
            
            <div id="aba-painel" class="aba-conteudo aba-ativa">
                <div id="grid-maquinas" class="flex flex-col gap-6 md:gap-8 items-center w-full"></div>
            </div>

            <div id="aba-op" class="aba-conteudo space-y-6">
                <div class="bg-white p-6 md:p-8 rounded-[32px] shadow-xl border border-slate-100">
                    <h2 class="text-xl md:text-2xl font-black mb-6 text-slate-800 flex items-center gap-2 border-b pb-4"><i class="fa-solid fa-calculator text-blue-600"></i> LAN√áAR O.P NA PRODU√á√ÉO</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">M√°quina</label>
                            <select id="f-maq" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold outline-none"></select>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">N¬∫ O.P</label>
                            <input type="text" id="f-op" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold outline-none uppercase">
                        </div>
                        <div class="md:col-span-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Selecionar Produto</label>
                            <select id="f-prod-select" onchange="autoFillCalculadora()" class="w-full p-3 bg-blue-50 border border-blue-200 text-blue-800 rounded-xl font-bold outline-none uppercase"></select>
                        </div>
                    </div>

                    <div class="bg-slate-900 p-4 md:p-6 rounded-[24px] mb-6 shadow-inner text-white">
                        <div class="grid grid-cols-2 md:grid-cols-6 gap-3 md:gap-4 mb-6">
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Ciclo (seg)</label>
                                <input type="number" id="c-ciclo" oninput="calcularTudo()" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">N¬∫ Cavidade</label>
                                <input type="number" id="c-cav" oninput="calcularTudo()" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Peso (g)</label>
                                <input type="number" id="c-peso" step="0.001" oninput="calcularTudo()" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold outline-none">
                            </div>
                            <div class="relative">
                                <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Cor (C√≥d ou Nome)</label>
                                <input type="text" id="c-cor" list="cores-datalist" onchange="verificarCodigoCor(event)" placeholder="Ex: 1206" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold outline-none text-blue-400 uppercase text-xs">
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Pigm (%)</label>
                                <input type="number" id="c-pigm" value="2" step="0.1" oninput="calcularTudo()" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold outline-none text-blue-400">
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label class="text-[10px] font-black text-emerald-400 uppercase mb-1 block">Qts [META]</label>
                                <input type="number" id="c-meta" oninput="calcularTudo()" class="w-full p-3 bg-white text-emerald-700 border-2 border-emerald-500 rounded-xl font-black outline-none shadow-[0_0_10px_rgba(16,185,129,0.2)]">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col justify-center items-center text-center">
                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Qts (KG) Material</span>
                                <span id="res-mat" class="text-base md:text-lg font-black text-blue-400">0.00</span>
                            </div>
                            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col justify-center items-center text-center">
                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Qts Pig (Grama)</span>
                                <span id="res-pig" class="text-base md:text-lg font-black text-pink-400">0g</span>
                            </div>
                            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col justify-center items-center text-center">
                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Peso L√≠q/Bruto</span>
                                <span id="res-total" class="text-base md:text-lg font-black text-white">0.00</span>
                            </div>
                            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col justify-center items-center text-center">
                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Horas Prod</span>
                                <span id="res-tempo" class="text-base md:text-lg font-black text-emerald-400">00:00:00</span>
                            </div>
                            <div class="col-span-2 md:col-span-1 bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col justify-center items-center text-center">
                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Meta/Hora</span>
                                <span id="res-meta-hora" class="text-base md:text-lg font-black text-amber-400">0</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="lancarOP()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-4 md:p-5 rounded-2xl font-black text-lg uppercase shadow-lg transition-all active:scale-95"><i class="fa-solid fa-paper-plane mr-2"></i> Lan√ßar O.P na Fila da M√°quina</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button onclick="abrirModalProdutos()" class="bg-indigo-600 hover:bg-indigo-700 text-white p-6 md:p-8 rounded-[32px] shadow-xl font-black text-xl flex items-center justify-center gap-4 transition-all active:scale-95 border-b-4 border-indigo-800">
                        <i class="fa-solid fa-boxes-stacked text-4xl"></i>
                        <span class="text-left leading-tight uppercase tracking-widest text-sm md:text-lg">Gerenciar Cat√°logo<br>de Produtos</span>
                    </button>
                    <button onclick="abrirModalCores()" class="bg-purple-600 hover:bg-purple-700 text-white p-6 md:p-8 rounded-[32px] shadow-xl font-black text-xl flex items-center justify-center gap-4 transition-all active:scale-95 border-b-4 border-purple-800">
                        <i class="fa-solid fa-palette text-4xl"></i>
                        <span class="text-left leading-tight uppercase tracking-widest text-sm md:text-lg">Gerenciador<br>de Cores</span>
                    </button>
                </div>
            </div>

            <div id="aba-resumo" class="aba-conteudo">
                <div class="bg-white rounded-[32px] shadow-xl border border-slate-100 overflow-hidden">
                    <div class="p-6 bg-slate-50 border-b border-slate-200">
                        <h2 class="text-xl font-black text-slate-800"><i class="fa-solid fa-table-list text-blue-600 mr-2"></i> RESUMO AO VIVO</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-slate-100 text-slate-500 uppercase font-black text-[10px]">
                                <tr>
                                    <th class="p-4">M√°quina</th>
                                    <th class="p-4">O.P Atual</th>
                                    <th class="p-4">Boas</th>
                                    <th class="p-4">Refugo</th>
                                    <th class="p-4">% Perda</th>
                                    <th class="p-4 text-green-600">T. Prod</th>
                                    <th class="p-4 text-orange-500">T. Baixa</th>
                                    <th class="p-4 text-red-600">T. Parado</th>
                                    <th class="p-4 text-slate-400">T. Neutro</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-resumo" class="font-bold text-slate-700 divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="aba-historico" class="aba-conteudo">
                <div class="bg-white rounded-[32px] shadow-xl border border-slate-100 overflow-hidden">
                    <div class="p-4 md:p-6 bg-slate-50 border-b border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
                        <h2 class="text-xl font-black text-slate-800"><i class="fa-solid fa-clock-rotate-left text-blue-600 mr-2"></i> HIST√ìRICO DE PRODU√á√ÉO</h2>
                        <div class="relative w-full md:w-80">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-400"></i>
                            <input type="text" id="busca-historico" onkeyup="filtrarHistorico()" placeholder="Buscar O.P, Produto ou Data..." class="w-full pl-10 p-3 rounded-xl border border-slate-300 font-bold text-sm outline-none focus:border-blue-500 shadow-inner">
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[600px]">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-slate-100 text-slate-500 uppercase font-black text-[10px] sticky top-0 shadow-sm">
                                <tr>
                                    <th class="p-4">Data</th>
                                    <th class="p-4">M√°quina</th>
                                    <th class="p-4">O.P</th>
                                    <th class="p-4">Produto</th>
                                    <th class="p-4">Boas</th>
                                    <th class="p-4">Refugo</th>
                                    <th class="p-4 text-right">A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-historico" class="font-bold text-slate-600 divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="aba-graficos" class="aba-conteudo space-y-6">
                <div class="flex justify-end items-center gap-3">
                    <label class="text-xs font-black text-slate-500 uppercase tracking-widest"><i class="fa-solid fa-calendar-days text-blue-500 mr-1"></i> Data do Relat√≥rio:</label>
                    <input type="date" id="filtro-data-grafico" onchange="iniciarGraficos()" class="bg-white border-2 border-slate-200 p-3 rounded-xl font-bold text-slate-700 outline-none shadow-sm cursor-pointer hover:border-blue-500 transition-colors">
                </div>
                <div class="grid grid-cols-1 gap-8">
                    <div class="bg-white p-4 md:p-8 rounded-[32px] shadow-xl border border-slate-100">
                        <h3 class="font-black text-slate-500 text-sm uppercase mb-4 text-center tracking-widest">Status Geral da F√°brica (Tempo Real)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-200 shadow-inner">
                            <div class="text-center md:border-r border-slate-200 mb-2 md:mb-0">
                                <span class="text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Produ√ß√£o</span>
                                <span id="lbl-chart-prod" class="text-lg md:text-2xl font-black text-green-500 font-mono">00:00:00</span>
                            </div>
                            <div class="text-center md:border-r border-slate-200 mb-2 md:mb-0">
                                <span class="text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Baixa Efi.</span>
                                <span id="lbl-chart-baixa" class="text-lg md:text-2xl font-black text-orange-500 font-mono">00:00:00</span>
                            </div>
                            <div class="text-center md:border-r border-slate-200">
                                <span class="text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Parada</span>
                                <span id="lbl-chart-parado" class="text-lg md:text-2xl font-black text-red-500 font-mono">00:00:00</span>
                            </div>
                            <div class="text-center md:border-r border-slate-200">
                                <span class="text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Neutro</span>
                                <span id="lbl-chart-neutro" class="text-lg md:text-2xl font-black text-slate-500 font-mono">00:00:00</span>
                            </div>
                            <div class="text-center col-span-2 md:col-span-1 border-t md:border-t-0 border-slate-200 pt-2 md:pt-0">
                                <span class="text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">OEE Global</span>
                                <span id="lbl-chart-oee" class="text-lg md:text-2xl font-black text-blue-600 font-mono">0.0%</span>
                            </div>
                        </div>
                        <div class="h-[250px] md:h-[300px] relative"><canvas id="chartStatus"></canvas></div>
                    </div>
                    <div class="bg-white p-4 md:p-8 rounded-[32px] shadow-xl border border-slate-100">
                        <h3 class="font-black text-slate-500 text-sm uppercase mb-4 text-center tracking-widest">Produ√ß√£o Total de Pe√ßas Boas</h3>
                        <div class="h-[250px] md:h-[300px]"><canvas id="chartGeral"></canvas></div>
                    </div>
                    <div class="bg-white p-4 md:p-8 rounded-[32px] shadow-xl border border-slate-100">
                        <h3 class="font-black text-slate-500 text-sm uppercase mb-4 text-center tracking-widest">√çndice de Refugo (%)</h3>
                        <div class="h-[250px] md:h-[300px]"><canvas id="chartRefugo"></canvas></div>
                    </div>
                    <div class="bg-white p-4 md:p-8 rounded-[32px] shadow-xl border border-slate-100">
                        <h3 class="font-black text-blue-500 text-sm uppercase mb-4 text-center tracking-widest"><i class="fa-solid fa-bolt"></i> Horas Extras Cumpridas</h3>
                        <div class="h-[250px] md:h-[300px]"><canvas id="chartHoraExtra"></canvas></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-operadores" class="fixed inset-0 bg-slate-900/80 z-[150] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-6 md:p-8 rounded-[32px] shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl text-slate-800"><i class="fa-solid fa-users text-blue-600 mr-2"></i> Operadores</h3>
                <button onclick="document.getElementById('modal-operadores').style.display='none'" class="text-slate-400 hover:text-red-500 text-3xl font-black">&times;</button>
            </div>
            <div class="flex gap-2 mb-6">
                <input type="text" id="novo-op-nome" class="flex-1 p-3 bg-slate-50 border rounded-xl font-bold outline-none focus:border-blue-500" placeholder="Nome...">
                <button onclick="addOperador()" class="bg-green-600 text-white px-6 rounded-xl font-black text-xl shadow-md hover:bg-green-50 transition-colors">+</button>
            </div>
            <div id="lista-equipe" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
        </div>
    </div>

    <div id="modal-produtos" class="fixed inset-0 bg-slate-900/80 z-[150] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-6 md:p-8 rounded-[32px] shadow-2xl w-full max-w-5xl max-h-[95vh] overflow-y-auto" style="scrollbar-width: thin;">
            <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-100">
                <h3 class="font-black text-2xl text-slate-800"><i class="fa-solid fa-boxes-stacked text-indigo-600 mr-2"></i> Cat√°logo de Produtos</h3>
                <button onclick="fecharModalProdutos()" class="text-slate-400 hover:text-red-500 text-4xl font-black leading-none">&times;</button>
            </div>
            <div class="flex flex-col md:flex-row gap-3 items-end bg-slate-50 p-5 rounded-2xl border border-slate-200 shadow-inner mb-6">
                <div class="flex-1 w-full">
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Nome da Pe√ßa</label>
                    <input type="text" id="novo-produto-nome-modal" class="w-full p-2.5 bg-white border border-slate-300 rounded-xl font-bold outline-none uppercase text-sm">
                </div>
                <div class="w-full md:w-20">
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Ciclo (s)</label>
                    <input type="number" id="novo-produto-ciclo-modal" class="w-full p-2.5 bg-white border border-slate-300 rounded-xl font-bold outline-none text-sm">
                </div>
                <div class="w-full md:w-16">
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Cavs</label>
                    <input type="number" id="novo-produto-cavidades-modal" class="w-full p-2.5 bg-white border border-slate-300 rounded-xl font-bold outline-none text-sm">
                </div>
                <div class="w-full md:w-24">
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Peso (g)</label>
                    <input type="number" step="0.001" id="novo-produto-peso-modal" class="w-full p-2.5 bg-white border border-slate-300 rounded-xl font-bold outline-none text-sm">
                </div>
                <div class="w-full md:w-24">
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Material</label>
                    <input type="text" id="novo-produto-mat-modal" class="w-full p-2.5 bg-white border border-slate-300 rounded-xl font-bold outline-none uppercase text-sm">
                </div>
                <div class="w-full md:w-32 relative">
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Cor</label>
                    <input type="text" id="novo-produto-cor-modal" list="cores-datalist" onchange="verificarCodigoCor(event)" class="w-full p-2.5 bg-white border border-slate-300 rounded-xl font-bold outline-none uppercase text-[10px]">
                </div>
                <div class="w-full md:w-16">
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Pigm%</label>
                    <input type="number" step="0.1" id="novo-produto-pigm-modal" class="w-full p-2.5 bg-white border border-slate-300 rounded-xl font-bold outline-none text-sm">
                </div>
                <button id="btn-salvar-prod" onclick="salvarProduto()" class="w-full md:w-auto bg-indigo-600 text-white px-6 py-3 rounded-xl font-black uppercase hover:bg-indigo-700 shadow-md transition-colors text-xs whitespace-nowrap">Salvar</button>
            </div>
            <div class="relative mb-6">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-400"></i>
                <input type="text" placeholder="Buscar produto..." onkeyup="renderCatalogoModal(this.value)" class="w-full pl-10 p-3 rounded-xl border border-slate-300 font-bold outline-none focus:border-indigo-500 bg-slate-50">
            </div>
            <div id="lista-catalogo-modal" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </div>
    </div>

    <div id="modal-cores" class="fixed inset-0 bg-slate-900/80 z-[150] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-6 md:p-8 rounded-[32px] shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" style="scrollbar-width: thin;">
            <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-100">
                <h3 class="font-black text-2xl text-slate-800"><i class="fa-solid fa-palette text-purple-600 mr-2"></i> Gerenciar Cores</h3>
                <button onclick="fecharModalCores()" class="text-slate-400 hover:text-red-500 text-4xl font-black leading-none">&times;</button>
            </div>
            <div class="flex flex-col md:flex-row gap-3 items-end bg-slate-50 p-5 rounded-2xl border border-slate-200 shadow-inner mb-6">
                <div class="flex-1 w-full">
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">C√≥digo</label>
                    <input type="text" id="nova-cor-cod-modal" class="w-full p-3 bg-white border border-slate-300 rounded-xl font-bold outline-none uppercase text-sm">
                </div>
                <div class="flex-1 w-full">
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Nome da Cor</label>
                    <input type="text" id="nova-cor-nome-modal" class="w-full p-3 bg-white border border-slate-300 rounded-xl font-bold outline-none uppercase text-sm">
                </div>
                <button id="btn-salvar-cor" onclick="salvarCor()" class="w-full md:w-auto bg-purple-600 text-white px-8 py-3.5 rounded-xl font-black uppercase hover:bg-purple-700 shadow-md transition-colors text-xs whitespace-nowrap">Salvar</button>
            </div>
            <div class="relative mb-6">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-400"></i>
                <input type="text" placeholder="Buscar cor..." onkeyup="renderCoresModal(this.value)" class="w-full pl-10 p-3 rounded-xl border border-slate-300 font-bold outline-none focus:border-purple-500 bg-slate-50">
            </div>
            <div id="lista-cores-gerenciador" class="flex flex-wrap gap-2"></div>
        </div>
    </div>

    <datalist id="cores-datalist"></datalist>

    <script>
        // ==========================================
        // FUN√á√ïES GLOBAIS
        // ==========================================
        const fmtTm = s => {
            let tempo = Math.floor(s);
            return `${Math.floor(tempo/3600).toString().padStart(2,'0')}:${Math.floor((tempo%3600)/60).toString().padStart(2,'0')}:${(tempo%60).toString().padStart(2,'0')}`;
        };

        function getCorDestaque(corStr) {
            let str = (corStr || '').toLowerCase();
            if(str.includes('verde')) return { bg: '#22c55e', text: '#ffffff' }; 
            if(str.includes('azul')) return { bg: '#3b82f6', text: '#ffffff' }; 
            if(str.includes('vermelh')) return { bg: '#ef4444', text: '#ffffff' }; 
            if(str.includes('amarel')) return { bg: '#facc15', text: '#000000' }; 
            if(str.includes('pret')) return { bg: '#0f172a', text: '#ffffff' }; 
            if(str.includes('branc')) return { bg: '#ffffff', text: '#000000' }; 
            if(str.includes('laranj')) return { bg: '#f97316', text: '#ffffff' }; 
            if(str.includes('rosa') || str.includes('pink')) return { bg: '#ec4899', text: '#ffffff' }; 
            if(str.includes('rox') || str.includes('violet') || str.includes('lilas') || str.includes('lil√°s')) return { bg: '#a855f7', text: '#ffffff' }; 
            if(str.includes('cinz')) return { bg: '#64748b', text: '#ffffff' }; 
            if(str.includes('marrom') || str.includes('cafe') || str.includes('caf√©')) return { bg: '#78350f', text: '#ffffff' }; 
            if(str.includes('cristal') || str.includes('transparent') || str.includes('natural')) return { bg: '#e2e8f0', text: '#0f172a' }; 
            return { bg: '#f3e8ff', text: '#2e1065' }; 
        }

        // ==========================================
        // CONFIGURA√á√ÉO DO BANCO DE DADOS
        // ==========================================
        const supabaseUrl = 'https://hgqnlqtvjiyuwnwypxxh.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhncW5scXR2aml5dXdud3lweHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjE1MDcsImV4cCI6MjA4NjQzNzUwN30.njSVfWDpIJK49IpRSgyMf6e5MEmJ-AROVT7-nOTZD9Y'; 
        let sb = null;
        try { sb = window.supabase.createClient(supabaseUrl, supabaseKey); } catch(e) {}

        const SENHAS = { admin: '2026', m1: 'm1', m2: 'm2', m3: 'm3', m4: 'm4' };
        let userLogado = ""; let saveTimeout; let filtroGraficoId = 'hoje'; let turnoForcado = null; 
        let sistemaPronto = false; let lastSyncTs = parseInt(localStorage.getItem('triplast_ts')) || 0;
        
        let dadosMensais = { mesAtual: new Date().getMonth(), metaAtualSec: 0, horaExtraSec: 0, plantTempos: { prod: 0, baixa: 0, parado: 0, neutro: 0 } };
        let modoHoraExtra = false;

        let coresGlobais = ["1206-AG | VERDE MA√á√É"]; 
        let produtosGlobais = [{ id: 1, nome: "Pote 1L", ciclo: 15, cav: 4, peso: 45, mat: "PP", cor: "1206-AG | VERDE MA√á√É", pigm: 2 }];
        let operadoresGlobais = ["Jo√£o Silva", "Carlos Souza"];
        let historico = [];
        
        let maquinas = [
            { id: 'm1', nome: 'Injetora M1', status: '04-PRODU√á√ÉO', operador: '', opAtiva: null, fila: [], tempos: { prod: 0, baixa: 0, parado: 0, neutro: 0 }, ultimoMotivoRefugo: "" },
            { id: 'm2', nome: 'Injetora M2', status: '22-SEM PROGRAMA√á√ÉO', operador: '', opAtiva: null, fila: [], tempos: { prod: 0, baixa: 0, parado: 0, neutro: 0 }, ultimoMotivoRefugo: "" },
            { id: 'm3', nome: 'Injetora M3', status: '22-SEM PROGRAMA√á√ÉO', operador: '', opAtiva: null, fila: [], tempos: { prod: 0, baixa: 0, parado: 0, neutro: 0 }, ultimoMotivoRefugo: "" },
            { id: 'm4', nome: 'Injetora M4', status: '22-SEM PROGRAMA√á√ÉO', operador: '', opAtiva: null, fila: [], tempos: { prod: 0, baixa: 0, parado: 0, neutro: 0 }, ultimoMotivoRefugo: "" }
        ];

        const statusMaquinasList = [
            "01-TROCA DE MOLDE", "02-TROCA DE POSTI√áO", "03-MAT√âRIA-PRIMA / AJUSTE", "04-PRODU√á√ÉO", 
            "05-AQUECIMENTO DE M√ÅQUINA", "06-TROCA DE COR", "07-MANUTEN√á√ÉO GELADEIRA", "08-LANCHE", 
            "09-LIMPEZA", "10-PE√áA PRESA NO MOLDE", "11-IN√çCIO DE PROCESSO", "12-FALTA DE ENERGIA EL√âTRICA", 
            "13-MANUTEN√á√ÉO DE MOLDE", "14-MANUTEN√á√ÉO DE M√ÅQUINA", "15-PROBLEMA AR", "16-PROBLEMA C√ÇMARA QUENTE", 
            "17-TROCA DE BICO DE INJE√á√ÉO", "18-OUTROS", "19-EL√âTRICA DE MOLDE", "20-FALTA DE OPERADOR", 
            "21-BAIXA EFICI√äNCIA", "22-SEM PROGRAMA√á√ÉO", "23-EMPRESA FECHADA", "24-PARADA PROGRAMADA", "25-FIM DE SEMANA (PAUSADO)", "26-M√ÅQUINA PAUSADA"
        ];
        const motivosRefugo = ["Falha de inje√ß√£o", "Arranh√£o", "Mancha", "Ponto Preto", "Queima", "Rebarba"];
        let chartStatusInstance = null; let chartGeralInstance = null; let chartRefugoInstance = null; let chartHoraExtraInstance = null;

        // ==========================================
        // AUTOCOMPLETAR CORES
        // ==========================================
        function verificarCodigoCor(e) {
            let val = e.target.value.trim().toUpperCase();
            if(!val) return;
            let found = coresGlobais.find(c => c.split(' | ')[0].trim().toUpperCase() === val || c.toUpperCase() === val);
            if(found) e.target.value = found; 
        }

        function atualizarSelectCores() {
            const options = coresGlobais.map(c => `<option value="${c}">`).join('');
            if(document.getElementById('cores-datalist')) document.getElementById('cores-datalist').innerHTML = options;
        }

        // ==========================================
        // MODAL DE CORES
        // ==========================================
        let editCorIndex = null;
        function abrirModalCores() { document.getElementById('modal-cores').style.display = 'flex'; renderCoresModal(); }
        function fecharModalCores() { 
            document.getElementById('modal-cores').style.display = 'none'; 
            editCorIndex = null; document.getElementById('btn-salvar-cor').innerText = "Salvar";
            document.getElementById('nova-cor-cod-modal').value = ""; document.getElementById('nova-cor-nome-modal').value = "";
        }

        function salvarCor() {
            let cod = document.getElementById('nova-cor-cod-modal').value.trim().toUpperCase();
            let nome = document.getElementById('nova-cor-nome-modal').value.trim().toUpperCase();
            if (cod && nome) {
                let val = cod + ' | ' + nome;
                if (editCorIndex !== null) {
                    let oldVal = coresGlobais[editCorIndex]; coresGlobais[editCorIndex] = val;
                    produtosGlobais.forEach(p => { if(p.cor === oldVal) p.cor = val; });
                    editCorIndex = null; document.getElementById('btn-salvar-cor').innerText = "Salvar";
                } else {
                    if (!coresGlobais.includes(val)) { coresGlobais.push(val); } else { alert("Cor j√° existe!"); return; }
                }
                coresGlobais.sort(); 
                document.getElementById('nova-cor-cod-modal').value = ""; document.getElementById('nova-cor-nome-modal').value = "";
                renderCoresModal(); atualizarSelectCores(); salvarAutomatico();
            } else { alert("Preencha o C√≥digo e o Nome!"); }
        }

        function editarCor(index) {
            let val = coresGlobais[index].split(' | ');
            document.getElementById('nova-cor-cod-modal').value = val[0] || '';
            document.getElementById('nova-cor-nome-modal').value = val[1] || '';
            editCorIndex = index; document.getElementById('btn-salvar-cor').innerText = "Atualizar";
        }

        function removerCor(index) {
            if(confirm(`Deseja apagar a cor ${coresGlobais[index]} do sistema?`)) {
                coresGlobais.splice(index, 1);
                renderCoresModal(); atualizarSelectCores(); salvarAutomatico();
            }
        }

        function renderCoresModal(busca = '') {
            let filtro = busca.toLowerCase();
            let filtradas = coresGlobais.map((c, i) => ({c, i})).filter(item => item.c.toLowerCase().includes(filtro));
            document.getElementById('lista-cores-gerenciador').innerHTML = filtradas.map(item => `
                <div class="bg-purple-50 text-purple-800 border border-purple-200 px-3 py-2 rounded-lg font-bold text-xs uppercase tracking-widest flex items-center shadow-sm mb-2 w-full md:w-[48%] justify-between">
                    <span><i class="fa-solid fa-droplet mr-2 text-purple-400"></i> ${item.c}</span>
                    <div class="flex gap-2 ml-2">
                        <button onclick="editarCor(${item.i})" class="text-amber-500 hover:text-amber-700 bg-white px-2 py-1 rounded shadow-sm border border-amber-200"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="removerCor(${item.i})" class="text-red-500 hover:text-red-700 bg-white px-2 py-1 rounded shadow-sm border border-red-200"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // MODAL DE PRODUTOS
        // ==========================================
        let editProdutoId = null;
        function abrirModalProdutos() { document.getElementById('modal-produtos').style.display = 'flex'; renderCatalogoModal(); }
        function fecharModalProdutos() { document.getElementById('modal-produtos').style.display = 'none'; limparFormProduto(); }
        
        function limparFormProduto() {
            editProdutoId = null; document.getElementById('btn-salvar-prod').innerText = "Salvar";
            document.getElementById('novo-produto-nome-modal').value = ""; document.getElementById('novo-produto-ciclo-modal').value = ""; 
            document.getElementById('novo-produto-cavidades-modal').value = ""; document.getElementById('novo-produto-peso-modal').value = "";
            document.getElementById('novo-produto-mat-modal').value = ""; document.getElementById('novo-produto-cor-modal').value = "";
            document.getElementById('novo-produto-pigm-modal').value = "";
        }

        function salvarProduto() {
            const nome = document.getElementById('novo-produto-nome-modal').value; const ciclo = parseFloat(document.getElementById('novo-produto-ciclo-modal').value); 
            const cav = parseInt(document.getElementById('novo-produto-cavidades-modal').value); const peso = parseFloat(document.getElementById('novo-produto-peso-modal').value);
            const mat = document.getElementById('novo-produto-mat-modal').value || ""; const cor = document.getElementById('novo-produto-cor-modal').value || "";
            const pigm = parseFloat(document.getElementById('novo-produto-pigm-modal').value) || 0;

            if(nome && ciclo && cav && peso) {
                if(editProdutoId !== null) {
                    let p = produtosGlobais.find(x => x.id === editProdutoId);
                    if(p) { p.nome=nome; p.ciclo=ciclo; p.cav=cav; p.peso=peso; p.mat=mat; p.cor=cor; p.pigm=pigm; }
                } else {
                    produtosGlobais.push({ id: Date.now(), nome, ciclo, cav, peso, mat, cor, pigm });
                }
                limparFormProduto(); renderCatalogoModal(); atualizarSelectProdutos(); salvarAutomatico();
            } else { alert("Preencha o Nome, Ciclo, Cavidades e Peso!"); }
        }

        function editarProduto(id) {
            let p = produtosGlobais.find(x => x.id === id);
            if(p) {
                document.getElementById('novo-produto-nome-modal').value = p.nome; document.getElementById('novo-produto-ciclo-modal').value = p.ciclo;
                document.getElementById('novo-produto-cavidades-modal').value = p.cav; document.getElementById('novo-produto-peso-modal').value = p.peso;
                document.getElementById('novo-produto-mat-modal').value = p.mat; document.getElementById('novo-produto-cor-modal').value = p.cor;
                document.getElementById('novo-produto-pigm-modal').value = p.pigm;
                editProdutoId = id; document.getElementById('btn-salvar-prod').innerText = "Atualizar";
            }
        }

        function removerProduto(id) {
            if(confirm("Deseja apagar este produto definitivamente?")) {
                produtosGlobais = produtosGlobais.filter(x => x.id !== id);
                renderCatalogoModal(); atualizarSelectProdutos(); salvarAutomatico();
            }
        }

        function renderCatalogoModal(busca = '') { 
            let filtro = busca.toLowerCase();
            let filtrados = produtosGlobais.filter(p => p.nome.toLowerCase().includes(filtro) || p.mat.toLowerCase().includes(filtro) || (p.cor && p.cor.toLowerCase().includes(filtro)));
            
            document.getElementById('lista-catalogo-modal').innerHTML = filtrados.map(p => `
                <div class="bg-white border border-slate-200 p-4 rounded-xl shadow-sm text-sm font-bold flex flex-col justify-between hover:shadow-md transition-shadow">
                    <div>
                        <span class="text-indigo-700 text-lg break-words">${p.nome}</span> <br>
                        <span class="text-[10px] font-black text-slate-400 tracking-widest mt-1 inline-block">
                            CICLO: ${p.ciclo}s | CAV: ${p.cav} | PESO: ${p.peso}g<br>MAT: ${p.mat || '--'} <br>COR: ${p.cor || '--'} <br>PIGM: ${p.pigm || 0}%
                        </span>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="editarProduto(${p.id})" class="flex-1 bg-amber-50 text-amber-600 hover:bg-amber-500 hover:text-white border border-amber-200 py-2 rounded-lg font-black text-[10px] uppercase transition-colors"><i class="fa-solid fa-pen mr-1"></i> Editar</button>
                        <button onclick="removerProduto(${p.id})" class="flex-1 bg-red-50 text-red-600 hover:bg-red-500 hover:text-white border border-red-200 py-2 rounded-lg font-black text-[10px] uppercase transition-colors"><i class="fa-solid fa-trash mr-1"></i> Apagar</button>
                    </div>
                </div>
            `).join(''); 
        }

        function atualizarSelectProdutos() { document.getElementById('f-prod-select').innerHTML = '<option value="">-- Selecione a Pe√ßa --</option>' + produtosGlobais.map(p => `<option value="${p.id}">${p.nome}</option>`).join(''); }

        // ==========================================
        // CALCULADORA LAN√áAMENTO OP
        // ==========================================
        function autoFillCalculadora() { 
            const prod = produtosGlobais.find(p => p.id == document.getElementById('f-prod-select').value); 
            if(prod) { 
                document.getElementById('c-ciclo').value = prod.ciclo; document.getElementById('c-cav').value = prod.cav; document.getElementById('c-peso').value = prod.peso; 
                if(prod.pigm !== undefined) document.getElementById('c-pigm').value = prod.pigm; 
                if(prod.cor !== undefined) document.getElementById('c-cor').value = prod.cor; 
                calcularTudo(); 
            } 
        }

        function calcularTudo() {
            const ciclo = parseFloat(document.getElementById('c-ciclo').value) || 0; const cav = parseInt(document.getElementById('c-cav').value) || 1; 
            const peso = parseFloat(document.getElementById('c-peso').value) || 0; const pigm = parseFloat(document.getElementById('c-pigm').value) || 0; 
            const meta = parseInt(document.getElementById('c-meta').value) || 0;

            if(meta > 0 && ciclo > 0 && cav > 0) {
                const batidas = Math.ceil(meta / cav); const totalSec = batidas * ciclo; 
                document.getElementById('res-tempo').innerText = fmtTm(totalSec);
                const pzsHora = (3600 / ciclo) * cav; document.getElementById('res-meta-hora').innerText = Math.floor(pzsHora);
                const kgMaterial = (meta * peso) / 1000; const kgPigmento = kgMaterial * (pigm / 100); const kgTotal = kgMaterial + kgPigmento;
                
                document.getElementById('res-mat').innerText = kgMaterial.toFixed(2); 
                document.getElementById('res-pig').innerText = (kgPigmento * 1000).toFixed(0) + 'g';
                document.getElementById('res-total').innerText = kgTotal.toFixed(2);
            } else { 
                document.getElementById('res-tempo').innerText = "00:00:00"; document.getElementById('res-meta-hora').innerText = "0";
                document.getElementById('res-mat').innerText = "0.00"; document.getElementById('res-pig').innerText = "0g"; document.getElementById('res-total').innerText = "0.00"; 
            }
        }

        function lancarOP() {
            const mId = document.getElementById('f-maq').value; const op = document.getElementById('f-op').value; const prodSel = document.getElementById('f-prod-select'); const meta = parseInt(document.getElementById('c-meta').value);
            if(op && prodSel.value && meta) {
                const prodId = prodSel.value; const produtoInfo = produtosGlobais.find(p => p.id == prodId);
                const nomeMat = produtoInfo && produtoInfo.mat ? produtoInfo.mat : '--';
                const corPeca = document.getElementById('c-cor').value || 'Sem Cor';
                const percPigm = document.getElementById('c-pigm').value || 0;

                const kgMat = document.getElementById('res-mat').innerText; const gPig = document.getElementById('res-pig').innerText; const tempoEst = document.getElementById('res-tempo').innerText;
                const matFormatado = `${nomeMat} (${kgMat}kg) | Cor: ${corPeca} | Pigm: ${percPigm}% (${gPig})`;

                maquinas.find(m => m.id === mId).fila.push({ 
                    op, prod: prodSel.options[prodSel.selectedIndex].text, meta, ciclo: document.getElementById('c-ciclo').value, cavs: document.getElementById('c-cav').value, 
                    material: matFormatado, tempoEst: tempoEst
                });
                alert(`O.P ${op} enviada para a fila!`); 
                document.getElementById('f-op').value = ""; document.getElementById('c-meta').value = ""; document.getElementById('f-prod-select').value = "";
                renderPainel(); salvarAutomatico();
            } else { alert("Preencha O.P, selecione a Pe√ßa e a Meta!"); }
        }

        // ==========================================
        // INICIALIZA√á√ÉO
        // ==========================================
        window.onload = async () => {
            if(document.getElementById('filtro-data-grafico')) { document.getElementById('filtro-data-grafico').value = new Date().toISOString().split('T')[0]; }
            await carregarDaNuvem(); if(!sistemaPronto) carregarDadosLocais();
            sistemaPronto = true; 
            atualizarSelectCores(); atualizarSelectProdutos();
            let userSalvo = localStorage.getItem('triplast_session');
            setTimeout(() => {
                document.getElementById('tela-loading').classList.add('opacity-0');
                setTimeout(() => { 
                    document.getElementById('tela-loading').classList.add('hidden');
                    if (userSalvo && SENHAS[userSalvo]) { document.getElementById('login-user').value = userSalvo; document.getElementById('login-pass').value = SENHAS[userSalvo]; autenticar(true); } 
                    else { document.getElementById('tela-login').classList.remove('hidden'); setTimeout(() => document.getElementById('tela-login').classList.remove('opacity-0'), 50); }
                }, 500);
            }, 1000);
        };

        // ==========================================
        // RENDERIZA√á√ÉO DO PAINEL PRINCIPAL
        // ==========================================
        function renderPainel() {
            const grid = document.getElementById('grid-maquinas'); grid.innerHTML = "";
            let maquinasFilter = userLogado === 'admin' ? maquinas : maquinas.filter(m => m.id === userLogado);
            let widthClass = userLogado === 'admin' ? "w-full" : "w-full max-w-5xl mx-auto";

            maquinasFilter.forEach(m => {
                let sClass = "status-parada"; 
                if(m.status === "04-PRODU√á√ÉO") sClass = "status-produzindo"; 
                else if(["21-BAIXA EFICI√äNCIA", "03-MAT√âRIA-PRIMA / AJUSTE"].includes(m.status)) sClass = "status-baixa"; 
                else if(["02-FALTA DE PROGRAMA√á√ÉO", "22-SEM PROGRAMA√á√ÉO", "23-EMPRESA FECHADA", "24-PARADA PROGRAMADA"].includes(m.status)) sClass = "status-sem-prog"; 
                else if(m.status === "25-FIM DE SEMANA (PAUSADO)") sClass = "status-fds"; 

                let opNum = "--", prodNome = "Aguardando O.P", meta = 0, boas = 0, refugo = 0, progresso = 0;
                let cardOp = ``;
                
                if(m.opAtiva) {
                    opNum = m.opAtiva.op; prodNome = m.opAtiva.prod; meta = m.opAtiva.meta; boas = m.opAtiva.boas; refugo = m.opAtiva.refugo;
                    progresso = meta > 0 ? Math.min(((boas / meta) * 100), 100).toFixed(1) : 0;
                    
                    let matPartAtiva = '--', corPartAtiva = '--', pigmPartAtiva = '--';
                    if(m.opAtiva.material && m.opAtiva.material.includes('|')) {
                        let p = m.opAtiva.material.split('|');
                        matPartAtiva = p[0] ? p[0].trim() : '--'; corPartAtiva = p[1] ? p[1].replace(/Cor:/i, '').trim() : '--'; pigmPartAtiva = p[2] ? p[2].replace(/Pigm:/i, '').trim() : '--';
                    } else { matPartAtiva = m.opAtiva.material || '--'; }
                    
                    let estCorAtiva = getCorDestaque(corPartAtiva);
                    
                    cardOp = `
                    <div class="bg-slate-50 p-4 md:p-6 rounded-[24px] border border-slate-200 mt-4 shadow-inner relative">
                        <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 border-b border-slate-200 pb-4 gap-2">
                            <span class="text-xs font-black text-slate-400 uppercase tracking-widest">O.P ATIVA: <span class="text-blue-600 text-2xl ml-2">${opNum}</span></span>
                            <span class="text-xs font-black text-slate-500 uppercase break-words bg-white px-3 py-1.5 rounded-lg border border-slate-200 max-w-full text-right leading-tight">${prodNome}</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                            <div class="flex flex-col bg-blue-50 border border-blue-300 px-3 py-2 rounded-lg text-blue-900">
                                <span class="text-[9px] font-black uppercase tracking-widest opacity-80 mb-0.5"><i class="fa-solid fa-cubes mr-1"></i> Material</span>
                                <span class="text-[13px] font-black break-words leading-tight">${matPartAtiva}</span>
                            </div>
                            <div class="flex flex-col px-3 py-2 rounded-lg border shadow-md" style="background-color: ${estCorAtiva.bg}; color: ${estCorAtiva.text}; border-color: rgba(0,0,0,0.15);">
                                <span class="text-[9px] font-black uppercase tracking-widest opacity-90 mb-0.5"><i class="fa-solid fa-palette mr-1"></i> Cor</span>
                                <span class="text-[13px] font-black break-words leading-tight">${corPartAtiva}</span>
                            </div>
                            <div class="flex flex-col bg-pink-50 border border-pink-300 px-3 py-2 rounded-lg text-pink-900">
                                <span class="text-[9px] font-black uppercase tracking-widest opacity-80 mb-0.5"><i class="fa-solid fa-droplet mr-1"></i> Pigmento</span>
                                <span class="text-[13px] font-black break-words leading-tight">${pigmPartAtiva}</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center bg-slate-800 p-3 rounded-xl text-[10px] md:text-xs font-mono mb-4 text-center border border-slate-700 shadow-inner">
                            <div class="flex-1 border-r border-slate-600">
                                <span class="text-slate-400 block text-[8px] uppercase tracking-widest">Produzindo</span>
                                <span id="t-prod-${m.id}" class="text-green-400 font-black text-sm">${fmtTm(m.tempos.prod)}</span>
                            </div>
                            <div class="flex-1 border-r border-slate-600">
                                <span class="text-slate-400 block text-[8px] uppercase tracking-widest">Baixa Efi.</span>
                                <span id="t-baixa-${m.id}" class="text-orange-400 font-black text-sm">${fmtTm(m.tempos.baixa)}</span>
                            </div>
                            <div class="flex-1 border-r border-slate-600">
                                <span class="text-slate-400 block text-[8px] uppercase tracking-widest">Parada</span>
                                <span id="t-parado-${m.id}" class="text-red-400 font-black text-sm">${fmtTm(m.tempos.parado)}</span>
                            </div>
                            <div class="flex-1">
                                <span class="text-slate-400 block text-[8px] uppercase tracking-widest">Neutro</span>
                                <span id="t-neutro-${m.id}" class="text-slate-300 font-black text-sm">${fmtTm(m.tempos.neutro)}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-3 md:gap-6 mb-5">
                            <div class="info-badge border-blue-100">
                                <span class="text-blue-400 text-[10px] md:text-xs font-black uppercase mb-2 tracking-widest">META</span>
                                <span class="text-blue-600 text-2xl md:text-4xl font-black leading-none">${meta}</span>
                            </div>
                            <div class="info-badge bg-green-50 border-green-200">
                                <span class="text-green-500 text-[10px] md:text-xs font-black uppercase mb-2 tracking-widest">BOAS</span>
                                <span class="text-green-600 text-2xl md:text-4xl font-black leading-none">${boas}</span>
                            </div>
                            <div class="info-badge bg-red-50 border-red-200">
                                <span class="text-red-400 text-[10px] md:text-xs font-black uppercase mb-2 tracking-widest">REFUGO</span>
                                <span class="text-red-600 text-2xl md:text-4xl font-black leading-none">${refugo}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-4 gap-2 mb-5 bg-slate-900 rounded-xl p-3 text-center shadow-inner">
                            <div><p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Disp</p><p id="oee-disp-${m.id}" class="text-sm md:text-base font-black text-blue-400 mt-0.5">0.0%</p></div>
                            <div><p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Perf</p><p id="oee-perf-${m.id}" class="text-sm md:text-base font-black text-amber-400 mt-0.5">0.0%</p></div>
                            <div><p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Qual</p><p id="oee-qual-${m.id}" class="text-sm md:text-base font-black text-emerald-400 mt-0.5">0.0%</p></div>
                            <div class="border-l border-slate-600 pl-2"><p class="text-[9px] text-slate-300 font-black uppercase tracking-widest">OEE (M√°q)</p><p id="oee-total-${m.id}" class="text-sm md:text-base font-black text-white mt-0.5 animate-pulse">0.0%</p></div>
                        </div>

                        <div class="w-full bg-slate-200 rounded-full h-4 mb-5 shadow-inner overflow-hidden border border-slate-300">
                            <div class="bg-gradient-to-r from-blue-500 to-cyan-400 h-full transition-all duration-500" style="width: ${progresso}%"></div>
                        </div>
                        
                        <div class="flex flex-col md:flex-row gap-3">
                            <button onclick="concluirOP('${m.id}')" class="flex-1 bg-emerald-100 text-emerald-700 font-black rounded-xl text-xs md:text-sm uppercase py-4 border border-emerald-300 hover:bg-emerald-500 hover:text-white transition-all tracking-widest shadow-sm"><i class="fa-solid fa-flag-checkered mr-2"></i> Finalizar O.P</button>
                            <button onclick="pausarOP('${m.id}')" class="flex-1 bg-amber-100 text-amber-700 font-black rounded-xl text-xs md:text-sm uppercase py-4 border border-amber-300 hover:bg-amber-500 hover:text-white transition-all tracking-widest shadow-sm"><i class="fa-solid fa-pause mr-2"></i> Pausar p/ Fila</button>
                        </div>
                    </div>`;
                }

                let filaHTML = `<div class="text-center text-xs font-bold text-slate-400 p-6 border-2 border-dashed border-slate-300 rounded-2xl mt-2 bg-slate-50">Nenhuma O.P na Fila</div>`;
                if(m.fila.length > 0) {
                    filaHTML = m.fila.map((f, index) => {
                        let matPart = '--', corPart = '--', pigmPart = '--';
                        if(f.material && f.material.includes('|')) {
                            let p = f.material.split('|');
                            matPart = p[0] ? p[0].trim() : '--'; corPart = p[1] ? p[1].replace(/Cor:/i, '').trim() : '--'; pigmPart = p[2] ? p[2].replace(/Pigm:/i, '').trim() : '--';
                        } else { matPart = f.material || '--'; }
                        
                        let estCorFila = getCorDestaque(corPart);

                        return `
                        <div class="bg-white border border-slate-200 border-l-4 border-l-blue-500 rounded-xl p-4 shadow-sm relative mb-3">
                            <div class="flex justify-between items-start mb-3 border-b border-slate-100 pb-3">
                                <div class="max-w-[80%]">
                                    <span class="font-black text-blue-700 text-base uppercase">O.P #${f.op}</span>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase mt-1 break-words leading-tight"><i class="fa-solid fa-box-open mr-1"></i>${f.prod}</p>
                                </div>
                                <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded font-black uppercase tracking-widest border border-slate-200">${index + 1}¬∫</span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <div class="bg-slate-50 p-2 rounded text-center border border-slate-100">
                                    <p class="text-[8px] text-slate-400 uppercase font-bold tracking-widest">Ciclo/Cav</p>
                                    <p class="text-[11px] font-black text-slate-700 mt-0.5">${f.ciclo || '--'}s / ${f.cavs || '--'}</p>
                                </div>
                                <div class="bg-slate-50 p-2 rounded text-center border border-slate-100">
                                    <p class="text-[8px] text-slate-400 uppercase font-bold tracking-widest">Tempo Est.</p>
                                    <p class="text-[11px] font-black text-emerald-600 mt-0.5">${f.tempoEst || '--'}</p>
                                </div>
                            </div>

                            <div class="flex flex-col gap-1.5 mb-3 bg-slate-50 p-2 rounded-lg border border-slate-100">
                                <div class="flex flex-col bg-blue-50 border border-blue-200 px-3 py-1.5 rounded text-blue-900">
                                    <span class="text-[9px] font-black uppercase tracking-widest opacity-80"><i class="fa-solid fa-cubes mr-1"></i> Material</span>
                                    <span class="text-[11px] md:text-[12px] font-black break-words leading-tight mt-0.5">${matPart}</span>
                                </div>
                                
                                <div class="flex flex-col px-3 py-1.5 rounded border shadow-sm" style="background-color: ${estCorFila.bg}; color: ${estCorFila.text}; border-color: rgba(0,0,0,0.15);">
                                    <span class="text-[9px] font-black uppercase tracking-widest opacity-90"><i class="fa-solid fa-palette mr-1"></i> Cor</span>
                                    <span class="text-[11px] md:text-[12px] font-black break-words leading-tight mt-0.5">${corPart}</span>
                                </div>
                                
                                <div class="flex flex-col bg-pink-50 border border-pink-200 px-3 py-1.5 rounded text-pink-900">
                                    <span class="text-[9px] font-black uppercase tracking-widest opacity-80"><i class="fa-solid fa-droplet mr-1"></i> Pigmento</span>
                                    <span class="text-[11px] md:text-[12px] font-black break-words leading-tight mt-0.5">${pigmPart}</span>
                                </div>
                            </div>

                            <div class="flex justify-between items-center mt-2 pt-3 border-t border-slate-200 border-dashed">
                                <div class="flex flex-col">
                                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Meta de Pe√ßas</span>
                                    <span class="text-sm font-black text-slate-800">${f.meta}</span>
                                </div>
                                <button onclick="puxarOPFila('${m.id}', ${index})" class="bg-blue-50 border border-blue-200 hover:bg-blue-600 hover:text-white text-blue-600 text-[10px] font-black px-4 py-2 rounded-lg transition-colors uppercase shadow-sm flex items-center"><i class="fa-solid fa-play mr-2"></i> Iniciar</button>
                            </div>
                        </div>`;
                    }).join('');
                }

                grid.innerHTML += `
                <div class="${widthClass} card-producao ${sClass}">
                    <div class="card-esq">
                        <div class="flex flex-col md:flex-row justify-between items-start gap-3">
                            <div class="w-full md:w-auto">
                                <h3 class="text-3xl md:text-4xl font-black text-slate-800 uppercase italic leading-none mb-3 tracking-tighter">${m.nome}</h3>
                                <select onchange="alterarOperador('${m.id}', this.value)" class="bg-white border-2 border-slate-200 p-2.5 rounded-xl font-black text-xs uppercase text-slate-600 outline-none cursor-pointer w-full md:w-auto shadow-sm focus:border-blue-400 transition-colors">
                                    <option value="">-- SELECIONE O OPERADOR --</option>
                                    ${operadoresGlobais.map(op => `<option value="${op}" ${m.operador === op ? 'selected' : ''}>üë∑ ${op}</option>`).join('')}
                                </select>
                            </div>
                            <select onchange="alterarStatus('${m.id}', this.value)" class="bg-white border-2 border-slate-200 p-3.5 rounded-xl font-black text-[10px] md:text-xs uppercase outline-none focus:border-blue-500 text-slate-700 w-full md:w-56 cursor-pointer shadow-sm transition-colors">
                                ${statusMaquinasList.map(st => `<option value="${st}" ${m.status === st ? 'selected' : ''}>${st}</option>`).join('')}
                            </select>
                        </div>
                        ${cardOp}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div class="bg-green-50/50 p-5 md:p-6 rounded-[24px] border border-green-200 text-center flex flex-col justify-between shadow-inner relative">
                                <div class="flex justify-between items-center mb-3">
                                    <label class="text-xs md:text-sm font-black text-green-600 uppercase tracking-widest"><i class="fa-solid fa-plus-circle mr-1"></i> Pe√ßas Boas</label>
                                    <button onclick="zerarBoas('${m.id}')" class="text-[9px] md:text-[10px] bg-green-100 border border-green-300 text-green-700 hover:bg-green-600 hover:text-white px-2 py-1 rounded-lg font-black uppercase transition-colors shadow-sm">Zerar</button>
                                </div>
                                <input type="number" id="boas-${m.id}" placeholder="0" class="input-industrial border-green-300 text-green-800 mb-4 !p-4 md:!p-5 bg-white shadow-sm">
                                <button onclick="lancarPecas('${m.id}')" class="bg-green-500 text-white w-full py-4 md:py-5 rounded-xl font-black shadow-lg hover:bg-green-600 active:scale-95 text-base md:text-lg uppercase tracking-widest">LAN√áAR BOAS</button>
                            </div>
                            <div class="bg-red-50/50 p-5 md:p-6 rounded-[24px] border border-red-200 text-center flex flex-col justify-between shadow-inner relative">
                                <div class="flex justify-between items-center mb-3">
                                    <label class="text-xs md:text-sm font-black text-red-500 uppercase tracking-widest"><i class="fa-solid fa-recycle mr-1"></i> Refugo (Qtd)</label>
                                    <button onclick="zerarRefugo('${m.id}')" class="text-[9px] md:text-[10px] bg-red-100 border border-red-300 text-red-600 hover:bg-red-500 hover:text-white px-2 py-1 rounded-lg font-black uppercase transition-colors shadow-sm">Zerar</button>
                                </div>
                                <input type="number" id="refugo-qtd-${m.id}" placeholder="Ex: 2" class="input-industrial border-red-300 text-red-800 mb-2 !p-3 md:!p-4 bg-white shadow-sm text-lg">
                                <select id="motivo-${m.id}" class="w-full text-xs font-bold p-3 md:p-4 rounded-xl border border-red-300 outline-none text-red-700 bg-white mb-4 shadow-sm">
                                    <option value="">Motivo da perda...</option>
                                    ${motivosRefugo.map(mot => `<option value="${mot}" ${m.ultimoMotivoRefugo === mot ? 'selected' : ''}>${mot}</option>`).join('')}
                                </select>
                                <button onclick="lancarRefugoManual('${m.id}')" class="w-full bg-red-100 border-2 border-red-400 text-red-600 py-3 md:py-4 rounded-xl font-black uppercase shadow-sm hover:bg-red-500 hover:text-white transition-all text-sm tracking-widest">LAN√áAR REFUGO</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-dir">
                        <p class="text-xs font-black text-slate-500 uppercase mb-4 tracking-widest border-b border-slate-200 pb-2"><i class="fa-solid fa-layer-group text-blue-400 mr-2"></i> Fila da M√°quina</p>
                        <div class="fila-scroll-vertical pr-2">${filaHTML}</div>
                    </div>
                </div>`;
            });
        }

        // ==========================================
        // DEMAIS FUN√á√ïES DE PAINEL E MOTOR
        // ==========================================
        function alterarStatus(id, st) { maquinas.find(m => m.id === id).status = st; renderPainel(); salvarAutomatico(); }
        function lancarPecas(id) { 
            const val = parseInt(document.getElementById(`boas-${id}`).value); const maq = maquinas.find(m => m.id === id); 
            if(val > 0 && maq.opAtiva) { maq.opAtiva.boas += val; document.getElementById(`boas-${id}`).value = ""; renderPainel(); renderResumo(); salvarAutomatico(); } 
        }
        function lancarRefugoManual(id) {
            const maq = maquinas.find(m => m.id === id); const qtd = parseInt(document.getElementById(`refugo-qtd-${id}`).value); const motivo = document.getElementById(`motivo-${id}`).value;
            if(!maq.opAtiva) { alert("Nenhuma O.P ativa."); return; } if(isNaN(qtd) || qtd <= 0) { alert("Quantidade inv√°lida."); return; } if(!motivo) { alert("Selecione um motivo."); return; }
            if(confirm(`Confirma lan√ßamento de ${qtd} pe√ßas por "${motivo}"?`)) {
                maq.opAtiva.refugo += qtd; maq.ultimoMotivoRefugo = motivo; 
                if(!maq.opAtiva.motivosRefugo) maq.opAtiva.motivosRefugo = {};
                maq.opAtiva.motivosRefugo[motivo] = (maq.opAtiva.motivosRefugo[motivo] || 0) + qtd;
                document.getElementById(`refugo-qtd-${id}`).value = ""; renderPainel(); renderResumo(); salvarAutomatico();
            }
        }
        function zerarRefugo(id) { const maq = maquinas.find(m => m.id === id); if(!maq.opAtiva) return; if(confirm("Deseja ZERAR O REFUGO?")) { maq.opAtiva.refugo = 0; maq.opAtiva.motivosRefugo = {}; renderPainel(); renderResumo(); salvarAutomatico(); } }
        function zerarBoas(id) { const maq = maquinas.find(m => m.id === id); if(!maq.opAtiva) return; if(confirm("Deseja ZERAR AS PE√áAS BOAS?")) { maq.opAtiva.boas = 0; renderPainel(); renderResumo(); salvarAutomatico(); } }
        
        function concluirOP(id) {
            const maq = maquinas.find(m => m.id === id);
            if(confirm("Finalizar O.P?")) {
                let motivosStr = "Nenhum refugo";
                if (maq.opAtiva.motivosRefugo && Object.keys(maq.opAtiva.motivosRefugo).length > 0) {
                    motivosStr = Object.entries(maq.opAtiva.motivosRefugo).map(([m, q]) => `${m} x${q}`).join(', ');
                }
                historico.unshift({ data: new Date().toLocaleString('pt-BR'), maq: maq.nome, op: maq.opAtiva.op, prod: maq.opAtiva.prod, meta: maq.opAtiva.meta, boas: maq.opAtiva.boas, refugo: maq.opAtiva.refugo, motivosStr: motivosStr });
                if(maq.fila.length > 0) { 
                    const p = maq.fila.shift(); 
                    maq.opAtiva = { op: p.op, prod: p.prod, meta: p.meta, boas: p.boas || 0, refugo: p.refugo || 0, ciclo: p.ciclo || 1, cavs: p.cavs || 1, motivosRefugo: {}, material: p.material }; 
                    maq.status = "04-PRODU√á√ÉO"; 
                } else { maq.opAtiva = null; maq.status = "22-SEM PROGRAMA√á√ÉO"; }
                renderPainel(); renderResumo(); renderHistorico(); salvarAutomatico();
            }
        }

        function pausarOP(id) {
            const maq = maquinas.find(m => m.id === id);
            if(confirm("Pausar a O.P atual e voltar para Fila?")) {
                maq.fila.push(maq.opAtiva); maq.opAtiva = null; maq.status = "26-M√ÅQUINA PAUSADA"; renderPainel(); renderResumo(); salvarAutomatico();
            }
        }
        
        function puxarOPFila(maqId, index) {
            const maq = maquinas.find(m => m.id === maqId); const opEscolhida = maq.fila[index];
            if(confirm(`Iniciar O.P ${opEscolhida.op}?`)) {
                if(maq.opAtiva) maq.fila.push(maq.opAtiva); 
                maq.fila.splice(index, 1); 
                if(opEscolhida.boas === undefined) opEscolhida.boas = 0; if(opEscolhida.refugo === undefined) opEscolhida.refugo = 0;
                if(opEscolhida.motivosRefugo === undefined) opEscolhida.motivosRefugo = {};
                maq.opAtiva = opEscolhida; maq.status = "04-PRODU√á√ÉO";
                renderPainel(); renderResumo(); salvarAutomatico();
            }
        }

        function renderResumo() { 
            document.getElementById('tbody-resumo').innerHTML = maquinas.map(m => {
                let boas = m.opAtiva ? m.opAtiva.boas : 0; let refugo = m.opAtiva ? m.opAtiva.refugo : 0; let perda = (boas+refugo) > 0 ? ((refugo/(boas+refugo))*100).toFixed(1) : 0;
                let perdaHtml = perda > 2.0 ? `<span class="bg-red-100 text-red-600 px-2 py-1 rounded font-black border border-red-300 animate-pulse"><i class="fa-solid fa-triangle-exclamation mr-1"></i>${perda}%</span>` : `<span class="text-slate-500">${perda}%</span>`;
                return `<tr><td class="p-4 font-black text-blue-600">${m.nome}</td><td class="p-4 font-bold text-slate-800">${m.opAtiva ? m.opAtiva.op : '--'}</td><td class="p-4 text-green-600">${boas}</td><td class="p-4 text-red-500">${refugo}</td><td class="p-4">${perdaHtml}</td><td class="p-4 text-green-600 font-mono">${fmtTm(m.tempos.prod)}</td><td class="p-4 text-orange-500 font-mono">${fmtTm(m.tempos.baixa)}</td><td class="p-4 text-red-600 font-mono">${fmtTm(m.tempos.parado)}</td><td class="p-4 text-slate-400 font-mono">${fmtTm(m.tempos.neutro)}</td></tr>`; 
            }).join(''); 
        }

        function renderHistorico() { 
            document.getElementById('tbody-historico').innerHTML = historico.map((h,i) => `
                <tr><td class="p-4 text-xs text-slate-400">${h.data}</td><td class="p-4 text-blue-600 font-black">${h.maq}</td><td class="p-4 font-black">${h.op}</td><td class="p-4 text-xs truncate max-w-[200px]">${h.prod}</td><td class="p-4 text-green-600 font-black">${h.boas}</td><td class="p-4 text-red-500 font-black leading-tight">${h.refugo || 0}${h.refugo > 0 && h.motivosStr ? `<br><span class="text-[9px] font-bold text-slate-400 mt-1 block">${h.motivosStr}</span>` : ''}</td><td class="p-4 text-right"><button onclick="historico.splice(${i},1); renderHistorico(); salvarAutomatico();" class="text-red-400 hover:text-red-600 bg-red-50 px-3 py-1.5 rounded-lg transition-colors"><i class="fa-solid fa-trash"></i></button></td></tr>
            `).join(''); 
        }
        function filtrarHistorico() { const termo = document.getElementById('busca-historico').value.toLowerCase(); document.querySelectorAll('#tbody-historico tr').forEach(linha => { linha.style.display = linha.innerText.toLowerCase().includes(termo) ? '' : 'none'; }); }

        function zerarMeta() { 
            let mudou = false;
            if(confirm("Deseja ZERAR a Meta Global de Produ√ß√£o do M√™s (1.628h)?")) { dadosMensais.metaAtualSec = 0; mudou = true; }
            if(confirm("Deseja ZERAR o Banco Global de HORAS EXTRAS?")) { dadosMensais.horaExtraSec = 0; mudou = true; }
            if(mudou) { salvarAutomatico(); iniciarGraficos(); }
        }

        function toggleHoraExtra() { modoHoraExtra = !modoHoraExtra; toggleHoraExtraVis(); salvarAutomatico(); }
        function toggleHoraExtraVis() {
            const btn = document.getElementById('btn-hora-extra');
            if(modoHoraExtra) { btn.className = "bg-blue-600 text-white border border-blue-500 px-4 py-3 rounded-xl text-[10px] font-black uppercase shadow-lg shadow-blue-500/50 whitespace-nowrap flex items-center"; btn.innerHTML = "<i class='fa-solid fa-bolt mr-2'></i> Extra (ON)"; } 
            else { btn.className = "bg-slate-800 text-slate-400 border border-slate-700 px-4 py-3 rounded-xl text-[10px] font-black uppercase whitespace-nowrap flex items-center"; btn.innerHTML = "<i class='fa-solid fa-bolt mr-2'></i> Extra (Off)"; }
        }
        function forcarTurno(val) { turnoForcado = val; salvarAutomatico(); }

        let ultimoTick = Math.floor(Date.now() / 1000);

        setInterval(() => {
            const relogioHtml = document.getElementById('relogio');
            if(relogioHtml) relogioHtml.innerText = new Date().toLocaleTimeString('pt-BR', { timeZone: 'America/Sao_Paulo', hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const agoraSegundoAtual = Math.floor(Date.now() / 1000); const passados = agoraSegundoAtual - ultimoTick;
            if (passados >= 1) {
                ultimoTick = agoraSegundoAtual; const agoraCompleto = new Date();
                if (agoraCompleto.getMonth() !== dadosMensais.mesAtual) {
                    dadosMensais.mesAtual = agoraCompleto.getMonth(); dadosMensais.metaAtualSec = 0; dadosMensais.horaExtraSec = 0; dadosMensais.plantTempos = { prod: 0, baixa: 0, parado: 0, neutro: 0 };
                    maquinas.forEach(m => { m.tempos = { prod: 0, baixa: 0, parado: 0, neutro: 0 }; if(m.opAtiva) { m.opAtiva.boas = 0; m.opAtiva.refugo = 0; } });
                    salvarAutomatico(); renderPainel(); 
                }

                const mTotal = agoraCompleto.getHours() * 60 + agoraCompleto.getMinutes();
                let textAuto = "Turno 3 (23h-05h)"; if (mTotal >= 300 && mTotal < 858) textAuto = "Turno 1 (05h-14h)"; else if (mTotal >= 858 && mTotal < 1416) textAuto = "Turno 2 (14h-23h)";
                if(document.getElementById('opt-auto')) document.getElementById('opt-auto').innerText = "Atual: " + textAuto; 
                if(turnoForcado && turnoForcado !== "auto") document.getElementById('select-turno').value = turnoForcado;

                const isWeekend = (agoraCompleto.getDay() === 0 || agoraCompleto.getDay() === 6);
                let contarTempo = true; let maqTrabalhando = false;
                if (isWeekend && !modoHoraExtra) {
                    contarTempo = false; document.getElementById('badge-fds').classList.remove('hidden'); let statusMudou = false;
                    maquinas.forEach(m => { if(m.status !== "25-FIM DE SEMANA (PAUSADO)") { m.status = "25-FIM DE SEMANA (PAUSADO)"; statusMudou = true; } });
                    if(statusMudou && document.getElementById('aba-painel').classList.contains('aba-ativa')) renderPainel();
                } else { document.getElementById('badge-fds').classList.add('hidden'); }

                if(contarTempo) {
                    let temProd = false, temBaixa = false, temParada = false, temNeutro = false; let oeeTotalGlob = 0; let oeeQtdGlob = 0; let somaTotalProducaoTodasMaquinas = 0;

                    maquinas.forEach(m => {
                        if(m.status === "04-PRODU√á√ÉO") { m.tempos.prod += passados; temProd = true; maqTrabalhando = true; }
                        else if(["21-BAIXA EFICI√äNCIA", "03-MAT√âRIA-PRIMA / AJUSTE"].includes(m.status)) { m.tempos.baixa += passados; temBaixa = true; maqTrabalhando = true; }
                        else if(["02-FALTA DE PROGRAMA√á√ÉO", "22-SEM PROGRAMA√á√ÉO", "23-EMPRESA FECHADA", "24-PARADA PROGRAMADA", "25-FIM DE SEMANA (PAUSADO)", "08-LANCHE", "09-LIMPEZA"].includes(m.status)) { m.tempos.neutro += passados; temNeutro = true; }
                        else { m.tempos.parado += passados; temParada = true; } 
                        
                        somaTotalProducaoTodasMaquinas += (m.tempos.prod || 0);
                        
                        if(m.opAtiva && document.getElementById(`oee-disp-${m.id}`)) {
                            let tProg = m.tempos.prod + m.tempos.baixa + m.tempos.parado; let disp = tProg > 0 ? (m.tempos.prod / tProg) : 0;
                            let teorica = (m.tempos.prod / (parseFloat(m.opAtiva.ciclo) || 1)) * (parseInt(m.opAtiva.cavs) || 1); 
                            let real = m.opAtiva.boas + m.opAtiva.refugo; let perf = teorica > 0 ? (real / teorica) : 0; if(perf > 1) perf = 1; 
                            let qual = real > 0 ? (m.opAtiva.boas / real) : 0; let oee = disp * perf * qual;
                            oeeTotalGlob += oee; oeeQtdGlob++;
                            document.getElementById(`oee-disp-${m.id}`).innerText = (disp * 100).toFixed(1) + '%'; document.getElementById(`oee-perf-${m.id}`).innerText = (perf * 100).toFixed(1) + '%';
                            document.getElementById(`oee-qual-${m.id}`).innerText = (qual * 100).toFixed(1) + '%'; document.getElementById(`oee-total-${m.id}`).innerText = (oee * 100).toFixed(1) + '%';
                        }
                    });
                    
                    if (temProd) dadosMensais.plantTempos.prod += passados; if (temBaixa) dadosMensais.plantTempos.baixa += passados;
                    if (temParada) dadosMensais.plantTempos.parado += passados; if (temNeutro) dadosMensais.plantTempos.neutro += passados;
                    if (maqTrabalhando && modoHoraExtra) dadosMensais.horaExtraSec += passados;

                    dadosMensais.metaAtualSec = somaTotalProducaoTodasMaquinas;
                    let globalOeeVal = oeeQtdGlob > 0 ? (oeeTotalGlob / oeeQtdGlob) * 100 : 0;
                    if(document.getElementById('lbl-chart-oee')) document.getElementById('lbl-chart-oee').innerText = globalOeeVal.toFixed(1) + '%';
                }

                if(document.getElementById('aba-painel').classList.contains('aba-ativa')) {
                    maquinas.forEach(m => {
                        if(document.getElementById(`t-prod-${m.id}`)) {
                            document.getElementById(`t-prod-${m.id}`).innerText = fmtTm(m.tempos.prod); document.getElementById(`t-baixa-${m.id}`).innerText = fmtTm(m.tempos.baixa);
                            document.getElementById(`t-parado-${m.id}`).innerText = fmtTm(m.tempos.parado); document.getElementById(`t-neutro-${m.id}`).innerText = fmtTm(m.tempos.neutro);
                        }
                    });
                }

                let horasDecimais = (dadosMensais.metaAtualSec / 3600).toFixed(1).replace('.', ',');
                if(document.getElementById('horas-mensal-txt')) document.getElementById('horas-mensal-txt').innerText = `${horasDecimais}h`; 
                if(document.getElementById('barra-mensal')) document.getElementById('barra-mensal').style.width = `${Math.min((dadosMensais.metaAtualSec / (1628 * 3600)) * 100, 100)}%`;
                if(document.getElementById('aba-resumo').classList.contains('aba-ativa')) renderResumo();

                if (chartStatusInstance) {
                    document.getElementById('lbl-chart-prod').innerText = fmtTm(dadosMensais.plantTempos.prod); document.getElementById('lbl-chart-baixa').innerText = fmtTm(dadosMensais.plantTempos.baixa);
                    document.getElementById('lbl-chart-parado').innerText = fmtTm(dadosMensais.plantTempos.parado); document.getElementById('lbl-chart-neutro').innerText = fmtTm(dadosMensais.plantTempos.neutro);
                    chartStatusInstance.data.datasets[0].data = [dadosMensais.plantTempos.prod, dadosMensais.plantTempos.baixa, dadosMensais.plantTempos.parado, dadosMensais.plantTempos.neutro];
                    chartStatusInstance.update('none'); 
                }
            }
        }, 200);

        function iniciarGraficos() {
            let dataFiltro = document.getElementById('filtro-data-grafico') ? document.getElementById('filtro-data-grafico').value : '';
            let maqBoas = maquinas.map(m=>0); let maqRefugo = maquinas.map(m=>0);

            if (!dataFiltro || dataFiltro === new Date().toISOString().split('T')[0]) {
                let hojeStr = new Date().toLocaleDateString('pt-BR'); 
                maquinas.forEach((m, i) => { if (m.opAtiva) { maqBoas[i] += m.opAtiva.boas || 0; maqRefugo[i] += m.opAtiva.refugo || 0; } });
                historico.forEach(h => { if (h.data.startsWith(hojeStr)) { let mIdx = maquinas.findIndex(m => m.nome === h.maq); if (mIdx !== -1) { maqBoas[mIdx] += parseInt(h.boas) || 0; maqRefugo[mIdx] += parseInt(h.refugo) || 0; } } });
            } else {
                let [y, m, d] = dataFiltro.split('-'); let dataStr = `${d}/${m}/${y}`; 
                historico.forEach(h => { if (h.data.startsWith(dataStr)) { let mIdx = maquinas.findIndex(maq => maq.nome === h.maq); if (mIdx !== -1) { maqBoas[mIdx] += parseInt(h.boas) || 0; maqRefugo[mIdx] += parseInt(h.refugo) || 0; } } });
            }

            if(chartStatusInstance) chartStatusInstance.destroy();
            chartStatusInstance = new Chart(document.getElementById('chartStatus').getContext('2d'), { 
                type: 'pie', data: { labels: ['Produzindo', 'Baixa Efici√™ncia', 'M√°quinas Paradas', 'Tempo Neutro'], datasets: [{ data: [dadosMensais.plantTempos.prod, dadosMensais.plantTempos.baixa, dadosMensais.plantTempos.parado, dadosMensais.plantTempos.neutro], backgroundColor: ['#22c55e', '#f97316', '#ef4444', '#94a3b8'], borderWidth: 2, hoverOffset: 10}] }, 
                options: { maintainAspectRatio: false, plugins: { tooltip: { bodyFont: { size: 16, weight: 'bold' }, padding: 12, callbacks: { label: function(context) { return ' ' + context.label + ': ' + fmtTm(context.raw); } } } } } 
            });
            if(chartGeralInstance) chartGeralInstance.destroy();
            chartGeralInstance = new Chart(document.getElementById('chartGeral'), { type: 'bar', data: { labels: maquinas.map(m=>m.nome), datasets: [{ label: 'Boas', data: maqBoas, backgroundColor: '#3b82f6', borderRadius: 6 }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
            if(chartRefugoInstance) chartRefugoInstance.destroy();
            chartRefugoInstance = new Chart(document.getElementById('chartRefugo'), { type: 'bar', data: { labels: maquinas.map(m=>m.nome), datasets: [{ label: '% Refugo', data: maqBoas.map((boas, i) => { let total = boas + maqRefugo[i]; return total > 0 ? ((maqRefugo[i] / total) * 100).toFixed(1) : 0; }), backgroundColor: '#ef4444', borderRadius: 6 }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
            if(chartHoraExtraInstance) chartHoraExtraInstance.destroy();
            chartHoraExtraInstance = new Chart(document.getElementById('chartHoraExtra'), { type: 'bar', data: { labels: ['Extra Geral'], datasets: [{ label: 'Segundos Extra', data: [dadosMensais.horaExtraSec], backgroundColor: '#eab308' }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
        }
    </script>
</body>
</html>

