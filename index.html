<!DOCTYPE html>
<html lang="pt-br" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Triplast Manager | v3.0 Enterprise</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto+Mono:wght@400;500;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        tech: ['Rajdhani', 'sans-serif'],
                        mono: ['"Roboto Mono"', 'monospace'],
                    },
                    colors: {
                        // Paleta Industrial Dark
                        dark: { 
                            950: '#020617', 900: '#0f172a', 800: '#1e293b', 
                            700: '#334155', 600: '#475569', surface: '#111827'
                        },
                        brand: { 
                            DEFAULT: '#3b82f6', glow: '#60a5fa', dark: '#1d4ed8' 
                        },
                        status: {
                            run: '#22c55e',   // Verde (Produzindo)
                            stop: '#ef4444',  // Vermelho (Parada)
                            setup: '#eab308', // Amarelo (Setup)
                            wait: '#94a3b8'   // Cinza (Aguardando)
                        }
                    },
                    boxShadow: {
                        'neon': '0 0 15px rgba(59, 130, 246, 0.5)',
                        'neon-green': '0 0 15px rgba(34, 197, 94, 0.4)',
                        'neon-red': '0 0 15px rgba(239, 68, 68, 0.4)',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Base */
        body {
            background-color: #020617;
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(15, 23, 42, 1) 0px, transparent 50%);
            color: #e2e8f0;
            overflow-x: hidden;
        }

        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .glass-header {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Inputs Modernos */
        .input-tech {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: white;
            transition: all 0.3s ease;
        }
        .input-tech:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            outline: none;
            background: rgba(15, 23, 42, 0.9);
        }

        /* Botões 3D Flat */
        .btn-3d {
            transition: all 0.1s;
            position: relative;
            top: 0;
        }
        .btn-3d:active {
            top: 2px;
            box-shadow: none !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Loader */
        .loader-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #020617; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
            transition: opacity 0.5s ease-out;
        }

        /* Classes Utilitárias de Estado */
        .status-badge {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .text-glow { text-shadow: 0 0 10px rgba(255,255,255,0.3); }

        /* Grids Customizados */
        .machine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        /* Notificação */
        #toast-container {
            position: fixed; bottom: 2rem; right: 2rem; z-index: 100;
            transform: translateY(150%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #toast-container.active { transform: translateY(0); }
    </style>
</head>
<body class="h-screen flex flex-col antialiased selection:bg-brand-dark selection:text-white">

    <div id="loader" class="loader-wrapper">
        <div class="relative w-24 h-24 mb-6">
            <div class="absolute inset-0 border-4 border-slate-800 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-t-brand-DEFAULT border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin"></div>
        </div>
        <h2 class="text-2xl font-tech font-bold text-white tracking-widest uppercase">Triplast<span class="text-brand-DEFAULT">System</span></h2>
        <p class="text-slate-500 text-sm font-mono mt-2" id="loader-msg">Conectando ao banco de dados...</p>
    </div>

    <section id="screen-login" class="flex-1 flex items-center justify-center p-4 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none opacity-20">
            <i class="fa-solid fa-gear absolute top-10 left-10 text-9xl animate-spin-slow text-slate-700"></i>
            <i class="fa-solid fa-microchip absolute bottom-10 right-10 text-9xl text-slate-700"></i>
        </div>

        <div class="w-full max-w-lg glass-panel rounded-2xl p-8 z-10 shadow-glass border-t border-white/10">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-xl bg-gradient-to-br from-brand-600 to-brand-900 mb-4 shadow-neon">
                    <i class="fa-solid fa-cube text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-white font-tech">Acesso ao Sistema</h1>
                <p class="text-slate-400 text-sm">Controle e Monitoramento de Produção</p>
            </div>

            <div class="grid grid-cols-2 gap-2 bg-dark-900/50 p-1.5 rounded-xl mb-6">
                <button onclick="toggleLoginMode('operador')" id="btn-mode-operador" class="py-2.5 rounded-lg text-sm font-bold transition-all bg-brand-600 text-white shadow-lg">
                    <i class="fa-solid fa-user-hard-hat mr-2"></i> Operador
                </button>
                <button onclick="toggleLoginMode('admin')" id="btn-mode-admin" class="py-2.5 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-white">
                    <i class="fa-solid fa-user-tie mr-2"></i> Admin
                </button>
            </div>

            <form onsubmit="handleLogin(event)" class="space-y-5">
                <div id="login-fields-operador" class="space-y-4 animate-fade-in">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Selecione a Máquina</label>
                        <div class="relative">
                            <i class="fa-solid fa-robot absolute left-4 top-3.5 text-slate-500"></i>
                            <select id="login-machine-select" class="input-tech w-full pl-11 pr-4 py-3 rounded-xl appearance-none cursor-pointer">
                                <option value="">Carregando lista...</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-3.5 text-slate-500 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <div id="login-fields-admin" class="space-y-4 hidden animate-fade-in">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Senha de Administração</label>
                        <div class="relative">
                            <i class="fa-solid fa-lock absolute left-4 top-3.5 text-slate-500"></i>
                            <input type="password" id="login-admin-pass" placeholder="••••••••" class="input-tech w-full pl-11 pr-4 py-3 rounded-xl font-mono">
                        </div>
                        <p class="text-[10px] text-slate-500 mt-2 text-right">Esqueceu? Contate o suporte TI.</p>
                    </div>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-brand-600 to-brand-700 hover:from-brand-500 hover:to-brand-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-900/50 transition-all transform active:scale-95 btn-3d flex items-center justify-center gap-2 group">
                    <span>Entrar no Painel</span>
                    <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </form>
            
            <div class="mt-6 pt-6 border-t border-white/5 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div id="db-status-dot" class="w-2 h-2 rounded-full bg-slate-500"></div>
                    <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Banco de Dados</span>
                </div>
                <span class="text-[10px] text-slate-600 font-mono">v3.0.1 Stable</span>
            </div>
        </div>
    </section>

    <div id="app-layout" class="hidden flex-1 flex overflow-hidden">
        
        <aside class="w-20 lg:w-64 bg-dark-900 border-r border-white/5 flex flex-col justify-between z-20 shadow-2xl">
            <div>
                <div class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-white/5 bg-dark-950/50">
                    <i class="fa-solid fa-cube text-brand-DEFAULT text-2xl"></i>
                    <span class="ml-3 font-tech font-bold text-xl text-white tracking-wide hidden lg:block">TRIPLAST</span>
                </div>

                <nav class="mt-6 px-2 space-y-2">
                    <div id="nav-group-admin" class="hidden">
                        <p class="px-4 text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-2 hidden lg:block">Gestão</p>
                        <button onclick="Router.go('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                            <i class="fa-solid fa-grid-2 text-lg w-6 text-center group-hover:text-brand-400"></i>
                            <span class="hidden lg:block font-medium">Visão Geral</span>
                        </button>
                        <button onclick="Router.go('config')" id="nav-config" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                            <i class="fa-solid fa-sliders text-lg w-6 text-center group-hover:text-brand-400"></i>
                            <span class="hidden lg:block font-medium">Configurações</span>
                        </button>
                    </div>

                    <div id="nav-group-operador" class="hidden">
                         <p class="px-4 text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-2 hidden lg:block">Produção</p>
                        <button onclick="Router.go('machine')" id="nav-machine" class="nav-item active w-full flex items-center gap-4 px-4 py-3 bg-brand-600/10 text-brand-400 border border-brand-600/20 rounded-xl transition-all">
                            <i class="fa-solid fa-industry text-lg w-6 text-center"></i>
                            <span class="hidden lg:block font-bold">Minha Máquina</span>
                        </button>
                    </div>
                </nav>
            </div>

            <div class="p-4 border-t border-white/5 bg-dark-950/30">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-slate-700 to-slate-600 flex items-center justify-center border border-white/10 shadow-lg">
                        <i class="fa-solid fa-user text-slate-300"></i>
                    </div>
                    <div class="hidden lg:block overflow-hidden">
                        <p id="user-display-name" class="text-sm font-bold text-white truncate">Usuário</p>
                        <p id="user-role-label" class="text-[10px] text-brand-400 font-bold uppercase tracking-wider">Acesso</p>
                    </div>
                    <button onclick="App.logout()" class="ml-auto text-slate-500 hover:text-red-400 transition-colors w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/5">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-dark-950 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] bg-opacity-20">
            
            <header class="h-16 glass-header flex items-center justify-between px-6 z-10 sticky top-0">
                <div class="flex items-center gap-4">
                    <h2 id="page-title" class="text-lg font-bold text-white flex items-center gap-2 font-tech tracking-wide uppercase">
                        Painel de Controle
                    </h2>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="hidden md:block text-right">
                        <p id="clock-time" class="text-lg font-mono font-bold text-white leading-none">00:00</p>
                        <p id="clock-date" class="text-[10px] text-slate-400 uppercase font-bold">Data</p>
                    </div>
                    
                    <div class="h-8 w-px bg-white/10 mx-2"></div>

                    <div class="flex items-center gap-2 bg-dark-800/80 px-3 py-1.5 rounded-full border border-white/5 shadow-inner">
                        <div id="cloud-indicator" class="w-2 h-2 rounded-full bg-green-500 shadow-neon-green animate-pulse"></div>
                        <span class="text-[10px] font-mono text-slate-400 font-bold">ONLINE</span>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth" id="viewport">
                
                <div id="view-dashboard" class="view-section hidden space-y-8 animate-fade-in">
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="glass-panel p-5 rounded-2xl border-l-4 border-brand-500 relative overflow-hidden group">
                            <div class="absolute right-0 top-0 opacity-10 transform translate-x-2 -translate-y-2 group-hover:scale-110 transition-transform">
                                <i class="fa-solid fa-boxes-stacked text-6xl"></i>
                            </div>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Produção Total</span>
                            <h3 class="text-3xl font-tech font-bold text-white mt-2" id="kpi-total">0</h3>
                            <p class="text-[10px] text-brand-400 mt-1 font-mono">+0% vs ontem</p>
                        </div>
                        
                        <div class="glass-panel p-5 rounded-2xl border-l-4 border-status-run relative overflow-hidden">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Eficiência (OEE)</span>
                            <h3 class="text-3xl font-tech font-bold text-status-run mt-2 text-glow" id="kpi-oee">0%</h3>
                             <div class="w-full h-1 bg-dark-900 mt-2 rounded-full overflow-hidden">
                                <div id="kpi-bar-oee" class="h-full bg-status-run w-0 transition-all duration-1000"></div>
                            </div>
                        </div>

                        <div class="glass-panel p-5 rounded-2xl border-l-4 border-status-stop relative overflow-hidden">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Máquinas Paradas</span>
                            <h3 class="text-3xl font-tech font-bold text-white mt-2" id="kpi-stopped">0</h3>
                            <p class="text-[10px] text-status-stop mt-1 font-bold">Atenção Requerida</p>
                        </div>

                        <div class="glass-panel p-5 rounded-2xl border-l-4 border-purple-500 relative overflow-hidden">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Turno Atual</span>
                            <h3 class="text-3xl font-tech font-bold text-white mt-2">1º</h3>
                            <p class="text-[10px] text-purple-400 mt-1 font-mono">06:00 - 14:00</p>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-4 px-2">
                            <h3 class="text-xl font-bold text-white font-tech uppercase tracking-wide border-b-2 border-brand-500 pb-1">Parque Fabril</h3>
                            <div class="flex gap-4 text-[10px] font-bold uppercase text-slate-400">
                                <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-status-run"></div> Prod</span>
                                <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-status-stop"></div> Parado</span>
                                <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-status-setup"></div> Setup</span>
                            </div>
                        </div>
                        <div id="admin-machine-grid" class="machine-grid">
                            </div>
                    </div>
                </div>

                <div id="view-machine" class="view-section hidden max-w-5xl mx-auto animate-fade-in">
                    
                    <div class="glass-panel rounded-3xl overflow-hidden border border-white/10 shadow-2xl">
                        <div class="bg-dark-800/50 p-6 md:p-8 border-b border-white/5 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h1 class="text-4xl md:text-5xl font-tech font-bold text-white" id="op-machine-name">MÁQUINA 00</h1>
                                <div class="flex items-center gap-3 mt-2">
                                    <span class="bg-brand-900/50 text-brand-300 border border-brand-500/30 px-3 py-1 rounded text-xs font-bold uppercase tracking-wider flex items-center gap-2">
                                        <i class="fa-solid fa-user"></i> <span id="op-operator-name">--</span>
                                    </span>
                                    <span id="op-status-badge" class="bg-slate-800 text-slate-400 border border-slate-700 px-4 py-1 rounded text-xs font-bold uppercase tracking-wider shadow-inner">
                                        OFFLINE
                                    </span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="block text-xs font-bold text-slate-500 uppercase tracking-widest">Contador Atual</span>
                                <span class="block text-5xl md:text-6xl font-mono font-bold text-white text-glow" id="op-counter-big">0</span>
                            </div>
                        </div>

                        <div class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
                            
                            <div class="lg:col-span-5 space-y-6">
                                <div class="bg-dark-900/40 p-5 rounded-2xl border border-white/5">
                                    <label class="text-[10px] font-bold text-brand-400 uppercase tracking-widest mb-2 block">Ordem de Produção</label>
                                    <div class="flex gap-2 mb-4">
                                        <input type="text" id="op-input-number" class="input-tech flex-1 p-3 rounded-lg font-mono text-lg font-bold text-center uppercase" placeholder="OP-000">
                                        <button class="bg-brand-600 hover:bg-brand-500 text-white w-12 rounded-lg shadow-lg flex items-center justify-center">
                                            <i class="fa-solid fa-check"></i>
                                        </button>
                                    </div>
                                    
                                    <label class="text-[10px] font-bold text-brand-400 uppercase tracking-widest mb-2 block">Produto</label>
                                    <select id="op-input-product" class="input-tech w-full p-3 rounded-lg mb-4 text-sm font-semibold bg-dark-900">
                                        </select>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1 block">Meta</label>
                                            <input type="number" id="op-input-target" class="input-tech w-full p-2 rounded-lg font-mono text-center" placeholder="0">
                                        </div>
                                        <div>
                                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1 block">Ciclo (s)</label>
                                            <input type="number" id="op-input-cycle" class="input-tech w-full p-2 rounded-lg font-mono text-center" placeholder="0.0">
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="MachineController.setStatus('produzindo')" class="py-4 bg-status-run/20 hover:bg-status-run hover:text-dark-950 text-status-run border border-status-run/50 rounded-xl font-bold transition-all shadow-neon-green flex flex-col items-center gap-1 group">
                                        <i class="fa-solid fa-play text-2xl group-hover:scale-110 transition-transform"></i>
                                        <span class="text-xs uppercase">Iniciar</span>
                                    </button>
                                    <button onclick="MachineController.setStatus('parada')" class="py-4 bg-status-stop/20 hover:bg-status-stop hover:text-white text-status-stop border border-status-stop/50 rounded-xl font-bold transition-all shadow-neon-red flex flex-col items-center gap-1 group">
                                        <i class="fa-solid fa-stop text-2xl group-hover:scale-110 transition-transform"></i>
                                        <span class="text-xs uppercase">Parar</span>
                                    </button>
                                    <button onclick="MachineController.setStatus('setup')" class="col-span-2 py-3 bg-status-setup/10 hover:bg-status-setup hover:text-dark-900 text-status-setup border border-status-setup/30 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-tools"></i> MODO SETUP / AJUSTE
                                    </button>
                                </div>
                            </div>

                            <div class="lg:col-span-7 flex flex-col">
                                <div class="flex-1 bg-dark-900/40 rounded-2xl border border-white/5 flex flex-col items-center justify-center p-6 relative">
                                    <div class="relative w-64 h-64">
                                        <svg class="w-full h-full transform -rotate-90">
                                            <circle cx="128" cy="128" r="120" stroke="#1e293b" stroke-width="12" fill="none"></circle>
                                            <circle id="op-progress-ring" cx="128" cy="128" r="120" stroke="#3b82f6" stroke-width="12" fill="none" stroke-dasharray="753" stroke-dashoffset="753" stroke-linecap="round" class="transition-all duration-1000 ease-out shadow-neon"></circle>
                                        </svg>
                                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                                            <span class="text-5xl font-black text-white font-mono" id="op-percent-text">0%</span>
                                            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest mt-2">Concluído</span>
                                        </div>
                                    </div>
                                    
                                    <div class="w-full mt-8 flex gap-4">
                                        <button onclick="MachineController.addCount(-1)" class="w-16 h-16 rounded-2xl bg-dark-800 hover:bg-red-900/30 hover:text-red-400 text-slate-400 border border-white/10 font-black text-2xl transition-all btn-3d">-</button>
                                        <button onclick="MachineController.addCount(1)" class="flex-1 h-16 rounded-2xl bg-brand-600 hover:bg-brand-500 text-white font-black text-2xl shadow-neon transition-all btn-3d flex items-center justify-center gap-3">
                                            <i class="fa-solid fa-plus text-lg"></i> 1 PEÇA
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div id="view-config" class="view-section hidden max-w-3xl mx-auto animate-fade-in">
                    <div class="glass-panel p-8 rounded-2xl border border-white/10">
                        <div class="flex items-center gap-3 mb-6 pb-4 border-b border-white/10">
                            <div class="w-10 h-10 rounded-lg bg-brand-900/50 flex items-center justify-center text-brand-400">
                                <i class="fa-solid fa-database"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white font-tech">Dados do Sistema</h2>
                                <p class="text-xs text-slate-400">Edite as listas utilizadas pelos operadores</p>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <label class="block text-xs font-bold text-brand-400 uppercase tracking-widest mb-2">Produtos Cadastrados (CSV)</label>
                                <textarea id="cfg-products" rows="5" class="input-tech w-full p-4 rounded-xl font-mono text-sm leading-relaxed" placeholder="Separe por vírgula..."></textarea>
                                <p class="text-[10px] text-slate-500 mt-2"><i class="fa-solid fa-circle-info mr-1"></i> Separe os itens por vírgula.</p>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-brand-400 uppercase tracking-widest mb-2">Operadores (CSV)</label>
                                <textarea id="cfg-operators" rows="3" class="input-tech w-full p-4 rounded-xl font-mono text-sm leading-relaxed"></textarea>
                            </div>

                            <div class="pt-4 flex justify-end">
                                <button onclick="AdminController.saveConfig()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-xl font-bold shadow-neon-green transition-all flex items-center gap-2 btn-3d">
                                    <i class="fa-solid fa-floppy-disk"></i> Salvar Alterações
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="toast-container" class="flex items-center gap-4 bg-dark-800 border-l-4 border-brand-500 text-white px-6 py-4 rounded-lg shadow-2xl">
        <div id="toast-icon" class="text-brand-500 text-xl"><i class="fa-solid fa-check-circle"></i></div>
        <div>
            <h4 id="toast-title" class="font-bold text-sm uppercase tracking-wide">Notificação</h4>
            <p id="toast-message" class="text-xs text-slate-400">Mensagem do sistema.</p>
        </div>
    </div>

    <script>
        /**
         * CONFIGURAÇÃO E CONEXÃO SUPABASE
         * Chave extraída e configurada automaticamente.
         */
        const SUPABASE_CONFIG = {
            url: 'https://hgqnlqtvjiyuwxwypxhh.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhncW5scXR2aml5dXdud3lweHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjE1MDcsImV4cCI6MjA4NjQzNzUwN30.njSVfWDpIJK49IpRSgyMf6e5MEmJ-AROVT7-nOTZD9Y'
        };

        const sb = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);

        /**
         * STATE MANAGEMENT (STORE)
         * Mantém o estado da aplicação em memória.
         */
        const Store = {
            user: null, // { type: 'admin' | 'operator', machineId: int | null, name: string }
            data: {
                maquinas: [], // Array principal
                operadores: [],
                produtos: [],
                lastUpdateTimestamp: 0,
                // Mantém compatibilidade com campos antigos para não perder dados
                historico: [],
                dadosMensais: {},
                modoHoraExtra: false
            },
            isSaving: false
        };

        // Template de Máquina Padrão (Factory)
        const createMachine = (id) => ({
            id: id,
            nome: `Injetora ${String(id).padStart(2, '0')}`,
            status: 'offline', // offline, produzindo, parada, setup
            operador: null,
            op_atual: {
                numero: '',
                produto: '',
                meta: 0,
                produzido: 0,
                ciclo_padrao: 0,
                inicio: null
            },
            log: []
        });

        /**
         * SYSTEM CONTROLLER
         * Lógica de inicialização e rede.
         */
        const System = {
            async init() {
                try {
                    await this.fetchData();
                    this.setupRealtime();
                    UI.init();
                    
                    // Esconde Loader
                    setTimeout(() => {
                        document.getElementById('loader').style.opacity = '0';
                        setTimeout(() => document.getElementById('loader').classList.add('hidden'), 500);
                    }, 800);

                } catch (error) {
                    console.error("Fatal Error:", error);
                    alert("Erro ao conectar no banco de dados. Verifique a internet.");
                }
            },

            async fetchData() {
                const { data, error } = await sb.from('sistema').select('*').eq('id', 1).single();
                
                if (error || !data) {
                    // Se não existe, cria estrutura inicial (Bootstrap)
                    console.warn("Criando banco de dados inicial...");
                    Store.data.maquinas = Array.from({length: 12}, (_, i) => createMachine(i + 1));
                    Store.data.produtos = ['Produto A', 'Produto B', 'Tampa Padrão'];
                    Store.data.operadores = ['Operador 1', 'Operador 2'];
                    Store.data.lastUpdateTimestamp = Date.now();
                    
                    await sb.from('sistema').insert([{ id: 1, conteudo: Store.data }]);
                } else {
                    // Merge seguro dos dados vindos da nuvem
                    Store.data = { ...Store.data, ...data.conteudo };
                }
                UI.renderLoginSelect();
            },

            setupRealtime() {
                sb.channel('public:sistema')
                  .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'sistema' }, payload => {
                      if(payload.new && payload.new.conteudo) {
                          const cloudData = payload.new.conteudo;
                          // Só atualiza se o timestamp da nuvem for mais recente que o local (evita loop)
                          if(cloudData.lastUpdateTimestamp > Store.data.lastUpdateTimestamp) {
                              Store.data = cloudData;
                              UI.refreshCurrentView();
                              UI.flashCloudStatus();
                          }
                      }
                  })
                  .subscribe();
            },

            // Debounce Save (Salva a cada 1s se houver mudanças)
            saveTimer: null,
            save() {
                document.getElementById('cloud-indicator').classList.remove('bg-green-500', 'shadow-neon-green');
                document.getElementById('cloud-indicator').classList.add('bg-yellow-500');
                
                Store.data.lastUpdateTimestamp = Date.now();
                
                clearTimeout(this.saveTimer);
                this.saveTimer = setTimeout(async () => {
                    try {
                        const { error } = await sb.from('sistema').update({ conteudo: Store.data }).eq('id', 1);
                        if(error) throw error;
                        
                        document.getElementById('cloud-indicator').classList.remove('bg-yellow-500');
                        document.getElementById('cloud-indicator').classList.add('bg-green-500', 'shadow-neon-green');
                    } catch (e) {
                        console.error("Save failed", e);
                        document.getElementById('cloud-indicator').classList.add('bg-red-500');
                        UI.toast("Erro ao salvar na nuvem!", "error");
                    }
                }, 1000);
            }
        };

        /**
         * UI CONTROLLER
         * Manipulação do DOM e visualização.
         */
        const UI = {
            init() {
                this.updateClock();
                setInterval(this.updateClock, 1000);
            },

            renderLoginSelect() {
                const sel = document.getElementById('login-machine-select');
                sel.innerHTML = '<option value="">Selecione sua Máquina...</option>';
                Store.data.maquinas.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.nome;
                    sel.appendChild(opt);
                });
            },

            refreshCurrentView() {
                if(!Store.user) return;
                if(Store.user.type === 'admin') AdminController.renderDashboard();
                if(Store.user.type === 'operator') MachineController.render();
            },

            updateClock() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                const dateStr = now.toLocaleDateString('pt-BR', {weekday: 'short', day: 'numeric', month: 'long'});
                
                const elTime = document.getElementById('clock-time');
                if(elTime) {
                    elTime.textContent = timeStr;
                    document.getElementById('clock-date').textContent = dateStr;
                }
            },

            flashCloudStatus() {
                const dot = document.getElementById('cloud-indicator');
                dot.classList.add('scale-150');
                setTimeout(() => dot.classList.remove('scale-150'), 200);
            },

            toast(msg, type = 'success') {
                const el = document.getElementById('toast-container');
                const title = document.getElementById('toast-title');
                const icon = document.getElementById('toast-icon');
                
                document.getElementById('toast-message').textContent = msg;
                
                if(type === 'error') {
                    el.className = "flex items-center gap-4 bg-dark-800 border-l-4 border-red-500 text-white px-6 py-4 rounded-lg shadow-2xl";
                    icon.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>';
                    title.textContent = "Erro";
                } else {
                    el.className = "flex items-center gap-4 bg-dark-800 border-l-4 border-brand-500 text-white px-6 py-4 rounded-lg shadow-2xl";
                    icon.innerHTML = '<i class="fa-solid fa-check-circle text-brand-500"></i>';
                    title.textContent = "Sucesso";
                }

                el.classList.add('active');
                setTimeout(() => el.classList.remove('active'), 3000);
            }
        };

        /**
         * ROUTER
         * Navegação SPA simples.
         */
        const Router = {
            go(route) {
                // Hide all views
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'bg-brand-600/10', 'text-brand-400', 'border', 'border-brand-600/20'));
                
                // Show requested
                const view = document.getElementById(`view-${route}`);
                if(view) {
                    view.classList.remove('hidden');
                    const nav = document.getElementById(`nav-${route}`);
                    if(nav) nav.classList.add('active', 'bg-brand-600/10', 'text-brand-400', 'border', 'border-brand-600/20');
                    UI.refreshCurrentView();
                }
            }
        };

        /**
         * AUTH LOGIC
         */
        let loginMode = 'operador'; // default

        function toggleLoginMode(mode) {
            loginMode = mode;
            const btnOp = document.getElementById('btn-mode-operador');
            const btnAd = document.getElementById('btn-mode-admin');
            const fieldsOp = document.getElementById('login-fields-operador');
            const fieldsAd = document.getElementById('login-fields-admin');

            if(mode === 'operador') {
                btnOp.className = "py-2.5 rounded-lg text-sm font-bold transition-all bg-brand-600 text-white shadow-lg";
                btnAd.className = "py-2.5 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-white";
                fieldsOp.classList.remove('hidden');
                fieldsAd.classList.add('hidden');
            } else {
                btnOp.className = "py-2.5 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-white";
                btnAd.className = "py-2.5 rounded-lg text-sm font-bold transition-all bg-brand-600 text-white shadow-lg";
                fieldsOp.classList.add('hidden');
                fieldsAd.classList.remove('hidden');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            
            if(loginMode === 'admin') {
                const pass = document.getElementById('login-admin-pass').value;
                if(pass === '2026') {
                    Store.user = { type: 'admin', name: 'Administrador' };
                    startApp();
                } else {
                    UI.toast("Senha Incorreta", "error");
                }
            } else {
                const id = document.getElementById('login-machine-select').value;
                if(!id) return UI.toast("Selecione uma máquina", "error");
                
                const machine = Store.data.maquinas.find(m => m.id == id);
                Store.user = { type: 'operator', machineId: id, name: machine.nome };
                startApp();
            }
        }

        function startApp() {
            document.getElementById('screen-login').classList.add('hidden');
            document.getElementById('app-layout').classList.remove('hidden');
            
            document.getElementById('user-display-name').textContent = Store.user.name;
            document.getElementById('user-role-label').textContent = Store.user.type === 'admin' ? 'Administrador' : 'Operador';

            if(Store.user.type === 'admin') {
                document.getElementById('nav-group-admin').classList.remove('hidden');
                Router.go('dashboard');
            } else {
                document.getElementById('nav-group-operador').classList.remove('hidden');
                Router.go('machine');
            }
        }

        const App = {
            logout() { window.location.reload(); }
        };

        /**
         * MACHINE CONTROLLER (LOGIC OPERATOR)
         */
        const MachineController = {
            getMachine() {
                return Store.data.maquinas.find(m => m.id == Store.user.machineId);
            },

            render() {
                const m = this.getMachine();
                if(!m) return;

                // Header Info
                document.getElementById('op-machine-name').textContent = m.nome;
                document.getElementById('op-operator-name').textContent = m.operador || 'Não definido';
                
                const badge = document.getElementById('op-status-badge');
                badge.textContent = m.status;
                
                // Color mapping
                let colorClass = "bg-slate-800 text-slate-400 border-slate-700";
                if(m.status === 'produzindo') colorClass = "bg-status-run text-dark-950 border-status-run shadow-neon-green";
                if(m.status === 'parada') colorClass = "bg-status-stop text-white border-status-stop shadow-neon-red";
                if(m.status === 'setup') colorClass = "bg-status-setup text-dark-950 border-status-setup";
                badge.className = `px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider shadow-inner transition-all ${colorClass}`;

                // Inputs (Check focus to avoid interruption)
                if(document.activeElement.id !== 'op-input-number') document.getElementById('op-input-number').value = m.op_atual.numero;
                if(document.activeElement.id !== 'op-input-target') document.getElementById('op-input-target').value = m.op_atual.meta || '';
                if(document.activeElement.id !== 'op-input-cycle') document.getElementById('op-input-cycle').value = m.op_atual.ciclo_padrao || '';

                // Product Select population check
                const sel = document.getElementById('op-input-product');
                if(sel.options.length !== Store.data.produtos.length + 1) {
                    sel.innerHTML = '<option value="">Selecione Produto...</option>';
                    Store.data.produtos.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p; opt.textContent = p;
                        sel.appendChild(opt);
                    });
                }
                if(document.activeElement.id !== 'op-input-product') sel.value = m.op_atual.produto;

                // Big Counter & Circle
                document.getElementById('op-counter-big').textContent = m.op_atual.produzido;
                
                const meta = m.op_atual.meta || 1;
                const pct = Math.min(100, Math.round((m.op_atual.produzido / meta) * 100));
                document.getElementById('op-percent-text').textContent = pct + '%';
                
                // SVG Circle calculation (circumference ~ 753)
                const offset = 753 - (753 * pct) / 100;
                document.getElementById('op-progress-ring').style.strokeDashoffset = offset;
                document.getElementById('op-progress-ring').style.stroke = 
                    m.status === 'produzindo' ? '#22c55e' : 
                    m.status === 'parada' ? '#ef4444' : '#3b82f6';
            },

            setStatus(status) {
                const m = this.getMachine();
                m.status = status;
                
                // Auto-set Operator Name if missing
                if(!m.operador) {
                    const name = prompt("Nome do Operador:");
                    if(name) m.operador = name;
                }
                
                System.save();
                this.render();
                UI.toast(`Status: ${status.toUpperCase()}`);
            },

            addCount(qtd) {
                const m = this.getMachine();
                const novo = (parseInt(m.op_atual.produzido) || 0) + qtd;
                if(novo >= 0) {
                    m.op_atual.produzido = novo;
                    System.save();
                    this.render();
                }
            }
        };

        // Bind Inputs
        ['op-input-number', 'op-input-product', 'op-input-target', 'op-input-cycle'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('change', (e) => {
                    const m = MachineController.getMachine();
                    if(!m) return;
                    
                    if(id === 'op-input-number') m.op_atual.numero = e.target.value;
                    if(id === 'op-input-product') m.op_atual.produto = e.target.value;
                    if(id === 'op-input-target') m.op_atual.meta = parseInt(e.target.value) || 0;
                    if(id === 'op-input-cycle') m.op_atual.ciclo_padrao = parseFloat(e.target.value) || 0;
                    
                    System.save();
                    MachineController.render();
                });
            }
        });

        /**
         * ADMIN CONTROLLER
         */
        const AdminController = {
            renderDashboard() {
                // KPIs
                let total = 0, paradas = 0, produzindo = 0;
                const totalMaq = Store.data.maquinas.length;

                const grid = document.getElementById('admin-machine-grid');
                grid.innerHTML = '';

                Store.data.maquinas.forEach(m => {
                    total += (parseInt(m.op_atual.produzido) || 0);
                    if(m.status === 'parada') paradas++;
                    if(m.status === 'produzindo') produzindo++;

                    // Create Card
                    const meta = m.op_atual.meta || 1;
                    const pct = Math.round((m.op_atual.produzido / meta) * 100);
                    
                    let statusColor = 'text-slate-400';
                    let borderClass = 'border-slate-700';
                    let icon = 'fa-power-off';

                    if(m.status === 'produzindo') { statusColor = 'text-status-run'; borderClass = 'border-status-run'; icon = 'fa-gear fa-spin'; }
                    if(m.status === 'parada') { statusColor = 'text-status-stop'; borderClass = 'border-status-stop'; icon = 'fa-triangle-exclamation'; }
                    if(m.status === 'setup') { statusColor = 'text-status-setup'; borderClass = 'border-status-setup'; icon = 'fa-tools'; }

                    const card = document.createElement('div');
                    card.className = `glass-panel rounded-xl p-4 border-t-2 ${borderClass} hover:translate-y-[-2px] transition-transform duration-300`;
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-bold text-white font-tech text-lg">${m.nome}</h4>
                            <i class="fa-solid ${icon} ${statusColor}"></i>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs text-slate-400">
                                <span>${m.op_atual.produto || 'Sem Produto'}</span>
                                <span class="font-mono text-white">${m.op_atual.produzido}/${m.op_atual.meta}</span>
                            </div>
                            <div class="w-full bg-dark-900 h-1.5 rounded-full overflow-hidden">
                                <div class="h-full ${statusColor === 'text-status-run' ? 'bg-status-run' : 'bg-slate-500'} transition-all" style="width: ${pct}%"></div>
                            </div>
                            <div class="flex justify-between items-center pt-2">
                                <span class="text-[10px] uppercase font-bold text-slate-500">${m.operador || 'Livre'}</span>
                                <span class="text-[10px] font-bold uppercase ${statusColor}">${m.status}</span>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });

                document.getElementById('kpi-total').textContent = total;
                document.getElementById('kpi-stopped').textContent = paradas;
                
                const oee = totalMaq > 0 ? Math.round((produzindo/totalMaq)*100) : 0;
                document.getElementById('kpi-oee').textContent = oee + '%';
                document.getElementById('kpi-bar-oee').style.width = oee + '%';
                
                // Config load
                document.getElementById('cfg-products').value = Store.data.produtos.join(', ');
                document.getElementById('cfg-operators').value = Store.data.operadores.join(', ');
            },

            saveConfig() {
                const prods = document.getElementById('cfg-products').value.split(',').map(s => s.trim()).filter(Boolean);
                const ops = document.getElementById('cfg-operators').value.split(',').map(s => s.trim()).filter(Boolean);
                
                Store.data.produtos = prods;
                Store.data.operadores = ops;
                System.save();
                UI.toast("Configurações atualizadas!");
            }
        };

        // STARTUP
        window.addEventListener('DOMContentLoaded', () => {
            System.init();
        });

    </script>
</body>
</html>
