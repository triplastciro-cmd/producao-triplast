<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Triplast - Sistema Integrado V19 (Gerenci√°vel)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        /* =================================================================
           ESTILOS GERAIS
           ================================================================= 
        */
        body { 
            background-color: #f1f5f9; 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 0; 
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            padding-bottom: 100px;
        }
        
        /* Utilit√°rios de Abas */
        .aba-conteudo { 
            display: none !important; 
            animation: fadeIn 0.4s ease-in-out;
        }
        
        .aba-ativa { 
            display: block !important; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =================================================================
           NOTIFICA√á√ïES (TOAST)
           ================================================================= 
        */
        #toast-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-200%);
            background-color: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            font-weight: 900;
            letter-spacing: 1px;
            text-transform: uppercase;
            border: 1px solid #334155;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }

        #toast-notification.show {
            transform: translateX(-50%) translateY(0);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background-color: #22c55e;
            border-radius: 50%;
            box-shadow: 0 0 10px #22c55e;
        }

        .status-dot.saving {
            background-color: #eab308;
            box-shadow: 0 0 10px #eab308;
            animation: pulse-yellow 1s infinite;
        }

        .status-dot.error {
            background-color: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        @keyframes pulse-yellow {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* =================================================================
           CARDS DE M√ÅQUINA
           ================================================================= 
        */
        .card-producao {
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-left: 12px solid #ef4444; 
            transition: all 0.2s ease; 
            position: relative;
            overflow: visible;
        }

        .card-producao:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
        }
        
        .status-produzindo { border-left-color: #22c55e !important; background-color: #f0fdf4; }
        .status-baixa { border-left-color: #f97316 !important; background-color: #fff7ed; }
        .status-sem-prog { border-left-color: #cbd5e1 !important; background-color: #f8fafc; }
        .status-fechada { border-left-color: #475569 !important; background-color: #e2e8f0; filter: grayscale(100%); opacity: 0.8; }

        .info-badge {
            background: #f8fafc; 
            padding: 8px 4px; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            text-align: center;
        }
        
        .info-badge span:first-child { 
            font-size: 0.60rem; 
            font-weight: 800; 
            text-transform: uppercase; 
            color: #64748b;
            margin-bottom: 2px; 
        }
        
        .info-badge span:last-child { 
            font-weight: 900; 
            line-height: 1; 
            font-size: 1.1rem;
        }

        /* =================================================================
           CARROSSEL (TICKETS)
           ================================================================= 
        */
        .scrolling-wrapper {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 16px;
            padding-bottom: 20px;
            padding-top: 5px;
            -webkit-overflow-scrolling: touch; 
            cursor: grab;
            scroll-behavior: smooth;
        }
        
        .scrolling-wrapper:active {
            cursor: grabbing;
        }
        
        .scrolling-wrapper::-webkit-scrollbar { height: 10px; }
        .scrolling-wrapper::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 5px; }
        .scrolling-wrapper::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 5px; border: 2px solid #e2e8f0; }

        .ticket-card {
            flex: 0 0 auto;
            width: 320px; 
            background: white;
            border: 1px solid #cbd5e1;
            border-top: 6px solid #3b82f6; 
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            position: relative;
            transition: transform 0.2s;
        }

        .ticket-card:hover { transform: scale(1.01); }
        
        .ticket-header { 
            background: #f8fafc; 
            padding: 12px; 
            border-bottom: 1px solid #e2e8f0;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        
        .ficha-row {
            display: flex; 
            border-bottom: 1px dashed #e2e8f0; 
            padding: 8px 12px;
            align-items: center; 
            justify-content: space-between;
        }
        
        .ficha-label { font-size: 9px; color: #64748b; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .ficha-value { font-size: 11px; color: #0f172a; font-weight: 700; text-align: right; }

        .btn-mover {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f1f5f9;
            border-radius: 8px;
            color: #64748b;
            font-size: 14px;
            border: 1px solid #e2e8f0;
        }
        .btn-mover:active { background-color: #cbd5e1; }

        /* =================================================================
           UI GERAL
           ================================================================= 
        */
        .tab-btn {
            background: white; 
            padding: 12px 24px; 
            border-radius: 99px;
            font-weight: 700; 
            font-size: 12px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s; 
            border: 2px solid transparent; 
            cursor: pointer; 
            color: #64748b;
            white-space: nowrap;
        }
        
        .tab-btn.active { 
            background: #2563eb; 
            color: white; 
            box-shadow: 0 4px 12px rgba(37,99,235,0.3); 
        }

        header { 
            background: #0f172a; 
            color: white; 
            padding: 20px; 
            border-radius: 0 0 24px 24px; 
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); 
        }
        
        .modal-reset {
            display: none; 
            position: absolute; 
            top: 40px; 
            right: 10px; 
            background: white;
            border: 1px solid #e2e8f0; 
            padding: 5px; 
            border-radius: 8px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
            z-index: 50; 
            width: 140px;
        }

        /* Scrollbar Global */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    </style>
</head>
<body onclick="fecharMenusGlobais(event)">

    <div id="toast-notification">
        <div id="toast-dot" class="status-dot"></div>
        <span id="toast-msg">SISTEMA ATUALIZADO</span>
    </div>

    <div id="modal-gerenciar-maquinas" class="fixed inset-0 bg-slate-900/90 z-[250] hidden items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="font-black text-xl text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-industry text-blue-600"></i> GERENCIAR M√ÅQUINAS
                </h3>
                <button onclick="document.getElementById('modal-gerenciar-maquinas').style.display='none'" class="text-slate-400 hover:text-red-500 text-3xl font-bold leading-none">&times;</button>
            </div>
            
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4 text-xs text-blue-700 font-bold">
                <i class="fa-solid fa-circle-info mr-1"></i> Adicione, remova ou renomeie m√°quinas. O login √© autom√°tico (Senha: "m" + ID, ex: m5).
            </div>

            <div id="lista-maquinas-config" class="flex-1 overflow-y-auto pr-2 space-y-2 mb-4 custom-scroll">
                </div>

            <button onclick="adicionarNovaMaquina()" class="w-full bg-green-600 hover:bg-green-500 text-white font-black py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 uppercase tracking-wide">
                <i class="fa-solid fa-plus"></i> ADICIONAR NOVA M√ÅQUINA
            </button>
        </div>
    </div>

    <div id="modal-cores" class="fixed inset-0 bg-slate-900/90 z-[150] hidden items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-6 border-b pb-2">
                <h3 class="font-black text-xl text-slate-800">üé® Cores do Sistema</h3>
                <button onclick="fecharModalCores()" class="text-slate-400 hover:text-red-500 text-3xl font-bold leading-none">&times;</button>
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="nova-cor-modal" class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold outline-none focus:border-blue-500" placeholder="Nova cor...">
                <button onclick="addCorModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 rounded-xl font-black text-xl shadow-md transition-colors">+</button>
            </div>
            <div id="lista-cores-modal" class="flex flex-wrap gap-2 max-h-64 overflow-y-auto p-1"></div>
        </div>
    </div>

    <div id="modal-editar-op" class="fixed inset-0 bg-slate-900/90 z-[200] hidden items-center justify-center backdrop-blur-sm p-2 overflow-y-auto">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full max-w-2xl border-4 border-blue-500/20 relative my-auto">
            
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h3 class="font-black text-xl md:text-2xl text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-file-invoice text-blue-600"></i> 
                    <span id="titulo-modal-op">FICHA T√âCNICA</span>
                </h3>
                <button onclick="fecharModalEdicao()" class="w-10 h-10 rounded-full bg-slate-100 text-slate-400 hover:bg-red-100 hover:text-red-500 transition-colors flex items-center justify-center font-bold text-xl">&times;</button>
            </div>

            <input type="hidden" id="edit-maq-id">
            <input type="hidden" id="edit-op-index">
            <input type="hidden" id="modo-edicao" value="false"> 
            
            <div class="space-y-4 max-h-[65vh] overflow-y-auto pr-2 custom-scroll">
                
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <div class="col-span-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1">M√°quina</label>
                        <select id="edit-op-maquina" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 text-sm outline-none focus:border-blue-500"></select>
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1">N¬∫ O.P</label>
                        <input type="text" id="edit-op-num" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm focus:border-blue-500 outline-none" placeholder="12345">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1">Meta (Qtd)</label>
                        <input type="number" id="edit-op-qtd" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm focus:border-blue-500 outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1">Cliente</label>
                        <input type="text" id="edit-op-cliente" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm focus:border-blue-500 outline-none" placeholder="Nome do Cliente">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1">Produto (Lista)</label>
                        <select id="edit-op-produto" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 text-sm outline-none focus:border-blue-500"></select>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 relative mt-2">
                    <span class="absolute -top-2 left-4 bg-blue-100 text-blue-600 text-[10px] font-black px-2 py-0.5 rounded uppercase tracking-wider">Mistura & Material</span>
                    <div class="grid grid-cols-2 gap-3 mt-1">
                         <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase">Material</label>
                            <input type="text" id="edit-op-material" class="w-full p-2 bg-white border border-blue-200 rounded-lg text-xs font-bold" placeholder="PP/PE...">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase">Qtd Material</label>
                            <input type="text" id="edit-op-material-qtd" class="w-full p-2 bg-white border border-blue-200 rounded-lg text-xs font-bold" placeholder="kg">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase">C√≥d. Pigmento</label>
                            <input type="text" id="edit-op-pigmento" class="w-full p-2 bg-white border border-blue-200 rounded-lg text-xs font-bold">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase">% Pigmento</label>
                            <input type="text" id="edit-op-porcentagem" class="w-full p-2 bg-white border border-blue-200 rounded-lg text-xs font-bold" placeholder="%">
                        </div>
                    </div>
                </div>

                 <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100 relative mt-4">
                    <span class="absolute -top-2 left-4 bg-orange-100 text-orange-600 text-[10px] font-black px-2 py-0.5 rounded uppercase tracking-wider">Embalagem</span>
                    <div class="grid grid-cols-2 gap-3 mt-1">
                         <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase">Tipo de Caixa</label>
                            <input type="text" id="edit-op-caixa" class="w-full p-2 bg-white border border-orange-200 rounded-lg text-xs font-bold">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase">Tipo de Saco</label>
                            <input type="text" id="edit-op-saco" class="w-full p-2 bg-white border border-orange-200 rounded-lg text-xs font-bold">
                        </div>
                    </div>
                </div>

                <div class="mt-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1">Operador Respons√°vel</label>
                    <select id="edit-op-operador" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 text-sm outline-none focus:border-blue-500"></select>
                </div>
            </div>

            <div class="flex gap-3 mt-6 pt-4 border-t border-slate-100">
                <button onclick="fecharModalEdicao()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 rounded-xl transition-colors text-sm">CANCELAR</button>
                <button onclick="salvarOpModal()" id="btn-salvar-op" class="flex-1 bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-blue-500 transition-all transform active:scale-95 uppercase tracking-widest text-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-up"></i> SALVAR
                </button>
            </div>
        </div>
    </div>

    <div id="tela-loading" class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center transition-opacity duration-500">
        <h1 class="text-6xl md:text-8xl font-black italic tracking-tighter mb-12 text-white animate-pulse">TRI<span class="text-blue-500">PLAST</span></h1>
        
        <div id="loading-spinner" class="flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-6"></div>
            <p class="text-slate-400 font-bold text-sm tracking-widest uppercase animate-pulse">Conectando ao banco de dados...</p>
            <p id="aviso-demora" class="text-yellow-500 text-[10px] mt-4 hidden font-bold">Tentando for√ßar acesso (4s)...</p>
        </div>

        <div id="loading-action" class="hidden flex-col items-center text-center px-4">
            <p class="text-green-400 mb-8 font-bold text-sm tracking-widest uppercase flex items-center justify-center gap-2">
                <i class="fa-solid fa-check-circle text-lg"></i> SISTEMA PRONTO
            </p>
            <button onclick="entrarLogin()" class="bg-blue-600 text-white font-black py-4 px-12 rounded-full shadow-[0_0_20px_rgba(37,99,235,0.4)] hover:shadow-[0_0_40px_rgba(37,99,235,0.8)] hover:bg-blue-500 transition-all duration-300 hover:scale-105 active:scale-95 text-xl tracking-widest uppercase border border-blue-400 w-full max-w-xs">
                ACESSAR
            </button>
        </div>
    </div>

    <div id="tela-login" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center" style="display: none;">
        <div class="bg-white p-10 rounded-[2rem] shadow-2xl w-96 max-w-[90%] text-center border border-slate-800">
            <h1 class="text-5xl font-black italic tracking-tighter mb-2 text-slate-800">TRI<span class="text-blue-600">PLAST</span></h1>
            <p class="text-[10px] font-bold text-slate-400 mb-10 uppercase tracking-[0.2em]">Painel de Controle v19.0</p>
            
            <div class="mb-6 text-left">
                <label class="text-[10px] font-black text-slate-400 block mb-1 uppercase pl-1">Identifica√ß√£o</label>
                <select id="login-tipo" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 transition-colors cursor-pointer appearance-none">
                    <option value="admin">üë®‚Äçüíª ADMINISTRADOR (GERAL)</option>
                </select>
            </div>
            
            <div class="mb-10 text-left">
                <label class="text-[10px] font-black text-slate-400 block mb-1 uppercase pl-1">Chave de Acesso</label>
                <input type="password" id="login-senha" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 transition-colors text-center text-lg placeholder:text-slate-300" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            
            <button onclick="fazerLogin()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-xl hover:bg-blue-500 transition-all transform active:scale-95 text-lg tracking-wide">
                ENTRAR
            </button>
        </div>
    </div>

    <div id="app-content" style="display: none;">
        
        <header class="max-w-7xl mx-auto mb-6 relative">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
                    <span class="text-3xl md:text-4xl font-black italic tracking-tighter select-none">TRI<span class="text-blue-400">PLAST</span></span>
                    <div class="flex items-center gap-2">
                        <div id="relogio" class="font-mono text-blue-300 bg-slate-800/50 px-3 py-1.5 rounded-lg text-sm md:text-lg border border-slate-700 backdrop-blur">00:00:00</div>
                        <button onclick="fazerLogout()" class="text-[10px] bg-red-500/10 hover:bg-red-500 text-red-400 hover:text-white font-black px-4 py-2 rounded-lg uppercase transition-colors border border-red-500/20"><i class="fa-solid fa-right-from-bracket"></i></button>
                    </div>
                </div>

                <div class="flex items-center gap-2 bg-slate-800 p-2 rounded-2xl border border-slate-700 shadow-lg flex-wrap justify-center w-full md:w-auto">
                    
                    <button id="btn-pause" onclick="togglePause()" class="flex-1 md:flex-none bg-yellow-500 hover:bg-yellow-400 text-white text-[10px] font-black px-4 py-2 rounded-xl transition-all shadow-md uppercase">
                        <i class="fa-solid fa-pause"></i> Pausar
                    </button>

                    <button id="btn-extra" onclick="toggleHoraExtra()" class="flex-1 md:flex-none text-white text-[10px] font-black px-4 py-2 rounded-xl transition-all shadow-md uppercase bg-slate-600">
                        <i class="fa-solid fa-bolt"></i> Extra
                    </button>

                    <div class="h-8 w-px bg-slate-600 mx-1 hidden md:block"></div>

                    <div class="flex flex-col ml-2">
                        <span class="text-[8px] font-bold text-slate-400 uppercase text-center">Turno</span>
                        <select id="filtro-turno" onchange="mudarTurnoManual(this.value)" class="bg-slate-900 text-white font-bold p-1 rounded outline-none border-none text-xs w-24">
                            <option value="1">üåÖ Manh√£</option>
                            <option value="2">‚òÄÔ∏è Tarde</option>
                            <option value="3">üåô Noite</option>
                        </select>
                    </div>
                    
                    <div id="badge-auto" class="bg-green-500 text-[9px] px-2 py-1 rounded font-black animate-pulse text-white">AUTO</div>
                    <div id="status-nuvem" class="text-[10px] text-gray-400 font-mono w-6 text-center">‚òÅÔ∏è</div>
                </div>
                
                <div id="header-eficiencia" class="text-right bg-gradient-to-r from-slate-800 to-slate-900 p-3 rounded-2xl border border-slate-700 shadow-lg min-w-[150px] hidden md:block">
                    <div class="flex justify-between items-center gap-4 mb-1">
                        <span class="text-[9px] text-slate-400 font-bold uppercase tracking-wide">Meta Mensal (1.628h)</span>
                        <button onclick="resetarMes()" class="text-[8px] bg-slate-700 hover:bg-red-600 text-white px-2 py-0.5 rounded uppercase transition-colors" title="Zerar acumulado mensal">&times;</button>
                    </div>
                    <div class="flex items-end justify-end gap-2">
                        <div class="text-right leading-none">
                            <span class="text-[9px] text-blue-400 font-bold block mb-0.5">TRABALHADAS</span>
                            <span id="horas-trabalhadas-mes" class="text-lg font-mono font-black text-white">0h</span>
                        </div>
                        <span id="meta-global" class="text-3xl font-black text-green-400 leading-none">0%</span>
                    </div>
                </div>
            </div>
        </header>

        <nav id="nav-principal" class="max-w-7xl mx-auto mb-6 px-2 flex gap-2 overflow-x-auto justify-start md:justify-center pb-2 no-scrollbar">
            <button onclick="trocarAba('painel')" id="btn-painel" class="tab-btn active shadow-md flex-none"><i class="fa-solid fa-desktop mr-1"></i> MONITORAMENTO</button>
            <button onclick="trocarAba('lista')" id="btn-lista" class="tab-btn shadow-md flex-none"><i class="fa-solid fa-list-check mr-1"></i> GEST√ÉO DE PEDIDOS</button>
            <button onclick="trocarAba('graficos')" id="btn-graficos" class="tab-btn shadow-md flex-none"><i class="fa-solid fa-chart-pie mr-1"></i> GR√ÅFICOS</button>
            <button onclick="trocarAba('apontamento')" id="btn-apontamento" class="tab-btn shadow-md flex-none"><i class="fa-solid fa-table mr-1"></i> RESUMO TURNO</button>
        </nav>

        <div id="aba-painel" class="aba-conteudo aba-ativa px-4">
            
            <div class="max-w-7xl mx-auto mb-6" id="area-admin-painel">
                <button onclick="abrirGerenciadorMaquinas()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg flex items-center gap-2 transition-all w-full md:w-auto justify-center">
                    <i class="fa-solid fa-gears"></i> GERENCIAR M√ÅQUINAS (ADICIONAR / REMOVER)
                </button>
            </div>

            <div id="grid-maquinas" class="pb-20"></div>
        </div>

        <div id="aba-lista" class="aba-conteudo px-4">
            <div class="max-w-7xl mx-auto grid grid-cols-1 gap-6">
                
                <div class="bg-white p-4 rounded-2xl shadow-lg border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-2 z-30">
                    <div class="relative w-full md:w-96 group">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-300 group-hover:text-blue-400 transition-colors"></i>
                        <input type="text" id="busca-lista-op" oninput="renderListaOPs()" placeholder="üîç Buscar O.P, Cliente, Produto..." 
                            class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-600 outline-none focus:border-blue-500 focus:bg-white transition-all">
                    </div>
                    
                    <button onclick="abrirModalCriacao()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white py-3 px-8 rounded-xl font-black uppercase shadow-lg shadow-blue-500/30 transition-all transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-circle-plus text-xl"></i> Nova Ficha T√©cnica
                    </button>
                </div>
                
                <div id="container-filas" class="space-y-8">
                    </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
                    
                    <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100 md:col-span-2">
                        <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 border-b border-slate-100 pb-4 gap-4">
                            <h2 class="text-xl font-black text-slate-700 flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-600 p-2 rounded-lg"><i class="fa-solid fa-clock-rotate-left"></i></span> 
                                HIST√ìRICO GERAL
                            </h2>
                            <div class="flex flex-wrap gap-2">
                                <input type="text" id="busca-historico-op" placeholder="Filtrar..." oninput="renderHistorico()" class="p-2 bg-slate-50 border border-slate-200 rounded-lg font-bold text-xs outline-none focus:border-blue-500 w-32">
                                <button onclick="limparBuscaHistorico()" class="bg-slate-100 hover:bg-slate-200 text-slate-500 px-3 py-2 rounded-lg font-bold text-xs transition-colors"><i class="fa-solid fa-eraser"></i></button>
                            </div>
                        </div>
                        <div class="overflow-x-auto max-h-80 overflow-y-auto scrollbar-custom">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-slate-400 text-[10px] font-black uppercase sticky top-0 z-10">
                                    <tr><th class="p-3 rounded-tl-lg">Data</th><th class="p-3">Status</th><th class="p-3">M√°q.</th><th class="p-3">O.P</th><th class="p-3">Produto</th><th class="p-3">Qtd Feita</th><th class="p-3 text-right rounded-tr-lg"></th></tr>
                                </thead>
                                <tbody id="lista-historico" class="text-xs font-bold text-slate-600"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100">
                        <h2 class="text-lg font-black mb-6 border-b pb-2 text-slate-700 flex items-center gap-2">
                            <span class="bg-purple-100 text-purple-600 p-2 rounded-lg"><i class="fa-solid fa-boxes-stacked"></i></span>
                            CAT√ÅLOGO DE PRODUTOS
                        </h2>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="busca-produto-catalog" oninput="renderProdutosConfig()" class="flex-1 p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold outline-none focus:border-purple-500" placeholder="üîç Pesquisar no cat√°logo...">
                        </div>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="novo-produto-catalog" class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm outline-none focus:border-purple-500" placeholder="Novo Produto...">
                            <button onclick="gerenciarProdutoCatalog('add')" class="bg-purple-600 hover:bg-purple-500 text-white px-4 rounded-xl font-black text-xl shadow-md transition-colors">+</button>
                        </div>
                        <div id="lista-produtos-config" class="flex flex-wrap gap-2 max-h-40 overflow-y-auto scrollbar-custom content-start"></div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100">
                        <h2 class="text-lg font-black mb-6 border-b pb-2 text-slate-700 flex items-center gap-2">
                            <span class="bg-green-100 text-green-600 p-2 rounded-lg"><i class="fa-solid fa-users-gear"></i></span>
                            EQUIPE DE OPERADORES
                        </h2>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="novo-operador" class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm outline-none focus:border-green-500" placeholder="Nome do Operador...">
                            <button onclick="gerenciarOperador('add')" class="bg-green-600 hover:bg-green-500 text-white px-4 rounded-xl font-black text-xl shadow-md transition-colors">+</button>
                        </div>
                        <div id="lista-operadores-config" class="flex flex-wrap gap-2 max-h-40 overflow-y-auto scrollbar-custom content-start"></div>
                    </div>

                </div>
            </div>
        </div>

        <div id="aba-graficos" class="aba-conteudo px-4">
            <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center col-span-1 lg:col-span-2 border border-slate-100">
                    <div class="flex flex-col sm:flex-row justify-between items-center w-full mb-6 border-b border-slate-100 pb-4">
                        <h3 class="font-black text-slate-700 text-xl flex items-center gap-2"><i class="fa-solid fa-stopwatch text-blue-500"></i> OEE - TEMPO REAL</h3>
                        <select id="filtro-grafico-status" onchange="alterarFiltroGrafico(this.value)" class="mt-2 sm:mt-0 bg-slate-100 border border-slate-200 text-slate-600 font-bold py-2 px-4 rounded-xl text-sm outline-none"></select>
                    </div>
                    <div class="w-full max-w-sm h-64 flex items-center justify-center relative">
                        <canvas id="chartOEE"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="text-center">
                                <span class="text-xs font-bold text-slate-400 block">STATUS</span>
                                <span class="text-2xl font-black text-slate-700">AGORA</span>
                            </div>
                        </div>
                    </div>
                    <div class="w-full mt-8 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-green-50 p-3 rounded-2xl border border-green-100 shadow-sm">
                            <div class="text-green-600 text-[9px] font-black uppercase mb-1 tracking-wider">PRODUZINDO</div>
                            <div id="global-timer-prod" class="text-xl font-black text-slate-700">00:00:00</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-2xl border border-orange-100 shadow-sm">
                            <div class="text-orange-500 text-[9px] font-black uppercase mb-1 tracking-wider">BAIXA EFIC.</div>
                            <div id="global-timer-baixa" class="text-xl font-black text-slate-700">00:00:00</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-2xl border border-red-100 shadow-sm">
                            <div class="text-red-500 text-[9px] font-black uppercase mb-1 tracking-wider">PARADO</div>
                            <div id="global-timer-parado" class="text-xl font-black text-slate-700">00:00:00</div>
                        </div>
                        <div class="bg-slate-100 p-3 rounded-2xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-[9px] font-black uppercase mb-1 tracking-wider">NEUTRO</div>
                            <div id="global-timer-semprog" class="text-xl font-black text-slate-700">00:00:00</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-xl col-span-1 lg:col-span-2 border border-slate-100">
                    <div class="flex items-center gap-3 mb-4 border-b pb-2">
                        <div class="bg-purple-100 p-2 rounded-lg text-purple-600"><i class="fa-solid fa-business-time"></i></div>
                        <h3 class="font-black text-slate-700 text-lg uppercase">ACUMULADO MENSAL (HORAS)</h3>
                    </div>
                    <div class="w-full h-40">
                         <canvas id="chartHorasExtras"></canvas>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100">
                    <div class="flex items-center gap-3 mb-4 border-b pb-2">
                        <div class="bg-red-100 p-2 rounded-lg text-red-600"><i class="fa-solid fa-triangle-exclamation"></i></div>
                        <h3 class="font-black text-slate-700 text-sm uppercase">RANKING DE PARADAS (MIN)</h3>
                    </div>
                    <div class="h-64"><canvas id="chartParadas"></canvas></div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100">
                    <div class="flex items-center gap-3 mb-4 border-b pb-2">
                        <div class="bg-red-100 p-2 rounded-lg text-red-600"><i class="fa-solid fa-trash-can"></i></div>
                        <h3 class="font-black text-slate-700 text-sm uppercase">RANKING DE REFUGO (P√áS)</h3>
                    </div>
                    <div class="h-64"><canvas id="chartRefugos"></canvas></div>
                </div>
            </div>
        </div>

        <div id="aba-apontamento" class="aba-conteudo px-4">
            <div class="max-w-7xl mx-auto bg-white p-8 rounded-3xl shadow-2xl overflow-hidden border border-slate-100">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-2xl font-black text-slate-700">RESUMO DETALHADO</h2>
                        <select id="filtro-resumo" onchange="renderApontamento()" class="bg-blue-50 text-blue-800 font-bold p-2 rounded-lg border border-blue-200 outline-none text-sm cursor-pointer">
                            <option value="todas">üìä GERAL (ACUMULADO)</option>
                            <option value="1">üåÖ TURNO MANH√É</option>
                            <option value="2">‚òÄÔ∏è TURNO TARDE</option>
                            <option value="3">üåô TURNO NOITE</option>
                        </select>
                    </div>
                    <button onclick="resetarTurnoCompleto()" class="bg-red-50 text-red-600 border border-red-200 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg font-bold text-xs uppercase transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-bomb"></i> ZERAR TUDO
                    </button>
                </div>
                <div class="overflow-x-auto rounded-xl border border-slate-200">
                    <table class="w-full text-left">
                        <thead class="bg-slate-800 text-white uppercase text-[10px] tracking-wider">
                            <tr>
                                <th class="p-4">M√°quina</th>
                                <th class="p-4">O.P Atual</th>
                                <th class="p-4 text-green-400">Boas</th>
                                <th class="p-4 text-red-400">Refugo</th>
                                <th class="p-4">% Perda</th>
                                <th class="p-4 bg-slate-900">T. Prod</th>
                                <th class="p-4 bg-slate-900">T. Baixa</th>
                                <th class="p-4 bg-slate-900">T. Parado</th>
                                <th class="p-4 bg-slate-900">T. Neutro</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-apontamento" class="font-bold text-slate-700 text-xs"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ïES SUPABASE
        const S_URL = 'https://hgqnlqtvjiyuwnwypxxh.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhncW5scXR2aml5dXdud3lweHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjE1MDcsImV4cCI6MjA4NjQzNzUwN30.njSVfWDpIJK49IpRSgyMf6e5MEmJ-AROVT7-nOTZD9Y';
        const sb = window.supabase.createClient(S_URL, S_KEY);

        // ESTADO GLOBAL
        let maquinas = [];
        let historico = [];
        let coresGlobais = ["Natural", "Preto", "Branco"];
        let operadoresGlobais = ["Jo√£o", "Maria", "Jos√©"]; 
        let produtosGlobais = ["Garrafa 500ml", "Tampa Padr√£o", "Pote 1kg"]; 
        let dadosMensais = { tempoProducaoTotal: 0, tempoHoraExtraTotal: 0 };
        
        let manualOverride = false;
        let modoHoraExtra = false;
        let saveTimeout = null;
        let filtroGraficoId = 'todas';
        let charts = { oee: null, paradas: null, refugos: null, horas: null };
        let relogioInterval = null; 
        
        let sistemaPausado = false;
        let usuarioLogado = null; 
        let fdsAtivo = false;
        let dadosLocaisLastUpdate = 0; 

        // UTILS
        function getBrasiliaDate() { return new Date(new Date().toLocaleString("en-US", {timeZone: "America/Sao_Paulo"})); }
        function isFimDeSemana(agora) {
            const dia = agora.getDay(); const minDoDia = agora.getHours() * 60 + agora.getMinutes();
            if (dia === 5 && minDoDia >= 1416) return true; // Sexta > 23:36
            if (dia === 6 || dia === 0) return true; // S√°b/Dom
            if (dia === 1 && minDoDia < 300) return true; // Seg < 05:00
            return false;
        }
        function createZero() { return { boas: 0, refugo: 0, paradas: 0, tempoProducao: 0, tempoBaixa: 0, tempoSemProg: 0 }; }
        function fmtTempo(s) { if(isNaN(s)) return "00:00:00"; s=Math.floor(s); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), seg=s%60; return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${seg.toString().padStart(2,'0')}`; }

        const paradasCodigos = [
            "04-PRODU√á√ÉO", "21-BAIXA EFICI√äNCIA", "01-TROCA DE MOLDE", "02-TROCA DE POSTI√áO", 
            "03-MATERIA-PRIMA/ AJUSTE", "05-AQUECIMENTO DE M√ÅQUINA", "06-TROCA DE COR", "07-MANUTEN√á√ÉO GELADEIRA", 
            "08-LANCHE", "09-LIMPEZA", "10-PE√áA PRESA NO MOLDE", "11-INICIO DE PROCESSO", 
            "12-FALTA DE ENERGIA EL√âTRICA", "13-MANUTEN√á√ÉO DE MOLDE", "14-MANUTEN√á√ÉO DE M√ÅQUINA", 
            "15-PROBLEMA AR", "16-PROBLEMA CAMAR√É QUENTE", "17-TROCA DE BICO DE INJE√á√ÉO", 
            "18-FALTA DE OPERADOR", "19-EL√âTRICA DE MOLDE", "20-OUTROS", 
            "22-SEM PROGRAMA√á√ÉO", "23-EMPRESA FECHADA", "24-PARADA PROGRAMADA"
        ];
        const codigosRefugo = ["Falha de inje√ß√£o", "Arranh√£o/batido", "Fora de cor", "Pe√ßa presa no molde", "Bolha", "Mancha", "Trinca", "Espirro", "Material contaminado", "Outros"];

        // --- SISTEMA DE TOAST (NOTIFICA√á√ÉO INTELIGENTE) ---
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast-notification');
            const m = document.getElementById('toast-msg');
            const d = document.getElementById('toast-dot');
            
            m.innerText = msg;
            d.className = 'status-dot ' + (type === 'saving' ? 'saving' : (type === 'error' ? 'error' : ''));
            
            t.classList.add('show');
            if (type !== 'saving') {
                setTimeout(() => { t.classList.remove('show'); }, 3000);
            }
        }

        function hideToast() {
            document.getElementById('toast-notification').classList.remove('show');
        }

        // --- VACINA DE DADOS (IMPEDE NAN/UNDEFINED) ---
        function sanitizarDados() {
            if(!dadosMensais) dadosMensais = { tempoProducaoTotal: 0, tempoHoraExtraTotal: 0 };
            dadosMensais.tempoProducaoTotal = Number(dadosMensais.tempoProducaoTotal) || 0;
            dadosMensais.tempoHoraExtraTotal = Number(dadosMensais.tempoHoraExtraTotal) || 0;

            maquinas.forEach(m => {
                m.accumulatedStatusTime = Number(m.accumulatedStatusTime) || 0;
                if(!m.dadosTurno) m.dadosTurno = {}; if(!m.resumoTurno) m.resumoTurno = {};
                [1, 2, 3].forEach(t => {
                    if(!m.dadosTurno[t]) m.dadosTurno[t] = createZero();
                    if(!m.resumoTurno[t]) m.resumoTurno[t] = createZero();
                    ['boas', 'refugo', 'paradas', 'tempoProducao', 'tempoBaixa', 'tempoSemProg'].forEach(k => {
                        m.dadosTurno[t][k] = Number(m.dadosTurno[t][k]) || 0;
                        m.resumoTurno[t][k] = Number(m.resumoTurno[t][k]) || 0;
                    });
                });
            });
        }

        // --- CARREGAMENTO DO BANCO DE DADOS (COM 4 M√ÅQUINAS) ---
        async function carregarBanco() {
            const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 4000));
            
            const dbRequest = async () => {
                let { data, error } = await sb.from('sistema').select('*').eq('id', 1).single();
                
                // Se n√£o existir, CRIA O PADR√ÉO COM 4 M√ÅQUINAS
                if (error || !data) {
                    const padrao = { 
                        id: 1, 
                        conteudo: { 
                            // AQUI EST√Å A CORRE√á√ÉO: LENGTH: 4
                            maquinas: Array.from({length: 4}, (_, i) => ({ 
                                id: i+1, nome: `M${i+1}`, status: "22-SEM PROGRAMA√á√ÉO", fila: [], 
                                dadosTurno: {1:createZero(),2:createZero(),3:createZero()}, 
                                resumoTurno: {1:createZero(),2:createZero(),3:createZero()}, 
                                accumulatedStatusTime: 0, lastStatusChange: Date.now() 
                            })), 
                            cores: ["Natural", "Preto", "Branco"], 
                            operadores: ["Operador 1"], 
                            produtos: [], historico: [], 
                            dadosMensais: { tempoProducaoTotal: 0 }, 
                            lastUpdateTimestamp: Date.now() 
                        } 
                    };
                    await sb.from('sistema').upsert(padrao);
                    return padrao;
                }
                return data;
            };

            try {
                const data = await Promise.race([dbRequest(), timeout]);
                aplicarDados(data.conteudo);
            } catch (err) {
                console.warn("Modo Offline ativado por demora ou erro:", err);
                // Carrega dados padr√£o se falhar (Offline Mode)
                aplicarDados({
                    maquinas: Array.from({length: 4}, (_, i) => ({ id: i+1, nome: `M${i+1}`, status: "22-SEM PROGRAMA√á√ÉO", fila: [], dadosTurno: {1:createZero(),2:createZero(),3:createZero()}, resumoTurno: {1:createZero(),2:createZero(),3:createZero()}, accumulatedStatusTime: 0, lastStatusChange: Date.now() })),
                    cores: ["Natural", "Preto", "Branco"],
                    operadores: ["Operador 1"],
                    produtos: [], historico: [],
                    dadosMensais: { tempoProducaoTotal: 0 },
                    lastUpdateTimestamp: Date.now()
                });
            } finally {
                finalizarCarregamento();
                setInterval(sincronizarComServidor, 2000);
            }
        }

        function finalizarCarregamento() {
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('loading-action').classList.remove('hidden');
            document.getElementById('loading-action').classList.add('flex');
            iniciarRelogio();
        }

        function aplicarDados(conteudo) {
            maquinas = conteudo.maquinas || [];
            coresGlobais = conteudo.cores || coresGlobais;
            operadoresGlobais = conteudo.operadores || operadoresGlobais;
            produtosGlobais = conteudo.produtos || produtosGlobais;
            historico = conteudo.historico || []; 
            dadosMensais = conteudo.dadosMensais || { tempoProducaoTotal: 0 };
            modoHoraExtra = conteudo.modoHoraExtra || false;
            dadosLocaisLastUpdate = conteudo.lastUpdateTimestamp || 0;

            // Preenche selects se estiver vazio
            const selLogin = document.getElementById('login-tipo');
            selLogin.innerHTML = '<option value="admin">üë®‚Äçüíª ADMINISTRADOR (GERAL)</option>' + 
                                    maquinas.map(m => `<option value="${m.id}">üè≠ TELA: ${m.nome}</option>`).join('');
            
            document.getElementById('edit-op-maquina').innerHTML = maquinas.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
            document.getElementById('filtro-grafico-status').innerHTML = '<option value="todas">üè≠ TODAS</option>' + maquinas.map(m => `<option value="${m.id}">üè≠ ${m.nome}</option>`).join('');
            
            sanitizarDados();
            atualizarDropdowns();
            processarTurnoAuto();
            const now = Date.now();
            const secondsPassed = Math.floor((now - dadosLocaisLastUpdate) / 1000);
            if (secondsPassed > 0 && secondsPassed < 86400) compensarTempoOffline(secondsPassed);
            renderBotaoExtra(); 
            calcEficienciaGlobal();
            
            if(usuarioLogado) {
                render();
                if(usuarioLogado === 'admin') {
                    renderListaOPs();
                    renderApontamento();
                }
                updateTimersVisualOnly();
            }
        }

        // --- SINCRONIZA√á√ÉO ---
        async function sincronizarComServidor() {
            if(document.getElementById('modal-editar-op').style.display === 'flex' || document.getElementById('modal-cores').style.display === 'flex') return;
            const { data } = await sb.from('sistema').select('conteudo').eq('id', 1).single();
            if (data && data.conteudo) {
                if ((data.conteudo.lastUpdateTimestamp || 0) > dadosLocaisLastUpdate + 2000) {
                    aplicarDados(data.conteudo);
                    showToast("SINCRONIZADO", 'success');
                }
            }
        }

        async function forcarSalvarImediato() {
            if(saveTimeout) clearTimeout(saveTimeout);
            showToast("‚òÅÔ∏è ENVIANDO...", "saving");
            const payload = { maquinas, cores: coresGlobais, operadores: operadoresGlobais, produtos: produtosGlobais, historico, dadosMensais, modoHoraExtra, lastUpdateTimestamp: Date.now() };
            const { error } = await sb.from('sistema').upsert({ id: 1, conteudo: payload });
            if(error) { showToast("ERRO AO SALVAR", "error"); } else { dadosLocaisLastUpdate = payload.lastUpdateTimestamp; showToast("SALVO NA NUVEM", "success"); }
        }

        async function salvarAutomatico() {
            document.getElementById('status-nuvem').innerText = "‚è≥";
            if(saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => { await forcarSalvarImediato(); document.getElementById('status-nuvem').innerText = "‚òÅÔ∏è"; }, 2000); 
        }

        // --- AUTH ---
        function entrarLogin() { document.getElementById('tela-loading').style.display = 'none'; const u = localStorage.getItem('triplast_user'); if(u){ usuarioLogado = u==='admin'?'admin':parseInt(u); iniciarSistema(); } else { document.getElementById('tela-login').style.display = 'flex'; } }
        function fazerLogin() { 
            const t = document.getElementById('login-tipo').value; 
            const s = document.getElementById('login-senha').value.trim(); 
            // L√ìGICA DE SENHA M√ÅQUINA: "m" + ID
            if((t==='admin' && s==='2026') || (t!=='admin' && s === 'm' + t)) { 
                usuarioLogado = t==='admin'?'admin':parseInt(t); localStorage.setItem('triplast_user', t); iniciarSistema(); 
            } else alert('Senha incorreta!'); 
        }
        function fazerLogout() { usuarioLogado=null; localStorage.removeItem('triplast_user'); location.reload(); }
        
        function iniciarSistema() {
            document.getElementById('tela-login').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            
            // GARANTE QUE A ABA ATIVA SEJA VIS√çVEL
            document.querySelectorAll('.aba-conteudo').forEach(el => el.classList.remove('aba-ativa'));
            document.getElementById('aba-painel').classList.add('aba-ativa');
            
            if(usuarioLogado !== 'admin') { 
                ['nav-principal','header-eficiencia','btn-pause','btn-extra', 'area-admin-painel'].forEach(id=>{
                    const el = document.getElementById(id);
                    if(el) el.style.display='none';
                });
                trocarAba('painel'); 
            } else {
                ['nav-principal','header-eficiencia', 'area-admin-painel'].forEach(id=>document.getElementById(id).style.display='block');
                ['btn-pause','btn-extra'].forEach(id=>document.getElementById(id).style.display='inline-block');
                renderListaOPs(); iniciarGraficos();
            }
            render(); 
        }

        // --- GERENCIADOR DE M√ÅQUINAS (NOVO) ---
        function abrirGerenciadorMaquinas() {
            document.getElementById('modal-gerenciar-maquinas').style.display = 'flex';
            renderListaMaquinasConfig();
        }

        function renderListaMaquinasConfig() {
            const container = document.getElementById('lista-maquinas-config');
            container.innerHTML = maquinas.map(m => `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-200">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 text-blue-600 font-black w-8 h-8 flex items-center justify-center rounded-lg text-xs">ID ${m.id}</div>
                        <input type="text" value="${m.nome}" onchange="editarNomeMaquina(${m.id}, this.value)" class="bg-white border border-slate-300 rounded px-2 py-1 text-sm font-bold text-slate-700 w-32 focus:border-blue-500 outline-none">
                    </div>
                    <button onclick="removerMaquina(${m.id})" class="text-red-400 hover:text-red-600 p-2"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }

        function adicionarNovaMaquina() {
            const novoId = maquinas.length > 0 ? Math.max(...maquinas.map(m => m.id)) + 1 : 1;
            maquinas.push({
                id: novoId,
                nome: `M√°quina ${novoId}`,
                status: "22-SEM PROGRAMA√á√ÉO",
                fila: [],
                dadosTurno: {1:createZero(),2:createZero(),3:createZero()},
                resumoTurno: {1:createZero(),2:createZero(),3:createZero()},
                accumulatedStatusTime: 0,
                lastStatusChange: Date.now()
            });
            renderListaMaquinasConfig();
            forcarSalvarImediato();
            if(usuarioLogado === 'admin') {
                render();
                // Atualiza Selects
                document.getElementById('login-tipo').innerHTML = '<option value="admin">üë®‚Äçüíª ADMINISTRADOR (GERAL)</option>' + maquinas.map(m => `<option value="${m.id}">üè≠ TELA: ${m.nome}</option>`).join('');
                document.getElementById('edit-op-maquina').innerHTML = maquinas.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
            }
        }

        function removerMaquina(id) {
            if(confirm("Tem certeza? Isso apagar√° todo hist√≥rico de hoje desta m√°quina.")) {
                maquinas = maquinas.filter(m => m.id !== id);
                renderListaMaquinasConfig();
                forcarSalvarImediato();
                render();
            }
        }

        function editarNomeMaquina(id, novoNome) {
            const m = maquinas.find(x => x.id === id);
            if(m) {
                m.nome = novoNome;
                forcarSalvarImediato();
                render();
            }
        }

        // --- LISTA DE PEDIDOS ---
        async function salvarOpModal() {
            const btn = document.getElementById('btn-salvar-op');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> SALVANDO...'; btn.disabled = true;
            const modo = document.getElementById('modo-edicao').value === "true";
            const maqId = parseInt(document.getElementById('edit-op-maquina').value || document.getElementById('edit-maq-id').value);
            const m = maquinas.find(x => x.id === maqId);
            const novaOp = { op: document.getElementById('edit-op-num').value, cliente: document.getElementById('edit-op-cliente').value, produto: document.getElementById('edit-op-produto').value, qtd: parseInt(document.getElementById('edit-op-qtd').value)||0, material: document.getElementById('edit-op-material').value, materialQtd: document.getElementById('edit-op-material-qtd').value, pigmento: document.getElementById('edit-op-pigmento').value, porcentagem: document.getElementById('edit-op-porcentagem').value, caixa: document.getElementById('edit-op-caixa').value, saco: document.getElementById('edit-op-saco').value, operador: document.getElementById('edit-op-operador').value };
            if(modo) { const idx = parseInt(document.getElementById('edit-op-index').value); m.fila[idx] = novaOp; } else { m.fila.push(novaOp); }
            await forcarSalvarImediato();
            fecharModalEdicao(); renderListaOPs(); render();
            btn.innerHTML = 'SALVAR NA NUVEM'; btn.disabled = false;
        }

        async function moverFila(maqId, index, dir) { const m = maquinas.find(x => x.id===maqId); const newPos = index + dir; if (newPos >= 0 && newPos < m.fila.length) { const item = m.fila.splice(index, 1)[0]; m.fila.splice(newPos, 0, item); renderListaOPs(); await forcarSalvarImediato(); } }
        async function deletarOP(maqId, index) { if(confirm("Apagar O.P?")) { const m = maquinas.find(x=>x.id===maqId); const op = m.fila.splice(index, 1)[0]; historico.push({ ...op, data: new Date().toISOString(), maquina: m.nome, status: 'CANCELADO' }); renderListaOPs(); await forcarSalvarImediato(); } }

        // --- INTERFACE ---
        function render() {
            const t = document.getElementById('filtro-turno').value;
            const grid = document.getElementById('grid-maquinas');
            if(!grid) return;
            const lista = usuarioLogado!=='admin' ? maquinas.filter(m=>m.id===usuarioLogado) : maquinas;
            grid.className = usuarioLogado!=='admin' ? "max-w-md mx-auto w-full mt-4" : "max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";

            grid.innerHTML = lista.map(m => {
                const op = m.fila[0] || { op: '---', produto: 'AGUARDANDO', qtd: 0 };
                const d = m.dadosTurno[t] || createZero();
                const prog = op.qtd>0 ? Math.min((d.boas/op.qtd)*100, 100) : 0;
                let stClass = "";
                if(m.status.includes("PRODU√á√ÉO")) stClass="status-produzindo"; else if(m.status.includes("BAIXA")||m.status.includes("MATERIA")) stClass="status-baixa"; else if(m.status.includes("SEM")) stClass="status-sem-prog"; else stClass="status-fechada";

                return `<div class="card-producao ${stClass} p-4 md:p-5">
                    <div class="flex flex-col mb-3"><span class="bg-blue-600 text-white px-3 py-1 rounded-lg font-black text-lg w-fit shadow-md mb-1">${m.nome}</span><span id="timer-display-${m.id}" class="text-[10px] font-bold block h-4">--:--:--</span></div>
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 mb-4">
                        <span class="font-black text-slate-800 text-xl block">O.P ${op.op}</span>
                        <div class="text-xs font-bold text-slate-500 uppercase truncate w-40 mb-3">${op.produto}</div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div class="info-badge"><span class="text-green-500">FEITO</span><span class="text-green-600 text-xl">${d.boas}</span></div>
                            <div class="info-badge"><span class="text-red-400">REFUGO</span><span class="text-red-600 text-xl">${d.refugo}</span></div>
                        </div>
                        <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden"><div class="bg-blue-500 h-full transition-all duration-500" style="width:${prog}%"></div></div>
                    </div>
                    <div class="flex gap-2 mb-3">
                        <input type="number" id="qtd-prod-${m.id}" class="flex-1 bg-white border-2 border-slate-200 rounded-xl text-center font-bold text-lg outline-none focus:border-blue-500" placeholder="Qtd">
                        <button onclick="apontarManual(${m.id})" class="bg-blue-600 text-white w-12 rounded-xl font-bold text-xl active:scale-95 transition-transform">+</button>
                    </div>
                    <div class="flex gap-2 mb-4 items-center bg-red-50 p-2 rounded-xl border border-red-100">
                        <span class="text-[10px] font-bold text-red-400 uppercase ml-1">Refugo:</span>
                        <select id="sel-refugo-${m.id}" class="flex-1 bg-white border rounded text-[9px] font-bold h-7">${codigosRefugo.map(c=>`<option value="${c}">${c}</option>`).join('')}</select>
                        <button onclick="addRefugo(${m.id})" class="bg-red-500 text-white w-7 h-7 rounded font-bold text-xs">+</button>
                    </div>
                    <select onchange="atualizarStatus(${m.id}, this.value)" class="w-full p-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-xs mb-2 outline-none">
                        ${paradasCodigos.map(p => `<option value="${p}" ${m.status===p?'selected':''}>${p}</option>`).join('')}
                    </select>
                    ${usuarioLogado==='admin' ? `<button onclick="finalizarOP(${m.id})" class="w-full text-slate-400 hover:text-red-500 text-[9px] font-black uppercase tracking-widest mt-1">Finalizar O.P</button>` : ''}
                </div>`;
            }).join('');
        }

        function renderListaOPs() {
            if(usuarioLogado !== 'admin') return;
            const termo = document.getElementById('busca-lista-op').value.toLowerCase();
            const container = document.getElementById('container-filas');
            container.innerHTML = maquinas.map(m => {
                const filaFiltrada = m.fila.filter(op => op.op.toLowerCase().includes(termo) || op.cliente.toLowerCase().includes(termo) || op.produto.toLowerCase().includes(termo));
                if (filaFiltrada.length === 0 && termo !== "") return ""; 
                return `<div class="bg-white p-4 md:p-6 rounded-3xl shadow-sm border border-slate-100">
                    <div class="flex items-center gap-2 mb-4"><div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-lg flex items-center justify-center font-bold">${m.id}</div><h3 class="font-black text-slate-700 text-lg">${m.nome}</h3></div>
                    <div class="scrolling-wrapper">
                        ${filaFiltrada.map((op, i) => `
                        <div class="ticket-card group shrink-0">
                            <div class="bg-slate-50 p-2 border-b flex justify-between">
                                <button onclick="deletarOP(${m.id}, ${i})" class="text-slate-300 hover:text-red-500 px-2"><i class="fa-solid fa-trash"></i></button>
                                <span class="text-xs font-black text-slate-400">#${i+1}</span>
                            </div>
                            <div class="p-3 flex-1">
                                <div class="flex justify-between mb-1"><span class="font-black text-blue-600 text-lg">${op.op}</span><span class="font-bold text-slate-600">${op.qtd} un</span></div>
                                <div class="text-xs font-bold text-slate-500 truncate mb-1">${op.cliente}</div>
                                <div class="text-xs font-black text-slate-800 truncate">${op.produto}</div>
                                <div class="bg-blue-50/50 p-2 rounded border border-blue-100 mt-2 text-[9px] font-bold text-slate-500">
                                    <div>MAT: ${op.material||'-'} (${op.materialQtd||'-'})</div>
                                    <div>COR: ${op.pigmento||'-'} (${op.porcentagem||'-'})</div>
                                    <div>CX: ${op.caixa||'-'} | SC: ${op.saco||'-'}</div>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-2 border-t flex justify-between items-center">
                                <button onclick="abrirModalEdicao(${m.id}, ${i})" class="text-[10px] font-black text-blue-600 border border-blue-200 px-2 py-1 rounded bg-white">EDITAR</button>
                                <div class="flex gap-1"><button onclick="moverFila(${m.id},${i},-1)" class="btn-mover"><i class="fa-solid fa-chevron-left"></i></button><button onclick="moverFila(${m.id},${i},1)" class="btn-mover"><i class="fa-solid fa-chevron-right"></i></button></div>
                            </div>
                        </div>`).join('') || '<span class="text-slate-400 text-xs font-bold p-4">Fila Vazia</span>'}
                    </div>
                </div>`;
            }).join('');
        }

        function iniciarRelogio() {
            if (relogioInterval) clearInterval(relogioInterval);
            relogioInterval = setInterval(() => {
                const agora = getBrasiliaDate();
                document.getElementById('relogio').innerText = agora.toLocaleTimeString('pt-BR');
                renderBotaoExtra();
                const ehFds = isFimDeSemana(agora);
                if(ehFds && !fdsAtivo && !modoHoraExtra) { fdsAtivo=true; maquinas.forEach(m=>{ if(m.lastStatusChange) { m.accumulatedStatusTime+=(Date.now()-m.lastStatusChange); m.lastStatusChange=null; } }); salvarAutomatico(); }
                else if(!ehFds && fdsAtivo) { fdsAtivo=false; maquinas.forEach(m=>m.lastStatusChange=Date.now()); salvarAutomatico(); }
                const bdg = document.getElementById('badge-auto');
                if(ehFds && !modoHoraExtra) { bdg.innerText="FDS PAUSA"; bdg.className="bg-yellow-500 text-[9px] px-2 py-1 rounded font-black text-white"; return; }
                if(modoHoraExtra) { bdg.innerText="EXTRA ON"; bdg.className="bg-purple-600 text-[9px] px-2 py-1 rounded font-black animate-pulse text-white"; }
                else if(sistemaPausado) { bdg.innerText="PAUSADO"; bdg.className="bg-orange-500 text-[9px] px-2 py-1 rounded font-black text-white"; return; }
                else { bdg.innerText = manualOverride ? "MANUAL" : "AUTO"; bdg.className = manualOverride ? "bg-blue-500 text-[9px] px-2 py-1 rounded font-black text-white" : "bg-green-500 text-[9px] px-2 py-1 rounded font-black animate-pulse text-white"; }
                processarTurnoAuto();
                const t = document.getElementById('filtro-turno').value;
                maquinas.forEach(m => {
                    if (m.status === "23-EMPRESA FECHADA") return;
                    if (m.status.includes("SEM") || m.status.includes("PARADA")) { m.dadosTurno[t].tempoSemProg++; m.resumoTurno[t].tempoSemProg++; return; }
                    if (m.status.includes("PRODU√á√ÉO") || m.status.includes("BAIXA") || m.status.includes("MATERIA")) { if(ehFds && modoHoraExtra) dadosMensais.tempoHoraExtraTotal++; else dadosMensais.tempoProducaoTotal++; }
                    if(m.status.includes("PRODU√á√ÉO")) { m.dadosTurno[t].tempoProducao++; m.resumoTurno[t].tempoProducao++; }
                    else if(m.status.includes("BAIXA") || m.status.includes("MATERIA")) { m.dadosTurno[t].tempoBaixa++; m.resumoTurno[t].tempoBaixa++; }
                    else { m.dadosTurno[t].paradas++; m.resumoTurno[t].paradas++; }
                });
                if(usuarioLogado) { updateTimersVisualOnly(); if(usuarioLogado==='admin') { calcEficienciaGlobal(); if(document.getElementById('aba-graficos').classList.contains('aba-ativa')) atualizarResumoGlobalNumeros(); if(document.getElementById('aba-apontamento').classList.contains('aba-ativa')) renderApontamento(); } }
            }, 1000);
        }

        function updateTimersVisualOnly() {
            if(!usuarioLogado) return;
            const now = Date.now();
            const lista = usuarioLogado!=='admin' ? maquinas.filter(m=>m.id===usuarioLogado) : maquinas;
            lista.forEach(m => {
                const el = document.getElementById(`timer-display-${m.id}`);
                if(el) {
                    let diff = (m.accumulatedStatusTime||0);
                    if(m.lastStatusChange) diff += (now - m.lastStatusChange);
                    diff/=1000;
                    if(m.status.includes('PRODU√á√ÉO')) el.innerHTML = `<span class="text-green-600">PRODUZINDO: ${fmtTempo(diff)}</span>`;
                    else if(m.status.includes('PARADA')) el.innerHTML = `<span class="text-purple-600">PARADA PROG: ${fmtTempo(diff)}</span>`;
                    else if(m.status.includes('FECHADA')) el.innerHTML = `<span class="text-slate-400">DESLIGADA</span>`;
                    else el.innerHTML = `<span class="text-red-500">PARADO: ${fmtTempo(diff)}</span>`;
                }
            });
        }
        
        function processarTurnoAuto() { if(manualOverride) return; const d=getBrasiliaDate(), m=d.getHours()*60+d.getMinutes(); let t=3; if(m>=300 && m<858) t=1; else if(m>=858 && m<1416) t=2; const el=document.getElementById('filtro-turno'); if(el.value!=t) { el.value=t; if(usuarioLogado) render(); } }
        function toggleReset(id) { const el = document.getElementById(`modal-reset-${id}`); if(el) el.style.display = el.style.display==='block'?'none':'block'; }
        function resetarValor(id, campo) { if(confirm("Zerar valor?")) { const t = document.getElementById('filtro-turno').value; maquinas.find(x => x.id === id).dadosTurno[t][campo] = 0; document.getElementById(`modal-reset-${id}`).style.display = 'none'; render(); if(usuarioLogado === 'admin') renderApontamento(); forcarSalvarImediato(); } }
        function resetarTurnoCompleto() { if(confirm("ZERAR TUDO DO TURNO?")) { const t=document.getElementById('filtro-resumo').value; if(t==='todas') return alert('Selecione um turno espec√≠fico'); maquinas.forEach(m => m.dadosTurno[t] = createZero()); renderApontamento(); forcarSalvarImediato(); } }
        function resetarMes() { if(confirm("Zerar horas mensais?")) { dadosMensais.tempoProducaoTotal = 0; dadosMensais.tempoHoraExtraTotal = 0; calcEficienciaGlobal(); forcarSalvarImediato(); } }
        function togglePause() { sistemaPausado = !sistemaPausado; document.getElementById('btn-pause').innerHTML = sistemaPausado ? '<i class="fa-solid fa-play"></i> RETOMAR' : '<i class="fa-solid fa-pause"></i> PAUSAR'; salvarAutomatico(); }
        function toggleHoraExtra() { if (!isFimDeSemana(getBrasiliaDate())) return alert("Apenas FDS!"); modoHoraExtra = !modoHoraExtra; renderBotaoExtra(); forcarSalvarImediato(); }
        function addRefugo(id) { const m=maquinas.find(x=>x.id===id); m.dadosTurno[document.getElementById('filtro-turno').value].refugo++; render(); salvarAutomatico(); }
        function apontarManual(id) { const v=parseInt(document.getElementById(`qtd-prod-${id}`).value); if(v>0) { maquinas.find(x=>x.id===id).dadosTurno[document.getElementById('filtro-turno').value].boas+=v; document.getElementById(`qtd-prod-${id}`).value=''; render(); salvarAutomatico(); } }
        function atualizarStatus(id, st) { const m=maquinas.find(x=>x.id===id); m.status=st; m.lastStatusChange=Date.now(); m.accumulatedStatusTime=0; render(); forcarSalvarImediato(); }
        function finalizarOP(id) { if(confirm("Finalizar O.P?")) { const m = maquinas.find(x=>x.id===id); const op = m.fila.shift(); if(op) historico.push({...op, data: new Date().toISOString(), maquina: m.nome, qtdFeita: m.dadosTurno[document.getElementById('filtro-turno').value].boas||0, status: 'CONCLU√çDO'}); m.dadosTurno[document.getElementById('filtro-turno').value]=createZero(); render(); renderListaOPs(); forcarSalvarImediato(); } }
        function abrirModalCriacao() { document.getElementById('modal-editar-op').style.display='flex'; document.getElementById('modo-edicao').value="false"; ['edit-op-num','edit-op-cliente','edit-op-qtd','edit-op-material','edit-op-material-qtd','edit-op-pigmento','edit-op-porcentagem','edit-op-caixa','edit-op-saco'].forEach(id=>document.getElementById(id).value=''); }
        function fecharModalEdicao() { document.getElementById('modal-editar-op').style.display='none'; }
        function abrirModalEdicao(id, idx) { const m = maquinas.find(x=>x.id===id); const op = m.fila[idx]; document.getElementById('modal-editar-op').style.display='flex'; document.getElementById('modo-edicao').value="true"; document.getElementById('edit-maq-id').value=id; document.getElementById('edit-op-index').value=idx; document.getElementById('edit-op-num').value=op.op; document.getElementById('edit-op-cliente').value=op.cliente; document.getElementById('edit-op-qtd').value=op.qtd; document.getElementById('edit-op-produto').value=op.produto; document.getElementById('edit-op-material').value=op.material||''; document.getElementById('edit-op-material-qtd').value=op.materialQtd||''; document.getElementById('edit-op-pigmento').value=op.pigmento||''; document.getElementById('edit-op-porcentagem').value=op.porcentagem||''; document.getElementById('edit-op-caixa').value=op.caixa||''; document.getElementById('edit-op-saco').value=op.saco||''; document.getElementById('edit-op-operador').value=op.operador; }
        
        function gerenciarOperador(a) { if(a==='add'){ const v=document.getElementById('novo-operador').value.trim(); if(v && !operadoresGlobais.includes(v)) { operadoresGlobais.push(v); document.getElementById('novo-operador').value=''; } } renderOperadoresConfig(); atualizarDropdowns(); forcarSalvarImediato(); }
        function deletarOperador(n) { operadoresGlobais=operadoresGlobais.filter(x=>x!==n); renderOperadoresConfig(); atualizarDropdowns(); forcarSalvarImediato(); }
        function renderOperadoresConfig() { document.getElementById('lista-operadores-config').innerHTML = operadoresGlobais.map(o => `<div class="bg-green-50 border border-green-200 text-green-700 px-3 py-1 rounded-lg font-bold flex gap-2 text-xs items-center">üë§ ${o} <button onclick="deletarOperador('${o}')" class="text-red-500 font-black hover:text-red-700">&times;</button></div>`).join(''); }
        function gerenciarProdutoCatalog(a) { if(a==='add'){ const v=document.getElementById('novo-produto-catalog').value.trim(); if(v && !produtosGlobais.includes(v)) { produtosGlobais.push(v); document.getElementById('novo-produto-catalog').value=''; } } renderProdutosConfig(); atualizarDropdowns(); forcarSalvarImediato(); }
        function deletarProdutoCatalog(n) { produtosGlobais=produtosGlobais.filter(x=>x!==n); renderProdutosConfig(); atualizarDropdowns(); forcarSalvarImediato(); }
        function renderProdutosConfig() { const t=document.getElementById('busca-produto-catalog').value.toLowerCase(); const f=produtosGlobais.filter(p=>p.toLowerCase().includes(t)); document.getElementById('lista-produtos-config').innerHTML = f.map(p=>`<div class="bg-purple-50 border border-purple-200 text-purple-700 px-3 py-1 rounded-lg font-bold flex gap-2 text-xs items-center">üì¶ ${p} <button onclick="deletarProdutoCatalog('${p}')" class="text-red-500 font-black hover:text-red-700">&times;</button></div>`).join(''); }
        function atualizarDropdowns() { const opH = '<option value="">-- Selecione --</option>' + operadoresGlobais.map(o => `<option value="${o}">${o}</option>`).join(''); document.getElementById('edit-op-operador').innerHTML = opH; const prH = '<option value="">-- Selecione --</option>' + produtosGlobais.map(p => `<option value="${p}">${p}</option>`).join(''); document.getElementById('edit-op-produto').innerHTML = prH; }
        
        function toggleMenuOperador(event, id) { event.stopPropagation(); const menuAtual = document.getElementById(`menu-op-${id}`); const estavaAberto = !menuAtual.classList.contains('hidden'); document.querySelectorAll('.menu-operador-dropdown').forEach(el => el.classList.add('hidden')); if(!estavaAberto) { menuAtual.classList.remove('hidden'); } }
        function fecharMenusGlobais(event) { if (!event.target.closest('.dropdown-container')) document.querySelectorAll('.menu-operador-dropdown').forEach(el => el.classList.add('hidden')); if (!event.target.closest('.modal-reset') && !event.target.closest('button[onclick^="toggleReset"]')) document.querySelectorAll('.modal-reset').forEach(el => el.style.display = 'none'); }
        function abrirModalCores() { document.getElementById('modal-cores').style.display='flex'; renderCoresModal(); }
        function fecharModalCores() { document.getElementById('modal-cores').style.display='none'; }
        function renderCoresModal() { document.getElementById('lista-cores-modal').innerHTML = coresGlobais.map(c => `<div class="bg-slate-100 border px-3 py-1 rounded-lg font-bold flex gap-2 text-xs items-center">${c} <button onclick="deletarCor('${c}')" class="text-red-500 font-black">&times;</button></div>`).join(''); }
        function addCorModal() { const v = document.getElementById('nova-cor-modal').value.trim(); if(v && !coresGlobais.includes(v)) { coresGlobais.push(v); document.getElementById('nova-cor-modal').value=''; renderCoresModal(); forcarSalvarImediato(); } }
        function deletarCor(c) { coresGlobais=coresGlobais.filter(x=>x!==c); renderCoresModal(); forcarSalvarImediato(); }
        function alterarFiltroGrafico(valor) { filtroGraficoId = valor; atualizarResumoGlobalNumeros(); iniciarGraficos(); }
        function atualizarResumoGlobalNumeros() { if(usuarioLogado !== 'admin') return; const t = document.getElementById('filtro-turno').value; let d = { tp:0, tb:0, pa:0, sp:0 }; maquinas.forEach(m => { if(filtroGraficoId==='todas' || m.id==filtroGraficoId) { if(m.resumoTurno[t]) { d.tp += (m.resumoTurno[t].tempoProducao || 0); d.tb += (m.resumoTurno[t].tempoBaixa || 0); d.pa += (m.resumoTurno[t].paradas || 0); d.sp += (m.resumoTurno[t].tempoSemProg || 0); } } }); if(document.getElementById('global-timer-prod')) { document.getElementById('global-timer-prod').innerText = fmtTempo(d.tp); document.getElementById('global-timer-baixa').innerText = fmtTempo(d.tb); document.getElementById('global-timer-parado').innerText = fmtTempo(d.pa); document.getElementById('global-timer-semprog').innerText = fmtTempo(d.sp); } }
        function renderApontamento() { const turno = document.getElementById('filtro-resumo').value; const tBody = document.getElementById('tabela-apontamento'); tBody.innerHTML = maquinas.map(m => { let d = { boas:0, refugo:0, tempoProducao:0, paradas:0, tempoBaixa:0, tempoSemProg:0 }; if(turno === 'todas') { [1,2,3].forEach(t => { d.boas+=m.dadosTurno[t].boas; d.refugo+=m.dadosTurno[t].refugo; d.tempoProducao+=m.dadosTurno[t].tempoProducao; d.paradas+=m.dadosTurno[t].paradas; d.tempoBaixa+=m.dadosTurno[t].tempoBaixa; d.tempoSemProg+=m.dadosTurno[t].tempoSemProg; }); } else { d = m.dadosTurno[turno]; } const perc = d.boas > 0 ? ((d.refugo/(d.boas+d.refugo))*100).toFixed(1) : 0; return `<tr class="border-b border-slate-100 hover:bg-slate-50"><td class="p-3 font-bold">${m.nome}</td><td class="p-3 text-xs">${m.fila[0]?.op || '-'}</td><td class="p-3 text-green-600 font-bold text-lg">${d.boas}</td><td class="p-3 text-red-500 font-bold">${d.refugo}</td><td class="p-3 text-red-400 text-xs">${perc}%</td><td class="p-3 text-slate-500 font-mono text-xs bg-green-50">${fmtTempo(d.tempoProducao)}</td><td class="p-3 text-slate-500 font-mono text-xs bg-orange-50">${fmtTempo(d.tempoBaixa)}</td><td class="p-3 text-slate-500 font-mono text-xs bg-red-50">${fmtTempo(d.paradas)}</td><td class="p-3 text-slate-400 font-mono text-xs bg-slate-100">${fmtTempo(d.tempoSemProg)}</td></tr>`; }).join(''); }
        function calcEficienciaGlobal() { if(usuarioLogado !== 'admin') return; const h = ((dadosMensais.tempoProducaoTotal || 0) + (dadosMensais.tempoHoraExtraTotal || 0)) / 3600; document.getElementById('horas-trabalhadas-mes').innerText = h.toFixed(1) + "h"; document.getElementById('meta-global').innerText = ((h / 1628) * 100).toFixed(1) + "%"; }
        function limparBuscaHistorico() { document.getElementById('busca-historico-op').value=''; renderHistorico(); }
        function renderHistorico() { if(usuarioLogado !== 'admin') return; const opFilter = document.getElementById('busca-historico-op').value.toLowerCase(); const filtered = historico.slice().reverse().filter(h => String(h.op).toLowerCase().includes(opFilter)); document.getElementById('lista-historico').innerHTML = filtered.map(h => `<tr class="border-b hover:bg-slate-50"><td class="p-3 text-xs text-slate-500">${new Date(h.data).toLocaleString('pt-BR')}</td><td class="p-3"><span class="text-[9px] font-black px-2 py-1 rounded ${h.status==='CANCELADO'?'bg-red-100 text-red-600':'bg-green-100 text-green-600'}">${h.status||'CONCLU√çDO'}</span></td><td class="p-3 font-bold text-blue-600">${h.maquina}</td><td class="p-3 font-bold">${h.op}</td><td class="p-3 text-xs uppercase">${h.produto}</td><td class="p-3 font-bold">${h.qtdFeita}</td><td class="p-3 text-right text-green-500"><i class="fa-solid fa-check"></i></td></tr>`).join(''); }

        // --- SISTEMA DE ABAS (CR√çTICO) ---
        function trocarAba(id) { 
            // 1. Esconde todas as abas
            document.querySelectorAll('.aba-conteudo').forEach(a => a.classList.remove('aba-ativa')); 
            
            // 2. Tira o destaque de todos os bot√µes
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
            
            // 3. Mostra a aba clicada
            document.getElementById('aba-' + id).classList.add('aba-ativa'); 
            
            // 4. Destaca o bot√£o clicado
            document.getElementById('btn-' + id).classList.add('active'); 
            
            // 5. Carrega conte√∫do espec√≠fico se necess√°rio
            if(id==='lista') { renderListaOPs(); }
            if(id==='graficos') { iniciarGraficos(); }
            if(id==='apontamento') { renderApontamento(); }
        }

        // --- CHART.JS ---
        function iniciarGraficos() {
            const ctx = document.getElementById('chartOEE');
            if(!ctx || charts.oee) return;
            charts.oee = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Produzindo', 'Baixa Efic.', 'Parado', 'Neutro'], datasets: [{ data: [0,0,0,1], backgroundColor: ['#22c55e', '#f97316', '#ef4444', '#cbd5e1'], borderWidth: 0, hoverOffset: 4 }] },
                options: { responsive: true, cutout: '70%', plugins: { legend: { display: false }, datalabels: { color: '#fff', font: { weight: 'bold', size: 14 }, formatter: (value, ctx) => { let sum = 0; let dataArr = ctx.chart.data.datasets[0].data; dataArr.map(data => { sum += data; }); if (sum === 0) return ''; let percentage = (value*100 / sum).toFixed(0)+"%"; return value > 0 ? percentage : ''; } } } }
            });

            // Outros gr√°ficos (Barras)
            if(!charts.paradas) {
               charts.paradas = new Chart(document.getElementById('chartParadas'), { type: 'bar', data: { labels: [], datasets: [{ label:'Minutos', data: [], backgroundColor:'#ef4444', borderRadius: 4 }] }, options: { responsive: true, plugins: { legend: {display:false} } } });
               charts.refugos = new Chart(document.getElementById('chartRefugos'), { type: 'bar', data: { labels: [], datasets: [{ label:'Pe√ßas', data: [], backgroundColor:'#ef4444', borderRadius: 4 }] }, options: { responsive: true, plugins: { legend: {display:false} } } });
               charts.horas = new Chart(document.getElementById('chartHorasExtras'), { type: 'bar', data: { labels: ['M√™s'], datasets: [{ label:'Normal', data:[0], backgroundColor:'#3b82f6'}, { label:'Extra', data:[0], backgroundColor:'#9333ea'}] }, options: { indexAxis: 'y', responsive: true } });
            }
        }

        window.addEventListener('beforeunload', () => { forcarSalvarImediato(); });
        setTimeout(() => { if(document.getElementById('loading-spinner').style.display !== 'none') document.getElementById('aviso-demora').style.display='block'; }, 4000);
        carregarBanco();
    </script>
</body>
</html>
