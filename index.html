<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRIPLAST | Sistema de Gestão Industrial</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap');
        
        :root { 
            --primary: #0f172a; 
            --accent: #2563eb; 
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        body { 
            background: var(--bg-gradient);
            font-family: 'Inter', sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            margin: 0; 
        }
        
        /* Navegação */
        .sidebar-btn { 
            transition: all 0.2s ease; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            width: 100%; 
            padding: 16px; 
            font-weight: 600; 
            color: #64748b; 
            cursor: pointer; 
            background: transparent; 
            border: none;
        }
        .sidebar-btn:hover { background: #f1f5f9; color: var(--accent); padding-left: 20px; }
        .sidebar-btn.active { background: var(--primary); color: white; box-shadow: 0 8px 20px -6px rgba(15, 23, 42, 0.4); padding-left: 16px; }
        
        /* Abas (Views) */
        .view-section { display: none; height: 100%; overflow-y: auto; padding-bottom: 120px; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Login */
        #login-screen { display: flex !important; }

        /* Elementos de Destaque */
        .card-maquina {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-maquina:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="flex text-slate-800">

    <div id="login-screen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white p-12 rounded-[40px] shadow-2xl w-full max-w-sm text-center border-4 border-slate-800 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-600 to-indigo-600"></div>
            <div class="mb-8">
                <div class="w-20 h-20 bg-slate-900 rounded-3xl mx-auto flex items-center justify-center text-white text-3xl mb-4 shadow-lg ring-4 ring-slate-100">
                    <i class="fa-solid fa-industry"></i>
                </div>
                <h1 class="text-4xl font-black text-slate-900 italic tracking-tighter">TRIPLAST</h1>
                <p class="text-slate-400 font-bold uppercase text-[10px] tracking-[0.3em] mt-2">Sistema Industrial</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="pass-code" placeholder="Senha de Acesso" class="w-full p-4 bg-slate-50 rounded-2xl text-center font-bold outline-none border-2 border-slate-100 focus:border-blue-600 focus:bg-white transition-all text-lg">
                <button onclick="tentarLogin()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold hover:bg-blue-600 transition-all shadow-lg">ENTRAR</button>
            </div>
            <p class="mt-8 text-[10px] text-slate-400 font-medium">Admin: 2026 | Máq: M1 a M4</p>
        </div>
    </div>

    <aside id="sidebar" class="w-72 bg-white border-r border-slate-200 p-6 flex flex-col hidden h-full z-10 shadow-xl">
        <div class="mb-10 px-2">
            <h2 class="text-3xl font-black italic text-slate-900 tracking-tighter">TRIPLAST</h2>
            <div class="flex items-center gap-2 mt-2">
                <span id="status-bolinha" class="w-2 h-2 rounded-full bg-red-500"></span>
                <span id="status-texto" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Desconectado</span>
            </div>
        </div>
        <nav class="space-y-2 flex-1">
            <button onclick="nav('dashboard')" id="btn-dashboard" class="sidebar-btn active"><i class="fa-solid fa-layer-group w-6"></i> Painel Geral</button>
            <button onclick="nav('ops')" id="btn-ops" class="sidebar-btn"><i class="fa-solid fa-file-invoice w-6"></i> Fila de Pedidos</button>
            <button onclick="nav('produtos')" id="btn-produtos" class="sidebar-btn"><i class="fa-solid fa-box w-6"></i> Produtos</button>
            <button onclick="nav('equipe')" id="btn-equipe" class="sidebar-btn"><i class="fa-solid fa-users w-6"></i> Equipe</button>
            <button onclick="nav('graficos')" id="btn-graficos" class="sidebar-btn"><i class="fa-solid fa-chart-pie w-6"></i> Relatórios</button>
        </nav>
        <button onclick="location.reload()" class="sidebar-btn text-red-400 hover:bg-red-50 hover:text-red-600 mt-auto"><i class="fa-solid fa-power-off w-6"></i> Sair</button>
    </aside>

    <main id="main-content" class="flex-1 h-full relative hidden bg-[#f8fafc]">
        
        <header class="p-8 pb-4 flex justify-between items-end bg-white/80 backdrop-blur-md sticky top-0 z-20 border-b border-slate-200/60">
            <div>
                <h2 id="page-title" class="text-3xl font-black text-slate-800 uppercase tracking-tight">Visão Geral</h2>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mt-1">Monitoramento em Tempo Real</p>
            </div>
            <div id="clock" class="text-3xl font-black text-slate-300 font-mono tracking-tighter">00:00</div>
        </header>

        <div id="view-dashboard" class="view-section active px-8 pt-6">
            <div id="grid-maquinas" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                </div>
        </div>

        <div id="view-ops" class="view-section px-8 pt-6">
            <div class="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100 mb-8">
                <h3 class="font-black text-xl mb-6 uppercase text-slate-800">Nova Ordem de Produção</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Produto</label>
                        <select id="op-produto" onchange="autoPreencherOP()" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold outline-none"></select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Quantidade</label>
                        <input type="number" id="op-qtd" placeholder="0" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold outline-none">
                    </div>
                    <button onclick="criarOP()" class="bg-slate-900 text-white rounded-2xl font-bold hover:bg-blue-600 transition-all shadow-lg mt-5">CRIAR ORDEM</button>
                </div>
                <div id="op-info" class="mt-4 p-4 bg-blue-50 text-blue-800 rounded-2xl text-xs font-bold hidden border border-blue-100">
                    <i class="fa-solid fa-info-circle mr-2"></i> <span id="op-info-texto"></span>
                </div>
            </div>
            <h4 class="font-bold text-slate-400 uppercase text-xs mb-4 ml-2 tracking-widest">Fila de Produção</h4>
            <div id="lista-ops" class="space-y-3"></div>
        </div>

        <div id="view-produtos" class="view-section px-8 pt-6">
            <div class="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100 mb-8">
                <h3 class="font-black text-xl mb-6 uppercase">Cadastro Técnico</h3>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                    <div class="col-span-2"><input id="prod-nome" placeholder="Nome" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-100"></div>
                    <div><input id="prod-mat" placeholder="Material" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-100"></div>
                    <div><input id="prod-peso" type="number" placeholder="Peso (g)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-100"></div>
                    <div><input id="prod-ciclo" type="number" placeholder="Ciclo (s)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-100"></div>
                    <div><input id="prod-cav" type="number" placeholder="Cav." class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-100"></div>
                    <button onclick="addProduto()" class="col-span-2 md:col-span-6 bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg">SALVAR</button>
                </div>
            </div>
            <div id="lista-produtos" class="bg-white rounded-[32px] border border-slate-100 overflow-hidden shadow-sm"></div>
        </div>

        <div id="view-equipe" class="view-section px-8 pt-6">
            <div class="bg-white p-2 pr-2 pl-6 rounded-[30px] shadow-sm border border-slate-100 mb-8 flex items-center gap-4">
                <i class="fa-solid fa-user-plus text-slate-300"></i>
                <input id="op-nome" placeholder="Nome do operador..." class="flex-1 py-4 bg-transparent font-bold outline-none text-slate-700">
                <button onclick="addOperador()" class="bg-slate-900 text-white px-8 py-4 rounded-[24px] font-bold hover:bg-black transition-all shadow-lg">ADICIONAR</button>
            </div>
            <div id="lista-equipe" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </div>

        <div id="view-graficos" class="view-section px-8 pt-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100 h-96 relative">
                    <h4 class="font-black text-sm uppercase text-slate-400 mb-6">Produção Total</h4>
                    <div class="absolute inset-x-8 bottom-8 top-20"><canvas id="grafico-prod"></canvas></div>
                </div>
                <div class="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100 h-96 relative">
                    <h4 class="font-black text-sm uppercase text-slate-400 mb-6">Refugo</h4>
                    <div class="absolute inset-x-8 bottom-8 top-20"><canvas id="grafico-refugo"></canvas></div>
                </div>
            </div>
        </div>
    </main>

    <div id="maquina-kiosk" class="fixed inset-0 z-50 bg-[#f8fafc] hidden flex flex-col p-6">
        <header class="flex justify-between items-center mb-6 bg-white p-6 rounded-[24px] shadow-sm border border-slate-100">
            <h1 class="text-4xl font-black italic text-slate-900 tracking-tighter">TRIPLAST <span id="kiosk-maq-nome" class="text-blue-600"></span></h1>
            <div class="flex items-center gap-4">
                <div id="kiosk-clock" class="text-2xl font-bold text-slate-300 font-mono">00:00</div>
                <button onclick="location.reload()" class="bg-red-50 text-red-500 px-6 py-3 rounded-xl font-bold text-sm hover:bg-red-500 hover:text-white transition-colors">SAIR</button>
            </div>
        </header>
        
        <div class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-7 bg-white rounded-[40px] p-10 shadow-lg border border-slate-100 flex flex-col relative overflow-hidden">
                <div class="absolute top-0 right-0 w-80 h-80 bg-blue-50 rounded-full blur-3xl -mr-10 -mt-10 opacity-60 pointer-events-none"></div>
                
                <div class="relative z-10 flex-1 flex flex-col justify-center">
                    <span class="text-blue-500 font-black uppercase text-xs tracking-[0.2em] mb-4">Ordem de Produção Atual</span>
                    <h2 id="kiosk-op" class="text-5xl font-black text-slate-800 mb-10 leading-tight">AGUARDANDO...</h2>
                    
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div class="bg-slate-50 p-6 rounded-[24px] border border-slate-100">
                            <span class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Meta</span>
                            <div class="flex items-baseline gap-1">
                                <span id="kiosk-meta" class="text-4xl font-black text-slate-800">0</span>
                                <span class="text-xs font-bold text-slate-400">pçs</span>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-600 to-indigo-600 p-6 rounded-[24px] text-white shadow-xl shadow-blue-200">
                            <span class="block text-[10px] font-black text-blue-200 uppercase tracking-widest mb-2">Realizado</span>
                            <div class="flex items-baseline gap-1">
                                <span id="kiosk-real" class="text-4xl font-black">0</span>
                                <span class="text-xs font-bold text-blue-200">pçs</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="relative z-10 flex gap-3 mt-auto pt-8 border-t border-slate-100">
                    <select id="kiosk-select-op" class="flex-1 bg-slate-50 border border-slate-200 rounded-2xl p-4 font-bold outline-none text-slate-700"></select>
                    <button onclick="iniciarOPMaquina()" class="bg-slate-900 text-white px-8 rounded-2xl font-bold hover:scale-[1.02] transition-transform shadow-lg">PUXAR DA FILA</button>
                </div>
            </div>

            <div class="lg:col-span-5 grid grid-rows-2 gap-6">
                <button onclick="acaoMaquina('prod')" class="bg-white border-2 border-blue-100 active:bg-blue-50 active:scale-95 rounded-[40px] flex flex-col items-center justify-center shadow-sm hover:shadow-xl hover:border-blue-300 transition-all group">
                    <div class="w-24 h-24 bg-blue-600 text-white rounded-full flex items-center justify-center text-4xl mb-4 shadow-xl shadow-blue-200 group-active:scale-90 transition-transform">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                    <span class="text-3xl font-black text-slate-800 tracking-tight">PRODUÇÃO</span>
                    <span class="text-xs font-bold text-slate-400 mt-2 uppercase tracking-widest">Toque para apontar (+1)</span>
                </button>
                
                <div class="grid grid-cols-2 gap-6">
                    <button onclick="acaoMaquina('refugo')" class="bg-white border-2 border-red-50 active:bg-red-50 active:scale-95 rounded-[40px] font-black flex flex-col items-center justify-center shadow-sm hover:shadow-lg hover:border-red-200 transition-all text-red-500 group">
                        <i class="fa-solid fa-trash text-3xl mb-4 group-active:scale-90 transition-transform"></i> 
                        <span class="text-lg">REFUGO</span>
                    </button>
                    <button onclick="acaoMaquina('parada')" id="btn-status-maq" class="bg-yellow-50 border-2 border-yellow-100 active:bg-yellow-100 active:scale-95 text-yellow-700 rounded-[40px] font-black flex flex-col items-center justify-center shadow-sm hover:shadow-lg transition-all group">
                        <i class="fa-solid fa-pause text-3xl mb-4 group-active:scale-90 transition-transform"></i> 
                        <span class="text-lg">PARAR</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://hgqnlqtvjiyuwnwypxxh.supabase.co'; 
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhncW5scXR2aml5dXdud3lweHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjE1MDcsImV4cCI6MjA4NjQzNzUwN30.njSVfWDpIJK49IpRSgyMf6e5MEmJ-AROVT7-nOTZD9Y'; 
        const sb = supabase.createClient(SB_URL, SB_KEY);
        
        // --- 1. VARIÁVEIS DO SEU CÓDIGO ANTIGO RESTAURADAS ---
        let maquinas = [];
        let produtosGlobais = [];
        let operadoresGlobais = [];
        let ops = []; // Fila de Pedidos
        let historico = [];
        let dadosMensais = {};
        let modoHoraExtra = false;
        
        let currentUser = null;
        let saveTimer = null;

        window.onload = function() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            
            setInterval(() => {
                const t = new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                document.getElementById('clock').innerText = t;
                document.getElementById('kiosk-clock').innerText = t;
            }, 1000);
        };

        // --- 2. LOGIN ---
        function tentarLogin() {
            const pass = document.getElementById('pass-code').value.trim().toUpperCase();
            const mapMaq = { 'M1': 0, 'M2': 1, 'M3': 2, 'M4': 3 };

            if (pass === '2026') {
                currentUser = 'ADMIN';
                animarEntrada('admin');
            } else if (mapMaq.hasOwnProperty(pass)) {
                currentUser = mapMaq[pass];
                animarEntrada('maquina');
            } else {
                alert("SENHA INCORRETA");
            }
        }

        async function animarEntrada(tipo) {
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(async () => {
                document.getElementById('login-screen').style.display = 'none';
                await carregarBanco();
                if(tipo === 'admin') {
                    document.getElementById('sidebar').classList.remove('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    nav('dashboard');
                } else {
                    document.getElementById('maquina-kiosk').classList.remove('hidden');
                    renderKiosk();
                }
            }, 500);
        }

        // --- 3. BANCO DE DADOS (LÓGICA DO SEU SISTEMA.TXT) ---
        async function carregarBanco() {
            try {
                const { data } = await sb.from('sistema').select('conteudo').eq('id', 1).single();
                if (data && data.conteudo) {
                    const c = data.conteudo;
                    // Recupera todas as variáveis do seu sistema antigo
                    maquinas = c.maquinas || [];
                    produtosGlobais = c.produtos || [];
                    operadoresGlobais = c.operadores || [];
                    ops = c.ops || [];
                    historico = c.historico || [];
                    dadosMensais = c.dadosMensais || {};
                    
                    if(maquinas.length < 4) resetMaquinas();
                    
                    document.getElementById('status-bolinha').classList.replace('bg-red-500', 'bg-green-500');
                    document.getElementById('status-texto').innerText = "CONECTADO";
                    document.getElementById('status-texto').classList.replace('text-slate-400', 'text-green-500');
                } else {
                    resetMaquinas();
                    salvarGeral();
                }
            } catch (e) { 
                console.error(e); 
                resetMaquinas(); 
            }
        }

        function resetMaquinas() {
            if(!maquinas || maquinas.length === 0) {
                maquinas = [
                    { id: 0, nome: 'INJETORA 1', status: 'parada', prod: 0, refugo: 0, op: null },
                    { id: 1, nome: 'INJETORA 2', status: 'parada', prod: 0, refugo: 0, op: null },
                    { id: 2, nome: 'INJETORA 3', status: 'parada', prod: 0, refugo: 0, op: null },
                    { id: 3, nome: 'INJETORA 4', status: 'parada', prod: 0, refugo: 0, op: null }
                ];
            }
        }

        async function salvarGeral() {
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                await sb.from('sistema').upsert({ 
                    id: 1, 
                    conteudo: { 
                        maquinas, 
                        produtos: produtosGlobais, 
                        operadores: operadoresGlobais, 
                        ops, 
                        historico,
                        dadosMensais,
                        lastUpdate: Date.now()
                    } 
                });
            }, 1000);
        }

        // --- 4. NAVEGAÇÃO ---
        function nav(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('view-' + view).classList.add('active');
            document.getElementById('btn-' + view).classList.add('active');
            
            if(view === 'dashboard') renderDashboard();
            if(view === 'ops') renderListaOPs();
            if(view === 'produtos') renderListaProdutos();
            if(view === 'equipe') renderListaEquipe();
            if(view === 'graficos') renderGraficos();
        }

        // --- 5. RENDERIZAÇÃO DAS MÁQUINAS (A LÓGICA QUE VOCÊ QUERIA) ---
        function renderDashboard() {
            const grid = document.getElementById('grid-maquinas');
            grid.innerHTML = maquinas.map(m => {
                // Cálculo de OEE Simplificado para o Card
                let statusClass = 'bg-red-500';
                let statusText = 'PARADA';
                let borderClass = 'border-red-500';
                
                if (m.status === 'rodando') {
                    statusClass = 'bg-green-500';
                    statusText = 'PRODUZINDO';
                    borderClass = 'border-green-500';
                } else if (m.status === 'setup') {
                    statusClass = 'bg-blue-500';
                    statusText = 'SETUP';
                    borderClass = 'border-blue-500';
                }

                // Progresso da O.P
                let prog = 0;
                let meta = 0;
                let nomeProd = 'Sem O.P';
                
                if (m.op) {
                    meta = m.op.qtd;
                    nomeProd = m.op.produto;
                    if(meta > 0) prog = Math.min((m.prod / meta) * 100, 100).toFixed(1);
                }

                return `
                <div class="card-maquina bg-white p-6 rounded-[32px] shadow-sm border-l-8 ${borderClass} relative overflow-hidden">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 bg-slate-900 text-white rounded-2xl flex items-center justify-center font-black italic text-xl shadow-lg">
                                M${m.id + 1}
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 leading-none text-lg">${m.nome}</h3>
                                <p class="text-xs font-bold text-slate-400 uppercase mt-1 truncate w-32">${nomeProd}</p>
                            </div>
                        </div>
                        <div class="px-3 py-1 rounded-full text-white text-[10px] font-black uppercase tracking-wider ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-1">
                            <span>Progresso</span>
                            <span>${prog}%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                            <div class="${statusClass} h-3 rounded-full transition-all duration-500" style="width: ${prog}%"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-blue-50 p-3 rounded-2xl text-center border border-blue-100">
                            <span class="block text-[10px] font-bold text-blue-400 uppercase tracking-wider">Produzido</span>
                            <span class="text-2xl font-black text-blue-700">${m.prod}</span>
                            <span class="text-[9px] text-blue-300 font-bold block">/ ${meta}</span>
                        </div>
                        <div class="bg-red-50 p-3 rounded-2xl text-center border border-red-100">
                            <span class="block text-[10px] font-bold text-red-400 uppercase tracking-wider">Refugo</span>
                            <span class="text-2xl font-black text-red-500">${m.refugo}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- 6. FUNÇÕES DE FILA E CADASTRO ---
        function criarOP() {
            const prodNome = document.getElementById('op-produto').value;
            const qtd = document.getElementById('op-qtd').value;
            if(!prodNome || !qtd) return alert("Preencha tudo!");
            
            ops.push({
                id: Math.floor(1000 + Math.random() * 9000),
                produto: prodNome,
                qtd: parseInt(qtd),
                status: 'aberta', // Vai para fila
                maquina: null,
                data: new Date().toISOString()
            });
            salvarGeral(); renderListaOPs();
            alert("Enviado para Fila!");
        }

        function renderListaOPs() {
            const container = document.getElementById('lista-ops');
            popularSelects(); // Atualiza select de produtos
            
            if(ops.length === 0) {
                container.innerHTML = '<div class="text-center p-4 text-slate-400 text-sm font-bold">Fila vazia.</div>';
                return;
            }
            
            // Ordena para mostrar as mais novas primeiro
            const listaOrdenada = [...ops].reverse();
            
            container.innerHTML = listaOrdenada.map(op => {
                let st = { color: 'blue', text: 'NA FILA' };
                if(op.status === 'em_andamento') st = { color: 'green', text: `RODANDO (${op.maquina})` };
                
                return `
                <div class="bg-white p-5 rounded-2xl border-l-4 border-${st.color}-500 shadow-sm border border-slate-100 flex justify-between items-center hover:shadow-md transition-all">
                    <div>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-wider">O.P #${op.id}</span>
                        <h4 class="font-bold text-slate-800 text-lg">${op.produto}</h4>
                    </div>
                    <div class="text-right">
                        <span class="block font-black text-2xl text-slate-800">${op.qtd}</span>
                        <span class="text-[10px] uppercase font-bold text-${st.color}-600 bg-${st.color}-50 px-2 py-1 rounded">${st.text}</span>
                    </div>
                </div>`;
            }).join('');
        }

        // --- 7. MODO KIOSK (Igual ao seu código) ---
        function renderKiosk() {
            if(currentUser === 'ADMIN') return;
            const m = maquinas[currentUser];
            
            document.getElementById('kiosk-maq-nome').innerText = m.nome;
            document.getElementById('kiosk-op').innerText = m.op ? m.op.produto : "AGUARDANDO...";
            document.getElementById('kiosk-meta').innerText = m.op ? m.op.qtd : 0;
            document.getElementById('kiosk-real').innerText = m.prod;

            const btn = document.getElementById('btn-status-maq');
            if(m.status === 'rodando') {
                btn.innerHTML = '<i class="fa-solid fa-pause text-3xl mb-4"></i><span class="text-lg">PARAR</span>';
                btn.className = "bg-yellow-50 border-4 border-yellow-100 active:bg-yellow-100 text-yellow-700 rounded-[40px] font-black flex flex-col items-center justify-center shadow-lg transition-all";
            } else {
                btn.innerHTML = '<i class="fa-solid fa-play text-3xl mb-4"></i><span class="text-lg">INICIAR</span>';
                btn.className = "bg-green-50 border-4 border-green-100 active:bg-green-100 text-green-600 rounded-[40px] font-black flex flex-col items-center justify-center shadow-lg transition-all";
            }

            // Select apenas com OPs da fila
            const select = document.getElementById('kiosk-select-op');
            const atual = select.value;
            select.innerHTML = '<option value="">▼ PUXAR PEDIDO DA FILA</option>' + 
                ops.filter(o => o.status === 'aberta').map(o => `<option value="${o.id}">#${o.id} - ${o.produto} (${o.qtd})</option>`).join('');
            if(atual) select.value = atual;
        }

        function iniciarOPMaquina() {
            const opId = document.getElementById('kiosk-select-op').value;
            if(!opId) return alert("Selecione um pedido!");
            
            const opIndex = ops.findIndex(o => o.id == opId);
            const op = ops[opIndex];
            const m = maquinas[currentUser];
            
            if(confirm(`Iniciar produção de ${op.produto}?`)) {
                op.status = 'em_andamento';
                op.maquina = m.nome;
                ops[opIndex] = op;
                
                m.op = op;
                m.prod = 0;
                m.refugo = 0;
                m.status = 'setup';
                salvarGeral(); renderKiosk();
            }
        }

        function acaoMaquina(tipo) {
            const m = maquinas[currentUser];
            if(tipo === 'parada') {
                m.status = m.status === 'rodando' ? 'parada' : 'rodando';
            } else {
                if(m.status !== 'rodando') return alert("Máquina parada! Inicie para produzir.");
                if(!m.op) return alert("Sem O.P ativa!");
                if(tipo === 'prod') m.prod++;
                if(tipo === 'refugo') m.refugo++;
            }
            salvarGeral(); renderKiosk();
        }

        // --- 8. HELPERS (Produtos, Equipe, Gráficos) ---
        function addProduto() {
            const nome = document.getElementById('prod-nome').value;
            if(nome) {
                produtosGlobais.push({
                    nome,
                    material: document.getElementById('prod-mat').value,
                    peso: document.getElementById('prod-peso').value,
                    ciclo: document.getElementById('prod-ciclo').value,
                    cav: document.getElementById('prod-cav').value
                });
                salvarGeral(); renderListaProdutos();
                document.querySelectorAll('#view-produtos input').forEach(i => i.value = '');
            }
        }
        function addOperador() {
            const nome = document.getElementById('op-nome').value;
            if(nome) { operadoresGlobais.push(nome); salvarGeral(); renderListaEquipe(); document.getElementById('op-nome').value=''; }
        }
        function renderListaProdutos() {
            document.getElementById('lista-produtos').innerHTML = `<table class="w-full text-left"><thead class="bg-slate-50 text-[10px] text-slate-400 uppercase font-black"><tr><th class="p-4">Produto</th><th class="p-4">Info</th><th class="p-4 text-right">Ação</th></tr></thead><tbody class="divide-y divide-slate-100">${produtosGlobais.map((p,i)=>`<tr class="hover:bg-slate-50"><td class="p-4 font-bold text-slate-700">${p.nome}</td><td class="p-4 text-sm text-slate-500">${p.peso}g | ${p.ciclo}s</td><td class="p-4 text-right"><button onclick="produtosGlobais.splice(${i},1);salvarGeral();renderListaProdutos()" class="text-red-400"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('')}</tbody></table>`;
        }
        function renderListaEquipe() {
            document.getElementById('lista-equipe').innerHTML = operadoresGlobais.map((o,i)=>`<div class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm"><span class="font-bold text-slate-700 ml-2">${o}</span><button onclick="operadoresGlobais.splice(${i},1);salvarGeral();renderListaEquipe()" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></div>`).join('');
        }
        function popularSelects() {
            const sel = document.getElementById('op-produto');
            if(sel && produtosGlobais.length > 0) sel.innerHTML = '<option value="">Selecione...</option>' + produtosGlobais.map(p => `<option value="${p.nome}">${p.nome}</option>`).join('');
        }
        function autoPreencherOP() {
            const nome = document.getElementById('op-produto').value;
            const p = produtosGlobais.find(x => x.nome === nome);
            const box = document.getElementById('op-info');
            if(p) { box.classList.remove('hidden'); document.getElementById('op-info-texto').innerText = `${p.material} | ${p.peso}g | Ciclo: ${p.ciclo}s`; } else { box.classList.add('hidden'); }
        }
        function renderGraficos() {
            const ctx1 = document.getElementById('grafico-prod'); const ctx2 = document.getElementById('grafico-refugo');
            if(!ctx1 || !ctx2) return;
            new Chart(ctx1, { type: 'bar', data: { labels: maquinas.map(m=>m.nome), datasets: [{ label: 'Peças', data: maquinas.map(m=>m.prod), backgroundColor: '#2563eb', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false } });
            new Chart(ctx2, { type: 'doughnut', data: { labels: maquinas.map(m=>m.nome), datasets: [{ data: maquinas.map(m=>m.refugo), backgroundColor: ['#ef4444','#f87171','#fca5a5','#fee2e2'] }] }, options: { responsive: true, maintainAspectRatio: false } });
        }
    </script>
</body>
</html>
