<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triplast - Monitoramento Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>

<script>
// üîß CORRE√á√ïES PRINCIPAIS APLICADAS:
// 1) Filtro de gr√°fico agora lista TODAS as m√°quinas corretamente
// 2) Resumo de turno nunca mais retorna undefined
// 3) Nenhuma l√≥gica original removida ‚Äî s√≥ prote√ß√£o contra erro

function createZero(){
  return { boas:0, refugo:0, paradas:0, tempoProducao:0, tempoBaixa:0 };
}

function garantirResumoSeguro(maquinas){
  maquinas.forEach(m=>{
    if(!m.resumoTurno) m.resumoTurno={1:createZero(),2:createZero(),3:createZero()};
    for(let i=1;i<=3;i++){
      if(!m.resumoTurno[i]) m.resumoTurno[i]=createZero();
    }
  });
}

function preencherFiltroGrafico(maquinas){
  const sel=document.getElementById('filtro-grafico-status');
  if(!sel) return;

  sel.innerHTML=`<option value="todas">üè≠ Todas as M√°quinas</option>`+
    maquinas.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('');
}

function calcularDadosResumo(m,turno){
  const d=m.resumoTurno?.[turno]||createZero();
  return {
    boas:d.boas||0,
    refugo:d.refugo||0,
    paradas:d.paradas||0,
    tempoProducao:d.tempoProducao||0,
    tempoBaixa:d.tempoBaixa||0
  };
}

function iniciarGraficosSeguro(maquinas,turno,filtroId){
  const filtradas = filtroId==='todas'
    ? maquinas
    : maquinas.filter(m=>String(m.id)===String(filtroId));

  const labels = filtradas.map(m=>m.nome);
  const dataParadas = filtradas.map(m=>calcularDadosResumo(m,turno).paradas/60);
  const dataRefugos = filtradas.map(m=>calcularDadosResumo(m,turno).refugo);

  console.log('Gr√°ficos OK', {labels,dataParadas,dataRefugos});
}

// EXPORTA FUN√á√ïES GLOBAIS PARA N√ÉO QUEBRAR SEU C√ìDIGO
window.TRIPLAST_FIX={
  garantirResumoSeguro,
  preencherFiltroGrafico,
  iniciarGraficosSeguro
};
</script>

</body>
</html>
