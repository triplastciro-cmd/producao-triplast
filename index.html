<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Triplast - Sistema V22 (Gerenci√°vel)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; padding-bottom: 100px; }
        .aba-conteudo { display: none; animation: fadeIn 0.4s ease-in-out; }
        .aba-ativa { display: block !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #toast-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-200%); background-color: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; z-index: 9999; display: flex; align-items: center; gap: 12px; font-size: 11px; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; transition: transform 0.4s; pointer-events: none; }
        #toast-notification.show { transform: translateX(-50%) translateY(0); }
        .status-dot { width: 10px; height: 10px; background-color: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; }
        .status-dot.saving { background-color: #eab308; box-shadow: 0 0 10px #eab308; animation: pulse 1s infinite; }
        .status-dot.error { background-color: #ef4444; box-shadow: 0 0 10px #ef4444; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .card-producao { background: white; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 12px solid #ef4444; padding: 16px; transition: all 0.2s; }
        .status-produzindo { border-left-color: #22c55e !important; background-color: #f0fdf4; }
        .status-baixa { border-left-color: #f97316 !important; background-color: #fff7ed; }
        .status-sem-prog { border-left-color: #cbd5e1 !important; background-color: #f8fafc; }
        .status-fechada { border-left-color: #475569 !important; background-color: #e2e8f0; filter: grayscale(100%); opacity: 0.8; }
        .info-badge { background: #f8fafc; padding: 8px 4px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center; display: flex; flex-direction: column; }
        .info-badge span:first-child { font-size: 0.6rem; font-weight: 800; text-transform: uppercase; color: #64748b; }
        .info-badge span:last-child { font-weight: 900; font-size: 1.1rem; }
        .scrolling-wrapper { display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 16px; padding-bottom: 20px; }
        .ticket-card { flex: 0 0 auto; width: 320px; background: white; border: 1px solid #cbd5e1; border-top: 6px solid #3b82f6; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .tab-btn { background: white; padding: 12px 24px; border-radius: 99px; font-weight: 700; font-size: 12px; cursor: pointer; color: #64748b; transition: all 0.2s; }
        .tab-btn.active { background: #2563eb; color: white; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
        header { background: #0f172a; color: white; padding: 20px; border-radius: 0 0 24px 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body onclick="fecharMenusGlobais(event)">

    <div id="toast-notification"><div id="toast-dot" class="status-dot"></div><span id="toast-msg">SISTEMA ATUALIZADO</span></div>

    <div id="modal-gerenciar-maquinas" class="fixed inset-0 bg-slate-900/90 z-[250] hidden items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="font-black text-xl text-slate-800"><i class="fa-solid fa-industry text-blue-600"></i> GERENCIAR M√ÅQUINAS</h3>
                <button onclick="document.getElementById('modal-gerenciar-maquinas').style.display='none'" class="text-slate-400 hover:text-red-500 text-3xl font-bold">&times;</button>
            </div>
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4 text-xs text-blue-700 font-bold">
                <i class="fa-solid fa-circle-info mr-1"></i> Adicione ou remova m√°quinas. Login: "m" + ID (Ex: ID 5 = Senha m5).
            </div>
            <div id="lista-maquinas-config" class="flex-1 overflow-y-auto pr-2 space-y-2 mb-4"></div>
            <button onclick="adicionarNovaMaquina()" class="w-full bg-green-600 hover:bg-green-500 text-white font-black py-4 rounded-xl shadow-lg flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus"></i> ADICIONAR NOVA M√ÅQUINA
            </button>
        </div>
    </div>

    <div id="modal-cores" class="fixed inset-0 bg-slate-900/90 z-[150] hidden items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-6 border-b pb-2">
                <h3 class="font-black text-xl text-slate-800">üé® Cores</h3>
                <button onclick="fecharModalCores()" class="text-slate-400 hover:text-red-500 text-3xl font-bold">&times;</button>
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="nova-cor-modal" class="flex-1 p-3 bg-slate-50 border rounded-xl font-bold" placeholder="Nova cor...">
                <button onclick="addCorModal()" class="bg-blue-600 text-white px-5 rounded-xl font-black">+</button>
            </div>
            <div id="lista-cores-modal" class="flex flex-wrap gap-2 max-h-64 overflow-y-auto p-1"></div>
        </div>
    </div>

    <div id="modal-editar-op" class="fixed inset-0 bg-slate-900/90 z-[200] hidden items-center justify-center backdrop-blur-sm p-2 overflow-y-auto">
        <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-2xl border-4 border-blue-500/20 relative my-auto">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="font-black text-xl text-slate-800"><i class="fa-solid fa-file-invoice text-blue-600"></i> FICHA T√âCNICA</h3>
                <button onclick="fecharModalEdicao()" class="text-slate-400 hover:text-red-500 text-3xl font-bold">&times;</button>
            </div>
            <input type="hidden" id="edit-maq-id"><input type="hidden" id="edit-op-index"><input type="hidden" id="modo-edicao">
            <div class="space-y-4 max-h-[65vh] overflow-y-auto pr-2">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-400">M√ÅQUINA</label><select id="edit-op-maquina" class="w-full p-2.5 bg-slate-50 border rounded-xl font-bold text-sm"></select></div>
                    <div><label class="text-[10px] font-bold text-slate-400">N¬∫ O.P</label><input type="text" id="edit-op-num" class="w-full p-2.5 bg-slate-50 border rounded-xl font-bold text-sm"></div>
                    <div><label class="text-[10px] font-bold text-slate-400">META</label><input type="number" id="edit-op-qtd" class="w-full p-2.5 bg-slate-50 border rounded-xl font-bold text-sm"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-400">CLIENTE</label><input type="text" id="edit-op-cliente" class="w-full p-2.5 bg-slate-50 border rounded-xl font-bold text-sm"></div>
                    <div><label class="text-[10px] font-bold text-slate-400">PRODUTO</label><select id="edit-op-produto" class="w-full p-2.5 bg-slate-50 border rounded-xl font-bold text-sm"></select></div>
                </div>
                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 mt-2">
                    <span class="text-blue-600 text-[10px] font-black uppercase">MISTURA</span>
                    <div class="grid grid-cols-2 gap-3 mt-1">
                         <div><input type="text" id="edit-op-material" class="w-full p-2 border rounded-lg text-xs" placeholder="Material"></div>
                         <div><input type="text" id="edit-op-material-qtd" class="w-full p-2 border rounded-lg text-xs" placeholder="Qtd Material"></div>
                         <div><input type="text" id="edit-op-pigmento" class="w-full p-2 border rounded-lg text-xs" placeholder="C√≥d Pigmento"></div>
                         <div><input type="text" id="edit-op-porcentagem" class="w-full p-2 border rounded-lg text-xs" placeholder="% Pigmento"></div>
                    </div>
                </div>
                <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100 mt-4">
                    <span class="text-orange-600 text-[10px] font-black uppercase">EMBALAGEM</span>
                    <div class="grid grid-cols-2 gap-3 mt-1">
                         <div><input type="text" id="edit-op-caixa" class="w-full p-2 border rounded-lg text-xs" placeholder="Cx"></div>
                         <div><input type="text" id="edit-op-saco" class="w-full p-2 border rounded-lg text-xs" placeholder="Saco"></div>
                    </div>
                </div>
                <div class="mt-2"><label class="text-[10px] font-bold text-slate-400">OPERADOR</label><select id="edit-op-operador" class="w-full p-2.5 bg-slate-50 border rounded-xl font-bold text-sm"></select></div>
            </div>
            <div class="flex gap-3 mt-6 pt-4 border-t">
                <button onclick="fecharModalEdicao()" class="flex-1 bg-slate-100 text-slate-600 font-bold py-3 rounded-xl">CANCELAR</button>
                <button onclick="salvarOpModal()" id="btn-salvar-op" class="flex-1 bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg">SALVAR</button>
            </div>
        </div>
    </div>

    <div id="tela-loading" class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center">
        <h1 class="text-6xl font-black italic tracking-tighter mb-12 text-white animate-pulse">TRI<span class="text-blue-500">PLAST</span></h1>
        <div id="loading-spinner"><div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-6"></div><p class="text-slate-400 font-bold text-sm uppercase">Carregando...</p></div>
        <div id="loading-action" class="hidden flex-col items-center"><button onclick="entrarLogin()" class="bg-blue-600 text-white font-black py-4 px-12 rounded-full shadow-lg">ACESSAR</button></div>
    </div>

    <div id="tela-login" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center" style="display: none;">
        <div class="bg-white p-10 rounded-[2rem] shadow-2xl w-96 text-center">
            <h1 class="text-5xl font-black italic tracking-tighter mb-2 text-slate-800">TRI<span class="text-blue-600">PLAST</span></h1>
            <div class="mb-6 text-left"><label class="text-[10px] font-black text-slate-400">IDENTIFICA√á√ÉO</label><select id="login-tipo" class="w-full p-4 bg-slate-50 border-2 rounded-xl font-bold"><option value="admin">ADMINISTRADOR</option></select></div>
            <div class="mb-10 text-left"><label class="text-[10px] font-black text-slate-400">SENHA</label><input type="password" id="login-senha" class="w-full p-4 bg-slate-50 border-2 rounded-xl font-bold text-center" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            <button onclick="fazerLogin()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-xl">ENTRAR</button>
        </div>
    </div>

    <div id="app-content" style="display: none;">
        <header class="max-w-7xl mx-auto mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-4"><span class="text-3xl font-black italic tracking-tighter">TRI<span class="text-blue-400">PLAST</span></span><div id="relogio" class="font-mono text-blue-300 bg-slate-800/50 px-3 py-1.5 rounded-lg">00:00:00</div><button onclick="fazerLogout()" class="text-[10px] bg-red-500/10 text-red-400 font-black px-4 py-2 rounded-lg">SAIR</button></div>
                <div class="flex items-center gap-2 bg-slate-800 p-2 rounded-2xl shadow-lg">
                    <button id="btn-pause" onclick="togglePause()" class="bg-yellow-500 text-white text-[10px] font-black px-4 py-2 rounded-xl">PAUSAR</button>
                    <button id="btn-extra" onclick="toggleHoraExtra()" class="text-white text-[10px] font-black px-4 py-2 rounded-xl bg-slate-600">EXTRA</button>
                    <div class="flex flex-col ml-2"><span class="text-[8px] font-bold text-slate-400">TURNO</span><select id="filtro-turno" onchange="mudarTurnoManual(this.value)" class="bg-slate-900 text-white font-bold p-1 rounded text-xs w-24"><option value="1">Manh√£</option><option value="2">Tarde</option><option value="3">Noite</option></select></div>
                    <div id="badge-auto" class="bg-green-500 text-[9px] px-2 py-1 rounded font-black text-white">AUTO</div><div id="status-nuvem" class="text-[10px]">‚òÅÔ∏è</div>
                </div>
                <div id="header-eficiencia" class="text-right bg-slate-800 p-3 rounded-2xl border border-slate-700 hidden md:block">
                    <div class="flex justify-between gap-4 mb-1"><span class="text-[9px] text-slate-400 font-bold">META MENSAL</span><button onclick="resetarMes()" class="text-[8px] bg-slate-700 text-white px-2 rounded">&times;</button></div>
                    <div class="flex items-end justify-end gap-2"><span id="horas-trabalhadas-mes" class="text-lg font-mono font-black text-white">0h</span><span id="meta-global" class="text-3xl font-black text-green-400">0%</span></div>
                </div>
            </div>
        </header>

        <nav id="nav-principal" class="max-w-7xl mx-auto mb-6 px-2 flex gap-2 overflow-x-auto justify-center pb-2">
            <button onclick="trocarAba('painel')" id="btn-painel" class="tab-btn active">MONITORAMENTO</button>
            <button onclick="trocarAba('lista')" id="btn-lista" class="tab-btn">PEDIDOS</button>
            <button onclick="trocarAba('graficos')" id="btn-graficos" class="tab-btn">GR√ÅFICOS</button>
            <button onclick="trocarAba('apontamento')" id="btn-apontamento" class="tab-btn">RESUMO</button>
        </nav>

        <div id="aba-painel" class="aba-conteudo aba-ativa px-4">
            <div class="max-w-7xl mx-auto mb-6 text-center" id="area-admin-painel"><button onclick="abrirGerenciadorMaquinas()" class="bg-slate-700 text-white font-bold py-2 px-6 rounded-xl shadow-lg"><i class="fa-solid fa-gears"></i> GERENCIAR M√ÅQUINAS</button></div>
            <div id="grid-maquinas" class="pb-20"></div>
        </div>

        <div id="aba-lista" class="aba-conteudo px-4">
            <div class="max-w-7xl mx-auto grid grid-cols-1 gap-6">
                <div class="bg-white p-4 rounded-2xl shadow-lg border border-slate-100 flex justify-between items-center sticky top-2 z-30">
                    <input type="text" id="busca-lista-op" oninput="renderListaOPs()" placeholder="üîç Buscar..." class="w-full pl-4 py-3 bg-slate-50 border rounded-xl font-bold">
                    <button onclick="abrirModalCriacao()" class="ml-4 bg-blue-600 text-white py-3 px-8 rounded-xl font-black uppercase shadow-lg">NOVA FICHA</button>
                </div>
                <div id="container-filas" class="space-y-8"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
                    <div class="bg-white p-6 rounded-3xl shadow-xl md:col-span-2">
                        <h2 class="text-xl font-black text-slate-700 mb-4">HIST√ìRICO</h2>
                        <div class="flex gap-2 mb-4"><input type="text" id="busca-historico-op" placeholder="Filtrar..." oninput="renderHistorico()" class="p-2 bg-slate-50 border rounded w-32"><button onclick="limparBuscaHistorico()" class="bg-slate-100 px-3 rounded">Limpar</button></div>
                        <div class="overflow-x-auto max-h-80"><table class="w-full text-left"><tbody id="lista-historico" class="text-xs font-bold text-slate-600"></tbody></table></div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-xl">
                        <h2 class="text-lg font-black mb-4">CAT√ÅLOGO PRODUTOS</h2>
                        <div class="flex gap-2 mb-4"><input type="text" id="novo-produto-catalog" class="flex-1 p-2 bg-slate-50 border rounded" placeholder="Nome..."><button onclick="gerenciarProdutoCatalog('add')" class="bg-purple-600 text-white px-4 rounded font-black">+</button></div>
                        <div id="lista-produtos-config" class="flex flex-wrap gap-2 max-h-40 overflow-y-auto"></div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-xl">
                        <h2 class="text-lg font-black mb-4">OPERADORES</h2>
                        <div class="flex gap-2 mb-4"><input type="text" id="novo-operador" class="flex-1 p-2 bg-slate-50 border rounded" placeholder="Nome..."><button onclick="gerenciarOperador('add')" class="bg-green-600 text-white px-4 rounded font-black">+</button></div>
                        <div id="lista-operadores-config" class="flex flex-wrap gap-2 max-h-40 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="aba-graficos" class="aba-conteudo px-4">
            <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center col-span-1 lg:col-span-2">
                    <h3 class="font-black text-slate-700 text-xl mb-4">OEE - TEMPO REAL</h3>
                    <select id="filtro-grafico-status" onchange="alterarFiltroGrafico(this.value)" class="mb-4 bg-slate-100 border font-bold py-2 px-4 rounded"></select>
                    <div class="w-full max-w-sm h-64 relative"><canvas id="chartOEE"></canvas><div class="absolute inset-0 flex items-center justify-center pointer-events-none"><span class="text-2xl font-black text-slate-700">AGORA</span></div></div>
                    <div class="w-full mt-8 grid grid-cols-4 gap-4 text-center">
                        <div class="bg-green-50 p-2 rounded border border-green-100"><div class="text-green-600 text-[9px] font-black">PRODUZINDO</div><div id="global-timer-prod" class="text-lg font-black">00:00:00</div></div>
                        <div class="bg-orange-50 p-2 rounded border border-orange-100"><div class="text-orange-500 text-[9px] font-black">BAIXA</div><div id="global-timer-baixa" class="text-lg font-black">00:00:00</div></div>
                        <div class="bg-red-50 p-2 rounded border border-red-100"><div class="text-red-500 text-[9px] font-black">PARADO</div><div id="global-timer-parado" class="text-lg font-black">00:00:00</div></div>
                        <div class="bg-slate-100 p-2 rounded border border-slate-200"><div class="text-slate-500 text-[9px] font-black">NEUTRO</div><div id="global-timer-semprog" class="text-lg font-black">00:00:00</div></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-xl col-span-1 lg:col-span-2"><h3 class="font-black mb-4">ACUMULADO MENSAL</h3><div class="w-full h-40"><canvas id="chartHorasExtras"></canvas></div></div>
                <div class="bg-white p-6 rounded-3xl shadow-xl"><h3 class="font-black mb-4">RANKING PARADAS</h3><div class="h-64"><canvas id="chartParadas"></canvas></div></div>
                <div class="bg-white p-6 rounded-3xl shadow-xl"><h3 class="font-black mb-4">RANKING REFUGO</h3><div class="h-64"><canvas id="chartRefugos"></canvas></div></div>
            </div>
        </div>

        <div id="aba-apontamento" class="aba-conteudo px-4">
            <div class="max-w-7xl mx-auto bg-white p-8 rounded-3xl shadow-2xl">
                <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-black text-slate-700">RESUMO</h2><select id="filtro-resumo" onchange="renderApontamento()" class="bg-blue-50 font-bold p-2 rounded"><option value="todas">GERAL</option><option value="1">MANH√É</option><option value="2">TARDE</option><option value="3">NOITE</option></select><button onclick="resetarTurnoCompleto()" class="bg-red-50 text-red-600 font-bold px-4 py-2 rounded">ZERAR TUDO</button></div>
                <div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-slate-800 text-white text-[10px]"><tr><th class="p-4">M√ÅQ</th><th class="p-4">BOAS</th><th class="p-4">REFUGO</th><th class="p-4">PERDA</th><th class="p-4">PROD</th><th class="p-4">PARADO</th></tr></thead><tbody id="tabela-apontamento" class="font-bold text-xs"></tbody></table></div>
            </div>
        </div>
    </div>

    <script>
        const S_URL = 'https://hgqnlqtvjiyuwnwypxxh.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhncW5scXR2aml5dXdud3lweHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjE1MDcsImV4cCI6MjA4NjQzNzUwN30.njSVfWDpIJK49IpRSgyMf6e5MEmJ-AROVT7-nOTZD9Y';
        const sb = window.supabase.createClient(S_URL, S_KEY);

        let maquinas = [], historico = [], coresGlobais = ["Natural", "Preto", "Branco"], operadoresGlobais = ["Jo√£o"], produtosGlobais = ["Pe√ßa Padr√£o"];
        let dadosMensais = { tempoProducaoTotal: 0, tempoHoraExtraTotal: 0 };
        let manualOverride = false, modoHoraExtra = false, saveTimeout = null, filtroGraficoId = 'todas', charts = { oee: null, paradas: null, refugos: null, horas: null }, relogioInterval = null, sistemaPausado = false, usuarioLogado = null, fdsAtivo = false, dadosLocaisLastUpdate = 0;

        function getBrasiliaDate() { return new Date(new Date().toLocaleString("en-US", {timeZone: "America/Sao_Paulo"})); }
        function isFimDeSemana(agora) { const dia=agora.getDay(), min=agora.getHours()*60+agora.getMinutes(); return (dia===5&&min>=1416)||(dia===6||dia===0)||(dia===1&&min<300); }
        function createZero() { return { boas: 0, refugo: 0, paradas: 0, tempoProducao: 0, tempoBaixa: 0, tempoSemProg: 0 }; }
        function fmtTempo(s) { if(isNaN(s)) return "00:00:00"; s=Math.floor(s); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), seg=s%60; return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${seg.toString().padStart(2,'0')}`; }
        
        const paradasCodigos = ["04-PRODU√á√ÉO", "21-BAIXA EFICI√äNCIA", "22-SEM PROGRAMA√á√ÉO", "01-TROCA DE MOLDE", "02-TROCA DE POSTI√áO", "03-MATERIA-PRIMA/ AJUSTE", "05-AQUECIMENTO", "06-TROCA COR", "08-LANCHE", "09-LIMPEZA", "10-PE√áA PRESA", "12-ENERGIA", "13-MANUT. MOLDE", "14-MANUT. M√ÅQ", "18-FALTA OPERADOR", "23-FECHADA"];
        const codigosRefugo = ["Falha inj.", "Arranh√£o", "Cor", "Presa", "Bolha", "Mancha", "Trinca", "Outros"];

        function showToast(msg, type='success') { const t=document.getElementById('toast-notification'), m=document.getElementById('toast-msg'), d=document.getElementById('toast-dot'); m.innerText=msg; d.className='status-dot '+(type==='saving'?'saving':type==='error'?'error':''); t.classList.add('show'); if(type!=='saving') setTimeout(()=>t.classList.remove('show'),3000); }
        
        function sanitizarDados() {
            if(!dadosMensais) dadosMensais={tempoProducaoTotal:0,tempoHoraExtraTotal:0};
            maquinas.forEach(m=>{ m.accumulatedStatusTime=Number(m.accumulatedStatusTime)||0; if(!m.dadosTurno) m.dadosTurno={}; if(!m.resumoTurno) m.resumoTurno={}; [1,2,3].forEach(t=>{ if(!m.dadosTurno[t]) m.dadosTurno[t]=createZero(); if(!m.resumoTurno[t]) m.resumoTurno[t]=createZero(); }); });
        }

        async function carregarBanco() {
            const timeout=new Promise((_,r)=>setTimeout(()=>r(new Error("Timeout")),4000));
            try {
                const {data,error} = await Promise.race([sb.from('sistema').select('*').eq('id',1).single(), timeout]);
                if(error || !data) { aplicarDados({ maquinas: Array.from({length:4},(_,i)=>({id:i+1, nome:`M${i+1}`, status:"22-SEM PROGRAMA√á√ÉO", fila:[], dadosTurno:{1:createZero(),2:createZero(),3:createZero()}, resumoTurno:{1:createZero(),2:createZero(),3:createZero()}, accumulatedStatusTime:0, lastStatusChange:Date.now()})), cores:["Natural"], operadores:["Op 1"], produtos:[], historico:[], dadosMensais:{tempoProducaoTotal:0}, lastUpdateTimestamp:Date.now() }); await forcarSalvarImediato(); }
                else aplicarDados(data.conteudo);
            } catch(e) { console.warn("Offline"); aplicarDados({ maquinas: Array.from({length:4},(_,i)=>({id:i+1, nome:`M${i+1}`, status:"22-SEM PROGRAMA√á√ÉO", fila:[], dadosTurno:{1:createZero(),2:createZero(),3:createZero()}, resumoTurno:{1:createZero(),2:createZero(),3:createZero()}, accumulatedStatusTime:0, lastStatusChange:Date.now()})), cores:["Natural"], operadores:["Op 1"], produtos:[], historico:[], dadosMensais:{tempoProducaoTotal:0}, lastUpdateTimestamp:Date.now() }); }
            finally { document.getElementById('loading-spinner').style.display='none'; document.getElementById('loading-action').classList.replace('hidden','flex'); iniciarRelogio(); setInterval(sincronizarComServidor,2000); }
        }

        function aplicarDados(c) {
            maquinas=c.maquinas||[]; coresGlobais=c.cores||[]; operadoresGlobais=c.operadores||[]; produtosGlobais=c.produtos||[]; historico=c.historico||[]; dadosMensais=c.dadosMensais||{tempoProducaoTotal:0}; modoHoraExtra=c.modoHoraExtra||false; dadosLocaisLastUpdate=c.lastUpdateTimestamp||0;
            const sel=document.getElementById('login-tipo'); sel.innerHTML='<option value="admin">üë®‚Äçüíª ADMIN</option>'+maquinas.map(m=>`<option value="${m.id}">üè≠ ${m.nome}</option>`).join('');
            document.getElementById('edit-op-maquina').innerHTML=maquinas.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('');
            document.getElementById('filtro-grafico-status').innerHTML='<option value="todas">TODAS</option>'+maquinas.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('');
            sanitizarDados(); atualizarDropdowns(); processarTurnoAuto(); renderBotaoExtra(); calcEficienciaGlobal();
            if(usuarioLogado) { render(); if(usuarioLogado==='admin') { renderListaOPs(); renderApontamento(); } updateTimersVisualOnly(); }
        }

        async function sincronizarComServidor() { if(document.getElementById('modal-editar-op').style.display==='flex') return; const {data}=await sb.from('sistema').select('conteudo').eq('id',1).single(); if(data && (data.conteudo.lastUpdateTimestamp||0)>dadosLocaisLastUpdate+2000) aplicarDados(data.conteudo); }
        async function forcarSalvarImediato() { if(saveTimeout) clearTimeout(saveTimeout); showToast("ENVIANDO...","saving"); const p={maquinas,cores:coresGlobais,operadores:operadoresGlobais,produtos:produtosGlobais,historico,dadosMensais,modoHoraExtra,lastUpdateTimestamp:Date.now()}; const {error}=await sb.from('sistema').upsert({id:1,conteudo:p}); if(!error) { dadosLocaisLastUpdate=p.lastUpdateTimestamp; showToast("SALVO"); } }
        async function salvarAutomatico() { document.getElementById('status-nuvem').innerText="‚è≥"; if(saveTimeout) clearTimeout(saveTimeout); saveTimeout=setTimeout(async()=>{await forcarSalvarImediato();document.getElementById('status-nuvem').innerText="‚òÅÔ∏è";},2000); }

        function entrarLogin() { document.getElementById('tela-loading').style.display='none'; const u=localStorage.getItem('triplast_user'); if(u){ usuarioLogado=u==='admin'?'admin':parseInt(u); iniciarSistema(); } else document.getElementById('tela-login').style.display='flex'; }
        function fazerLogin() { const t=document.getElementById('login-tipo').value, s=document.getElementById('login-senha').value.trim(); if((t==='admin' && s==='2026') || (t!=='admin' && s==='m'+t)) { usuarioLogado=t==='admin'?'admin':parseInt(t); localStorage.setItem('triplast_user',t); iniciarSistema(); } else alert('Senha incorreta!'); }
        function fazerLogout() { usuarioLogado=null; localStorage.removeItem('triplast_user'); location.reload(); }
        
        function iniciarSistema() {
            document.getElementById('tela-login').style.display='none'; document.getElementById('app-content').style.display='block';
            trocarAba('painel');
            if(usuarioLogado!=='admin') { ['nav-principal','header-eficiencia','btn-pause','btn-extra','area-admin-painel'].forEach(id=>document.getElementById(id).style.display='none'); }
            else { ['nav-principal','header-eficiencia','area-admin-painel'].forEach(id=>document.getElementById(id).style.display='block'); ['btn-pause','btn-extra'].forEach(id=>document.getElementById(id).style.display='inline-block'); renderListaOPs(); iniciarGraficos(); }
            render();
        }

        // GERENCIAR M√ÅQUINAS
        function abrirGerenciadorMaquinas() { document.getElementById('modal-gerenciar-maquinas').style.display='flex'; renderListaMaquinasConfig(); }
        function renderListaMaquinasConfig() { document.getElementById('lista-maquinas-config').innerHTML = maquinas.map(m=>`<div class="flex justify-between items-center bg-slate-50 p-2 rounded border mb-2"><span>ID ${m.id}</span><input value="${m.nome}" onchange="editarNomeMaquina(${m.id},this.value)" class="border p-1 rounded w-32"><button onclick="removerMaquina(${m.id})" class="text-red-500 font-bold">&times;</button></div>`).join(''); }
        function adicionarNovaMaquina() { const id=maquinas.length>0?Math.max(...maquinas.map(m=>m.id))+1:1; maquinas.push({id, nome:`M${id}`, status:"22-SEM PROGRAMA√á√ÉO", fila:[], dadosTurno:{1:createZero(),2:createZero(),3:createZero()}, resumoTurno:{1:createZero(),2:createZero(),3:createZero()}, accumulatedStatusTime:0, lastStatusChange:Date.now()}); renderListaMaquinasConfig(); forcarSalvarImediato(); if(usuarioLogado==='admin') render(); }
        function removerMaquina(id) { if(confirm("Remover m√°quina?")) { maquinas=maquinas.filter(m=>m.id!==id); renderListaMaquinasConfig(); forcarSalvarImediato(); render(); } }
        function editarNomeMaquina(id,n) { const m=maquinas.find(x=>x.id===id); if(m){ m.nome=n; forcarSalvarImediato(); render(); } }

        function render() {
            const t=document.getElementById('filtro-turno').value, grid=document.getElementById('grid-maquinas'), lista=usuarioLogado!=='admin'?maquinas.filter(m=>m.id===usuarioLogado):maquinas;
            grid.className=usuarioLogado!=='admin'?"max-w-md mx-auto w-full":"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
            grid.innerHTML=lista.map(m=>{
                const op=m.fila[0]||{op:'---',produto:'AGUARDANDO',qtd:0}, d=m.dadosTurno[t]||createZero(), prog=op.qtd>0?Math.min((d.boas/op.qtd)*100,100):0;
                let stClass=""; if(m.status.includes("PRODU√á√ÉO")) stClass="status-produzindo"; else if(m.status.includes("BAIXA")||m.status.includes("MATERIA")) stClass="status-baixa"; else if(m.status.includes("SEM")) stClass="status-sem-prog"; else stClass="status-fechada";
                return `<div class="card-producao ${stClass}">
                    <div class="flex flex-col mb-2"><span class="bg-blue-600 text-white px-2 py-1 rounded font-black w-fit">${m.nome}</span><span id="timer-display-${m.id}" class="text-xs font-bold block h-4">--:--:--</span></div>
                    <div class="bg-slate-50 p-3 rounded border mb-2"><span class="font-black text-xl">O.P ${op.op}</span><div class="text-xs font-bold text-slate-500 truncate">${op.produto}</div><div class="grid grid-cols-2 gap-2 my-2"><div class="info-badge"><span class="text-green-500">FEITO</span><span class="text-green-600">${d.boas}</span></div><div class="info-badge"><span class="text-red-400">REFUGO</span><span class="text-red-600">${d.refugo}</span></div></div><div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden"><div class="bg-blue-500 h-full" style="width:${prog}%"></div></div></div>
                    <div class="flex gap-2 mb-2"><input type="number" id="qtd-prod-${m.id}" class="flex-1 border rounded text-center font-bold text-lg"><button onclick="apontarManual(${m.id})" class="bg-blue-600 text-white w-10 rounded font-bold text-xl">+</button></div>
                    <div class="flex gap-2 mb-2"><select id="sel-refugo-${m.id}" class="flex-1 border rounded text-xs">${codigosRefugo.map(c=>`<option>${c}</option>`).join('')}</select><button onclick="addRefugo(${m.id})" class="bg-red-500 text-white w-8 rounded font-bold text-xs">+</button></div>
                    <select onchange="atualizarStatus(${m.id},this.value)" class="w-full p-2 border rounded font-bold text-xs mb-1">${paradasCodigos.map(p=>`<option value="${p}" ${m.status===p?'selected':''}>${p}</option>`).join('')}</select>
                    ${usuarioLogado==='admin'?`<button onclick="finalizarOP(${m.id})" class="w-full text-slate-400 hover:text-red-500 text-[9px] font-black uppercase">Finalizar O.P</button>`:''}
                </div>`;
            }).join('');
        }

        // L√ìGICA DE TEMPO E GR√ÅFICOS
        function iniciarRelogio() { if(relogioInterval) clearInterval(relogioInterval); relogioInterval=setInterval(()=>{ const d=getBrasiliaDate(); document.getElementById('relogio').innerText=d.toLocaleTimeString(); renderBotaoExtra(); processarTurnoAuto(); if(usuarioLogado) { updateTimersVisualOnly(); if(usuarioLogado==='admin') { calcEficienciaGlobal(); if(document.getElementById('aba-graficos').style.display==='block') atualizarResumoGlobalNumeros(); } } },1000); }
        function updateTimersVisualOnly() { const now=Date.now(), l=usuarioLogado!=='admin'?maquinas.filter(m=>m.id===usuarioLogado):maquinas; l.forEach(m=>{ const el=document.getElementById(`timer-display-${m.id}`); if(el) { let diff=(m.accumulatedStatusTime||0)+(m.lastStatusChange?now-m.lastStatusChange:0); el.innerHTML=`<span class="${m.status.includes('PROD')?'text-green-600':m.status.includes('PARADA')?'text-purple-600':'text-red-500'}">${fmtTempo(diff/1000)}</span>`; } }); }
        function processarTurnoAuto() { if(manualOverride) return; const d=getBrasiliaDate(), m=d.getHours()*60+d.getMinutes(); let t=3; if(m>=300&&m<858)t=1; else if(m>=858&&m<1416)t=2; const el=document.getElementById('filtro-turno'); if(el.value!=t) { el.value=t; if(usuarioLogado) render(); } }
        
        // FUN√á√ïES OPERACIONAIS
        function apontarManual(id) { const v=parseInt(document.getElementById(`qtd-prod-${id}`).value); if(v>0) { maquinas.find(x=>x.id===id).dadosTurno[document.getElementById('filtro-turno').value].boas+=v; document.getElementById(`qtd-prod-${id}`).value=''; render(); salvarAutomatico(); } }
        function addRefugo(id) { maquinas.find(x=>x.id===id).dadosTurno[document.getElementById('filtro-turno').value].refugo++; render(); salvarAutomatico(); }
        function atualizarStatus(id,st) { const m=maquinas.find(x=>x.id===id); m.status=st; m.lastStatusChange=Date.now(); m.accumulatedStatusTime=0; render(); forcarSalvarImediato(); }
        function finalizarOP(id) { if(confirm("Finalizar?")) { const m=maquinas.find(x=>x.id===id), op=m.fila.shift(); if(op) historico.push({...op, data:new Date().toISOString(), maquina:m.nome, qtd:m.dadosTurno[document.getElementById('filtro-turno').value].boas, status:'CONCLU√çDO'}); m.dadosTurno[document.getElementById('filtro-turno').value]=createZero(); render(); renderListaOPs(); forcarSalvarImediato(); } }
        function togglePause() { sistemaPausado=!sistemaPausado; document.getElementById('btn-pause').innerText=sistemaPausado?'RETOMAR':'PAUSAR'; salvarAutomatico(); }
        function toggleHoraExtra() { modoHoraExtra=!modoHoraExtra; renderBotaoExtra(); forcarSalvarImediato(); }
        function renderBotaoExtra() { document.getElementById('btn-extra').className=modoHoraExtra?'bg-purple-600 text-white text-[10px] font-black px-4 py-2 rounded-xl animate-pulse':'bg-slate-600 text-white text-[10px] font-black px-4 py-2 rounded-xl'; }
        
        // O.P E FILAS
        function salvarOpModal() { const m=maquinas.find(x=>x.id===(document.getElementById('edit-op-maquina').value||document.getElementById('edit-maq-id').value)), op={op:document.getElementById('edit-op-num').value, cliente:document.getElementById('edit-op-cliente').value, produto:document.getElementById('edit-op-produto').value, qtd:document.getElementById('edit-op-qtd').value, operador:document.getElementById('edit-op-operador').value}; if(document.getElementById('modo-edicao').value==="true") m.fila[document.getElementById('edit-op-index').value]=op; else m.fila.push(op); forcarSalvarImediato(); fecharModalEdicao(); renderListaOPs(); }
        function renderListaOPs() { const c=document.getElementById('container-filas'); c.innerHTML=maquinas.map(m=>`<div class="bg-white p-4 rounded shadow mb-4"><h3 class="font-bold">${m.nome}</h3><div class="scrolling-wrapper">${m.fila.map((op,i)=>`<div class="ticket-card p-3"><div class="flex justify-between"><span class="font-black text-blue-600">${op.op}</span><button onclick="deletarOP(${m.id},${i})" class="text-red-500">&times;</button></div><div class="text-xs">${op.produto}</div><button onclick="abrirModalEdicao(${m.id},${i})" class="text-xs bg-slate-100 p-1 rounded mt-2">EDITAR</button></div>`).join('')}</div></div>`).join(''); }
        function abrirModalCriacao() { document.getElementById('modal-editar-op').style.display='flex'; document.getElementById('modo-edicao').value="false"; }
        function fecharModalEdicao() { document.getElementById('modal-editar-op').style.display='none'; }
        function abrirModalEdicao(id,i) { const op=maquinas.find(x=>x.id===id).fila[i]; document.getElementById('modal-editar-op').style.display='flex'; document.getElementById('modo-edicao').value="true"; document.getElementById('edit-maq-id').value=id; document.getElementById('edit-op-index').value=i; document.getElementById('edit-op-num').value=op.op; }
        function deletarOP(id,i) { if(confirm("Apagar?")) { maquinas.find(x=>x.id===id).fila.splice(i,1); renderListaOPs(); forcarSalvarImediato(); } }

        // UTILIT√ÅRIOS E ABAS
        function trocarAba(id) { document.querySelectorAll('.aba-conteudo').forEach(a=>a.classList.remove('aba-ativa')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById('aba-'+id).classList.add('aba-ativa'); document.getElementById('btn-'+id).classList.add('active'); if(id==='lista') renderListaOPs(); if(id==='graficos') iniciarGraficos(); if(id==='apontamento') renderApontamento(); }
        function iniciarGraficos() { const ctx=document.getElementById('chartOEE'); if(!ctx||charts.oee)return; charts.oee=new Chart(ctx,{type:'doughnut',data:{labels:['Prod','Baixa','Parado','Neutro'],datasets:[{data:[0,0,0,1],backgroundColor:['#22c55e','#f97316','#ef4444','#cbd5e1']}]},options:{responsive:true,cutout:'70%',plugins:{legend:{display:false}}}}); }
        function renderApontamento() { const t=document.getElementById('tabela-apontamento'); t.innerHTML=maquinas.map(m=>`<tr><td class="p-2">${m.nome}</td><td class="p-2 text-green-600">${m.dadosTurno[document.getElementById('filtro-resumo').value].boas}</td><td class="p-2 text-red-500">${m.dadosTurno[document.getElementById('filtro-resumo').value].refugo}</td></tr>`).join(''); }
        function resetarTurnoCompleto() { if(confirm("Zerar?")) { const t=document.getElementById('filtro-resumo').value; maquinas.forEach(m=>m.dadosTurno[t]=createZero()); renderApontamento(); forcarSalvarImediato(); } }
        function mudarTurnoManual(v) { manualOverride=true; document.getElementById('badge-auto').style.display='none'; render(); }
        function addCorModal() { const v=document.getElementById('nova-cor-modal').value; if(v){ coresGlobais.push(v); renderCoresModal(); forcarSalvarImediato(); } }
        function renderCoresModal() { document.getElementById('lista-cores-modal').innerHTML=coresGlobais.map(c=>`<span class="bg-slate-100 p-1 rounded text-xs">${c}</span>`).join(''); }
        function fecharModalCores() { document.getElementById('modal-cores').style.display='none'; }
        
        function atualizarDropdowns() {
            const ops = operadoresGlobais.map(o=>`<option>${o}</option>`).join('');
            const prods = produtosGlobais.map(p=>`<option>${p}</option>`).join('');
            document.getElementById('edit-op-operador').innerHTML = ops;
            document.getElementById('edit-op-produto').innerHTML = prods;
        }
        function gerenciarOperador(a) { if(a==='add'){ const v=document.getElementById('novo-operador').value; if(v) operadoresGlobais.push(v); } atualizarDropdowns(); forcarSalvarImediato(); renderOperadoresConfig(); }
        function gerenciarProdutoCatalog(a) { if(a==='add'){ const v=document.getElementById('novo-produto-catalog').value; if(v) produtosGlobais.push(v); } atualizarDropdowns(); forcarSalvarImediato(); renderProdutosConfig(); }
        function renderOperadoresConfig() { document.getElementById('lista-operadores-config').innerHTML=operadoresGlobais.map(o=>`<div class="bg-green-50 p-1 mb-1 rounded text-xs">${o}</div>`).join(''); }
        function renderProdutosConfig() { document.getElementById('lista-produtos-config').innerHTML=produtosGlobais.map(p=>`<div class="bg-purple-50 p-1 mb-1 rounded text-xs">${p}</div>`).join(''); }
        function calcEficienciaGlobal() { const h=((dadosMensais.tempoProducaoTotal||0)+(dadosMensais.tempoHoraExtraTotal||0))/3600; document.getElementById('horas-trabalhadas-mes').innerText=h.toFixed(1)+"h"; document.getElementById('meta-global').innerText=((h/1628)*100).toFixed(1)+"%"; }
        function limparBuscaHistorico() { document.getElementById('busca-historico-op').value=''; renderHistorico(); }
        function renderHistorico() { const f=document.getElementById('busca-historico-op').value.toLowerCase(); document.getElementById('lista-historico').innerHTML=historico.filter(h=>String(h.op).toLowerCase().includes(f)).map(h=>`<tr><td class="p-2">${h.op}</td><td class="p-2">${h.qtdFeita}</td></tr>`).join(''); }
        function atualizarResumoGlobalNumeros() { /* Atualiza contadores gr√°ficos se necess√°rio */ }
        function alterarFiltroGrafico(v) { filtroGraficoId=v; atualizarResumoGlobalNumeros(); iniciarGraficos(); }

        window.addEventListener('beforeunload', () => forcarSalvarImediato());
        setTimeout(() => { if(document.getElementById('loading-spinner').style.display!=='none') document.getElementById('loading-action').classList.replace('hidden','flex'); }, 4000);
        carregarBanco();
    </script>
</body>
</html>
