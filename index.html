<!DOCTYPE html>
<html lang="pt-br" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Triplast Titanium | Sistema de Produção</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=Inter:wght@300;400;600;800&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        tech: ['"Chakra Petch"', 'sans-serif'],
                        mono: ['"Roboto Mono"', 'monospace'],
                    },
                    colors: {
                        dark: { 950: '#050505', 900: '#0a0a0a', 800: '#121212', 700: '#1e1e1e', border: '#333333' },
                        brand: { DEFAULT: '#2563eb', light: '#60a5fa', dark: '#1e40af' },
                        status: { run: '#00d26a', stop: '#f8312f', setup: '#ffc107', off: '#6c757d' }
                    },
                    boxShadow: {
                        'neon-blue': '0 0 15px rgba(37, 99, 235, 0.4)',
                        'neon-green': '0 0 15px rgba(0, 210, 106, 0.4)',
                        'neon-red': '0 0 15px rgba(248, 49, 47, 0.4)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050505;
            background-image: 
                linear-gradient(rgba(5,5,5,0.9), rgba(5,5,5,0.95)),
                url("https://www.transparenttextures.com/patterns/carbon-fibre.png");
            color: #e5e5e5; overflow: hidden;
        }
        
        /* Glassmorphism Dark */
        .glass-panel {
            background: rgba(20, 20, 20, 0.6); 
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        .input-tech {
            background: rgba(0, 0, 0, 0.5); 
            border: 1px solid #333; 
            color: #fff;
            font-family: 'Roboto Mono', monospace; 
            transition: all 0.3s;
        }
        .input-tech:focus { border-color: #2563eb; box-shadow: 0 0 10px rgba(37, 99, 235, 0.3); outline: none; }

        /* Botões de Status (Neon Effect) */
        .btn-status { transition: all 0.3s; opacity: 0.4; filter: grayscale(1); transform: scale(0.95); border: 1px solid transparent; }
        .btn-status:hover { opacity: 0.8; filter: grayscale(0.5); }
        .btn-status.active { 
            opacity: 1; filter: grayscale(0); transform: scale(1.05); 
            box-shadow: 0 0 20px currentColor; border-color: white; 
            z-index: 10;
        }

        /* Utilitários */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2563eb; }
        
        .view-section { display: none; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col antialiased font-sans">

    <section id="screen-login" class="fixed inset-0 z-50 flex items-center justify-center bg-dark-950 bg-[url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm"></div>
        
        <div class="relative glass-panel p-10 rounded-2xl w-full max-w-md text-center border-t border-white/10 shadow-2xl">
            <div class="mb-6 inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-brand-DEFAULT shadow-neon-blue">
                <i class="fa-solid fa-cube text-4xl text-white"></i>
            </div>
            <h1 class="text-4xl font-bold text-white font-tech tracking-wider mb-1">TRIPLAST</h1>
            <p class="text-brand-light font-mono text-xs tracking-[0.3em] uppercase mb-8">Titanium System v4.0</p>
            
            <form onsubmit="Auth.login(event)" class="space-y-4">
                <div class="relative group">
                    <i class="fa-solid fa-lock absolute left-4 top-4 text-slate-500 group-focus-within:text-brand-DEFAULT transition-colors"></i>
                    <input type="password" id="login-pass" placeholder="Senha de Acesso" class="input-tech w-full pl-12 pr-4 py-4 rounded-xl text-center text-lg tracking-widest">
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-brand-dark to-brand-DEFAULT hover:from-brand-DEFAULT hover:to-brand-light text-white font-bold py-4 rounded-xl shadow-neon-blue transition-all transform active:scale-[0.98] uppercase tracking-wide">
                    Entrar no Sistema
                </button>
            </form>
            <p class="mt-6 text-[10px] text-slate-600 font-mono">Secure Connection • 2026</p>
        </div>
    </section>

    <div id="app-layout" class="hidden flex-1 flex h-full overflow-hidden">
        
        <aside class="w-20 lg:w-72 bg-dark-900 border-r border-dark-border flex flex-col z-20">
            <div class="h-20 flex items-center justify-center lg:justify-start lg:px-6 border-b border-dark-border bg-dark-950/50">
                <i class="fa-solid fa-industry text-brand-DEFAULT text-2xl shadow-neon-blue rounded p-1"></i>
                <div class="ml-3 hidden lg:block">
                    <h1 class="font-tech font-bold text-xl text-white leading-none">TRIPLAST</h1>
                    <span class="text-[10px] text-slate-500 font-mono tracking-widest">CONTROL PANEL</span>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                <p class="hidden lg:block text-[10px] font-bold text-slate-600 uppercase tracking-widest pl-2 mb-2 mt-2">Geral</p>
                <button onclick="Router.go('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group active">
                    <i class="fa-solid fa-chart-pie text-lg w-6 text-center group-hover:text-brand-light"></i>
                    <span class="hidden lg:block font-bold text-sm">Dashboard</span>
                </button>
                <button onclick="Router.go('calculadora')" id="nav-calculadora" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                    <i class="fa-solid fa-calculator text-lg w-6 text-center group-hover:text-brand-light"></i>
                    <span class="hidden lg:block font-bold text-sm">Calc. & Pedidos</span>
                </button>
                <button onclick="Router.go('operadores')" id="nav-operadores" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                    <i class="fa-solid fa-users text-lg w-6 text-center group-hover:text-brand-light"></i>
                    <span class="hidden lg:block font-bold text-sm">Operadores</span>
                </button>

                <p class="hidden lg:block text-[10px] font-bold text-slate-600 uppercase tracking-widest pl-2 mb-2 mt-6">Produção</p>
                <div id="sidebar-machines" class="space-y-1">
                    </div>
            </nav>

            <div class="p-4 border-t border-dark-border bg-dark-950/30">
                <div class="flex items-center gap-3 justify-center lg:justify-start">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-brand-dark to-brand-DEFAULT flex items-center justify-center font-bold text-white text-xs border border-white/10">A</div>
                    <div class="hidden lg:block overflow-hidden">
                        <p class="text-sm font-bold text-white truncate">Admin</p>
                        <p class="text-[10px] text-green-500 font-mono uppercase flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online</p>
                    </div>
                    <button onclick="System.save()" class="ml-auto text-slate-500 hover:text-brand-light transition" title="Salvar Manual"><i class="fa-solid fa-cloud-arrow-up"></i></button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-dark-950 overflow-hidden">
            <header class="h-20 bg-dark-900/80 backdrop-blur border-b border-dark-border flex items-center justify-between px-8 z-10">
                <h2 id="page-title" class="text-2xl font-bold text-white font-tech uppercase tracking-wide">Visão Geral</h2>
                <div class="flex items-center gap-6">
                    <div class="text-right hidden md:block">
                        <p id="clock-time" class="text-xl font-mono font-bold text-white leading-none tracking-widest">00:00:00</p>
                        <p id="clock-date" class="text-[10px] text-brand-light uppercase font-bold tracking-wide mt-1">DATA</p>
                    </div>
                    <div class="h-8 w-px bg-white/10"></div>
                    <div id="status-indicator" class="flex items-center gap-2 px-3 py-1 rounded-full bg-dark-800 border border-dark-border">
                        <div class="w-2 h-2 rounded-full bg-green-500 shadow-neon-green"></div>
                        <span class="text-[10px] font-bold text-slate-400">SYNC</span>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 lg:p-10 relative scroll-smooth space-y-8" id="viewport">
                
                <div id="view-dashboard" class="view-section active space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="glass-panel p-6 rounded-2xl border-l-4 border-brand-DEFAULT group hover:bg-white/5 transition">
                            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Produção Total</span>
                            <h3 class="text-4xl font-tech font-bold text-white mt-2 group-hover:scale-105 transition" id="kpi-total">0</h3>
                            <p class="text-xs text-brand-light mt-1 font-mono">Peças Hoje</p>
                        </div>
                        <div class="glass-panel p-6 rounded-2xl border-l-4 border-status-run group hover:bg-white/5 transition">
                            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Máquinas Ativas</span>
                            <h3 class="text-4xl font-tech font-bold text-status-run mt-2 group-hover:scale-105 transition" id="kpi-active">0</h3>
                            <p class="text-xs text-slate-400 mt-1 font-mono">Produzindo Agora</p>
                        </div>
                        <div class="glass-panel p-6 rounded-2xl border-l-4 border-status-stop group hover:bg-white/5 transition">
                            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Paradas / Off</span>
                            <h3 class="text-4xl font-tech font-bold text-white mt-2 group-hover:scale-105 transition" id="kpi-stopped">0</h3>
                            <p class="text-xs text-status-stop mt-1 font-bold">Atenção</p>
                        </div>
                        <div class="glass-panel p-6 rounded-2xl border-l-4 border-purple-500 group hover:bg-white/5 transition">
                            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Eficiência Global</span>
                            <h3 class="text-4xl font-tech font-bold text-white mt-2 group-hover:scale-105 transition" id="kpi-eff">0%</h3>
                            <div class="w-full bg-dark-800 h-1 mt-2 rounded-full overflow-hidden"><div id="bar-eff" class="h-full bg-purple-500 w-0"></div></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 glass-panel p-6 rounded-2xl border border-white/5">
                            <h3 class="font-tech font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-chart-column text-brand-DEFAULT"></i> Produção por Máquina</h3>
                            <div class="h-72"><canvas id="chart-bar"></canvas></div>
                        </div>
                        <div class="glass-panel p-6 rounded-2xl border border-white/5">
                            <h3 class="font-tech font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-clock text-brand-DEFAULT"></i> Distribuição de Tempo</h3>
                            <div class="h-72 relative">
                                <canvas id="chart-doughnut"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                        <div class="p-4 bg-dark-900/50 border-b border-white/5">
                            <h3 class="font-bold text-white font-tech uppercase text-sm">Monitoramento em Tempo Real</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-slate-400">
                                <thead class="bg-white/5 text-xs uppercase font-bold text-white">
                                    <tr><th class="p-4">Máquina</th><th class="p-4">Status</th><th class="p-4">Tempo no Status</th><th class="p-4">Operador</th><th class="p-4">O.P. / Produto</th><th class="p-4 text-right">Progresso</th></tr>
                                </thead>
                                <tbody id="table-dashboard-body" class="font-mono text-xs"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-calculadora" class="view-section space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        <div class="lg:col-span-5 glass-panel p-8 rounded-2xl border border-white/5 h-fit">
                            <div class="flex items-center gap-4 mb-6 border-b border-white/10 pb-4">
                                <div class="w-12 h-12 rounded-xl bg-brand-DEFAULT/20 border border-brand-DEFAULT/50 flex items-center justify-center text-brand-light text-xl"><i class="fa-solid fa-calculator"></i></div>
                                <div>
                                    <h2 class="font-tech text-xl font-bold text-white">Calculadora de Produção</h2>
                                    <p class="text-xs text-slate-500">Estimativa de Tempo e Material</p>
                                </div>
                            </div>

                            <div class="space-y-5">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-[10px] uppercase font-bold text-brand-light mb-1 block">Peso Peça (g)</label><input type="number" id="calc-peso" class="input-tech w-full p-3 rounded-lg" placeholder="20"></div>
                                    <div><label class="text-[10px] uppercase font-bold text-brand-light mb-1 block">Ciclo (seg)</label><input type="number" id="calc-ciclo" class="input-tech w-full p-3 rounded-lg" placeholder="20"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-[10px] uppercase font-bold text-brand-light mb-1 block">Cavidades</label><input type="number" id="calc-cav" class="input-tech w-full p-3 rounded-lg" value="1"></div>
                                    <div><label class="text-[10px] uppercase font-bold text-brand-light mb-1 block">Pigmento (%)</label><input type="number" id="calc-pig" class="input-tech w-full p-3 rounded-lg" value="2"></div>
                                </div>
                                <div><label class="text-[10px] uppercase font-bold text-white mb-1 block">Quantidade Meta (Peças)</label><input type="number" id="calc-meta" class="input-tech w-full p-4 rounded-lg text-xl font-bold border-brand-DEFAULT text-white" placeholder="2000"></div>

                                <button onclick="Calculator.calc()" class="w-full bg-white/5 hover:bg-white/10 border border-white/10 text-white font-bold py-3 rounded-lg uppercase tracking-widest transition">Calcular Dados</button>

                                <div id="calc-res" class="hidden bg-dark-900/80 p-5 rounded-xl border border-white/10 animate-fadeIn mt-4">
                                    <div class="grid grid-cols-2 gap-6 mb-4">
                                        <div><span class="text-[10px] text-slate-500 block uppercase">Tempo Estimado</span><span class="text-2xl font-mono font-bold text-white" id="res-tempo">0h</span></div>
                                        <div><span class="text-[10px] text-slate-500 block uppercase">Peças / Hora</span><span class="text-2xl font-mono font-bold text-white" id="res-pph">0</span></div>
                                    </div>
                                    <div class="border-t border-white/10 pt-4 grid grid-cols-2 gap-4 mb-4">
                                        <div><span class="text-[10px] text-slate-500 block uppercase">Material (kg)</span><span class="text-lg font-bold text-brand-light font-mono" id="res-mat">0</span></div>
                                        <div><span class="text-[10px] text-slate-500 block uppercase">Pigmento (kg)</span><span class="text-lg font-bold text-pink-500 font-mono" id="res-pig">0</span></div>
                                    </div>
                                    <button onclick="Calculator.saveOrder()" class="w-full bg-green-600 hover:bg-green-500 text-white text-xs font-bold py-3 rounded-lg uppercase shadow-neon-green"><i class="fa-solid fa-plus mr-2"></i> Cadastrar Pedido</button>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-7 glass-panel p-8 rounded-2xl border border-white/5 flex flex-col h-[700px]">
                            <div class="flex justify-between items-center mb-6 pb-4 border-b border-white/10">
                                <h3 class="text-xl font-bold text-white font-tech"><i class="fa-solid fa-list-check text-brand-DEFAULT mr-2"></i> Pedidos na Fila</h3>
                                <span class="bg-brand-DEFAULT/20 text-brand-light text-xs px-3 py-1 rounded-full font-bold border border-brand-DEFAULT/30" id="order-count">0</span>
                            </div>
                            <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar" id="orders-list">
                                </div>
                        </div>
                    </div>
                </div>

                <div id="view-operadores" class="view-section">
                    <div class="glass-panel p-8 rounded-2xl border border-white/5 max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold text-white font-tech mb-6 border-b border-white/10 pb-4">Gestão de Operadores</h2>
                        <div class="flex gap-4 mb-8">
                            <input type="text" id="new-op-name" placeholder="Nome do Colaborador" class="input-tech flex-1 p-4 rounded-xl">
                            <button onclick="Operators.add()" class="bg-brand-DEFAULT hover:bg-brand-light text-white px-8 py-4 rounded-xl font-bold shadow-neon-blue uppercase tracking-wider">Adicionar</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="operators-grid">
                            </div>
                    </div>
                </div>

                <div id="view-maquina" class="view-section">
                    <div id="machine-detail-container" class="max-w-6xl mx-auto space-y-6 animate-fadeIn"></div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // CONFIG
        const CONFIG = {
            url: 'https://hgqnlqtvjiyuwxwypxhh.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhncW5scXR2aml5dXdud3lweHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjE1MDcsImV4cCI6MjA4NjQzNzUwN30.njSVfWDpIJK49IpRSgyMf6e5MEmJ-AROVT7-nOTZD9Y',
            pass: '2026'
        };
        const sb = supabase.createClient(CONFIG.url, CONFIG.key);

        // DATA STORE
        const Store = {
            maquinas: Array.from({length: 4}, (_,i) => ({
                id: i+1, nome: `Injetora 0${i+1}`, 
                status: 'desligada', 
                lastStatusChange: Date.now(),
                operador: '',
                pedido: { produto: 'Sem Pedido', meta: 0, realizado: 0, ciclo: 20, cav: 1 },
                stats: { run: 0, stop: 0, setup: 0, off: 0 } // Segundos acumulados
            })),
            pedidos: [],
            operadores: ['João Silva', 'Maria Souza', 'Técnico Geral'],
            selectedMachine: 1
        };

        // --- SYSTEM CORE ---
        const System = {
            async init() {
                try {
                    let { data } = await sb.from('sistema').select('*').eq('id', 1).single();
                    if(data && data.conteudo) {
                        // Merge com cuidado para não quebrar estruturas novas
                        const cloud = data.conteudo;
                        if(cloud.maquinas) Store.maquinas = cloud.maquinas;
                        if(cloud.pedidos) Store.pedidos = cloud.pedidos;
                        if(cloud.operadores) Store.operadores = cloud.operadores;
                    }
                } catch(e) { console.log("Offline mode or first run"); }

                this.startClock();
                setInterval(() => this.tick(), 1000); // Clock principal de 1s
                setInterval(() => this.save(), 30000); // Autosave 30s
                
                UI.renderSidebarMachines();
                UI.refresh();
            },

            tick() {
                // Atualiza relógio
                document.getElementById('clock-time').innerText = moment().format('HH:mm:ss');
                document.getElementById('clock-date').innerText = moment().format('DD/MM/YYYY');

                // Atualiza contadores de tempo das máquinas
                const now = Date.now();
                Store.maquinas.forEach(m => {
                    const elapsedSec = 1; // 1 segundo passou
                    if(m.status === 'produzindo') m.stats.run += 1;
                    else if(m.status === 'parada') m.stats.stop += 1;
                    else if(m.status === 'setup') m.stats.setup += 1;
                    else m.stats.off += 1;
                });

                // Se estiver no dashboard ou maquina, atualiza UI de tempo real
                if(document.getElementById('view-dashboard').style.display !== 'none') UI.updateDashboardTimers();
                if(document.getElementById('view-maquina').style.display !== 'none') UI.updateMachineTimers();
            },

            async save() {
                const ind = document.getElementById('status-indicator');
                if(ind) ind.classList.add('opacity-50');
                await sb.from('sistema').update({ conteudo: Store }).eq('id', 1);
                if(ind) ind.classList.remove('opacity-50');
            }
        };

        // --- AUTH ---
        const Auth = {
            login(e) {
                e.preventDefault();
                const p = document.getElementById('login-pass').value;
                if(p === CONFIG.pass) {
                    document.getElementById('screen-login').classList.add('hidden');
                    document.getElementById('app-layout').classList.remove('hidden');
                    System.init();
                } else {
                    alert('Acesso Negado');
                }
            }
        };

        // --- ROUTER ---
        const Router = {
            go(route) {
                document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
                document.getElementById(`view-${route}`).classList.add('active');
                
                // Sidebar active state
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active', 'bg-white/5', 'text-white'));
                const nav = document.getElementById(`nav-${route}`);
                if(nav) nav.classList.add('active', 'bg-white/5', 'text-white');

                // Titles
                const titles = { 'dashboard': 'Visão Geral', 'calculadora': 'Pedidos & Calc', 'operadores': 'Equipe', 'maquina': 'Painel Máquina' };
                document.getElementById('page-title').innerText = titles[route];

                UI.refresh();
            }
        };

        // --- CONTROLLERS ---
        const Calculator = {
            temp: null,
            calc() {
                const peso = parseFloat(document.getElementById('calc-peso').value) || 0;
                const ciclo = parseFloat(document.getElementById('calc-ciclo').value) || 0;
                const cav = parseFloat(document.getElementById('calc-cav').value) || 1;
                const meta = parseFloat(document.getElementById('calc-meta').value) || 0;
                const pig = parseFloat(document.getElementById('calc-pig').value) || 0;

                if(ciclo <= 0) return alert("Ciclo inválido");

                const pph = (3600 / ciclo) * cav;
                const horas = meta / pph;
                const matKg = (peso * meta) / 1000;
                const pigKg = matKg * (pig / 100);

                document.getElementById('res-tempo').innerText = horas.toFixed(1) + 'h';
                document.getElementById('res-pph').innerText = Math.round(pph);
                document.getElementById('res-mat').innerText = matKg.toFixed(2) + 'kg';
                document.getElementById('res-pig').innerText = pigKg.toFixed(3) + 'kg';
                
                document.getElementById('calc-res').classList.remove('hidden');
                this.temp = { meta, ciclo, cav, horas, matKg, pigKg };
            },
            saveOrder() {
                if(!this.temp) return;
                const prod = prompt("Nome do Produto/Cliente:");
                if(prod) {
                    Store.pedidos.push({
                        id: Date.now(),
                        produto: prod,
                        ...this.temp,
                        data: moment().format('DD/MM/YYYY')
                    });
                    System.save();
                    UI.renderOrders();
                    alert("Pedido Criado!");
                }
            }
        };

        const Operators = {
            add() {
                const n = document.getElementById('new-op-name').value;
                if(n) {
                    Store.operadores.push(n);
                    document.getElementById('new-op-name').value = '';
                    System.save();
                    UI.renderOperators();
                }
            },
            remove(idx) {
                Store.operadores.splice(idx, 1);
                System.save();
                UI.renderOperators();
            }
        };

        const Machines = {
            select(id) {
                Store.selectedMachine = id;
                Router.go('maquina');
                UI.renderMachineDetail();
            },
            setStatus(status) {
                const m = Store.maquinas.find(x => x.id === Store.selectedMachine);
                m.status = status;
                m.lastStatusChange = Date.now(); // Reset timer for current status view
                System.save();
                UI.renderMachineDetail();
                UI.renderSidebarMachines();
            },
            setOperator(name) {
                const m = Store.maquinas.find(x => x.id === Store.selectedMachine);
                m.operador = name;
                System.save();
            },
            addCycle(qtd) {
                const m = Store.maquinas.find(x => x.id === Store.selectedMachine);
                if(m.status !== 'produzindo') {
                    if(!confirm("Máquina não está PRODUZINDO. Registrar mesmo assim?")) return;
                }
                m.pedido.realizado += (qtd * m.pedido.cav);
                System.save();
                UI.renderMachineDetail();
            },
            loadOrder(idxOrder) {
                const p = Store.pedidos[idxOrder];
                if(!p) return;
                
                // Ask for machine
                let text = "Escolha a máquina (1-4):\n";
                Store.maquinas.forEach(m => text += `${m.id}: ${m.nome} (${m.status})\n`);
                const mid = prompt(text);
                const m = Store.maquinas.find(x => x.id == mid);
                
                if(m) {
                    m.pedido = {
                        produto: p.produto,
                        meta: p.meta,
                        ciclo: p.ciclo,
                        cav: p.cav,
                        realizado: 0
                    };
                    System.save();
                    alert(`Pedido carregado na ${m.nome}`);
                    UI.refresh();
                } else {
                    alert("Máquina inválida");
                }
            },
            updateManual(field, val) {
                const m = Store.maquinas.find(x => x.id === Store.selectedMachine);
                if(field === 'produto') m.pedido.produto = val;
                else m.pedido[field] = parseFloat(val);
                System.save();
            }
        };

        // --- UI RENDERER ---
        const UI = {
            refresh() {
                this.renderDashboard();
                this.renderOrders();
                this.renderOperators();
                if(document.getElementById('view-maquina').classList.contains('active')) this.renderMachineDetail();
            },

            formatTime(ms) {
                const dur = moment.duration(ms);
                return Math.floor(dur.asHours()).toString().padStart(2,'0') + ":" + 
                       dur.minutes().toString().padStart(2,'0') + ":" + 
                       dur.seconds().toString().padStart(2,'0');
            },

            renderSidebarMachines() {
                const div = document.getElementById('sidebar-machines');
                div.innerHTML = '';
                Store.maquinas.forEach(m => {
                    let color = m.status === 'produzindo' ? 'bg-green-500' : m.status === 'parada' ? 'bg-red-500' : m.status === 'setup' ? 'bg-yellow-500' : 'bg-slate-500';
                    div.innerHTML += `
                        <button onclick="Machines.select(${m.id})" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                            <span class="w-2 h-2 rounded-full ${color} shadow-[0_0_10px_currentColor]"></span>
                            <span class="font-bold text-sm group-hover:text-brand-light">${m.nome}</span>
                        </button>
                    `;
                });
            },

            renderDashboard() {
                let total = 0, active = 0, stopped = 0;
                let metaSum = 0, realSum = 0;
                let stats = { run: 0, stop: 0, setup: 0, off: 0 };

                const tbody = document.getElementById('table-dashboard-body');
                tbody.innerHTML = '';

                Store.maquinas.forEach(m => {
                    total += m.pedido.realizado;
                    if(m.status === 'produzindo') active++; else stopped++;
                    metaSum += m.pedido.meta; realSum += m.pedido.realizado;
                    
                    stats.run += m.stats.run; stats.stop += m.stats.stop; stats.setup += m.stats.setup; stats.off += m.stats.off;

                    // Timer string calculation
                    const timeInStatus = Date.now() - m.lastStatusChange;
                    const timeStr = UI.formatTime(timeInStatus);

                    let stColor = m.status === 'produzindo' ? 'text-green-500' : m.status === 'parada' ? 'text-red-500' : 'text-slate-500';
                    let pct = m.pedido.meta > 0 ? Math.round((m.pedido.realizado/m.pedido.meta)*100) : 0;

                    tbody.innerHTML += `
                        <tr class="border-b border-white/5 hover:bg-white/5 transition">
                            <td class="p-4 font-bold text-white">${m.nome}</td>
                            <td class="p-4 uppercase font-bold text-xs ${stColor}">${m.status}</td>
                            <td class="p-4 font-mono text-slate-300 status-timer" data-start="${m.lastStatusChange}">${timeStr}</td>
                            <td class="p-4 text-slate-400">${m.operador || '-'}</td>
                            <td class="p-4 text-brand-light font-bold">${m.pedido.produto}</td>
                            <td class="p-4 text-right font-mono text-white">${pct}%</td>
                        </tr>
                    `;
                });

                document.getElementById('kpi-total').innerText = total;
                document.getElementById('kpi-active').innerText = active;
                document.getElementById('kpi-stopped').innerText = stopped;
                let eff = metaSum > 0 ? Math.round((realSum/metaSum)*100) : 0;
                document.getElementById('kpi-eff').innerText = eff + '%';
                document.getElementById('bar-eff').style.width = eff + '%';

                this.renderCharts(stats);
            },

            updateDashboardTimers() {
                // Update text without re-rendering whole table
                document.querySelectorAll('.status-timer').forEach(el => {
                    const start = parseInt(el.getAttribute('data-start'));
                    el.innerText = UI.formatTime(Date.now() - start);
                });
            },

            renderCharts(stats) {
                // Bar Chart
                if(window.chartBar) window.chartBar.destroy();
                const ctxBar = document.getElementById('chart-bar').getContext('2d');
                window.chartBar = new Chart(ctxBar, {
                    type: 'bar',
                    data: {
                        labels: Store.maquinas.map(m => m.nome),
                        datasets: [{ 
                            label: 'Peças', data: Store.maquinas.map(m => m.pedido.realizado),
                            backgroundColor: '#2563eb', borderRadius: 4 
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { y: { grid: {color:'#333'} }, x: { grid: {display:false} } } }
                });

                // Doughnut (Time)
                if(window.chartDough) window.chartDough.destroy();
                const ctxDough = document.getElementById('chart-doughnut').getContext('2d');
                window.chartDough = new Chart(ctxDough, {
                    type: 'doughnut',
                    data: {
                        labels: ['Prod', 'Parada', 'Setup', 'Off'],
                        datasets: [{
                            data: [stats.run, stats.stop, stats.setup, stats.off],
                            backgroundColor: ['#00d26a', '#f8312f', '#ffc107', '#6c757d'], borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: {position:'right', labels:{color:'#fff'}} } }
                });
            },

            renderOrders() {
                const div = document.getElementById('orders-list');
                div.innerHTML = '';
                Store.pedidos.forEach((p, idx) => {
                    div.innerHTML += `
                        <div class="bg-dark-900/50 p-4 rounded-xl border border-white/5 flex justify-between items-center group hover:border-brand-DEFAULT transition">
                            <div>
                                <h4 class="font-bold text-white text-sm">${p.produto}</h4>
                                <div class="text-[10px] text-slate-500 mt-1 space-x-2 font-mono">
                                    <span><i class="fa-solid fa-bullseye"></i> ${p.meta}</span>
                                    <span><i class="fa-solid fa-clock"></i> ${p.horas.toFixed(1)}h</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="Machines.loadOrder(${idx})" class="bg-white text-black px-3 py-1 rounded text-xs font-bold hover:bg-brand-light hover:text-white transition">USAR</button>
                                <button onclick="if(confirm('Excluir?')){Store.pedidos.splice(${idx},1);System.save();UI.renderOrders();}" class="text-slate-600 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('order-count').innerText = Store.pedidos.length;
            },

            renderOperators() {
                const div = document.getElementById('operators-grid');
                div.innerHTML = '';
                Store.operadores.forEach((op, idx) => {
                    div.innerHTML += `
                        <div class="bg-dark-900/50 p-4 rounded-xl border border-white/5 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 font-bold">${op[0]}</div>
                                <span class="font-bold text-slate-300 text-sm">${op}</span>
                            </div>
                            <button onclick="Operators.remove(${idx})" class="text-slate-600 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                        </div>
                    `;
                });
            },

            renderMachineDetail() {
                const m = Store.maquinas.find(x => x.id === Store.selectedMachine);
                const div = document.getElementById('machine-detail-container');
                
                // Status Logic
                const btnClass = (type) => {
                    let base = "btn-status flex-1 py-4 rounded-xl font-bold flex flex-col items-center justify-center gap-1 border border-white/5 ";
                    if(m.status === type) return base + "active " + (type==='produzindo'?'bg-green-500 text-black':type==='parada'?'bg-red-500 text-white':type==='setup'?'bg-yellow-500 text-black':'bg-slate-500 text-white');
                    return base + "bg-dark-800 text-slate-500 hover:bg-dark-700";
                }

                // Operator Options
                let opsHtml = `<option value="">Selecionar Operador...</option>`;
                Store.operadores.forEach(op => opsHtml += `<option value="${op}" ${m.operador===op?'selected':''}>${op}</option>`);

                // Progress
                const pct = m.pedido.meta > 0 ? Math.min(100, Math.round((m.pedido.realizado/m.pedido.meta)*100)) : 0;
                const offset = 753 - (753 * pct) / 100;
                let ringColor = m.status === 'produzindo' ? '#00d26a' : m.status === 'parada' ? '#f8312f' : '#2563eb';

                // Timer
                const timeStr = UI.formatTime(Date.now() - m.lastStatusChange);

                div.innerHTML = `
                    <div class="glass-panel rounded-3xl border border-white/10 overflow-hidden shadow-2xl">
                        <div class="bg-dark-800/50 p-6 md:p-8 flex flex-col md:flex-row justify-between items-start md:items-center border-b border-white/5 gap-6">
                            <div>
                                <h1 class="text-5xl font-tech font-bold text-white">${m.nome}</h1>
                                <div class="flex items-center gap-4 mt-2">
                                    <div class="bg-dark-900 border border-white/10 px-3 py-1 rounded flex items-center gap-2">
                                        <i class="fa-solid fa-user text-slate-500"></i>
                                        <select onchange="Machines.setOperator(this.value)" class="bg-transparent text-brand-light font-bold outline-none cursor-pointer">
                                            ${opsHtml}
                                        </select>
                                    </div>
                                    <div class="font-mono text-xl text-white font-bold bg-white/5 px-3 py-1 rounded border border-white/10" id="mach-timer-big">${timeStr}</div>
                                </div>
                            </div>
                            <div class="text-right bg-dark-900/50 p-4 rounded-xl border border-white/5 min-w-[200px]">
                                <span class="text-xs text-slate-500 uppercase font-bold tracking-widest block">Peças Produzidas</span>
                                <span class="text-6xl font-mono font-bold text-white drop-shadow-lg">${m.pedido.realizado}</span>
                            </div>
                        </div>

                        <div class="p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-6">
                                <div class="bg-dark-900/40 p-6 rounded-2xl border border-white/5 shadow-inner">
                                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 border-b border-white/5 pb-2 flex justify-between">
                                        <span>Dados do Pedido</span>
                                        <span class="text-brand-light cursor-pointer hover:underline" onclick="Router.go('calculadora')">Carregar Novo</span>
                                    </h4>
                                    <div class="space-y-4">
                                        <div><label class="text-[10px] text-brand-light uppercase font-bold">Produto</label><input class="input-tech w-full p-3 rounded-lg text-white font-bold" value="${m.pedido.produto}" onchange="Machines.updateManual('produto', this.value)"></div>
                                        <div class="grid grid-cols-3 gap-3">
                                            <div><label class="text-[10px] text-slate-500 uppercase font-bold">Meta</label><input type="number" class="input-tech w-full p-2 text-center rounded-lg" value="${m.pedido.meta}" onchange="Machines.updateManual('meta', this.value)"></div>
                                            <div><label class="text-[10px] text-slate-500 uppercase font-bold">Ciclo</label><input type="number" class="input-tech w-full p-2 text-center rounded-lg" value="${m.pedido.ciclo}" onchange="Machines.updateManual('ciclo', this.value)"></div>
                                            <div><label class="text-[10px] text-slate-500 uppercase font-bold">Cav</label><input type="number" class="input-tech w-full p-2 text-center rounded-lg" value="${m.pedido.cav}" onchange="Machines.updateManual('cav', this.value)"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="Machines.setStatus('produzindo')" class="${btnClass('produzindo')}"><i class="fa-solid fa-play text-2xl"></i> PRODUZINDO</button>
                                    <button onclick="Machines.setStatus('parada')" class="${btnClass('parada')}"><i class="fa-solid fa-stop text-2xl"></i> PARADA</button>
                                    <button onclick="Machines.setStatus('setup')" class="${btnClass('setup')}"><i class="fa-solid fa-tools"></i> SETUP</button>
                                    <button onclick="Machines.setStatus('desligada')" class="${btnClass('desligada')}"><i class="fa-solid fa-power-off"></i> OFF</button>
                                </div>
                            </div>

                            <div class="flex flex-col items-center justify-center bg-dark-900/20 rounded-2xl border border-white/5 p-6">
                                <div class="relative w-64 h-64 mb-6">
                                    <svg class="w-full h-full transform -rotate-90">
                                        <circle cx="128" cy="128" r="120" stroke="#1e1e1e" stroke-width="16" fill="none"></circle>
                                        <circle cx="128" cy="128" r="120" stroke="${ringColor}" stroke-width="16" fill="none" stroke-dasharray="753" stroke-dashoffset="${offset}" stroke-linecap="round" class="transition-all duration-1000"></circle>
                                    </svg>
                                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                                        <span class="text-6xl font-mono font-black text-white">${pct}%</span>
                                        <span class="text-xs uppercase text-slate-500 font-bold tracking-widest mt-1">Concluído</span>
                                    </div>
                                </div>
                                <button onclick="Machines.addCycle(1)" class="w-full py-5 bg-gradient-to-r from-brand-dark to-brand-DEFAULT rounded-xl shadow-neon-blue text-white font-black text-2xl uppercase tracking-widest hover:brightness-110 active:scale-95 transition-all">
                                    +${m.pedido.cav} Peças
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            updateMachineTimers() {
                const el = document.getElementById('mach-timer-big');
                if(el) {
                    const m = Store.maquinas.find(x => x.id === Store.selectedMachine);
                    el.innerText = UI.formatTime(Date.now() - m.lastStatusChange);
                }
            }
        };

    </script>
</body>
</html>
