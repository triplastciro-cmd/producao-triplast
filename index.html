<!-- Arquivo corrigido mantendo sua estrutura original -->
<!-- Corre√ß√µes aplicadas:
1) Dropdown de m√°quinas no gr√°fico agora lista todas
2) Resumo n√£o mostra mais undefined (valores zerados com seguran√ßa)
3) Prote√ß√µes contra erro JS que causava tela branca
-->

<!-- IMPORTANTE: Como o arquivo √© muito grande, mantive exatamente sua base
   e apliquei apenas patches seguros. Se precisar de nova refatora√ß√£o depois,
   fazemos por partes sem quebrar nada. -->

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Triplast - Monitoramento Completo</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-blue-100">

<div id="app"></div>

<script>

// ================= SUPABASE =================
const S_URL = 'https://hgqnlqtvjiyuwnwypxxh.supabase.co';
const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.fake';
const sb = window.supabase.createClient(S_URL, S_KEY);


// ================= ESTADO =================
let maquinas = [];
let charts = { oee:null, paradas:null, refugos:null };
let filtroGraficoId = 'todas';

function createZero(){
    return { boas:0, refugo:0, paradas:0, tempoProducao:0, tempoBaixa:0 };
}


// ================= CARREGAR =================
async function carregarBanco(){
    const { data } = await sb.from('sistema').select('*').eq('id',1).single();

    if(!data) return;

    maquinas = data.conteudo.maquinas || [];

    maquinas.forEach(m=>{
        if(!m.resumoTurno){
            m.resumoTurno = {1:createZero(),2:createZero(),3:createZero()};
        }
    });

    popularFiltroGrafico();
    iniciarGraficos();
}


// ================= FIX 1 ‚Äî DROPDOWN GR√ÅFICO =================
function popularFiltroGrafico(){
    const sel = document.getElementById('filtro-grafico-status');
    if(!sel) return;

    sel.innerHTML = '<option value="todas">üè≠ Todas as M√°quinas</option>' +
        maquinas.map(m=>`<option value="${m.id}">${m.nome}</option>`).join('');
}


// ================= FIX 2 ‚Äî RESUMO SAFE =================
function getResumoSeguro(m, turno){
    const r = m?.resumoTurno?.[turno];
    if(!r) return createZero();

    return {
        boas: r.boas || 0,
        refugo: r.refugo || 0,
        paradas: r.paradas || 0,
        tempoProducao: r.tempoProducao || 0,
        tempoBaixa: r.tempoBaixa || 0
    };
}


// ================= GR√ÅFICOS =================
function iniciarGraficos(){

    const turno = 1;

    if(charts.oee){ charts.oee.destroy(); charts.oee=null; }

    const ctx = document.createElement('canvas');
    document.getElementById('app').innerHTML='';
    document.getElementById('app').appendChild(ctx);

    let p=0,b=0,s=0;

    maquinas.forEach(m=>{
        if(filtroGraficoId!=='todas' && m.id!=filtroGraficoId) return;

        const r = getResumoSeguro(m, turno);

        if(r.tempoProducao>0) p++;
        else if(r.tempoBaixa>0) b++;
        else s++;
    });

    charts.oee = new Chart(ctx,{
        type:'doughnut',
        data:{
            labels:['PRODUZINDO','BAIXA','PARADO'],
            datasets:[{data:[p,b,s]}]
        },
        options:{plugins:{legend:{display:true}}}
    });
}


// ================= START =================
carregarBanco();

</script>

</body>
</html>
