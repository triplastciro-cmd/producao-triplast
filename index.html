<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triplast Cloud | Industrial ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        :root { --primary: #2563eb; --dark: #0f172a; }
        body { background: #f1f5f9; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        
        .sidebar-btn { transition: 0.3s; border-radius: 12px; display: flex; align-items: center; gap: 12px; width: 100%; padding: 12px; font-weight: 600; color: #64748b; }
        .sidebar-btn:hover { background: #e2e8f0; color: var(--primary); }
        .sidebar-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilo Vidro (Glassmorphism) */
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="flex">

    <div id="login-screen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl w-full max-w-md text-center">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl mx-auto mb-6 flex items-center justify-center text-white text-4xl shadow-lg shadow-blue-500/30">
                <i class="fa-solid fa-industry"></i>
            </div>
            <h1 class="text-4xl font-extrabold text-slate-800 mb-2 italic tracking-tighter">TRIPLAST</h1>
            <p class="text-slate-400 font-bold mb-8 uppercase text-[10px] tracking-widest">Controle de Produção</p>
            
            <div class="space-y-4">
                <input type="password" id="pass-code" placeholder="Senha de Acesso" class="w-full p-4 bg-slate-100 rounded-2xl text-center font-bold outline-none border-2 border-transparent focus:border-blue-500 transition-all">
                <button onclick="validaLogin()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-black shadow-xl hover:bg-blue-700 transition-all">ENTRAR</button>
            </div>
            <p class="mt-6 text-[10px] text-slate-300 font-bold uppercase">Software Versão 2.0.26</p>
        </div>
    </div>

    <aside id="main-sidebar" class="w-64 bg-white border-r border-slate-200 p-6 flex flex-col hidden">
        <div class="text-2xl font-black italic text-slate-800 mb-10 tracking-tighter">TRIPLAST <span class="text-blue-600">PRO</span></div>
        
        <nav class="space-y-2 flex-1">
            <button onclick="showView('monitor')" id="nav-monitor" class="sidebar-btn active"><i class="fa-solid fa-gauge-high"></i> Painel Geral</button>
            <button onclick="showView('ops')" id="nav-ops" class="sidebar-btn"><i class="fa-solid fa-file-contract"></i> Gestão de O.P</button>
            <button onclick="showView('produtos')" id="nav-produtos" class="sidebar-btn"><i class="fa-solid fa-box-open"></i> Produtos</button>
            <button onclick="showView('equipe')" id="nav-equipe" class="sidebar-btn"><i class="fa-solid fa-users-gear"></i> Equipe</button>
            <button onclick="showView('graficos')" id="nav-graficos" class="sidebar-btn"><i class="fa-solid fa-chart-pie"></i> Relatórios</button>
        </nav>

        <div class="pt-6 border-t border-slate-100">
            <button onclick="location.reload()" class="sidebar-btn text-red-400 hover:bg-red-50 hover:text-red-600"><i class="fa-solid fa-power-off"></i> Sair do Sistema</button>
        </div>
    </aside>

    <main id="main-content" class="flex-1 overflow-y-auto p-8 hidden">
        <header class="flex justify-between items-end mb-10">
            <div>
                <h2 id="view-title" class="text-4xl font-black text-slate-800 tracking-tight uppercase">Painel Geral</h2>
                <p id="view-subtitle" class="text-slate-400 font-bold text-xs uppercase tracking-widest">Status das injetoras em tempo real</p>
            </div>
            <div class="text-right">
                <div id="clock" class="text-2xl font-black text-slate-700 tabular-nums italic">00:00:00</div>
                <div id="db-status" class="text-[9px] font-black text-green-500 uppercase tracking-widest flex items-center gap-2 justify-end">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Sistema Online
                </div>
            </div>
        </header>

        <div id="view-monitor" class="view-section active">
             <div id="grid-maquinas" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="view-ops" class="view-section">
            <div class="bg-white p-8 rounded-[32px] shadow-sm border border-slate-200">
                <h3 class="font-black text-slate-800 mb-6 uppercase">Nova Ordem de Produção</h3>
                </div>
        </div>

        <div id="view-produtos" class="view-section">
            </div>

        <div id="view-equipe" class="view-section">
            </div>

        <div id="view-graficos" class="view-section">
            </div>

    </main>

    <script>
        // --- CONFIGURAÇÃO SUPABASE ---
        // IMPORTANTE: Insira aqui as suas chaves originais que estavam no outro arquivo
        const SB_URL = 'SUA_URL_AQUI';
        const SB_KEY = 'SUA_KEY_AQUI';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        // VARIÁVEIS DE ESTADO
        let maquinas = [];
        let produtosGlobais = [];
        let operadoresGlobais = [];
        let historico = [];
        let saveTimeout = null;

        // --- SISTEMA DE LOGIN ---
        function validaLogin() {
            const pass = document.getElementById('pass-code').value;
            if(pass === '123') { // Senha padrão
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-sidebar').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                carregarDadosIniciais();
            } else {
                alert("Senha incorreta!");
            }
        }

        // --- CARREGAMENTO DE DADOS ---
        async function carregarDadosIniciais() {
            try {
                const { data, error } = await sb.from('sistema').select('conteudo').eq('id', 1).single();
                if (data && data.conteudo) {
                    const c = data.conteudo;
                    maquinas = c.maquinas || [];
                    produtosGlobais = c.produtos || [];
                    operadoresGlobais = c.operadores || [];
                    historico = c.historico || [];
                    
                    renderMaquinas();
                    popularSelectsOP();
                }
            } catch (err) {
                console.error("Erro ao carregar:", err);
            }
        }

        // --- RENDERIZAÇÃO DAS MÁQUINAS (DESIGN MODERNO) ---
        function renderMaquinas() {
            const grid = document.getElementById('grid-maquinas');
            grid.innerHTML = maquinas.map((m, index) => {
                const progresso = m.opativa ? Math.min(((m.produzido || 0) / (m.opativa.qtd || 1)) * 100, 100).toFixed(1) : 0;
                const statusColor = m.status === 'rodando' ? 'text-green-500' : 'text-red-500';
                
                return `
                <div class="glass p-6 rounded-[32px] shadow-sm border border-white hover:shadow-xl transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-black text-slate-800 text-xl tracking-tighter uppercase">${m.nome}</h3>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${m.opativa ? m.opativa.produto : 'SEM O.P ATIVA'}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-current ${statusColor} animate-pulse"></span>
                            <span class="text-[10px] font-black uppercase ${statusColor}">${m.status || 'PARADA'}</span>
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-2xl p-4 mb-4">
                        <div class="flex justify-between text-[10px] font-black text-slate-400 uppercase mb-2">
                            <span>Progresso</span>
                            <span>${progresso}%</span>
                        </div>
                        <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-600 transition-all duration-500" style="width: ${progresso}%"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="bg-slate-800 text-white p-3 rounded-2xl text-center">
                            <p class="text-[8px] font-bold opacity-50 uppercase">Produzido</p>
                            <p class="text-xl font-black">${m.produzido || 0}</p>
                        </div>
                        <div class="bg-red-50 text-red-600 p-3 rounded-2xl text-center border border-red-100">
                            <p class="text-[8px] font-bold opacity-70 uppercase">Refugo</p>
                            <p class="text-xl font-black">${m.refugo || 0}</p>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="apontarProducao(${index})" class="flex-1 bg-blue-600 text-white p-3 rounded-xl font-bold text-xs">+ PRODUÇÃO</button>
                        <button onclick="abrirConfigMaquina(${index})" class="w-12 bg-slate-100 text-slate-400 p-3 rounded-xl hover:bg-slate-800 hover:text-white transition-all">
                            <i class="fa-solid fa-gear"></i>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- FUNÇÕES DE SALVAMENTO ---
        async function salvarGeral() {
            const payload = {
                maquinas, 
                produtos: produtosGlobais, 
                operadores: operadoresGlobais, 
                historico,
                lastUpdate: Date.now()
            };
            
            const { error } = await sb.from('sistema').update({ conteudo: payload }).eq('id', 1);
            if(!error) {
                document.getElementById('db-status').innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full"></span> Sincronizado';
            }
        }

        function agendarSalvamento() {
            document.getElementById('db-status').innerHTML = '<span class="w-2 h-2 bg-yellow-500 rounded-full animate-bounce"></span> Salvando...';
            if(saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(salvarGeral, 2000);
        }

        // --- LOGICA DE APONTAMENTO ---
        function apontarProducao(idx) {
            if(!maquinas[idx].opativa) return alert("Inicie uma O.P nesta máquina primeiro!");
            maquinas[idx].produzido = (maquinas[idx].produzido || 0) + 1;
            renderMaquinas();
            agendarSalvamento();
        }

        // --- INICIALIZADORES ---
        function popularSelectsOP() {
            const select = document.getElementById('op-produto');
            if(select) {
                select.innerHTML = '<option value="">SELECIONE UM PRODUTO...</option>' + 
                produtosGlobais.map(p => `<option value="${p.nome}">${p.nome}</option>`).join('');
            }
        }

        // Relógio e Autoload
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('pt-br');
        }, 1000);

    </script>
</body>
</html>
</body>
</html>

