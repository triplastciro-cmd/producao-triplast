<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triplast - Controle de Produ√ß√£o v7.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body { 
            background-color: #add8e6; /* Azul claro do fundo das imagens */
            font-family: 'Inter', sans-serif;
            color: #333;
        }

        .aba-conteudo { display: none; }
        .aba-ativa { display: block; }

        /* Estilo dos Cart√µes (Painel) */
        .card-producao {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 8px solid #e5e7eb; /* Cor padr√£o: Aguardando */
            transition: all 0.3s ease;
        }
        .card-status-produzindo { border-left-color: #22c55e; background-color: #f0fdf4; }
        .card-status-parada { border-left-color: #ef4444; background-color: #fef2f2; }

        /* Badge de Informa√ß√µes (Apontadas/Saldo) */
        .info-badge {
            background: #f3f4f6;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            min-width: 120px;
        }

        /* Tabs customizadas */
        .tab-btn {
            background: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
            transition: 0.2s;
        }
        .tab-btn.active { background: #3b82f6; color: white; }

        .header-meta {
            background: linear-gradient(to bottom, #f59e0b, #d97706);
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 800;
            font-size: 1.25rem;
            box-shadow: 0 4px 0 #b45309;
        }
    </style>
</head>
<body class="p-4">

    <div class="max-w-7xl mx-auto mb-6">
        <div class="header-meta flex justify-center items-center gap-4">
            <span>üöÄ Alcan√ßamos</span>
            <span class="bg-white/20 px-4 py-1 rounded-lg border border-white/30" id="meta-porcentagem">14%</span>
            <span>da meta! üöÄ</span>
        </div>
    </div>

    <nav class="max-w-7xl mx-auto mb-6 flex gap-3 overflow-x-auto pb-2">
        <button onclick="trocarAba('painel')" id="tab-painel" class="tab-btn active shadow-sm">Painel</button>
        <button onclick="trocarAba('lista')" id="tab-lista" class="tab-btn shadow-sm">Lista</button>
        <button onclick="trocarAba('paradas')" id="tab-paradas" class="tab-btn shadow-sm">Paradas</button>
        <button onclick="trocarAba('rastreio')" id="tab-rastreio" class="tab-btn shadow-sm">Rastreio</button>
        <button onclick="trocarAba('apontamento')" id="tab-apontamento" class="tab-btn shadow-sm">Apontamento</button>
    </nav>

    <main id="aba-painel" class="aba-conteudo aba-ativa max-w-7xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="grid-maquinas">
            </div>
    </main>

    <main id="aba-lista" class="aba-conteudo max-w-7xl mx-auto bg-white/50 p-6 rounded-3xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black uppercase text-slate-800">Fila de Produ√ß√£o</h2>
            <button onclick="novaOP()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold">+ Nova OP</button>
        </div>
        <div id="fila-container" class="space-y-4"></div>
    </main>

    <main id="aba-paradas" class="aba-conteudo max-w-5xl mx-auto">
        <div class="bg-white p-8 rounded-3xl shadow-xl">
            <h2 class="text-xl font-black mb-6">Resumo do Per√≠odo</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <canvas id="graficoParadas"></canvas>
                <div id="legenda-paradas" class="space-y-2 font-bold"></div>
            </div>
        </div>
    </main>

    <script>
        // CONFIGURA√á√ïES SUPABASE
        const S_URL = 'https://hgqnlqtvjiyuwnwypxxh.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhncW5scXR2aml5dXdud3lweHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjE1MDcsImV4cCI6MjA4NjQzNzUwN30.njSVfWDpIJK49IpRSgyMf6e5MEmJ-AROVT7-nOTZD9Y';
        const sb = window.supabase.createClient(S_URL, S_KEY);

        // C√ìDIGOS DE PARADA
        const motivosParada = [
            "01-TROCA DE MOLDE", "02-TROCA DE POSTI√áO", "03-MATERIA-PRIMA/ AJUSTE", "04-PRODU√á√ÉO",
            "05-AQUECIMENTO DE M√ÅQUINA", "06-TROCA DE COR", "07-MANUTEN√á√ÉO GELADEIRA", "08-LANCHE",
            "09-LIMPEZA", "10-PE√áA PRESA NO MOLDE", "11-INICIO DE PROCESSO", "12-FALTA DE ENERGIA EL√âTRICA",
            "13-MANUTEN√á√ÉO DE MOLDE", "14-MANUTEN√á√ÉO DE M√ÅQUINA", "15-PROBLEMA AR", "16-PROBLEMA CAMAR√É QUENTE",
            "17-TROCA DE BICO DE INJE√á√ÉO", "18-FALTA DE OPERADOR", "19-EL√âTRICA DE MOLDE", "20-OUTROS"
        ];

        let maquinas = [];

        async function carregarDados() {
            let { data } = await sb.from('sistema').select('*').eq('id', 1).single();
            if (data) {
                maquinas = data.conteudo.maquinas;
                renderizarPainel();
            }
        }

        function renderizarPainel() {
            const grid = document.getElementById('grid-maquinas');
            grid.innerHTML = maquinas.map(m => {
                const op = m.fila[0] || { op: '---', cliente: '---', produto: 'AGUARDANDO', cor: '---', qtd: 0, volumes: 0, padrao: 0, prazo: '--/--/--', produzidas: 0, prioridade: 1 };
                const saldo = op.qtd - op.produzidas;
                
                // L√≥gica de classe baseada na situa√ß√£o
                let statusClass = "";
                if (m.situacao === "Produzindo") statusClass = "card-status-produzindo";
                if (m.situacao === "Parada") statusClass = "card-status-parada";

                return `
                <div class="card-producao ${statusClass} p-4 flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                        <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg font-black text-lg">${m.nome}</span>
                        <span class="font-mono font-bold text-blue-600">${m.tempo || '00:00:00'}</span>
                        <span class="bg-slate-100 text-[10px] px-2 py-1 rounded uppercase font-bold text-slate-500">Prioridade: ${op.prioridade}</span>
                    </div>

                    <div class="border rounded-xl p-3 bg-white/50 text-xs leading-relaxed">
                        <div class="font-black text-sm mb-1">O.P - ${op.op}</div>
                        <div><b>Cliente:</b> ${op.cliente}</div>
                        <div><b>Produto:</b> ${op.produto}</div>
                        <div><b>Cor:</b> ${op.cor}</div>
                        <div class="grid grid-cols-2 mt-1">
                            <div><b>Qtd:</b> ${op.qtd}</div>
                            <div class="flex justify-end"><div class="info-badge">Apontadas: <span class="text-blue-600">${op.produzidas}</span></div></div>
                        </div>
                        <div class="grid grid-cols-2 mt-1">
                            <div><b>Volumes:</b> ${op.volumes}</div>
                            <div class="flex justify-end"><div class="info-badge">Saldo: <span class="text-red-600">${saldo}</span></div></div>
                        </div>
                        <div><b>Padr√£o:</b> ${op.padrao}</div>
                        <div><b>Prazo:</b> ${op.prazo}</div>
                    </div>

                    <div class="flex flex-col gap-2">
                        <label class="text-[10px] font-bold uppercase text-slate-400">Situa√ß√£o</label>
                        <select onchange="alterarSituacao(${m.id}, this.value)" class="w-full p-2 border rounded-lg font-bold text-sm outline-none">
                            <option value="Aguardando" ${m.situacao === 'Aguardando' ? 'selected' : ''}>Aguardando</option>
                            <option value="Produzindo" ${m.situacao === 'Produzindo' ? 'selected' : ''}>Produzindo</option>
                            <option value="Baixa Efici√™ncia" ${m.situacao === 'Baixa Efici√™ncia' ? 'selected' : ''}>Baixa Efici√™ncia</option>
                            <option value="Parada" ${m.situacao === 'Parada' ? 'selected' : ''}>Parada</option>
                        </select>
                    </div>

                    <button class="w-full bg-slate-50 border py-2 rounded-lg font-black text-xs uppercase hover:bg-slate-100">Iniciar Produ√ß√£o</button>
                </div>
                `;
            }).join('');
        }

        function trocarAba(aba) {
            document.querySelectorAll('.aba-conteudo').forEach(a => a.classList.remove('aba-ativa'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('aba-' + aba).classList.add('aba-ativa');
            document.getElementById('tab-' + aba).classList.add('active');
            if (aba === 'paradas') renderizarGrafico();
        }

        async function alterarSituacao(id, novaSituacao) {
            const m = maquinas.find(x => x.id === id);
            m.situacao = novaSituacao;
            renderizarPainel();
            await sb.from('sistema').update({ conteudo: { maquinas, historico: [] } }).eq('id', 1);
        }

        function renderizarGrafico() {
            const ctx = document.getElementById('graficoParadas').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Produzindo', 'Parada', 'Sem Programa√ß√£o'],
                    datasets: [{
                        data: [42, 34, 24],
                        backgroundColor: ['#22c55e', '#ef4444', '#3b82f6']
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });
            document.getElementById('legenda-paradas').innerHTML = `
                <div class="text-green-600">‚óè Produzindo: 78:12:13 - 42,2%</div>
                <div class="text-red-600">‚óè Parada: 63:47:56 - 34,4%</div>
                <div class="text-blue-600">‚óè Sem Programa√ß√£o: 43:26:17 - 23,4%</div>
            `;
        }

        carregarDados();
    </script>
</body>
</html>
