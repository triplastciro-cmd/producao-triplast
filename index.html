<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRIPLAST | Sistema Industrial</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap');
        
        :root { 
            --primary: #0f172a; 
            --accent: #2563eb; 
            --bg: #f8fafc; 
        }
        
        body { 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            font-family: 'Inter', sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            margin: 0; 
        }
        
        /* Sidebar e Navegação */
        .sidebar-btn { 
            transition: all 0.3s ease; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            width: 100%; 
            padding: 16px; 
            font-weight: 600; 
            color: #64748b; 
            cursor: pointer; 
            text-align: left; 
            background: transparent;
            border: none;
        }
        .sidebar-btn:hover { background: #f1f5f9; color: var(--accent); transform: translateX(4px); }
        .sidebar-btn.active { background: var(--primary); color: white; box-shadow: 0 8px 20px -6px rgba(15, 23, 42, 0.4); transform: translateX(0); }
        
        /* Views e Animações */
        .view-section { display: none; height: 100%; overflow-y: auto; padding-bottom: 100px; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .view-section.active { display: block; }
        
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Scrollbar Customizada */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Login Overlay - Força visibilidade inicial */
        #login-screen { display: flex !important; } 
    </style>
</head>
<body class="flex text-slate-800">

    <div id="login-screen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white p-12 rounded-[40px] shadow-2xl w-full max-w-sm text-center border-4 border-slate-800 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-600 to-indigo-600"></div>
            
            <div class="mb-8">
                <div class="w-20 h-20 bg-slate-900 rounded-3xl mx-auto flex items-center justify-center text-white text-3xl mb-4 shadow-lg ring-4 ring-slate-100">
                    <i class="fa-solid fa-industry"></i>
                </div>
                <h1 class="text-4xl font-black text-slate-900 italic tracking-tighter">TRIPLAST</h1>
                <p class="text-slate-400 font-bold uppercase text-[10px] tracking-[0.3em] mt-2">Sistema Industrial 2026</p>
            </div>

            <div class="space-y-4">
                <input type="password" id="pass-code" placeholder="Senha de Acesso" 
                    class="w-full p-4 bg-slate-50 rounded-2xl text-center font-bold outline-none border-2 border-slate-100 focus:border-blue-600 focus:bg-white transition-all text-lg placeholder:text-slate-300 shadow-inner">
                
                <button onclick="tentarLogin()" 
                    class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold hover:bg-blue-600 hover:shadow-lg hover:scale-[1.02] transition-all duration-300">
                    ACESSAR PAINEL
                </button>
            </div>
            
            <p class="mt-8 text-[10px] text-slate-400 font-medium">
                <span class="bg-slate-100 px-2 py-1 rounded">Admin: 2026</span>
                <span class="bg-slate-100 px-2 py-1 rounded ml-2">Maq: M1 a M4</span>
            </p>
        </div>
    </div>

    <aside id="sidebar" class="w-72 bg-white border-r border-slate-200 p-6 flex flex-col hidden h-full z-10 relative shadow-xl">
        <div class="mb-10 px-2">
            <h2 class="text-3xl font-black italic text-slate-900 tracking-tighter">TRIPLAST</h2>
            <div class="flex items-center gap-2 mt-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_rgba(34,197,94,0.5)]"></span>
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Conectado</span>
            </div>
        </div>

        <nav class="space-y-2 flex-1">
            <button onclick="nav('dashboard')" id="btn-dashboard" class="sidebar-btn active">
                <i class="fa-solid fa-layer-group w-5 text-center"></i> Visão Geral
            </button>
            <button onclick="nav('ops')" id="btn-ops" class="sidebar-btn">
                <i class="fa-solid fa-file-invoice w-5 text-center"></i> Ordens (O.P)
            </button>
            <button onclick="nav('produtos')" id="btn-produtos" class="sidebar-btn">
                <i class="fa-solid fa-box w-5 text-center"></i> Produtos
            </button>
            <button onclick="nav('equipe')" id="btn-equipe" class="sidebar-btn">
                <i class="fa-solid fa-users w-5 text-center"></i> Equipe
            </button>
            <button onclick="nav('graficos')" id="btn-graficos" class="sidebar-btn">
                <i class="fa-solid fa-chart-pie w-5 text-center"></i> Relatórios
            </button>
        </nav>

        <button onclick="location.reload()" class="sidebar-btn text-red-400 hover:bg-red-50 hover:text-red-600 mt-auto">
            <i class="fa-solid fa-power-off w-5 text-center"></i> Sair
        </button>
    </aside>

    <main id="main-content" class="flex-1 h-full relative hidden bg-[#f8fafc]">
        
        <header class="p-8 pb-4 flex justify-between items-end bg-white/60 backdrop-blur-md sticky top-0 z-20 border-b border-slate-200/60">
            <div>
                <h2 id="page-title" class="text-3xl font-black text-slate-800 uppercase tracking-tight">Visão Geral</h2>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mt-1">Gestão Industrial</p>
            </div>
            <div id="clock" class="text-3xl font-black text-slate-300 font-mono tracking-tighter">00:00</div>
        </header>

        <div id="view-dashboard" class="view-section active px-8 pt-6">
            <div id="grid-admin" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                </div>
        </div>

        <div id="view-ops" class="view-section px-8 pt-6">
            <div class="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100 mb-8 relative overflow-hidden group hover:shadow-md transition-all">
                <div class="absolute -right-6 -top-6 text-9xl text-slate-50 opacity-50 rotate-12 group-hover:scale-110 transition-transform"><i class="fa-solid fa-file-contract"></i></div>
                
                <h3 class="font-black text-xl mb-6 uppercase text-slate-800 relative z-10">Nova Ordem de Produção</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 relative z-10">
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 block">Produto</label>
                        <select id="op-produto" onchange="autoPreencherOP()" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold outline-none focus:border-blue-500 transition-colors cursor-pointer"></select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 block">Quantidade</label>
                        <input type="number" id="op-qtd" placeholder="Ex: 5000" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold outline-none focus:border-blue-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="criarOP()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold hover:bg-blue-600 transition-all shadow-lg active:scale-95">GERAR O.P</button>
                    </div>
                </div>
                
                <div id="op-info" class="mt-4 p-4 bg-blue-50 text-blue-800 rounded-2xl text-xs font-bold hidden border border-blue-100 flex items-center gap-4 animate-pulse">
                    <i class="fa-solid fa-circle-check text-lg"></i>
                    <span id="op-info-texto">Ficha técnica carregada</span>
                </div>
            </div>
            
            <h4 class="font-bold text-slate-400 uppercase text-xs mb-4 ml-2 tracking-widest">Fila de Produção</h4>
            <div id="lista-ops" class="space-y-3"></div>
        </div>

        <div id="view-produtos" class="view-section px-8 pt-6">
            <div class="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100 mb-8">
                <h3 class="font-black text-xl mb-6 uppercase">Cadastro Técnico</h3>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                    <div class="col-span-2"><input id="prod-nome" placeholder="Nome do Produto" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-100 focus:border-blue-500 outline-none"></div>
                    <div><input id="prod-mat" placeholder="Material" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-100 focus:border-blue-500 outline-none"></div>
                    <div><input id="prod-peso" type="number" placeholder="Peso (g)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-100 focus:border-blue-500 outline-none"></div>
                    <div><input id="prod-ciclo" type="number" placeholder="Ciclo (s)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-100 focus:border-blue-500 outline-none"></div>
                    <div><input id="prod-cav" type="number" placeholder="Cav." class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm border border-slate-100 focus:border-blue-500 outline-none"></div>
                    <button onclick="addProduto()" class="col-span-2 md:col-span-6 bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200">SALVAR NO CATÁLOGO</button>
                </div>
            </div>
            <div id="lista-produtos" class="bg-white rounded-[32px] border border-slate-100 overflow-hidden shadow-sm"></div>
        </div>

        <div id="view-equipe" class="view-section px-8 pt-6">
            <div class="bg-white p-2 pr-2 pl-6 rounded-[30px] shadow-sm border border-slate-100 mb-8 flex items-center gap-4 hover:shadow-md transition-all">
                <i class="fa-solid fa-user-plus text-slate-300"></i>
                <input id="op-nome" placeholder="Nome do novo operador..." class="flex-1 py-4 bg-transparent font-bold outline-none text-slate-700 placeholder-slate-300">
                <button onclick="addOperador()" class="bg-slate-900 text-white px-8 py-4 rounded-[24px] font-bold hover:bg-black transition-all shadow-lg">ADICIONAR</button>
            </div>
            <div id="lista-equipe" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="view-graficos" class="view-section px-8 pt-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100 h-96 relative">
                    <h4 class="font-black text-sm uppercase text-slate-400 mb-6 tracking-widest">Produção por Máquina</h4>
                    <div class="absolute inset-x-8 bottom-8 top-20">
                        <canvas id="grafico-prod"></canvas>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100 h-96 relative">
                    <h4 class="font-black text-sm uppercase text-slate-400 mb-6 tracking-widest">Índice de Refugo</h4>
                    <div class="absolute inset-x-8 bottom-8 top-20">
                        <canvas id="grafico-refugo"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="maquina-kiosk" class="fixed inset-0 z-50 bg-[#f8fafc] hidden flex flex-col p-6">
        <header class="flex justify-between items-center mb-6 bg-white p-6 rounded-[24px] shadow-sm border border-slate-100">
            <h1 class="text-4xl font-black italic text-slate-900 tracking-tighter">TRIPLAST <span id="kiosk-maq-nome" class="text-blue-600"></span></h1>
            <div class="flex items-center gap-4">
                <div id="kiosk-clock" class="text-2xl font-bold text-slate-300 font-mono">00:00</div>
                <button onclick="location.reload()" class="bg-red-50 text-red-500 px-6 py-3 rounded-xl font-bold text-sm hover:bg-red-500 hover:text-white transition-colors">SAIR</button>
            </div>
        </header>
        
        <div class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-7 bg-white rounded-[40px] p-10 shadow-lg border border-slate-100 flex flex-col relative overflow-hidden">
                <div class="absolute top-0 right-0 w-80 h-80 bg-blue-50 rounded-full blur-3xl -mr-10 -mt-10 opacity-60 pointer-events-none"></div>
                
                <div class="relative z-10 flex-1 flex flex-col justify-center">
                    <span class="text-blue-500 font-black uppercase text-xs tracking-[0.2em] mb-4">Ordem de Produção Atual</span>
                    <h2 id="kiosk-op" class="text-5xl font-black text-slate-800 mb-10 leading-tight">AGUARDANDO...</h2>
                    
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div class="bg-slate-50 p-6 rounded-[24px] border border-slate-100">
                            <span class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Meta</span>
                            <div class="flex items-baseline gap-1">
                                <span id="kiosk-meta" class="text-4xl font-black text-slate-800">0</span>
                                <span class="text-xs font-bold text-slate-400">pçs</span>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-600 to-indigo-600 p-6 rounded-[24px] text-white shadow-xl shadow-blue-200">
                            <span class="block text-[10px] font-black text-blue-200 uppercase tracking-widest mb-2">Realizado</span>
                            <div class="flex items-baseline gap-1">
                                <span id="kiosk-real" class="text-4xl font-black">0</span>
                                <span class="text-xs font-bold text-blue-200">pçs</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="relative z-10 flex gap-3 mt-auto pt-8 border-t border-slate-100">
                    <select id="kiosk-select-op" class="flex-1 bg-slate-50 border border-slate-200 rounded-2xl p-4 font-bold outline-none text-slate-700"></select>
                    <button onclick="iniciarOPMaquina()" class="bg-slate-900 text-white px-8 rounded-2xl font-bold hover:scale-[1.02] transition-transform shadow-lg">INICIAR O.P</button>
                </div>
            </div>

            <div class="lg:col-span-5 grid grid-rows-2 gap-6">
                <button onclick="acaoMaquina('prod')" class="bg-white border-2 border-blue-100 active:bg-blue-50 active:scale-95 rounded-[40px] flex flex-col items-center justify-center shadow-sm hover:shadow-xl hover:border-blue-300 transition-all group">
                    <div class="w-24 h-24 bg-blue-600 text-white rounded-full flex items-center justify-center text-4xl mb-4 shadow-xl shadow-blue-200 group-active:scale-90 transition-transform">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                    <span class="text-3xl font-black text-slate-800 tracking-tight">PRODUÇÃO</span>
                    <span class="text-xs font-bold text-slate-400 mt-2 uppercase tracking-widest">Toque para apontar (+1)</span>
                </button>
                
                <div class="grid grid-cols-2 gap-6">
                    <button onclick="acaoMaquina('refugo')" class="bg-white border-2 border-red-50 active:bg-red-50 active:scale-95 rounded-[40px] font-black flex flex-col items-center justify-center shadow-sm hover:shadow-lg hover:border-red-200 transition-all text-red-500 group">
                        <i class="fa-solid fa-trash text-3xl mb-4 group-active:scale-90 transition-transform"></i> 
                        <span class="text-lg">REFUGO</span>
                    </button>
                    <button onclick="acaoMaquina('parada')" id="btn-status-maq" class="bg-yellow-50 border-2 border-yellow-100 active:bg-yellow-100 active:scale-95 text-yellow-700 rounded-[40px] font-black flex flex-col items-center justify-center shadow-sm hover:shadow-lg transition-all group">
                        <i class="fa-solid fa-pause text-3xl mb-4 group-active:scale-90 transition-transform"></i> 
                        <span class="text-lg">PARAR</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO SUPABASE ---
        // A chave que você passou continha o ID 'hgqnlqtvjiyuwnwypxxh'. 
        // Montei a URL correta baseada nela:
        const SB_URL = 'https://hgqnlqtvjiyuwnwypxxh.supabase.co'; 
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhncW5scXR2aml5dXdud3lweHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjE1MDcsImV4cCI6MjA4NjQzNzUwN30.njSVfWDpIJK49IpRSgyMf6e5MEmJ-AROVT7-nOTZD9Y'; 
        
        const sb = supabase.createClient(SB_URL, SB_KEY);
        
        // --- ESTADO GLOBAL ---
        let DATA = { maquinas: [], produtos: [], operadores: [], ops: [], historico: [] };
        let currentUser = null;
        let saveTimer = null;

        // --- INICIALIZAÇÃO ---
        window.onload = function() {
            // Garante o estado inicial da UI
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            
            // Relógio em tempo real
            setInterval(() => {
                const time = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                document.getElementById('clock').innerText = time;
                document.getElementById('kiosk-clock').innerText = time;
            }, 1000);
        };

        // --- SISTEMA DE LOGIN ---
        function tentarLogin() {
            const pass = document.getElementById('pass-code').value.trim().toUpperCase();
            const mapMaq = { 'M1': 0, 'M2': 1, 'M3': 2, 'M4': 3 };

            if (pass === '2026') {
                currentUser = 'ADMIN';
                animarEntrada('admin');
            } else if (mapMaq.hasOwnProperty(pass)) {
                currentUser = mapMaq[pass];
                animarEntrada('maquina');
            } else {
                const input = document.getElementById('pass-code');
                input.value = '';
                input.placeholder = "SENHA INCORRETA";
                input.classList.add('bg-red-50', 'placeholder-red-400');
                setTimeout(() => {
                    input.classList.remove('bg-red-50', 'placeholder-red-400');
                    input.placeholder = "Senha de Acesso";
                }, 1500);
            }
        }

        async function animarEntrada(tipo) {
            const login = document.getElementById('login-screen');
            login.style.transition = "opacity 0.5s ease";
            login.style.opacity = '0';
            
            setTimeout(() => {
                login.style.display = 'none';
                
                if(tipo === 'admin') {
                    document.getElementById('sidebar').classList.remove('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    renderTudo();
                } else {
                    document.getElementById('maquina-kiosk').classList.remove('hidden');
                    renderKiosk();
                }
                
                carregarDados(); // Busca dados do Supabase
            }, 500);
        }

        // --- BANCO DE DADOS (SUPABASE) ---
        async function carregarDados() {
            try {
                // Tenta buscar o registro com ID 1 na tabela 'sistema'
                const { data, error } = await sb.from('sistema').select('conteudo').eq('id', 1).single();
                
                if (data && data.conteudo) {
                    DATA = { ...DATA, ...data.conteudo };
                    if(!DATA.maquinas || DATA.maquinas.length < 4) resetMaquinas();
                } else {
                    // Se não existir, inicializa e salva
                    console.log("Inicializando banco de dados...");
                    resetMaquinas();
                    salvar();
                }
                
                // Atualiza a tela correta após carregar
                if(currentUser === 'ADMIN') renderTudo();
                else renderKiosk();
                
            } catch (e) { 
                console.error('Erro de conexão ou tabela inexistente:', e);
                // Fallback para funcionar offline ou se a tabela não tiver sido criada ainda
                resetMaquinas();
                if(currentUser === 'ADMIN') renderTudo();
                else renderKiosk();
            }
        }

        function resetMaquinas() {
            if(!DATA.maquinas || DATA.maquinas.length === 0) {
                DATA.maquinas = [
                    { id: 0, nome: 'M1', status: 'parada', prod: 0, refugo: 0, op: null },
                    { id: 1, nome: 'M2', status: 'parada', prod: 0, refugo: 0, op: null },
                    { id: 2, nome: 'M3', status: 'parada', prod: 0, refugo: 0, op: null },
                    { id: 3, nome: 'M4', status: 'parada', prod: 0, refugo: 0, op: null }
                ];
            }
        }

        async function salvar() {
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                // Usa upsert para criar se não existir ou atualizar se existir
                await sb.from('sistema').upsert({ id: 1, conteudo: DATA });
            }, 1000);
        }

        // --- NAVEGAÇÃO ADMIN ---
        function nav(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('view-' + view).classList.add('active');
            document.getElementById('btn-' + view).classList.add('active');
            
            const titulos = { 'dashboard': 'Visão Geral', 'ops': 'Gestão de O.P', 'produtos': 'Catálogo', 'equipe': 'Equipe', 'graficos': 'Relatórios' };
            document.getElementById('page-title').innerText = titulos[view];
            
            renderTudo();
        }

        // --- RENDERIZADORES ADMIN ---
        function renderTudo() {
            renderDashboard();
            renderListaOPs();
            renderListaProdutos();
            renderListaEquipe();
            popularSelects();
            renderGraficos();
        }

        function renderDashboard() {
            const grid = document.getElementById('grid-admin');
            grid.innerHTML = DATA.maquinas.map(m => {
                const statusMap = {
                    'rodando': { color: 'bg-green-500', text: 'text-green-500', label: 'PRODUZINDO', border: 'border-green-500' },
                    'parada': { color: 'bg-red-500', text: 'text-red-500', label: 'PARADA', border: 'border-red-500' },
                    'setup': { color: 'bg-blue-500', text: 'text-blue-500', label: 'SETUP', border: 'border-blue-500' }
                };
                const st = statusMap[m.status] || statusMap['parada'];
                
                return `
                <div class="bg-white p-6 rounded-[32px] shadow-sm border-l-8 ${st.border} hover:shadow-xl transition-all">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 bg-slate-900 text-white rounded-2xl flex items-center justify-center font-black italic text-xl shadow-lg">${m.nome}</div>
                            <div>
                                <h3 class="font-bold text-slate-800 leading-none text-lg">INJETORA ${m.id+1}</h3>
                                <p class="text-xs font-bold text-slate-400 uppercase mt-1">${m.op ? m.op.produto : 'Sem O.P'}</p>
                            </div>
                        </div>
                        <div class="px-3 py-1 rounded-full bg-slate-50 ${st.text} text-[10px] font-black uppercase tracking-wider border border-slate-100">
                            ${st.label}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-blue-50 p-4 rounded-2xl text-center">
                            <span class="block text-[10px] font-bold text-blue-400 uppercase tracking-wider">Produzido</span>
                            <span class="text-2xl font-black text-blue-700">${m.prod}</span>
                        </div>
                        <div class="bg-red-50 p-4 rounded-2xl text-center">
                            <span class="block text-[10px] font-bold text-red-400 uppercase tracking-wider">Refugo</span>
                            <span class="text-2xl font-black text-red-500">${m.refugo}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderListaProdutos() {
            const container = document.getElementById('lista-produtos');
            if(DATA.produtos.length === 0) {
                container.innerHTML = '<div class="p-10 text-center text-slate-400 font-bold">Nenhum produto cadastrado no catálogo.</div>';
                return;
            }
            container.innerHTML = `
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[10px] text-slate-400 uppercase font-black">
                        <tr><th class="p-4">Produto</th><th class="p-4">Dados Técnicos</th><th class="p-4 text-right">Ação</th></tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${DATA.produtos.map((p, i) => `
                        <tr class="hover:bg-slate-50 transition-colors group">
                            <td class="p-4">
                                <div class="font-bold text-slate-700">${p.nome}</div>
                                <div class="text-[10px] font-bold text-blue-500 uppercase tracking-wider">${p.material}</div>
                            </td>
                            <td class="p-4 text-sm font-bold text-slate-500">
                                ${p.peso}g | ${p.ciclo}s | ${p.cav} Cav.
                            </td>
                            <td class="p-4 text-right">
                                <button onclick="removerItem('produtos', ${i})" class="w-8 h-8 rounded-full bg-white border border-slate-200 text-red-400 hover:bg-red-500 hover:text-white hover:border-red-500 transition-all shadow-sm"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderListaEquipe() {
            document.getElementById('lista-equipe').innerHTML = DATA.operadores.map((op, i) => `
                <div class="bg-white p-4 rounded-[24px] border border-slate-100 flex justify-between items-center shadow-sm hover:border-blue-200 transition-all group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center font-black">${op.charAt(0)}</div>
                        <span class="font-bold text-slate-700">${op}</span>
                    </div>
                    <button onclick="removerItem('operadores', ${i})" class="w-8 h-8 rounded-full bg-red-50 text-red-400 opacity-0 group-hover:opacity-100 hover:bg-red-500 hover:text-white transition-all"><i class="fa-solid fa-xmark"></i></button>
                </div>`).join('');
        }

        function renderListaOPs() {
            const container = document.getElementById('lista-ops');
            if(DATA.ops.length === 0) {
                container.innerHTML = '<div class="text-center p-4 text-slate-400 text-sm font-bold">Nenhuma O.P ativa no momento.</div>';
                return;
            }
            container.innerHTML = DATA.ops.slice().reverse().map((op, i) => {
                const statusColor = op.status === 'aberta' ? 'border-l-blue-500' : 'border-l-slate-300 opacity-60';
                return `
                <div class="bg-white p-5 rounded-2xl border-l-4 ${statusColor} shadow-sm border border-slate-100 flex justify-between items-center hover:shadow-md transition-shadow">
                    <div>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-wider">O.P #${op.id}</span>
                        <h4 class="font-bold text-slate-800 text-lg">${op.produto}</h4>
                    </div>
                    <div class="text-right">
                        <span class="block font-black text-2xl text-slate-800">${op.qtd}</span>
                        <span class="text-[10px] uppercase font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">${op.status}</span>
                    </div>
                </div>`;
            }).join('');
        }

        // --- FUNÇÕES DE AÇÃO ---
        function addProduto() {
            const nome = document.getElementById('prod-nome').value.trim();
            if(!nome) return alert('Nome do produto é obrigatório');
            
            DATA.produtos.push({
                nome,
                material: document.getElementById('prod-mat').value,
                peso: document.getElementById('prod-peso').value,
                ciclo: document.getElementById('prod-ciclo').value,
                cav: document.getElementById('prod-cav').value,
                cx: document.getElementById('prod-cx').value
            });
            salvar(); renderTudo();
            document.querySelectorAll('#view-produtos input').forEach(i => i.value = '');
        }

        function addOperador() {
            const nome = document.getElementById('op-nome').value.trim();
            if(nome) { 
                DATA.operadores.push(nome); 
                salvar(); renderListaEquipe(); 
                document.getElementById('op-nome').value = ''; 
            }
        }

        function criarOP() {
            const prodNome = document.getElementById('op-produto').value;
            const qtd = document.getElementById('op-qtd').value;
            if(!prodNome || !qtd) return alert("Preencha o produto e a quantidade");
            
            DATA.ops.push({
                id: Math.floor(1000 + Math.random() * 9000),
                produto: prodNome,
                qtd: parseInt(qtd),
                status: 'aberta',
                data: new Date().toISOString()
            });
            salvar(); renderListaOPs();
            alert("Ordem de Produção Gerada!");
        }

        function removerItem(lista, index) {
            if(confirm("Remover este item?")) {
                DATA[lista].splice(index, 1);
                salvar(); renderTudo();
            }
        }

        // --- MODO KIOSK (MÁQUINA) ---
        function renderKiosk() {
            if(currentUser === 'ADMIN') return;
            const m = DATA.maquinas[currentUser];
            
            document.getElementById('kiosk-maq-nome').innerText = m.nome;
            document.getElementById('kiosk-op').innerText = m.op ? m.op.produto : "AGUARDANDO O.P";
            document.getElementById('kiosk-meta').innerText = m.op ? m.op.qtd : 0;
            document.getElementById('kiosk-real').innerText = m.prod;

            const btn = document.getElementById('btn-status-maq');
            if(m.status === 'rodando') {
                btn.innerHTML = '<i class="fa-solid fa-pause text-3xl mb-4"></i><span class="text-lg">PARAR</span>';
                btn.className = "bg-yellow-50 border-2 border-yellow-100 active:bg-yellow-100 text-yellow-700 rounded-[40px] font-black flex flex-col items-center justify-center shadow-sm hover:shadow-md transition-all group";
            } else {
                btn.innerHTML = '<i class="fa-solid fa-play text-3xl mb-4"></i><span class="text-lg">INICIAR</span>';
                btn.className = "bg-green-50 border-2 border-green-100 active:bg-green-100 text-green-600 rounded-[40px] font-black flex flex-col items-center justify-center shadow-sm hover:shadow-md transition-all group";
            }

            // Atualiza select de O.P mantendo seleção se possível
            const select = document.getElementById('kiosk-select-op');
            const atual = select.value;
            select.innerHTML = '<option value="">Selecionar O.P da Fila...</option>' + 
                DATA.ops.filter(o => o.status === 'aberta').map(o => `<option value="${o.id}">#${o.id} - ${o.produto}</option>`).join('');
            if(atual) select.value = atual;
        }

        function iniciarOPMaquina() {
            const opId = document.getElementById('kiosk-select-op').value;
            if(!opId) return alert("Selecione uma O.P primeiro");
            
            const op = DATA.ops.find(o => o.id == opId);
            const m = DATA.maquinas[currentUser];
            
            if(confirm(`Confirmar inicio de ${op.produto} na ${m.nome}?`)) {
                m.op = op;
                m.prod = 0;
                m.refugo = 0;
                m.status = 'setup';
                salvar(); renderKiosk();
            }
        }

        function acaoMaquina(tipo) {
            const m = DATA.maquinas[currentUser];
            
            if (tipo === 'parada') {
                m.status = (m.status === 'rodando') ? 'parada' : 'rodando';
            } else {
                if (m.status !== 'rodando') return alert("A máquina precisa estar RODANDO (Inicie no botão amarelo)");
                if (!m.op) return alert("Selecione e inicie uma O.P primeiro");
                
                if (tipo === 'prod') m.prod++;
                if (tipo === 'refugo') m.refugo++;
            }
            salvar(); renderKiosk();
        }

        // --- UTILITÁRIOS ---
        function popularSelects() {
            const sel = document.getElementById('op-produto');
            if(sel && DATA.produtos.length > 0) {
                sel.innerHTML = '<option value="">Selecione...</option>' + 
                    DATA.produtos.map(p => `<option value="${p.nome}">${p.nome}</option>`).join('');
            }
        }

        function autoPreencherOP() {
            const nome = document.getElementById('op-produto').value;
            const p = DATA.produtos.find(x => x.nome === nome);
            const box = document.getElementById('op-info');
            
            if(p) {
                box.classList.remove('hidden');
                document.getElementById('op-info-texto').innerText = `${p.material} | Peso: ${p.peso}g | Ciclo: ${p.ciclo}s`;
            } else {
                box.classList.add('hidden');
            }
        }

        // --- GRÁFICOS ---
        let chart1 = null, chart2 = null;
        function renderGraficos() {
            const ctx1 = document.getElementById('grafico-prod');
            const ctx2 = document.getElementById('grafico-refugo');
            
            if(!ctx1 || !ctx2) return;

            const labels = DATA.maquinas.map(m => m.nome);
            const prods = DATA.maquinas.map(m => m.prod);
            const refugos = DATA.maquinas.map(m => m.refugo);

            if(chart1) chart1.destroy();
            chart1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Peças Produzidas',
                        data: prods,
                        backgroundColor: '#2563eb',
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
            });

            if(chart2) chart2.destroy();
            chart2 = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: refugos,
                        backgroundColor: ['#ef4444', '#f87171', '#fca5a5', '#fee2e2'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
