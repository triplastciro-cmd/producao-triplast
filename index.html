<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Triplast - Sistema de Gest√£o Industrial (Enterprise)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* =================================================================
           ESTILIZA√á√ÉO GERAL DO SISTEMA
           ================================================================= */
        
        body { 
            background-color: #f8fafc; /* Slate 50 */
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 0; 
            -webkit-font-smoothing: antialiased;
            color: #1e293b; /* Slate 800 */
            padding-bottom: 120px; /* Espa√ßo extra para scroll em mobile */
        }
        
        /* Utilit√°rios de Transi√ß√£o */
        .transicao-suave { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        /* SISTEMA DE ABAS (CR√çTICO)
           Controla qual tela est√° vis√≠vel.
        */
        .aba-conteudo { 
            display: none; 
            animation: fadeIn 0.4s ease-out;
        }
        
        .aba-ativa { 
            display: block !important; 
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(5px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        /* NOTIFICA√á√ÉO TOAST (VISUAL)
           Aviso flutuante no topo da tela.
        */
        #notificacao-toast {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(-150%);
            background-color: #0f172a; /* Slate 900 */
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            font-weight: 600;
            border-left: 4px solid #3b82f6; /* Azul destaque */
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }

        #notificacao-toast.mostrar {
            transform: translateX(-50%) translateY(0);
        }

        /* CART√ïES DAS M√ÅQUINAS 
           Design principal do painel de monitoramento.
        */
        .cartao-maquina {
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            border-left-width: 6px;
            border-left-style: solid;
            transition: all 0.2s ease; 
            position: relative;
            overflow: visible;
        }

        .cartao-maquina:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        
        /* Cores de Status Profissionais */
        .borda-status-produzindo { border-left-color: #10b981 !important; } /* Emerald */
        .borda-status-atencao { border-left-color: #f59e0b !important; } /* Amber */
        .borda-status-parado { border-left-color: #ef4444 !important; } /* Red */
        .borda-status-neutro { border-left-color: #64748b !important; } /* Slate */

        /* BOT√ïES DE NAVEGA√á√ÉO (TABS)
        */
        .botao-aba {
            padding: 10px 24px; 
            border-radius: 6px;
            font-weight: 600; 
            font-size: 13px; 
            color: #64748b;
            background: transparent;
            transition: all 0.2s;
            border: 1px solid transparent;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .botao-aba:hover { 
            background-color: #f1f5f9; 
            color: #0f172a; 
        }
        
        .botao-aba.ativo { 
            background-color: #fff; 
            color: #2563eb; 
            border-color: #e2e8f0;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* SCROLLBARS E UTILIT√ÅRIOS 
        */
        ::-webkit-scrollbar { 
            width: 6px; 
            height: 6px; 
        }
        ::-webkit-scrollbar-track { 
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 3px; 
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: #94a3b8; 
        }

        .wrapper-scroll-horizontal {
            display: flex;
            overflow-x: auto;
            gap: 16px;
            padding-bottom: 16px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        .input-profissional {
            width: 100%;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            color: #334155;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-profissional:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .input-profissional:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }

        /* Ticket de O.P */
        .ticket-op {
            flex: 0 0 auto;
            width: 280px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body onclick="fecharMenusGlobais(event)">
    <div id="notificacao-toast">
        <i class="fa-solid fa-circle-check text-green-400"></i>
        <span id="mensagem-toast">SISTEMA PRONTO</span>
    </div>

    <div id="modal-gerenciar-maquinas" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[250] hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg border border-slate-200 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-server text-blue-600"></i> Configura√ß√£o do Parque
                </h3>
                <button onclick="fecharModalGerenciamento()" class="text-slate-400 hover:text-red-500 text-xl transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6 flex items-start gap-3">
                <i class="fa-solid fa-circle-info text-blue-600 mt-1"></i>
                <div class="text-sm text-blue-800">
                    <p class="font-bold mb-1">Acesso Autom√°tico:</p>
                    <p>Ao criar uma m√°quina, o login √© gerado automaticamente.</p>
                    <p class="mt-1 font-mono text-xs bg-blue-100 p-1 rounded inline-block">
                        Senha padr√£o = "m" + ID (Ex: ID 5 &rarr; Senha <strong>m5</strong>)
                    </p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto pr-2 mb-4">
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block sticky top-0 bg-white pb-2">
                    M√°quinas Ativas
                </label>
                <div id="lista-maquinas-configuracao" class="space-y-2">
                    </div>
            </div>

            <button onclick="adicionarNovaMaquina()" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-lg shadow transition-all flex items-center justify-center gap-2 text-sm uppercase tracking-wide">
                <i class="fa-solid fa-plus-circle"></i> Adicionar Nova Injetora
            </button>
        </div>
    </div>

    <div id="modal-ficha-tecnica" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[200] hidden items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl border border-slate-200 relative my-auto">
            
            <div class="flex justify-between items-start mb-6 border-b border-slate-100 pb-4">
                <div>
                    <h3 class="font-bold text-2xl text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-list text-blue-600"></i> Ficha T√©cnica
                    </h3>
                    <p class="text-sm text-slate-500 mt-1">Planejamento e Ordem de Produ√ß√£o</p>
                </div>
                <button onclick="fecharModalFicha()" class="text-slate-400 hover:text-red-500 text-2xl transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <input type="hidden" id="input-maquina-id">
            <input type="hidden" id="input-op-index">
            <input type="hidden" id="input-modo-edicao" value="false"> 
            
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">M√°quina</label>
                        <select id="input-op-maquina" class="input-profissional bg-slate-50 font-bold" disabled></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">N¬∫ O.P.</label>
                        <input type="text" id="input-op-numero" class="input-profissional" placeholder="Ex: 102030">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Meta (Pe√ßas)</label>
                        <input type="number" id="input-op-quantidade" class="input-profissional" placeholder="0" oninput="calcularPrevisaoProducao()">
                    </div>
                </div>

                <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100">
                    <h4 class="text-xs font-black text-indigo-700 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-calculator"></i> Calculadora de Insumos e Tempo
                    </h4>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-[10px] font-bold text-indigo-400 uppercase">Peso Pe√ßa (g)</label>
                            <input type="number" id="calc-peso-peca" class="input-profissional text-xs border-indigo-200 text-indigo-900 font-bold" placeholder="0.020" step="0.001" oninput="calcularPrevisaoProducao()">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-indigo-400 uppercase">Ciclo (seg)</label>
                            <input type="number" id="calc-ciclo-seg" class="input-profissional text-xs border-indigo-200 text-indigo-900 font-bold" placeholder="20" oninput="calcularPrevisaoProducao()">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-indigo-400 uppercase">Cavidades</label>
                            <input type="number" id="calc-cavidades" class="input-profissional text-xs border-indigo-200 text-indigo-900 font-bold" value="1" oninput="calcularPrevisaoProducao()">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-indigo-400 uppercase">% Pigmento</label>
                            <input type="number" id="calc-pct-pigmento" class="input-profissional text-xs border-indigo-200 text-indigo-900 font-bold" placeholder="Ex: 2" oninput="calcularPrevisaoProducao()">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 bg-white p-3 rounded-lg border border-indigo-100 shadow-sm">
                        <div class="text-center">
                            <span class="block text-[9px] font-bold text-slate-400 uppercase">Material Total</span>
                            <span id="resultado-material" class="block text-sm font-black text-indigo-600">0 kg</span>
                        </div>
                        <div class="text-center border-l border-r border-indigo-50">
                            <span class="block text-[9px] font-bold text-slate-400 uppercase">Pigmento Nec.</span>
                            <span id="resultado-pigmento" class="block text-sm font-black text-indigo-600">0 kg</span>
                        </div>
                        <div class="text-center">
                            <span class="block text-[9px] font-bold text-slate-400 uppercase">Tempo Estimado</span>
                            <span id="resultado-tempo" class="block text-sm font-black text-indigo-600">0h 00m</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cliente</label>
                        <input type="text" id="input-op-cliente" class="input-profissional">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Produto</label>
                        <div class="flex gap-2">
                            <select id="input-op-produto" class="input-profissional flex-1"></select>
                            <button onclick="adicionarNovoProdutoCatalogo()" class="bg-blue-100 text-blue-600 px-3 rounded-lg hover:bg-blue-200"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <h4 class="text-xs font-black text-slate-700 uppercase mb-3">Dados Material</h4>
                        <div class="space-y-3">
                            <input type="text" id="input-op-material" class="input-profissional text-xs" placeholder="Tipo Material (Ex: PP)">
                            <input type="text" id="input-op-pigmento" class="input-profissional text-xs" placeholder="C√≥digo Cor">
                        </div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <h4 class="text-xs font-black text-orange-700 uppercase mb-3">Embalagem</h4>
                        <div class="space-y-3">
                            <input type="text" id="input-op-caixa" class="input-profissional text-xs" placeholder="Tipo Caixa">
                            <input type="text" id="input-op-saco" class="input-profissional text-xs" placeholder="Tipo Saco">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Operador Respons√°vel</label>
                    <div class="flex gap-2">
                        <select id="input-op-operador" class="input-profissional flex-1"></select>
                        <button onclick="adicionarNovoOperador()" class="bg-green-100 text-green-600 px-3 rounded-lg hover:bg-green-200"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
            </div>

            <div class="flex gap-4 pt-6 border-t border-slate-100 mt-6">
                <button onclick="fecharModalFicha()" class="flex-1 py-3 rounded-lg font-bold text-slate-600 hover:bg-slate-100 transition-colors text-sm uppercase">Cancelar</button>
                <button onclick="salvarFichaTecnica()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition-all transform active:scale-95 text-sm uppercase tracking-wide flex items-center justify-center gap-2">
                    <i class="fa-solid fa-save"></i> Salvar Ordem
                </button>
            </div>
        </div>
    </div>

    <div id="tela-carregamento" class="fixed inset-0 bg-slate-900 z-[300] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="mb-8 text-center">
            <h1 class="text-6xl font-black italic tracking-tighter text-white mb-2">TRI<span class="text-blue-500">PLAST</span></h1>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-[0.3em]">Gest√£o Industrial</p>
        </div>
        <div id="spinner-loading" class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p id="texto-loading" class="text-slate-500 font-medium text-sm animate-pulse">Conectando...</p>
        </div>
        <div id="acao-pos-loading" class="hidden flex-col items-center text-center px-4">
            <p class="text-green-400 mb-6 font-bold text-sm uppercase flex items-center justify-center gap-2"><i class="fa-solid fa-circle-check"></i> Pronto</p>
            <button onclick="exibirTelaLogin()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-10 rounded-full shadow-lg transition-all transform hover:scale-105 active:scale-95 text-sm uppercase tracking-wider">Acessar Sistema</button>
        </div>
    </div>

    <div id="tela-login" class="fixed inset-0 bg-slate-50 z-[100] flex items-center justify-center hidden">
        <div class="bg-white p-10 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
            <div class="text-center mb-10">
                <h2 class="text-4xl font-black italic tracking-tighter text-slate-900">TRI<span class="text-blue-600">PLAST</span></h2>
                <p class="text-slate-400 text-xs font-bold uppercase mt-2">Acesso Restrito</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Usu√°rio</label>
                    <div class="relative">
                        <i class="fa-solid fa-user absolute left-4 top-3.5 text-slate-400"></i>
                        <select id="select-login-usuario" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500 appearance-none cursor-pointer">
                            <option value="admin">Administrador</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-slate-400 text-xs pointer-events-none"></i>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Senha</label>
                    <div class="relative">
                        <i class="fa-solid fa-lock absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="password" id="input-login-senha" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500 transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>
                
                <button onclick="realizarLogin()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-lg shadow-lg transition-all transform active:scale-95 text-sm uppercase tracking-wider">
                    Entrar
                </button>
            </div>
        </div>
    </div>
    <div id="painel-principal" class="hidden min-h-screen">
        
        <header class="bg-slate-900 text-white sticky top-0 z-40 shadow-md">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-6 w-full md:w-auto justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl font-black italic tracking-tighter">TRI<span class="text-blue-500">PLAST</span></span>
                            <div class="h-6 w-px bg-slate-700 hidden sm:block"></div>
                            <span id="relogio-sistema" class="font-mono text-slate-400 text-sm hidden sm:block">00:00:00</span>
                        </div>
                        <button onclick="realizarLogout()" class="text-xs bg-slate-800 hover:bg-red-600 text-slate-300 hover:text-white px-3 py-1.5 rounded transition-colors border border-slate-700">
                            <i class="fa-solid fa-power-off mr-1"></i> SAIR
                        </button>
                    </div>

                    <div class="flex items-center gap-3 bg-slate-800 p-1.5 rounded-lg border border-slate-700">
                        <div class="flex flex-col px-2">
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Turno</span>
                            <select id="select-turno-global" onchange="alterarTurnoManual(this.value)" class="bg-transparent text-white font-bold text-xs outline-none border-none cursor-pointer">
                                <option value="1">1¬∫ Manh√£</option>
                                <option value="2">2¬∫ Tarde</option>
                                <option value="3">3¬∫ Noite</option>
                            </select>
                        </div>
                        <div class="h-8 w-px bg-slate-700"></div>
                        <button id="btn-pausa-sistema" onclick="alternarPausaSistema()" class="text-[10px] font-bold px-3 py-1.5 rounded bg-yellow-500/10 text-yellow-500 border border-yellow-500/30 hover:bg-yellow-500 hover:text-white transition-all uppercase">Pausa</button>
                        <button id="btn-hora-extra" onclick="alternarHoraExtra()" class="text-[10px] font-bold px-3 py-1.5 rounded bg-purple-500/10 text-purple-400 border border-purple-500/30 hover:bg-purple-600 hover:text-white transition-all uppercase">Extra</button>
                    </div>
                </div>
            </div>
        </header>

        <nav class="max-w-7xl mx-auto px-4 mt-6 mb-6">
            <div class="bg-white p-1.5 rounded-lg shadow-sm border border-slate-200 inline-flex gap-1 overflow-x-auto max-w-full">
                <button onclick="navegarParaAba('monitoramento')" id="tab-monitoramento" class="botao-aba ativo">
                    <i class="fa-solid fa-table-columns mr-2"></i> Monitoramento
                </button>
                <button onclick="navegarParaAba('pedidos')" id="tab-pedidos" class="botao-aba">
                    <i class="fa-solid fa-list-check mr-2"></i> Pedidos
                </button>
                <button onclick="navegarParaAba('graficos')" id="tab-graficos" class="botao-aba">
                    <i class="fa-solid fa-chart-pie mr-2"></i> Indicadores
                </button>
                <button onclick="navegarParaAba('resumo')" id="tab-resumo" class="botao-aba">
                    <i class="fa-solid fa-file-invoice mr-2"></i> Relat√≥rios
                </button>
            </div>
        </nav>

        <div id="aba-monitoramento" class="aba-conteudo aba-ativa px-4 max-w-7xl mx-auto pb-20">
            <div id="painel-admin-ferramentas" class="mb-6 flex justify-end">
                <button onclick="abrirModalGerenciamento()" class="bg-white hover:bg-slate-50 text-slate-600 hover:text-blue-600 font-bold py-2 px-4 rounded-lg shadow-sm border border-slate-200 transition-all text-xs uppercase flex items-center gap-2">
                    <i class="fa-solid fa-gears"></i> Gerenciar M√°quinas
                </button>
            </div>
            <div id="grid-maquinas-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>
        </div>

        <div id="aba-pedidos" class="aba-conteudo px-4 max-w-7xl mx-auto pb-20">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-4 z-30">
                <div class="relative w-full md:w-96">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400"></i>
                    <input type="text" id="busca-pedidos" oninput="renderizarFilasPedidos()" placeholder="Buscar O.P..." class="pl-10 pr-4 py-2.5 w-full bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium outline-none focus:border-blue-500">
                </div>
                <button onclick="abrirModalCriacaoOP()" class="bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-6 rounded-lg font-bold text-sm shadow-md transition-transform active:scale-95 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> NOVA ORDEM
                </button>
            </div>
            <div id="container-filas-producao" class="space-y-6"></div>
        </div>

        <div id="aba-graficos" class="aba-conteudo px-4 max-w-7xl mx-auto pb-20">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 lg:col-span-2">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                        <h3 class="font-bold text-slate-800 text-lg">Efici√™ncia Global (OEE)</h3>
                        <select id="filtro-grafico-maquina" onchange="atualizarGraficos()" class="text-sm border-none bg-slate-100 rounded px-2 py-1 font-bold text-slate-600 outline-none cursor-pointer"></select>
                    </div>
                    <div class="flex flex-col md:flex-row items-center justify-around gap-8">
                        <div class="w-64 h-64 relative">
                            <canvas id="grafico-oee"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <div class="text-center">
                                    <span class="text-xs text-slate-400 font-bold">STATUS</span>
                                    <p class="text-2xl font-black text-slate-800">AGORA</p>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 w-full md:w-auto">
                            <div class="bg-green-50 p-4 rounded-lg border border-green-100 text-center w-32"><span class="text-[10px] font-black text-green-600 uppercase">Produzindo</span><p id="tempo-prod-total" class="text-xl font-bold text-slate-800">00:00</p></div>
                            <div class="bg-orange-50 p-4 rounded-lg border border-orange-100 text-center w-32"><span class="text-[10px] font-black text-orange-500 uppercase">Baixa Efic.</span><p id="tempo-baixa-total" class="text-xl font-bold text-slate-800">00:00</p></div>
                            <div class="bg-red-50 p-4 rounded-lg border border-red-100 text-center w-32"><span class="text-[10px] font-black text-red-500 uppercase">Parado</span><p id="tempo-parado-total" class="text-xl font-bold text-slate-800">00:00</p></div>
                            <div class="bg-slate-100 p-4 rounded-lg border border-slate-200 text-center w-32"><span class="text-[10px] font-black text-slate-500 uppercase">Neutro</span><p id="tempo-neutro-total" class="text-xl font-bold text-slate-800">00:00</p></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-clock text-blue-500"></i> Horas (M√™s)</h4>
                    <div class="h-64"><canvas id="grafico-horas"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation text-red-500"></i> Paradas</h4>
                    <div class="h-64"><canvas id="grafico-paradas"></canvas></div>
                </div>
            </div>
        </div>

        <div id="aba-resumo" class="aba-conteudo px-4 max-w-7xl mx-auto pb-20">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold text-slate-800">Apontamento</h2>
                        <select id="filtro-resumo-turno" onchange="renderizarTabelaResumo()" class="bg-slate-100 text-slate-700 font-bold py-1 px-3 rounded text-xs border-none outline-none cursor-pointer">
                            <option value="todas">Geral</option>
                            <option value="1">Turno 1</option>
                            <option value="2">Turno 2</option>
                            <option value="3">Turno 3</option>
                        </select>
                    </div>
                    <button onclick="resetarDadosTurno()" class="text-red-500 hover:text-white hover:bg-red-500 border border-red-200 font-bold py-2 px-4 rounded-lg text-xs uppercase transition-all flex items-center gap-2"><i class="fa-solid fa-trash-can"></i> Zerar Turno</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 text-slate-500 uppercase text-[10px] font-bold tracking-wider border-b border-slate-200">
                                <th class="p-4">M√°quina</th><th class="p-4">O.P</th><th class="p-4 text-right text-green-600">Boas</th><th class="p-4 text-right text-red-500">Refugo</th><th class="p-4 text-right">% Perda</th><th class="p-4 text-center">Produzindo</th><th class="p-4 text-center">Parado</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-resumo-corpo" class="text-sm font-medium text-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://hgqnlqtvjiyuwnwypxxh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhncW5scXR2aml5dXdud3lweHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjE1MDcsImV4cCI6MjA4NjQzNzUwN30.njSVfWDpIJK49IpRSgyMf6e5MEmJ-AROVT7-nOTZD9Y';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let maquinas=[], historicoOperacoes=[], catalogoCores=["Natural","Preto","Branco"], equipeOperadores=["Operador Padr√£o"], catalogoProdutos=["Produto Gen√©rico"];
        let metricasMensais={tempoProducao:0,tempoHoraExtra:0};
        let modoManualAtivo=false, modoHoraExtraAtivo=false, sistemaPausado=false, usuarioLogado=null, timerSalvamento=null, timerRelogio=null, fimDeSemanaAtivo=false, timestampUltimaAtualizacaoLocal=0;
        let chartInstances={oee:null,paradas:null,refugos:null,horas:null};

        const LISTA_MOTIVOS_PARADA = ["04 - PRODU√á√ÉO NORMAL","21 - BAIXA EFICI√äNCIA","01 - TROCA DE MOLDE","02 - TROCA DE POSTI√áO","03 - FALTA MAT√âRIA-PRIMA","05 - AQUECIMENTO","06 - TROCA DE COR","07 - MANUT. PERIF√âRICOS","08 - REFEI√á√ÉO","09 - LIMPEZA","10 - PE√áA PRESA","11 - IN√çCIO PROCESSO","12 - FALTA ENERGIA","13 - MANUT. MOLDE","14 - MANUT. M√ÅQUINA","15 - PROB. AR COMPRIMIDO","16 - PROB. C√ÇMARA QUENTE","17 - TROCA BICO","18 - AGUARDANDO OPERADOR","19 - MANUT. EL√âTRICA MOLDE","20 - OUTROS","22 - SEM PROGRAMA√á√ÉO","23 - F√ÅBRICA FECHADA","24 - PARADA PROGRAMADA"];
        const LISTA_TIPOS_REFUGO = ["Falha Inje√ß√£o","Manchas","Rebarbas","Deforma√ß√£o","Queimado","Cor Incorreta","Trincas","Marcas Fluxo","Contamina√ß√£o","Outros"];

        function obterDataHoraBrasilia() { return new Date(new Date().toLocaleString("en-US", {timeZone: "America/Sao_Paulo"})); }
        function formatarTempo(s) { if (isNaN(s)) return "00:00:00"; s=Math.floor(s); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`; }
        function criarObjetoMetricasVazio() { return { pecasBoas: 0, pecasRefugo: 0, tempoParadas: 0, tempoProducao: 0, tempoBaixaEficiencia: 0, tempoSemProgramacao: 0 }; }
        function verificarFimDeSemana(d) { const dia=d.getDay(), min=d.getHours()*60+d.getMinutes(); return (dia===5&&min>=1416)||(dia===6||dia===0)||(dia===1&&min<300); }
        function exibirNotificacao(m,t='sucesso'){const el=document.getElementById('notificacao-toast');const txt=document.getElementById('mensagem-toast');const i=el.querySelector('i');txt.innerText=m;if(t==='salvando'){i.className="fa-solid fa-circle-notch fa-spin text-yellow-400";}else{i.className="fa-solid fa-circle-check text-green-400";}el.classList.add('mostrar');if(t!=='salvando')setTimeout(()=>el.classList.remove('mostrar'),3000);}

        // --- SISTEMA DE DADOS ---
        function sanitizarDados() {
            if (!metricasMensais) metricasMensais = { tempoProducao: 0, tempoHoraExtra: 0 };
            maquinas.forEach(m => { m.tempoAcumuladoStatus = Number(m.tempoAcumuladoStatus)||0; if(!m.dadosTurno)m.dadosTurno={}; if(!m.resumoTurno)m.resumoTurno={}; [1,2,3].forEach(t=>{ if(!m.dadosTurno[t])m.dadosTurno[t]=criarObjetoMetricasVazio(); if(!m.resumoTurno[t])m.resumoTurno[t]=criarObjetoMetricasVazio(); }); });
        }

        async function inicializarSistema() {
            const timeout = new Promise((_, r) => setTimeout(() => r(new Error("Timeout")), 5000));
            try {
                const { data, error } = await Promise.race([sb.from('sistema').select('*').eq('id', 1).single(), timeout]);
                if (error || !data) {
                    const padrao = { id: 1, conteudo: { maquinas: Array.from({length: 4}, (_, i) => criarNovaEstruturaMaquina(i + 1)), cores: catalogoCores, operadores: equipeOperadores, produtos: catalogoProdutos, historico: [], metricasMensais: { tempoProducao: 0 }, timestampAtualizacao: Date.now() } };
                    await sb.from('sistema').upsert(padrao); carregarEstadoGlobal(padrao.conteudo);
                } else carregarEstadoGlobal(data.conteudo);
            } catch (e) { console.error(e); carregarEstadoGlobal({ maquinas: Array.from({length: 4}, (_, i) => criarNovaEstruturaMaquina(i + 1)), cores: catalogoCores, operadores: equipeOperadores, produtos: catalogoProdutos, historico: [], metricasMensais: { tempoProducao: 0 }, timestampAtualizacao: Date.now() }); }
            finally { 
                document.getElementById('loading-spinner').style.display='none'; 
                document.getElementById('acao-pos-loading').classList.remove('hidden'); 
                document.getElementById('acao-pos-loading').classList.add('flex');
                iniciarRelogioSistema(); 
                setInterval(sincronizarDadosNuvem, 3000); 
            }
        }

        function criarNovaEstruturaMaquina(id) { return { id: id, nome: `Injetora ${id}`, status: "22 - SEM PROGRAMA√á√ÉO DE PRODU√á√ÉO", filaProducao: [], dadosTurno: {1:criarObjetoMetricasVazio(),2:criarObjetoMetricasVazio(),3:criarObjetoMetricasVazio()}, resumoTurno: {1:criarObjetoMetricasVazio(),2:criarObjetoMetricasVazio(),3:criarObjetoMetricasVazio()}, tempoAcumuladoStatus: 0, ultimoStatusChange: Date.now() }; }
        function carregarEstadoGlobal(d) { maquinas=d.maquinas||[]; catalogoCores=d.cores||catalogoCores; equipeOperadores=d.operadores||equipeOperadores; catalogoProdutos=d.produtos||catalogoProdutos; historicoOperacoes=d.historico||[]; metricasMensais=d.metricasMensais||{tempoProducao:0,tempoHoraExtra:0}; modoHoraExtraAtivo=d.modoHoraExtra||false; timestampUltimaAtualizacaoLocal=d.timestampAtualizacao||0; atualizarSelectLogin(); atualizarDropdownsFormularios(); sanitizarDados(); verificarTurnoAutomatico(); if(usuarioLogado){ renderizarPainelPrincipal(); if(usuarioLogado==='admin'){ renderizarFilasPedidos(); renderizarTabelaResumo(); } atualizarTimersNaTela(); } }
        function atualizarSelectLogin() { const sel=document.getElementById('select-login-usuario'); let h='<option value="admin">Administrador</option>'; maquinas.forEach(m=>h+=`<option value="${m.id}">üè≠ ${m.nome}</option>`); sel.innerHTML=h; const f=document.getElementById('filtro-grafico-maquina'); if(f) f.innerHTML='<option value="todas">Todas</option>'+maquinas.map(m=>`<option value="${m.id}">${m.nome}</option>`).join(''); }
        
        async function salvarDadosNuvem() { if(timerSalvamento) clearTimeout(timerSalvamento); exibirNotificacao("Salvando...", "salvando"); const p={maquinas,cores:catalogoCores,operadores:equipeOperadores,produtos:catalogoProdutos,historico:historicoOperacoes,metricasMensais,modoHoraExtra:modoHoraExtraAtivo,timestampAtualizacao:Date.now()}; const {error}=await sb.from('sistema').upsert({id:1,conteudo:p}); if(!error){ timestampUltimaAtualizacaoLocal=p.timestampAtualizacao; exibirNotificacao("Dados Salvos", "sucesso"); } }
        function agendarSalvamentoAutomatico() { if(timerSalvamento) clearTimeout(timerSalvamento); timerSalvamento=setTimeout(salvarDadosNuvem, 2000); }
        async function sincronizarDadosNuvem() { if(document.getElementById('modal-editar-op').style.display==='flex'||document.getElementById('modal-gerenciar-maquinas').style.display==='flex') return; const {data}=await sb.from('sistema').select('conteudo').eq('id',1).single(); if(data&&(data.conteudo.timestampAtualizacao||0)>timestampUltimaAtualizacaoLocal+2000) carregarEstadoGlobal(data.conteudo); }

        // --- GERENCIAMENTO M√ÅQUINAS ---
        function abrirModalGerenciamento() { document.getElementById('modal-gerenciar-maquinas').style.display='flex'; renderizarListaMaquinasConfig(); }
        function fecharModalGerenciamento() { document.getElementById('modal-gerenciar-maquinas').style.display='none'; }
        function renderizarListaMaquinasConfig() { document.getElementById('lista-maquinas-configuracao').innerHTML=maquinas.map(m=>`<div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border mb-2"><div class="flex items-center gap-3"><div class="bg-blue-100 text-blue-700 font-bold w-8 h-8 flex items-center justify-center rounded text-xs">${m.id}</div><input type="text" value="${m.nome}" onchange="renomearMaquina(${m.id},this.value)" class="bg-white border rounded px-2 py-1 text-sm font-bold w-48"></div><button onclick="removerMaquina(${m.id})" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></div>`).join(''); }
        function adicionarNovaMaquina() { const id=maquinas.length>0?Math.max(...maquinas.map(m=>m.id))+1:1; maquinas.push(criarNovaEstruturaMaquina(id)); renderizarListaMaquinasConfig(); atualizarSelectLogin(); renderizarPainelPrincipal(); agendarSalvamentoAutomatico(); }
        function removerMaquina(id) { if(confirm("Excluir m√°quina?")) { maquinas=maquinas.filter(m=>m.id!==id); renderizarListaMaquinasConfig(); atualizarSelectLogin(); renderizarPainelPrincipal(); agendarSalvamentoAutomatico(); } }
        function renomearMaquina(id, nome) { const m=maquinas.find(x=>x.id===id); if(m){ m.nome=nome; agendarSalvamentoAutomatico(); renderizarPainelPrincipal(); atualizarSelectLogin(); } }

        // --- L√ìGICA DE TEMPO ---
        function iniciarRelogioSistema() {
            if(timerRelogio) clearInterval(timerRelogio);
            timerRelogio = setInterval(() => {
                const agora = obterDataHoraBrasilia();
                document.getElementById('relogio-sistema').innerText = agora.toLocaleTimeString('pt-BR');
                const ehFDS = verificarFimDeSemana(agora);
                if(ehFDS && !fimDeSemanaAtivo && !modoHoraExtraAtivo) { fimDeSemanaAtivo=true; maquinas.forEach(m=>{ if(m.ultimoStatusChange){ m.tempoAcumuladoStatus+=(Date.now()-m.ultimoStatusChange); m.ultimoStatusChange=null; } }); agendarSalvamentoAutomatico(); }
                else if(!ehFDS && fimDeSemanaAtivo) { fimDeSemanaAtivo=false; maquinas.forEach(m=>m.ultimoStatusChange=Date.now()); agendarSalvamentoAutomatico(); }
                
                const badge = document.getElementById('badge-auto');
                if(ehFDS && !modoHoraExtraAtivo) { badge.innerText="FDS PAUSA"; badge.className="bg-yellow-500 text-[9px] px-2 py-1 rounded font-black text-white"; return; }
                if(modoHoraExtraAtivo) { badge.innerText="EXTRA ON"; badge.className="bg-purple-600 text-[9px] px-2 py-1 rounded font-black animate-pulse text-white"; }
                else if(sistemaPausado) { badge.innerText="PAUSADO"; badge.className="bg-orange-500 text-[9px] px-2 py-1 rounded font-black text-white"; return; }
                else { badge.innerText=modoManualAtivo?"MANUAL":"AUTO"; badge.className=modoManualAtivo?"bg-blue-500 text-[9px] px-2 py-1 rounded font-black text-white":"bg-green-500 text-[9px] px-2 py-1 rounded font-black animate-pulse text-white"; }

                verificarTurnoAutomatico(); processarContadoresTempo();
                if(usuarioLogado) { atualizarTimersNaTela(); if(usuarioLogado==='admin' && document.getElementById('aba-graficos').classList.contains('aba-ativa')) atualizarGraficos(); }
            }, 1000);
        }

        function verificarTurnoAutomatico() { if(modoManualAtivo) return; const min=obterDataHoraBrasilia().getHours()*60+obterDataHoraBrasilia().getMinutes(); let t=3; if(min>=300&&min<858)t=1; else if(min>=858&&min<1416)t=2; const sel=document.getElementById('select-turno-global'); if(sel.value!=t){ sel.value=t; if(usuarioLogado) renderizarPainelPrincipal(); } }
        function processarContadoresTempo() { const t=document.getElementById('select-turno-global').value; maquinas.forEach(m=>{ if(m.status.includes("FECHADA")||m.status.includes("SEM")||m.status.includes("PARADA PROGRAMADA")) { m.dadosTurno[t].tempoSemProgramacao++; return; } if(m.status.includes("PRODU√á√ÉO")||m.status.includes("BAIXA")||m.status.includes("MAT√âRIA")) { if(fimDeSemanaAtivo&&modoHoraExtraAtivo) metricasMensais.tempoHoraExtra++; else metricasMensais.tempoProducao++; } if(m.status.includes("PRODU√á√ÉO")) m.dadosTurno[t].tempoProducao++; else if(m.status.includes("BAIXA")||m.status.includes("MAT√âRIA")) m.dadosTurno[t].tempoBaixaEficiencia++; else m.dadosTurno[t].tempoParadas++; }); }

        // --- SISTEMA DE LOGIN E NAVEGA√á√ÉO ---
        function exibirTelaLogin() { document.getElementById('tela-carregamento').style.display='none'; const u=localStorage.getItem('triplast_user_v23'); if(u){ usuarioLogado=u==='admin'?'admin':parseInt(u); acessarSistema(); } else document.getElementById('tela-login').style.display='flex'; }
        function realizarLogin() { const t=document.getElementById('select-login-usuario').value, s=document.getElementById('input-login-senha').value.trim().toLowerCase(); if((t==='admin'&&s==='2026')||(t!=='admin'&&s==='m'+t)){ usuarioLogado=t==='admin'?'admin':parseInt(t); localStorage.setItem('triplast_user_v23',t); acessarSistema(); } else alert("Senha incorreta."); }
        function acessarSistema() { document.getElementById('tela-login').style.display='none'; document.getElementById('painel-principal').style.display='block'; const adm=usuarioLogado==='admin'; ['area-admin-painel','header-eficiencia','btn-pausa-sistema','btn-hora-extra'].forEach(id=>document.getElementById(id).style.display=adm?'block':'none'); ['tab-pedidos','tab-resumo','tab-graficos'].forEach(id=>document.getElementById(id).style.display=adm?'inline-block':'none'); navegarParaAba('monitoramento'); renderizarPainelPrincipal(); }
        function realizarLogout() { usuarioLogado=null; localStorage.removeItem('triplast_user_v23'); location.reload(); }
        function navegarParaAba(id) { document.querySelectorAll('.aba-conteudo').forEach(el=>el.classList.remove('aba-ativa')); document.querySelectorAll('.botao-aba').forEach(el=>el.classList.remove('ativo')); document.getElementById(`aba-${id}`).classList.add('aba-ativa'); document.getElementById(`tab-${id}`).classList.add('ativo'); if(id==='pedidos')renderizarFilasPedidos(); if(id==='graficos')inicializarGraficos(); if(id==='resumo')renderizarTabelaResumo(); }

        // --- RENDERIZA√á√ÉO PAINEL ---
        function renderizarPainelPrincipal() {
            const t=document.getElementById('select-turno-global').value;
            const container=document.getElementById('grid-maquinas-container');
            const lista=(usuarioLogado==='admin')?maquinas:maquinas.filter(m=>m.id===usuarioLogado);
            container.innerHTML = lista.map(m => {
                const op = m.filaProducao[0] || { op: '---', produto: 'AGUARDANDO PROGRAMA√á√ÉO', quantidade: 0 };
                const met = m.dadosTurno[t];
                const prog = op.quantidade > 0 ? Math.min((met.pecasBoas / op.quantidade) * 100, 100) : 0;
                let border = "borda-status-parado"; if(m.status.includes("PRODU√á√ÉO")) border="borda-status-produzindo"; else if(m.status.includes("BAIXA")) border="borda-status-atencao"; else if(m.status.includes("SEM")||m.status.includes("FECHADA")) border="borda-status-neutro";
                return `<div class="cartao-maquina ${border} p-5"><div class="flex justify-between items-start mb-3"><span class="bg-slate-800 text-white px-3 py-1 rounded-md font-black text-lg shadow-sm">${m.nome}</span><div class="text-right"><span id="timer-display-${m.id}" class="text-xs font-mono font-bold block text-slate-500">00:00:00</span></div></div><div class="bg-slate-50 p-4 rounded-lg border border-slate-100 mb-4"><div class="flex justify-between items-end mb-1"><span class="text-xs font-bold text-slate-400 uppercase">O.P</span><span class="font-black text-lg text-slate-800">${op.op}</span></div><div class="text-sm font-bold text-blue-600 truncate mb-3 w-full">${op.produto}</div><div class="grid grid-cols-2 gap-3 mb-3"><div class="bg-white p-2 rounded border border-slate-200 text-center"><span class="block text-[10px] font-bold text-green-600 uppercase">Feito</span><span class="block text-xl font-black text-slate-800">${met.pecasBoas}</span></div><div class="bg-white p-2 rounded border border-slate-200 text-center"><span class="block text-[10px] font-bold text-red-500 uppercase">Refugo</span><span class="block text-xl font-black text-slate-800">${met.pecasRefugo}</span></div></div><div class="w-full bg-slate-200 h-2.5 rounded-full overflow-hidden"><div class="bg-blue-500 h-full" style="width:${prog}%"></div></div></div><div class="space-y-2"><div class="flex gap-2"><input type="number" id="input-prod-${m.id}" class="flex-1 input-profissional text-center font-bold text-lg h-10 p-0"><button onclick="registrarProducaoManual(${m.id})" class="bg-blue-600 hover:bg-blue-500 text-white w-12 rounded-lg font-bold text-xl">+</button></div><div class="flex gap-2 items-center bg-red-50 p-2 rounded-lg border border-red-100"><i class="fa-solid fa-trash-can text-red-400 ml-1"></i><select id="select-refugo-${m.id}" class="flex-1 bg-transparent border-none text-xs font-bold text-slate-600 outline-none">${LISTA_TIPOS_REFUGO.map(r=>`<option value="${r}">${r}</option>`).join('')}</select><button onclick="registrarRefugo(${m.id})" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded font-bold text-sm">+</button></div><div class="relative"><i class="fa-solid fa-traffic-light absolute left-3 top-3 text-slate-400 text-xs"></i><select onchange="alterarStatusMaquina(${m.id},this.value)" class="w-full pl-8 pr-2 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold text-slate-700 outline-none cursor-pointer">${LISTA_MOTIVOS_PARADA.map(s=>`<option value="${s}" ${m.status===s?'selected':''}>${s}</option>`).join('')}</select></div></div>${usuarioLogado==='admin'?`<button onclick="finalizarOrdemProducao(${m.id})" class="w-full mt-3 text-[10px] font-bold text-slate-400 hover:text-red-600 uppercase tracking-wider border-t border-slate-100 pt-2"><i class="fa-solid fa-flag-checkered mr-1"></i> Finalizar O.P</button>`:''}</div>`;
            }).join('');
        }

        function atualizarTimersNaTela() { const now=Date.now(); const lista=(usuarioLogado==='admin')?maquinas:maquinas.filter(m=>m.id===usuarioLogado); lista.forEach(m=>{ const el=document.getElementById(`timer-display-${m.id}`); if(el){ let diff=(m.tempoAcumuladoStatus||0)+(m.ultimoStatusChange?now-m.ultimoStatusChange:0); const fmt=formatarTempo(diff/1000); if(m.status.includes('PRODU√á√ÉO')) el.innerHTML=`<span class="text-green-600 flex items-center justify-end gap-1"><i class="fa-solid fa-gear fa-spin"></i> ${fmt}</span>`; else if(m.status.includes('PARADA')||m.status.includes('FECHADA')) el.innerHTML=`<span class="text-slate-400">${fmt}</span>`; else el.innerHTML=`<span class="text-red-500 animate-pulse">${fmt}</span>`; } }); }
        
        function registrarProducaoManual(id) { const v=parseInt(document.getElementById(`input-prod-${id}`).value); if(v>0){ const m=maquinas.find(x=>x.id===id); m.dadosTurno[document.getElementById('select-turno-global').value].pecasBoas+=v; document.getElementById(`input-prod-${id}`).value=''; renderizarPainelPrincipal(); agendarSalvamentoAutomatico(); } }
        function registrarRefugo(id) { maquinas.find(x=>x.id===id).dadosTurno[document.getElementById('select-turno-global').value].pecasRefugo++; renderizarPainelPrincipal(); agendarSalvamentoAutomatico(); }
        function alterarStatusMaquina(id,s) { const m=maquinas.find(x=>x.id===id); m.tempoAcumuladoStatus+=(Date.now()-m.ultimoStatusChange); m.status=s; m.ultimoStatusChange=Date.now(); m.tempoAcumuladoStatus=0; renderizarPainelPrincipal(); agendarSalvamentoAutomatico(); }
        function finalizarOrdemProducao(id) { if(confirm("Finalizar O.P?")){ const m=maquinas.find(x=>x.id===id); const op=m.filaProducao.shift(); if(op){ historicoOperacoes.push({...op, dataFinalizacao:new Date().toISOString(), maquina:m.nome, qtdProduzida:m.dadosTurno[document.getElementById('select-turno-global').value].pecasBoas, status:'CONCLU√çDO'}); } m.dadosTurno[document.getElementById('select-turno-global').value]=criarObjetoMetricasVazio(); renderizarPainelPrincipal(); if(usuarioLogado==='admin')renderizarFilasPedidos(); agendarSalvamentoAutomatico(); } }

        // --- CALCULADORA AUTOM√ÅTICA (NOVO) ---
        function calcularPrevisaoProducao() {
            const qtd = parseFloat(document.getElementById('input-op-quantidade').value) || 0;
            const peso = parseFloat(document.getElementById('calc-peso-peca').value) || 0; // gramas
            const ciclo = parseFloat(document.getElementById('calc-ciclo-seg').value) || 0;
            const cavidades = parseFloat(document.getElementById('calc-cavidades').value) || 1;
            const pigPct = parseFloat(document.getElementById('calc-pct-pigmento').value) || 0;

            // 1. Material Total (kg) = (Qtd * Peso) / 1000
            const materialTotalKg = (qtd * peso) / 1000;
            document.getElementById('resultado-material').innerText = materialTotalKg > 0 ? materialTotalKg.toFixed(2) + ' kg' : '0 kg';

            // 2. Pigmento (kg) = Material Total * (Porcentagem / 100)
            const pigmentoTotalKg = materialTotalKg * (pigPct / 100);
            document.getElementById('resultado-pigmento').innerText = pigmentoTotalKg > 0 ? pigmentoTotalKg.toFixed(3) + ' kg' : '0 kg';

            // 3. Tempo Estimado = (Meta / Pe√ßas por Hora)
            // Pe√ßas por hora = (3600 / Ciclo) * Cavidades
            if (ciclo > 0 && cavidades > 0) {
                const pecasPorHora = (3600 / ciclo) * cavidades;
                const horasNecessarias = qtd / pecasPorHora;
                
                const horasInteiras = Math.floor(horasNecessarias);
                const minutosRestantes = Math.round((horasNecessarias - horasInteiras) * 60);
                
                document.getElementById('resultado-tempo').innerText = `${horasInteiras}h ${minutosRestantes}m`;
            } else {
                document.getElementById('resultado-tempo').innerText = '0h 0m';
            }
        }

        // --- GEST√ÉO DE O.P ---
        function renderizarFilasPedidos() { const c=document.getElementById('container-filas-producao'); const b=document.getElementById('busca-pedidos').value.toLowerCase(); c.innerHTML=maquinas.map(m=>{ const f=m.filaProducao.filter(op=>op.op.toLowerCase().includes(b)||op.cliente.toLowerCase().includes(b)); if(f.length===0&&b!=="")return ""; return `<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><div class="flex items-center gap-3 mb-4 border-b border-slate-100 pb-3"><div class="bg-blue-100 text-blue-700 font-black w-8 h-8 rounded flex items-center justify-center">${m.id}</div><h3 class="font-bold text-lg text-slate-800">${m.nome}</h3></div><div class="wrapper-scroll-horizontal">${f.map((op,i)=>`<div class="ticket-op shrink-0 p-4 shadow-sm border-slate-200"><div class="flex justify-between mb-2"><span class="font-black text-xl text-blue-600">${op.op}</span><button onclick="deletarOP(${m.id},${i})" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></div><p class="text-xs font-bold text-slate-500">${op.cliente}</p><p class="text-sm font-bold text-slate-800 border-b pb-2 mb-2">${op.produto}</p><button onclick="abrirModalEdicao(${m.id},${i})" class="text-blue-600 font-bold text-xs uppercase hover:underline">Editar</button></div>`).join('')}</div></div>`; }).join(''); }
        function abrirModalCriacaoOP() { document.getElementById('modal-ficha-tecnica').style.display='flex'; document.getElementById('input-modo-edicao').value="false"; document.getElementById('input-op-maquina').disabled=false; ['input-op-numero','input-op-cliente','input-op-quantidade','input-op-material','input-op-material-qtd','input-op-pigmento','input-op-porcentagem','input-op-caixa','input-op-saco','calc-peso-peca','calc-ciclo-seg','calc-cavidades','calc-pct-pigmento'].forEach(i=>document.getElementById(i).value=''); }
        function abrirModalEdicao(id,i) { const m=maquinas.find(x=>x.id===id); const op=m.filaProducao[i]; document.getElementById('modal-ficha-tecnica').style.display='flex'; document.getElementById('input-modo-edicao').value="true"; document.getElementById('input-maquina-id').value=id; document.getElementById('input-op-index').value=i; document.getElementById('input-op-maquina').value=m.nome; document.getElementById('input-op-maquina').disabled=true; document.getElementById('input-op-numero').value=op.op; document.getElementById('input-op-cliente').value=op.cliente; document.getElementById('input-op-quantidade').value=op.qtd; document.getElementById('input-op-produto').value=op.produto; document.getElementById('calc-peso-peca').value=op.calcPeso||''; document.getElementById('calc-ciclo-seg').value=op.calcCiclo||''; document.getElementById('calc-cavidades').value=op.calcCav||1; document.getElementById('calc-pct-pigmento').value=op.calcPigPct||''; calcularPrevisaoProducao(); }
        function fecharModalFicha() { document.getElementById('modal-ficha-tecnica').style.display='none'; }
        function salvarFichaTecnica() { const modo=document.getElementById('input-modo-edicao').value==="true"; let id=modo?parseInt(document.getElementById('input-maquina-id').value):maquinas.find(m=>m.nome===document.getElementById('input-op-maquina').value)?.id; const m=maquinas.find(x=>x.id===id); const op={ op:document.getElementById('input-op-numero').value, cliente:document.getElementById('input-op-cliente').value, produto:document.getElementById('input-op-produto').value, qtd:parseInt(document.getElementById('input-op-quantidade').value)||0, operador:document.getElementById('input-op-operador').value, material:document.getElementById('input-op-material').value, materialQtd:document.getElementById('input-op-material-qtd').value, pigmento:document.getElementById('input-op-pigmento').value, porcentagem:document.getElementById('input-op-porcentagem').value, caixa:document.getElementById('input-op-caixa').value, saco:document.getElementById('input-op-saco').value, calcPeso:document.getElementById('calc-peso-peca').value, calcCiclo:document.getElementById('calc-ciclo-seg').value, calcCav:document.getElementById('calc-cavidades').value, calcPigPct:document.getElementById('calc-pct-pigmento').value }; if(modo) m.filaProducao[document.getElementById('input-op-index').value]=op; else m.filaProducao.push(op); agendarSalvamentoAutomatico(); fecharModalFicha(); renderizarFilasPedidos(); renderizarPainelPrincipal(); }
        function deletarOP(id,i) { if(confirm("Excluir O.P?")){ maquinas.find(x=>x.id===id).filaProducao.splice(i,1); renderizarFilasPedidos(); agendarSalvamentoAutomatico(); } }
        function moverNaFila(id,i,d) { const m=maquinas.find(x=>x.id===id); const n=i+d; if(n>=0&&n<m.filaProducao.length){ const item=m.filaProducao.splice(i,1)[0]; m.filaProducao.splice(n,0,item); renderizarFilasPedidos(); agendarSalvamentoAutomatico(); } }

        // --- OUTROS ---
        function atualizarDropdownsFormularios() { document.getElementById('input-op-maquina').innerHTML=maquinas.map(m=>`<option value="${m.nome}">${m.nome}</option>`).join(''); document.getElementById('input-op-operador').innerHTML=equipeOperadores.map(o=>`<option value="${o}">${o}</option>`).join(''); document.getElementById('input-op-produto').innerHTML=catalogoProdutos.map(p=>`<option value="${p}">${p}</option>`).join(''); }
        function inicializarGraficos() { const ctx=document.getElementById('grafico-oee'); if(!ctx||chartInstances.oee)return; chartInstances.oee=new Chart(ctx,{type:'doughnut',data:{labels:['Prod','Baixa','Parado','Neutro'],datasets:[{data:[0,0,0,1],backgroundColor:['#22c55e','#f97316','#ef4444','#cbd5e1'],borderWidth:0}]},options:{responsive:true,cutout:'75%',plugins:{legend:{display:false}}}}); chartInstances.horas=new Chart(document.getElementById('grafico-horas'),{type:'bar',data:{labels:['Acumulado'],datasets:[{label:'Normal',data:[0],backgroundColor:'#3b82f6'},{label:'Extra',data:[0],backgroundColor:'#9333ea'}]},options:{indexAxis:'y',responsive:true}}); }
        function atualizarGraficos() { if(!chartInstances.oee)return; const id=document.getElementById('filtro-grafico-maquina').value, t=document.getElementById('select-turno-global').value; let d={p:0,b:0,pa:0,n:0}; maquinas.forEach(m=>{ if(id==='todas'||m.id==id){ d.p+=m.resumoTurno[t].tempoProducao; d.b+=m.resumoTurno[t].tempoBaixaEficiencia; d.pa+=m.resumoTurno[t].tempoParadas; d.n+=m.resumoTurno[t].tempoSemProgramacao; } }); chartInstances.oee.data.datasets[0].data=[d.p,d.b,d.pa,d.n]; chartInstances.oee.update(); document.getElementById('tempo-prod-total').innerText=formatarTempo(d.p); document.getElementById('tempo-baixa-total').innerText=formatarTempo(d.b); document.getElementById('tempo-parado-total').innerText=formatarTempo(d.pa); document.getElementById('tempo-neutro-total').innerText=formatarTempo(d.n); if(chartInstances.horas){ chartInstances.horas.data.datasets[0].data=[(metricasMensais.tempoProducao||0)/3600]; chartInstances.horas.data.datasets[1].data=[(metricasMensais.tempoHoraExtra||0)/3600]; chartInstances.horas.update(); } }
        
        function renderizarTabelaResumo() { const t=document.getElementById('filtro-resumo-turno').value; document.getElementById('tabela-resumo-corpo').innerHTML=maquinas.map(m=>{ let d={boas:0,refugo:0,prod:0,parada:0}; if(t==='todas')[1,2,3].forEach(turn=>{d.boas+=m.dadosTurno[turn].pecasBoas;d.refugo+=m.dadosTurno[turn].pecasRefugo;d.prod+=m.dadosTurno[turn].tempoProducao;d.parada+=m.dadosTurno[turn].tempoParadas;}); else d=m.dadosTurno[t]; const p=(d.boas+d.refugo)>0?((d.refugo/(d.boas+d.refugo))*100).toFixed(1):0; return `<tr class="border-b hover:bg-slate-50"><td class="p-4 font-bold text-slate-800">${m.nome}</td><td class="p-4 text-xs text-slate-500 font-mono">${m.filaProducao[0]?.op||'-'}</td><td class="p-4 text-right font-bold text-green-600">${d.boas}</td><td class="p-4 text-right font-bold text-red-500">${d.refugo}</td><td class="p-4 text-right text-xs font-bold text-slate-400">${p}%</td><td class="p-4 text-center font-mono text-xs bg-green-50 text-green-700 rounded">${formatarTempo(d.prod)}</td><td class="p-4 text-center font-mono text-xs bg-red-50 text-red-700 rounded">${formatarTempo(d.parada)}</td></tr>`; }).join(''); }
        function resetarDadosTurno() { const t=document.getElementById('filtro-resumo-turno').value; if(t==='todas')return alert("Selecione um turno."); if(confirm("Zerar?")){ maquinas.forEach(m=>m.dadosTurno[t]=criarObjetoMetricasVazio()); renderizarTabelaResumo(); renderizarPainelPrincipal(); agendarSalvamentoAutomatico(); } }
        function adicionarNovoOperador() { const n=prompt("Nome:"); if(n){ equipeOperadores.push(n); atualizarDropdownsFormularios(); agendarSalvamentoAutomatico(); } }
        function adicionarNovoProdutoCatalogo() { const n=prompt("Produto:"); if(n){ catalogoProdutos.push(n); atualizarDropdownsFormularios(); agendarSalvamentoAutomatico(); } }
        function alternarPausaSistema() { sistemaPausado=!sistemaPausado; document.getElementById('btn-pausa-sistema').innerText=sistemaPausado?'RETOMAR':'Pausa'; agendarSalvamentoAutomatico(); }
        function alternarHoraExtra() { if(!verificarFimDeSemana(obterDataHoraBrasilia()))return alert("Apenas FDS."); modoHoraExtraAtivo=!modoHoraExtraAtivo; document.getElementById('btn-hora-extra').className=modoHoraExtraAtivo?"bg-purple-600 text-white animate-pulse":"bg-slate-600 text-white"; agendarSalvamentoAutomatico(); }
        function alterarTurnoManual(v) { modoManualAtivo=true; document.getElementById('badge-auto').style.display='none'; renderizarPainelPrincipal(); }
        function resetarMes() { if(confirm("Zerar M√™s?")) { metricasMensais={tempoProducao:0,tempoHoraExtra:0}; calcEficienciaGlobal(); agendarSalvamentoAutomatico(); } }

        // Destravamento Emerg√™ncia
        setTimeout(()=>{ const l=document.getElementById('tela-carregamento'); if(l&&l.style.display!=='none'){ l.style.display='none'; document.getElementById('acao-pos-loading').classList.remove('hidden'); document.getElementById('acao-pos-loading').classList.add('flex'); } }, 6000);
        window.addEventListener('beforeunload', ()=>salvarDadosNuvem());
        inicializarSistema();
    </script>
</body>
</html>
