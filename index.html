<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triplast - Monitoramento Completo</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body { 
            background-color: #eef2f6; 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 0; 
        }
        
        /* Utilit√°rios de Abas */
        .aba-conteudo { display: none !important; }
        .aba-ativa { display: block !important; }

        /* ================================================================= */
        /* ESTILO DOS CARDS DE M√ÅQUINA (PAINEL) */
        /* ================================================================= */
        .card-producao {
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-left: 12px solid #ef4444; 
            transition: 0.3s; 
            position: relative;
        }
        
        .status-produzindo { border-left-color: #22c55e !important; background-color: #f0fdf4; }
        .status-baixa { border-left-color: #f97316 !important; background-color: #fff7ed; }
        .status-sem-prog { border-left-color: #cbd5e1 !important; background-color: #f8fafc; }
        .status-fechada { border-left-color: #475569 !important; background-color: #e2e8f0; filter: grayscale(50%); opacity: 0.9; }

        .info-badge {
            background: #f8fafc; 
            padding: 6px; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }
        
        .info-badge span:first-child { 
            font-size: 0.65rem; 
            font-weight: 800; 
            text-transform: uppercase; 
            margin-bottom: 2px; 
        }
        
        .info-badge span:last-child { 
            font-weight: 900; 
            line-height: 1; 
        }

        /* ================================================================= */
        /* ESTILO DOS BOT√ïES DE NAVEGA√á√ÉO */
        /* ================================================================= */
        .tab-btn {
            background: white; 
            padding: 10px 20px; 
            border-radius: 20px;
            font-weight: 700; 
            font-size: 13px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: 0.2s; 
            border: 2px solid transparent; 
            cursor: pointer; 
            color: #64748b;
        }
        
        .tab-btn.active { 
            background: #3b82f6; 
            color: white; 
            border-color: #2563eb; 
            box-shadow: 0 4px 10px rgba(37,99,235,0.3); 
        }

        header { 
            background: #1e293b; 
            color: white; 
            padding: 20px; 
            border-radius: 0 0 20px 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
        }
        
        .modal-reset {
            display: none; 
            position: absolute; 
            top: 40px; 
            right: 10px; 
            background: white;
            border: 1px solid #ccc; 
            padding: 10px; 
            border-radius: 10px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            z-index: 50; 
            width: 150px;
        }

        /* ================================================================= */
        /* ESTILO: FILA HORIZONTAL (CARROSSEL) */
        /* ================================================================= */
        .scrolling-wrapper {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 16px;
            padding-bottom: 15px;
            padding-top: 5px;
            -webkit-overflow-scrolling: touch;
        }
        
        .scrolling-wrapper::-webkit-scrollbar { height: 8px; }
        .scrolling-wrapper::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 4px; }
        .scrolling-wrapper::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .scrolling-wrapper::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* ================================================================= */
        /* ESTILO: NOVA ETIQUETA / FICHA T√âCNICA */
        /* ================================================================= */
        .ticket-card {
            flex: 0 0 auto;
            width: 320px; 
            background: white;
            border: 1px solid #cbd5e1;
            border-top: 6px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            position: relative;
            overflow: hidden;
        }
        
        .ticket-header { 
            background: #f1f5f9; 
            padding: 10px; 
            border-bottom: 1px solid #e2e8f0;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        
        .ficha-row {
            display: flex; 
            border-bottom: 1px dashed #e2e8f0; 
            padding: 8px 12px;
            align-items: center; 
            justify-content: space-between;
        }
        
        .ficha-label { font-size: 10px; color: #64748b; font-weight: 800; text-transform: uppercase; }
        .ficha-value { font-size: 12px; color: #0f172a; font-weight: 700; text-align: right; }

        /* Scrollbar Global */
        .scrollbar-custom::-webkit-scrollbar { width: 6px; }
        .scrollbar-custom::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .scrollbar-custom::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* ================================================================= */
        /* ESTILO: NOTIFICA√á√ÉO TOAST (SALVAMENTO) */
        /* ================================================================= */
        #toast-notification {
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 9999;
        }
        .toast-show { transform: translate(-50%, 20px) !important; }
        .toast-hide { transform: translate(-50%, -100px) !important; }
    </style>
</head>
<body onclick="fecharMenusGlobais(event)">

    <div id="toast-notification" class="fixed top-0 left-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 toast-hide border border-slate-600">
        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse shadow-[0_0_10px_#4ade80]"></div>
        <span class="text-[10px] font-black tracking-widest uppercase" id="toast-msg">DADOS SINCRONIZADOS</span>
    </div>

    <div id="modal-cores" class="fixed inset-0 bg-slate-900/80 z-[150] hidden items-center justify-center">
        <div class="bg-white p-6 rounded-3xl shadow-2xl w-96 max-w-[90%]">
            <div class="flex justify-between items-center mb-6 border-b pb-2">
                <h3 class="font-black text-xl text-slate-800">üé® Gerenciar Cores</h3>
                <button onclick="fecharModalCores()" class="text-slate-400 hover:text-red-500 text-3xl font-bold leading-none">&times;</button>
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="nova-cor-modal" class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold outline-none focus:border-blue-500" placeholder="Nova cor...">
                <button onclick="addCorModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 rounded-xl font-black text-xl shadow-md transition-colors">+</button>
            </div>
            <div id="lista-cores-modal" class="flex flex-wrap gap-2 max-h-48 overflow-y-auto p-1"></div>
        </div>
    </div>

    <div id="modal-editar-op" class="fixed inset-0 bg-slate-900/80 z-[200] hidden items-center justify-center">
        <div class="bg-white p-6 rounded-3xl shadow-2xl w-[500px] max-w-[95%] overflow-y-auto max-h-[90vh]">
            <h3 class="font-black text-xl text-slate-800 mb-4 border-b pb-2">‚úèÔ∏è Editar Ficha T√©cnica</h3>
            <input type="hidden" id="edit-maq-id">
            <input type="hidden" id="edit-op-index">
            
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">N√öMERO O.P</label>
                        <input type="text" id="edit-op-num" class="w-full p-2 bg-slate-50 border rounded-xl font-bold">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">QUANTIDADE META</label>
                        <input type="number" id="edit-op-qtd" class="w-full p-2 bg-slate-50 border rounded-xl font-bold">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400">CLIENTE</label>
                    <input type="text" id="edit-op-cliente" class="w-full p-2 bg-slate-50 border rounded-xl font-bold">
                </div>
                
                <div>
                    <label class="text-[10px] font-bold text-slate-400">NOME DO PRODUTO / PE√áA</label>
                    <select id="edit-op-produto" class="w-full p-2 bg-slate-50 border rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500">
                        </select>
                </div>
                
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 mt-2">
                    <p class="text-[10px] font-black text-blue-600 uppercase mb-2">Detalhes da Mistura</p>
                    <div class="grid grid-cols-2 gap-2">
                         <div><label class="text-[9px] font-bold text-slate-500">MATERIAL</label><input type="text" id="edit-op-material" class="w-full p-2 bg-white border rounded-lg text-sm"></div>
                         <div><label class="text-[9px] font-bold text-slate-500">QTD MATERIAL</label><input type="text" id="edit-op-material-qtd" class="w-full p-2 bg-white border rounded-lg text-sm"></div>
                         <div><label class="text-[9px] font-bold text-slate-500">C√ìD. PIGMENTO</label><input type="text" id="edit-op-pigmento" class="w-full p-2 bg-white border rounded-lg text-sm"></div>
                         <div><label class="text-[9px] font-bold text-slate-500">% PIGMENTO</label><input type="text" id="edit-op-porcentagem" class="w-full p-2 bg-white border rounded-lg text-sm"></div>
                    </div>
                </div>

                 <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 mt-2">
                    <p class="text-[10px] font-black text-orange-600 uppercase mb-2">Embalagem</p>
                    <div class="grid grid-cols-2 gap-2">
                         <div><label class="text-[9px] font-bold text-slate-500">TIPO DE CAIXA</label><input type="text" id="edit-op-caixa" class="w-full p-2 bg-white border rounded-lg text-sm"></div>
                         <div><label class="text-[9px] font-bold text-slate-500">TIPO DE SACO</label><input type="text" id="edit-op-saco" class="w-full p-2 bg-white border rounded-lg text-sm"></div>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400">OPERADOR DEFINIDO</label>
                    <select id="edit-op-operador" class="w-full p-2 bg-slate-50 border rounded-xl font-bold"></select>
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button onclick="document.getElementById('modal-editar-op').style.display='none'" class="flex-1 bg-slate-200 text-slate-700 font-bold py-3 rounded-xl">Cancelar</button>
                <button onclick="salvarEdicaoOP()" class="flex-1 bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg hover:bg-blue-500">SALVAR</button>
            </div>
        </div>
    </div>

    <div id="tela-loading" class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center transition-opacity duration-500">
        <h1 class="text-6xl md:text-8xl font-black italic tracking-tighter mb-12 text-white animate-pulse">TRI<span class="text-blue-500">PLAST</span></h1>
        <div id="loading-spinner" class="flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-6"></div>
            <p class="text-slate-400 font-bold text-sm tracking-widest uppercase animate-pulse">Conectando ao banco de dados...</p>
        </div>
        <div id="loading-action" class="hidden flex-col items-center">
            <p class="text-green-400 mb-8 font-bold text-sm tracking-widest uppercase flex items-center gap-2">
                <i class="fa-solid fa-check-circle text-lg"></i> Conex√£o Estabelecida
            </p>
            <button onclick="entrarLogin()" class="bg-blue-600 text-white font-black py-4 px-12 rounded-full shadow-[0_0_20px_rgba(37,99,235,0.4)] hover:shadow-[0_0_40px_rgba(37,99,235,0.8)] hover:bg-blue-500 transition-all duration-300 hover:scale-105 active:scale-95 text-xl tracking-widest uppercase border border-blue-400">
                Acessar Sistema
            </button>
        </div>
    </div>

    <div id="tela-login" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center" style="display: none;">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-96 max-w-[90%] text-center">
            <h1 class="text-4xl font-black italic tracking-tighter mb-2 text-slate-800">TRI<span class="text-blue-500">PLAST</span></h1>
            <p class="text-xs font-bold text-slate-400 mb-8 uppercase">Acesso ao Sistema</p>
            <div class="mb-4 text-left">
                <label class="text-[10px] font-black text-slate-400 block mb-1">USU√ÅRIO</label>
                <select id="login-tipo" class="w-full p-4 bg-slate-50 border rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 transition-colors">
                    <option value="admin">üë®‚Äçüíª Triplast (Administrador)</option>
                </select>
            </div>
            <div class="mb-8 text-left">
                <label class="text-[10px] font-black text-slate-400 block mb-1">SENHA</label>
                <input type="password" id="login-senha" class="w-full p-4 bg-slate-50 border rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 transition-colors" placeholder="****">
            </div>
            <button onclick="fazerLogin()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg hover:bg-blue-500 transition-transform active:scale-95 text-lg">ENTRAR</button>
        </div>
    </div>

    <div id="app-content" style="display: none;">
        <header class="max-w-7xl mx-auto mb-6 relative">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-4">
                    <span class="text-3xl font-black italic tracking-tighter hidden sm:block">TRI<span class="text-blue-400">PLAST</span></span>
                    <div id="relogio" class="font-mono text-blue-300 bg-slate-900 px-4 py-2 rounded-lg text-lg border border-slate-700">00:00:00</div>
                    <button onclick="fazerLogout()" class="text-[10px] bg-red-500 hover:bg-red-400 text-white font-black px-3 py-2 rounded-lg uppercase shadow-md transition-colors"><i class="fa-solid fa-right-from-bracket"></i> Sair</button>
                </div>
                <div class="flex items-center gap-4 bg-slate-700 p-2 rounded-xl flex-wrap justify-center">
                    
                    <button id="btn-pause" onclick="togglePause()" class="bg-yellow-500 hover:bg-yellow-400 text-white text-[10px] font-black px-3 py-2 rounded-lg transition-all shadow-md uppercase">
                        <i class="fa-solid fa-pause"></i> Pausar
                    </button>

                    <button id="btn-extra" onclick="toggleHoraExtra()" class="text-white text-[10px] font-black px-3 py-2 rounded-lg transition-all shadow-md uppercase">
                        <i class="fa-solid fa-bolt"></i> Hora Extra
                    </button>

                    <span class="text-xs font-bold text-slate-400 ml-2">TURNO ATUAL:</span>
                    <select id="filtro-turno" onchange="mudarTurnoManual(this.value)" class="bg-slate-800 text-white font-bold p-2 rounded-lg outline-none border-none">
                        <option value="1">üåÖ Manh√£ (05:00 - 14:18)</option>
                        <option value="2">‚òÄÔ∏è Tarde (14:18 - 23:36)</option>
                        <option value="3">üåô Noite (23:36 - 05:00)</option>
                    </select>
                    <div id="badge-auto" class="bg-green-500 text-[10px] px-3 py-1 rounded-full font-black animate-pulse">AUTO</div>
                    <div id="status-nuvem" class="text-[10px] text-gray-400 font-mono">‚òÅÔ∏è</div>
                </div>
                
                <div id="header-eficiencia" class="text-right bg-slate-800 p-3 rounded-xl border border-slate-600">
                    <div class="flex justify-between items-center gap-4 mb-1">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">Meta Mensal (1.628h)</span>
                        <button onclick="resetarMes()" class="text-[8px] bg-slate-700 hover:bg-red-600 text-white px-2 py-1 rounded uppercase">Zerar M√™s</button>
                    </div>
                    <div class="flex items-end justify-end gap-2">
                        <div class="text-right">
                            <span class="text-[10px] text-blue-400 font-bold block">HORAS TRABALHADAS</span>
                            <span id="horas-trabalhadas-mes" class="text-lg font-mono font-black text-white">0h</span>
                        </div>
                        <span id="meta-global" class="text-3xl font-black text-green-400">0%</span>
                    </div>
                </div>
            </div>
        </header>

        <nav id="nav-principal" class="max-w-7xl mx-auto mb-8 px-4 flex flex-wrap gap-2 justify-center">
            <button onclick="trocarAba('painel')" id="btn-painel" class="tab-btn active shadow-md whitespace-nowrap">üñ•Ô∏è PAINEL</button>
            <button onclick="trocarAba('lista')" id="btn-lista" class="tab-btn shadow-md whitespace-nowrap">üìã GEST√ÉO O.P</button>
            <button onclick="trocarAba('graficos')" id="btn-graficos" class="tab-btn shadow-md whitespace-nowrap">üìä GR√ÅFICOS</button>
            <button onclick="trocarAba('produtos')" id="btn-produtos" class="tab-btn shadow-md whitespace-nowrap">üì¶ PRODUTOS</button>
            <button onclick="trocarAba('operadores')" id="btn-operadores" class="tab-btn shadow-md whitespace-nowrap">üë∑ OPERADORES</button>
        </nav>

        <div id="aba-painel" class="aba-conteudo aba-ativa px-4">
            <div id="grid-maquinas"></div>
        </div>

        <div id="aba-lista" class="aba-conteudo px-4">
            <div class="max-w-7xl mx-auto grid grid-cols-1 gap-8">
                
                <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100">
                    <h2 class="text-xl font-black mb-6 text-slate-700 flex items-center gap-2"><i class="fa-solid fa-circle-plus text-blue-600"></i> CRIAR FICHA T√âCNICA (O.P)</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="md:col-span-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">M√°quina</label>
                            <select id="f-maquina" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500"></select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">N¬∫ O.P</label>
                            <input type="text" id="f-op" placeholder="Ex: 12345" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500">
                        </div>
                         <div class="md:col-span-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Cliente</label>
                            <input type="text" id="f-cliente" placeholder="Nome do Cliente" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500">
                        </div>
                         <div class="md:col-span-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Quantidade (Meta)</label>
                            <input type="number" id="f-qtd" oninput="calcularPrevisao()" placeholder="0" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500">
                        </div>
                    </div>

                     <div class="col-span-full mb-6 bg-slate-50 rounded-2xl border border-slate-200 shadow-inner overflow-hidden">
                        <div class="bg-white px-4 py-2 border-b border-slate-200 flex items-center justify-between">
                            <h3 class="font-bold text-slate-700 text-xs uppercase flex items-center gap-2">
                                <i class="fas fa-calculator text-blue-500"></i> Calculadora de Produ√ß√£o
                            </h3>
                            <span class="text-[10px] font-black text-slate-400 uppercase">Previs√£o Autom√°tica</span>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Peso Pe√ßa (g)</label>
                                    <input type="number" id="tec-peso" oninput="calcularPrevisao()" placeholder="0.00" class="w-full p-2 bg-white border border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Ciclo (Seg)</label>
                                    <input type="number" id="tec-ciclo" oninput="calcularPrevisao()" placeholder="0.0" class="w-full p-2 bg-white border border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Cavidades</label>
                                    <input type="number" id="tec-cav" value="1" oninput="calcularPrevisao()" class="w-full p-2 bg-white border border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">% Pigmento</label>
                                    <input type="number" id="tec-pig-porc" oninput="calcularPrevisao()" placeholder="0.0" class="w-full p-2 bg-white border border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-orange-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-3">
                                <div class="bg-blue-600 rounded-lg p-2 text-center shadow-md">
                                    <span class="block text-[8px] text-blue-200 font-bold uppercase">Tempo</span>
                                    <span id="out-tempo" class="block text-lg font-black text-white leading-tight">-</span>
                                </div>
                                <div class="bg-white border border-slate-200 rounded-lg p-2 text-center">
                                    <span class="block text-[8px] text-slate-400 font-bold uppercase">Material</span>
                                    <span id="out-material" class="block text-lg font-black text-slate-700 leading-tight">-</span>
                                </div>
                                <div class="bg-orange-500 rounded-lg p-2 text-center shadow-md">
                                    <span class="block text-[8px] text-orange-200 font-bold uppercase">Pigmento (kg)</span>
                                    <span id="out-pigmento" class="block text-lg font-black text-white leading-tight">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="md:col-span-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Produto / Pe√ßa</label>
                            <select id="f-produto" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500">
                                <option value="">-- Selecione Produto --</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Material (Resina)</label>
                            <input type="text" id="f-material" placeholder="Ex: PP, PE, ABS" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500">
                        </div>
                         <div class="md:col-span-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Qtd Material</label>
                            <input type="text" id="f-material-qtd" placeholder="Ex: 50kg, 2 Sacos" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <div class="md:col-span-2 flex items-center">
                            <label class="text-xs font-black text-blue-600 uppercase mr-2"><i class="fa-solid fa-fill-drip"></i> MISTURA:</label>
                        </div>
                        <div class="md:col-span-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">C√≥d. Pigmento</label>
                            <input type="text" id="f-pigmento" placeholder="C√≥d..." class="w-full p-2 bg-white border border-blue-200 rounded-lg font-bold">
                        </div>
                        <div class="md:col-span-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Porcentagem (%)</label>
                            <input type="text" id="f-porcentagem" placeholder="Ex: 2%" class="w-full p-2 bg-white border border-blue-200 rounded-lg font-bold">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 bg-orange-50 p-4 rounded-xl border border-orange-100">
                        <div class="md:col-span-2 flex items-center">
                            <label class="text-xs font-black text-orange-600 uppercase mr-2"><i class="fa-solid fa-box-open"></i> EMBALAGEM:</label>
                        </div>
                        <div class="md:col-span-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Tipo de Caixa</label>
                            <input type="text" id="f-caixa" placeholder="Ex: CX Padr√£o" class="w-full p-2 bg-white border border-orange-200 rounded-lg font-bold">
                        </div>
                        <div class="md:col-span-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Saco Pl√°stico</label>
                            <input type="text" id="f-saco" placeholder="Ex: 40x60" class="w-full p-2 bg-white border border-orange-200 rounded-lg font-bold">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Operador Respons√°vel</label>
                        <select id="f-operador" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500"></select>
                    </div>

                    <button onclick="adicionarFila()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-black uppercase shadow-lg hover:bg-blue-500 hover:shadow-blue-500/30 transition-all active:scale-95"><i class="fa-solid fa-paper-plane mr-2"></i> LAN√áAR FICHA NA PRODU√á√ÉO</button>
                </div>
                
                <div id="container-filas" class="space-y-6"></div>

            </div>

            <div class="bg-white p-8 rounded-3xl shadow-2xl mt-8">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 border-b pb-4 gap-4">
                    <h2 class="text-2xl font-black text-slate-800"><i class="fa-solid fa-clock-rotate-left text-blue-600 mr-2"></i> HIST√ìRICO</h2>
                    <div class="flex flex-wrap gap-2">
                        <input type="text" id="busca-historico-op" placeholder="üîç Buscar N¬∫ O.P" oninput="renderHistorico()" class="p-2 bg-slate-50 border border-slate-200 rounded-lg font-bold text-sm outline-none focus:border-blue-500">
                        <input type="date" id="busca-historico-data" onchange="renderHistorico()" class="p-2 bg-slate-50 border border-slate-200 rounded-lg font-bold text-sm outline-none focus:border-blue-500 text-slate-600">
                        <button onclick="limparBuscaHistorico()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-2 rounded-lg font-bold text-xs transition-colors"><i class="fa-solid fa-xmark"></i> Limpar</button>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full text-left">
                        <thead class="bg-blue-50 text-blue-800 text-xs uppercase sticky top-0">
                            <tr>
                                <th class="p-3">Data</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">M√°quina</th>
                                <th class="p-3">O.P</th>
                                <th class="p-3">Cliente</th>
                                <th class="p-3">Produto</th>
                                <th class="p-3">Qtd Feita</th>
                                <th class="p-3 text-right">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-historico" class="text-sm font-bold text-slate-600"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="aba-graficos" class="aba-conteudo px-4">
             <div class="max-w-7xl mx-auto">
                 <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100 mb-8">
                     <h2 class="text-2xl font-black text-slate-800 mb-6">üìä DESEMPENHO EM TEMPO REAL</h2>
                     <div class="flex flex-wrap gap-2 mb-6 justify-center bg-slate-100 p-2 rounded-xl inline-flex w-full md:w-auto">
                         <button onclick="alterarFiltroGrafico('dia')" class="px-4 py-2 rounded-lg text-sm font-bold bg-white shadow text-blue-600">HOJE</button>
                         <button onclick="alterarFiltroGrafico('semana')" class="px-4 py-2 rounded-lg text-sm font-bold text-slate-500 hover:bg-white/50">SEMANA</button>
                         <button onclick="alterarFiltroGrafico('mes')" class="px-4 py-2 rounded-lg text-sm font-bold text-slate-500 hover:bg-white/50">M√äS</button>
                     </div>
                     <div class="h-80 w-full relative">
                         <canvas id="graficoProducao"></canvas>
                     </div>
                 </div>
                 
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                     <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100">
                         <h3 class="font-bold text-slate-700 mb-4 uppercase text-xs">Produ√ß√£o por M√°quina</h3>
                         <div class="h-64 relative"><canvas id="graficoMaquinas"></canvas></div>
                     </div>
                     <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100">
                         <h3 class="font-bold text-slate-700 mb-4 uppercase text-xs">Efici√™ncia por Operador</h3>
                         <div class="h-64 relative"><canvas id="graficoOperadores"></canvas></div>
                     </div>
                 </div>
             </div>
        </div>

        <div id="aba-produtos" class="aba-conteudo max-w-6xl mx-auto px-4">
            <div class="mb-6 text-center">
                <h2 class="text-2xl font-black text-slate-800 uppercase">Cat√°logo de Produtos</h2>
                <p class="text-slate-500 text-sm">Cadastro T√©cnico Completo</p>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-8">
                <h3 class="font-bold text-slate-700 border-b pb-2 mb-4 flex items-center gap-2">
                    <i class="fas fa-cube text-blue-600"></i> Novo Produto
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Nome do Produto</label>
                        <input type="text" id="cad-nome" placeholder="Ex: Pote 250ml" class="w-full p-2 border-2 border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Material</label>
                        <input type="text" id="cad-material" placeholder="Ex: PS Cristal" list="lista-materiais-sugestao" class="w-full p-2 border-2 border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500">
                        <datalist id="lista-materiais-sugestao">
                            <option value="PS Cristal"><option value="PP"><option value="PEAD"><option value="ABS">
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Pigmento (Tipo)</label>
                        <input type="text" id="cad-pig-tipo" placeholder="Ex: Todos de PS" class="w-full p-2 border-2 border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Peso Pe√ßa (g)</label>
                        <input type="number" id="cad-peso" step="0.001" placeholder="0.047" class="w-full p-2 border-2 border-slate-200 rounded-lg font-bold text-blue-600 outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Ciclo (Seg)</label>
                        <input type="number" id="cad-ciclo" step="0.1" placeholder="20.0" class="w-full p-2 border-2 border-slate-200 rounded-lg font-bold text-blue-600 outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Cavidades</label>
                        <input type="number" id="cad-cav" placeholder="2" class="w-full p-2 border-2 border-slate-200 rounded-lg font-bold text-blue-600 outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">% Pigmento</label>
                        <input type="number" id="cad-pig-porc" step="0.01" placeholder="2.0" class="w-full p-2 border-2 border-slate-200 rounded-lg font-bold text-orange-500 outline-none focus:border-orange-500">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Saquinho</label>
                        <input type="text" id="cad-saquinho" placeholder="17x27" class="w-full p-2 border-2 border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Qtd Caixa</label>
                        <input type="number" id="cad-cx" placeholder="100" class="w-full p-2 border-2 border-slate-200 rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500">
                    </div>
                    <div class="md:col-span-2 flex items-end">
                        <button onclick="salvarNovoProduto()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-black uppercase shadow-lg shadow-blue-200 transition-all">
                            <i class="fas fa-save mr-2"></i> Salvar Produto
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-500 text-[10px] uppercase font-bold">
                        <tr>
                            <th class="p-4">Produto</th>
                            <th class="p-4 hidden md:table-cell">Detalhes T√©cnicos</th>
                            <th class="p-4 hidden md:table-cell">Embalagem</th>
                            <th class="p-4 text-right">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-produtos-lista" class="divide-y divide-slate-100 text-sm text-slate-700">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="aba-operadores" class="aba-conteudo max-w-4xl mx-auto px-4">
            
            <div class="mb-8 text-center">
                <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight">Equipe de Produ√ß√£o</h2>
                <p class="text-slate-500 text-sm">Gerencie quem pode ser selecionado nas m√°quinas</p>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8 flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1 w-full">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Nome do Novo Operador</label>
                    <input type="text" id="novo-operador-nome" placeholder="Ex: Jo√£o da Silva" 
                        class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 transition-all">
                </div>
                <button onclick="adicionarOperador()" 
                    class="w-full md:w-auto px-8 py-3.5 bg-green-500 hover:bg-green-600 text-white rounded-xl font-black uppercase tracking-wider shadow-lg shadow-green-200 transition-all active:scale-95">
                    <i class="fas fa-plus mr-2"></i> Adicionar
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                    <h3 class="font-bold text-slate-700 uppercase text-sm">
                        <i class="fas fa-users text-blue-500 mr-2"></i> Operadores Cadastrados
                    </h3>
                    <span class="text-xs bg-blue-100 text-blue-700 py-1 px-2 rounded-lg font-bold">Ativos</span>
                </div>
                
                <ul id="lista-operadores" class="divide-y divide-slate-100 p-0 m-0">
                    </ul>
            </div>
        </div>

    </div>

    <script>
        // CONFIGURA√á√ÉO SUPABASE
        const SUPABASE_URL = 'https://tvfrkppocvarsriavszu.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2ZnJrcHBvY3ZhcnNyaWF2c3p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzkzMDM1NjEsImV4cCI6MjA1NDg3OTU2MX0.g0-d5jY6-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H-H'
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

        // ESTADO GLOBAL
        let maquinas = Array(12).fill(null).map((_, i) => ({ id: i+1, opAtual: null, fila: [] }))
        let coresGlobais = ["Azul", "Vermelho", "Verde", "Amarelo", "Preto", "Branco", "Laranja", "Roxo"]
        let operadoresGlobais = ["Jo√£o Silva", "Maria Oliveira", "Carlos Santos", "Ana Souza"]
        let produtosGlobais = []; // Garante que a lista existe
        let historico = []
        let dadosMensais = { mes: new Date().getMonth(), horasTrabalhadas: 0 }
        let modoHoraExtra = false
        let turnoManual = null
        let chartProducao, chartMaquinas, chartOperadores
        let saveTimeout = null
        let filtroGraficoId = 'dia'
        
        // Controle de vers√£o local vs nuvem para evitar loop de updates
        let dadosLocaisLastUpdate = 0; 

        // INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', () => {
            verificarLogin()
        })

        async function verificarLogin() {
            const logado = localStorage.getItem('triplast_logado')
            if(logado === 'true') {
                document.getElementById('tela-loading').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('loading-spinner').classList.add('hidden');
                    document.getElementById('loading-action').classList.remove('hidden');
                    document.getElementById('loading-action').style.display = 'flex';
                }, 1500);
            } else {
                document.getElementById('tela-loading').style.display = 'none'
                document.getElementById('tela-login').style.display = 'flex'
            }
        }

        function fazerLogin() {
            const user = document.getElementById('login-tipo').value
            const pass = document.getElementById('login-senha').value
            if(pass === '1234') { // SENHA SIMPLES
                localStorage.setItem('triplast_logado', 'true')
                localStorage.setItem('triplast_user', user)
                location.reload()
            } else {
                alert('Senha incorreta!')
            }
        }

        function entrarLogin() {
            document.getElementById('tela-loading').style.opacity = '0'
            setTimeout(() => {
                document.getElementById('tela-loading').style.display = 'none'
                document.getElementById('app-content').style.display = 'block'
                iniciarSistema()
            }, 500)
        }

        function fazerLogout() {
            localStorage.removeItem('triplast_logado')
            location.reload()
        }

        async function iniciarSistema() {
            await carregarDados()
            setInterval(atualizarRelogio, 1000)
            atualizarRelogio()
            renderPainel()
            renderListaOPs()
            atualizarResumoGlobalNumeros()
            
             // Carrega a tabela de produtos corretamente
            if(typeof renderizarTabelaProdutos === 'function') {
                renderizarTabelaProdutos();
            }
            
            // Subscreve para atualiza√ß√µes em tempo real do banco
            sb.channel('sistema_changes')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'sistema' }, payload => {
                const nuvemTimestamp = payload.new.conteudo.lastUpdateTimestamp || 0;
                // S√≥ atualiza se o dado da nuvem for mais novo que meu √∫ltimo save local
                if (nuvemTimestamp > dadosLocaisLastUpdate) {
                    console.log("Recebi atualiza√ß√£o da nuvem mais recente que a local.");
                    maquinas = payload.new.conteudo.maquinas || maquinas
                    coresGlobais = payload.new.conteudo.cores || coresGlobais
                    operadoresGlobais = payload.new.conteudo.operadores || operadoresGlobais
                    produtosGlobais = payload.new.conteudo.produtos || [];
                    historico = payload.new.conteudo.historico || historico
                    dadosMensais = payload.new.conteudo.dadosMensais || dadosMensais
                    modoHoraExtra = payload.new.conteudo.modoHoraExtra || false
                    renderPainel()
                    renderListaOPs()
                    renderizarTabelaProdutos()
                    atualizarResumoGlobalNumeros()
                    if(chartProducao) iniciarGraficos() // Atualiza gr√°ficos se estiverem abertos
                }
            })
            .subscribe()
        }

        async function carregarDados() {
            const { data, error } = await sb.from('sistema').select('*').eq('id', 1).single()
            if(data && data.conteudo) {
                maquinas = data.conteudo.maquinas || maquinas
                coresGlobais = data.conteudo.cores || coresGlobais
                operadoresGlobais = data.conteudo.operadores || operadoresGlobais
                produtosGlobais = data.conteudo.produtos || [];
                historico = data.conteudo.historico || historico
                dadosMensais = data.conteudo.dadosMensais || dadosMensais
                modoHoraExtra = data.conteudo.modoHoraExtra || false
                dadosLocaisLastUpdate = data.conteudo.lastUpdateTimestamp || 0
            }
        }

        // L√ìGICA DE NAVEGA√á√ÉO
        function trocarAba(id) {
            // 1. Limpa tudo
            document.querySelectorAll('.aba-conteudo').forEach(a => a.classList.remove('aba-ativa'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            // 2. Ativa a aba clicada
            const aba = document.getElementById('aba-' + id);
            const btn = document.getElementById('btn-' + id);
            if(aba) aba.classList.add('aba-ativa');
            if(btn) btn.classList.add('active');
            
            // 3. Carrega os dados espec√≠ficos
            if(id === 'graficos') { atualizarResumoGlobalNumeros(); iniciarGraficos(); }
            if(id === 'apontamento') { renderApontamento(); }
            if(id === 'lista') { renderListaOPs(); renderHistorico(); }
            
            // === NOVA ABA PRODUTOS ===
            if(id === 'produtos') { renderizarTabelaProdutos(); }
            
            // === ABA OPERADORES ===
            if(id === 'operadores') { 
                if(typeof renderizarListaOperadores === 'function') renderizarListaOperadores();
            }
        }
        
        function fecharMenusGlobais(e) {
            if(!e.target.closest('#modal-cores') && !e.target.closest('button[onclick="abrirModalCores()"]')) {
                document.getElementById('modal-cores').style.display = 'none'
            }
        }

        // FUN√á√ïES DO PAINEL
        function renderPainel() {
            const grid = document.getElementById('grid-maquinas')
            grid.innerHTML = ''
            grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6'

            maquinas.forEach(m => {
                const op = m.opAtual
                let statusClass = 'status-sem-prog'
                let statusText = 'SEM PROGRAMA√á√ÉO'
                let corDot = 'bg-slate-400'
                
                if(op) {
                    statusClass = 'status-produzindo'
                    statusText = 'EM PRODU√á√ÉO'
                    corDot = 'bg-green-500 animate-pulse'
                    if(op.status === 'pausa') {
                        statusClass = 'status-baixa'
                        statusText = 'EM PAUSA'
                        corDot = 'bg-orange-500'
                    }
                }

                const card = document.createElement('div')
                card.className = `card-producao p-5 ${statusClass}`
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-xs font-black text-slate-400 uppercase tracking-widest">M√ÅQUINA</span>
                            <h3 class="text-3xl font-black text-slate-800">#${String(m.id).padStart(2,'0')}</h3>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100 mb-2">
                                <div class="w-2 h-2 rounded-full ${corDot}"></div>
                                <span class="text-[10px] font-bold text-slate-600 uppercase">${statusText}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${op ? `
                    <div class="bg-white/60 p-3 rounded-xl border border-slate-200/50 mb-4 backdrop-blur-sm">
                        <div class="flex justify-between mb-1">
                            <span class="text-[10px] font-bold text-slate-500">O.P: <strong class="text-slate-800 text-sm">${op.numero}</strong></span>
                            <span class="text-[10px] font-bold text-slate-500">META: <strong class="text-slate-800 text-sm">${op.qtdMeta}</strong></span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2 mb-1 overflow-hidden">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-1000" style="width: ${(op.qtdProduzida/op.qtdMeta)*100}%"></div>
                        </div>
                        <div class="flex justify-between text-[9px] font-bold text-slate-400">
                            <span>0%</span>
                            <span>${Math.round((op.qtdProduzida/op.qtdMeta)*100)}% CONCLU√çDO</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="info-badge">
                            <span class="text-slate-400">PRODUTO</span>
                            <span class="text-slate-700 text-xs text-center leading-tight">${op.produto}</span>
                        </div>
                        <div class="info-badge">
                            <span class="text-slate-400">OPERADOR</span>
                            <span class="text-blue-600 text-xs">${op.operador || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mt-4">
                        ${op.status === 'produzindo' ? 
                        `<button onclick="pausarOP(${m.id})" class="flex-1 bg-orange-100 hover:bg-orange-200 text-orange-700 py-2 rounded-lg font-bold text-xs transition-colors"><i class="fa-solid fa-pause mr-1"></i> PAUSAR</button>` : 
                        `<button onclick="retomarOP(${m.id})" class="flex-1 bg-green-100 hover:bg-green-200 text-green-700 py-2 rounded-lg font-bold text-xs transition-colors"><i class="fa-solid fa-play mr-1"></i> RETOMAR</button>`}
                        <button onclick="finalizarOP(${m.id})" class="flex-1 bg-red-100 hover:bg-red-200 text-red-700 py-2 rounded-lg font-bold text-xs transition-colors"><i class="fa-solid fa-check mr-1"></i> ENCERRAR</button>
                    </div>
                    ` : `
                    <div class="h-32 flex flex-col items-center justify-center text-slate-300 border-2 border-dashed border-slate-200 rounded-xl">
                        <i class="fa-solid fa-power-off text-2xl mb-2"></i>
                        <span class="text-xs font-bold">M√ÅQUINA PARADA</span>
                    </div>
                    `}
                `
                grid.appendChild(card)
            })
        }

        // GEST√ÉO DE O.P E FILAS
        function renderListaOPs() {
            const selectMaq = document.getElementById('f-maquina')
            selectMaq.innerHTML = ''
            maquinas.forEach(m => {
                const opt = document.createElement('option')
                opt.value = m.id
                opt.text = `M√°quina #${String(m.id).padStart(2,'0')}`
                selectMaq.appendChild(opt)
            })

            const container = document.getElementById('container-filas')
            container.innerHTML = ''

            maquinas.forEach(m => {
                if(m.fila.length > 0) {
                    const box = document.createElement('div')
                    box.className = 'bg-white p-4 rounded-2xl shadow-sm border border-slate-200'
                    box.innerHTML = `
                        <h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                            <span class="bg-slate-800 text-white px-2 py-1 rounded text-xs">MAQ #${m.id}</span>
                            <span class="text-xs text-slate-400 uppercase">FILA DE PRODU√á√ÉO</span>
                        </h3>
                        <div class="scrolling-wrapper">
                            ${m.fila.map((op, index) => `
                            <div class="ticket-card">
                                <div class="ticket-header">
                                    <div>
                                        <span class="text-[9px] font-black text-slate-400 block">N¬∫ O.P</span>
                                        <span class="text-sm font-black text-slate-800">${op.numero}</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-[9px] font-black text-slate-400 block">QUANTIDADE</span>
                                        <span class="text-sm font-black text-blue-600">${op.qtdMeta}</span>
                                    </div>
                                </div>
                                <div class="p-0">
                                    <div class="ficha-row"><span class="ficha-label">CLIENTE</span> <span class="ficha-value">${op.cliente}</span></div>
                                    <div class="ficha-row"><span class="ficha-label">PRODUTO</span> <span class="ficha-value">${op.produto}</span></div>
                                    <div class="ficha-row bg-blue-50/50"><span class="ficha-label text-blue-400">MATERIAL</span> <span class="ficha-value text-blue-700">${op.material || '-'}</span></div>
                                    <div class="ficha-row bg-blue-50/50"><span class="ficha-label text-blue-400">PIGMENTO</span> <span class="ficha-value text-blue-700">${op.pigmento || '-'} (${op.porcentagem || '0'}%)</span></div>
                                </div>
                                <div class="p-2 bg-slate-50 border-t border-slate-200 flex justify-between items-center">
                                    <span class="text-[9px] font-bold text-slate-400 uppercase"><i class="fa-solid fa-user mr-1"></i> ${op.operador || 'N/D'}</span>
                                    <div class="flex gap-1">
                                        <button onclick="editarOP(${m.id}, ${index})" class="p-1.5 bg-white border border-slate-200 rounded hover:bg-blue-50 text-blue-500 transition-colors"><i class="fa-solid fa-pen text-xs"></i></button>
                                        <button onclick="moverFila(${m.id}, ${index}, -1)" class="p-1.5 bg-white border border-slate-200 rounded hover:bg-slate-100 text-slate-500 transition-colors"><i class="fa-solid fa-arrow-left text-xs"></i></button>
                                        <button onclick="moverFila(${m.id}, ${index}, 1)" class="p-1.5 bg-white border border-slate-200 rounded hover:bg-slate-100 text-slate-500 transition-colors"><i class="fa-solid fa-arrow-right text-xs"></i></button>
                                        <button onclick="removerFila(${m.id}, ${index})" class="p-1.5 bg-white border border-slate-200 rounded hover:bg-red-50 text-red-500 transition-colors"><i class="fa-solid fa-trash text-xs"></i></button>
                                    </div>
                                </div>
                                ${index === 0 && !m.opAtual ? '<button onclick="iniciarProducao('+m.id+')" class="w-full bg-green-500 hover:bg-green-600 text-white font-black text-xs py-2 uppercase transition-colors">INICIAR AGORA</button>' : ''}
                            </div>
                            `).join('')}
                        </div>
                    `
                    container.appendChild(box)
                }
            })
            
            // Popula selects
            renderizarSelectProdutos();
            renderizarSelectOperadores();
        }

        function renderizarSelectProdutos() {
            const selects = document.querySelectorAll('#f-produto, #edit-op-produto');
            selects.forEach(select => {
                const valorAtual = select.value;
                select.innerHTML = '<option value="">-- Selecione Produto --</option>';
                produtosGlobais.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.nome;
                    opt.innerText = p.nome;
                    select.appendChild(opt);
                });
                select.value = valorAtual;
            });
        }
        
        function renderizarSelectOperadores() {
             const selects = document.querySelectorAll('#f-operador, #edit-op-operador');
             selects.forEach(select => {
                 const valorAtual = select.value;
                 select.innerHTML = '<option value="">-- Selecione --</option>';
                 operadoresGlobais.forEach(op => {
                     const opt = document.createElement('option');
                     opt.value = op;
                     opt.innerText = op;
                     select.appendChild(opt);
                 });
                 select.value = valorAtual;
             })
        }

        function adicionarFila() {
            const maqId = parseInt(document.getElementById('f-maquina').value)
            const opData = {
                numero: document.getElementById('f-op').value,
                cliente: document.getElementById('f-cliente').value,
                produto: document.getElementById('f-produto').value,
                qtdMeta: parseInt(document.getElementById('f-qtd').value),
                material: document.getElementById('f-material').value,
                qtdMaterial: document.getElementById('f-material-qtd').value,
                pigmento: document.getElementById('f-pigmento').value,
                porcentagem: document.getElementById('f-porcentagem').value,
                caixa: document.getElementById('f-caixa').value,
                saco: document.getElementById('f-saco').value,
                operador: document.getElementById('f-operador').value,
                qtdProduzida: 0,
                status: 'fila',
                inicio: null
            }

            if(!opData.numero || !opData.qtdMeta || !opData.produto) return alert('Preencha os campos obrigat√≥rios!')

            maquinas[maqId-1].fila.push(opData)
            salvarAutomatico()
            renderListaOPs()
            
            // Limpa form
            document.getElementById('f-op').value = ''
            document.getElementById('f-qtd').value = ''
            document.getElementById('f-cliente').value = ''
            showToast("O.P CRIADA COM SUCESSO")
        }
        
        function iniciarProducao(maqId) {
            const maquina = maquinas[maqId-1]
            if(maquina.opAtual) return alert('M√°quina j√° est√° produzindo!')
            
            const op = maquina.fila.shift()
            op.status = 'produzindo'
            op.inicio = new Date().toISOString()
            maquina.opAtual = op
            
            salvarAutomatico()
            renderPainel()
            renderListaOPs()
        }

        function pausarOP(maqId) {
            const m = maquinas[maqId-1]
            if(m.opAtual) {
                m.opAtual.status = 'pausa'
                salvarAutomatico()
                renderPainel()
            }
        }

        function retomarOP(maqId) {
            const m = maquinas[maqId-1]
            if(m.opAtual) {
                m.opAtual.status = 'produzindo'
                salvarAutomatico()
                renderPainel()
            }
        }

        function finalizarOP(maqId) {
            if(!confirm('Confirmar finaliza√ß√£o da O.P?')) return
            const m = maquinas[maqId-1]
            if(m.opAtual) {
                const op = m.opAtual
                op.status = 'concluido'
                op.fim = new Date().toISOString()
                historico.unshift(op)
                
                // Atualiza horas trabalhadas no m√™s
                if(op.inicio) {
                   const diff = (new Date(op.fim) - new Date(op.inicio)) / 1000 / 3600 // horas
                   dadosMensais.horasTrabalhadas += diff
                }

                m.opAtual = null
                salvarAutomatico()
                renderPainel()
                renderHistorico() // Atualiza hist√≥rico na hora
                atualizarResumoGlobalNumeros()
                showToast("PRODU√á√ÉO FINALIZADA")
            }
        }

        function removerFila(maqId, index) {
            if(confirm('Remover esta O.P da fila?')) {
                maquinas[maqId-1].fila.splice(index, 1)
                salvarAutomatico()
                renderListaOPs()
            }
        }

        function moverFila(maqId, index, direction) {
            const fila = maquinas[maqId-1].fila
            const newIndex = index + direction
            if(newIndex >= 0 && newIndex < fila.length) {
                [fila[index], fila[newIndex]] = [fila[newIndex], fila[index]]
                salvarAutomatico()
                renderListaOPs()
            }
        }

        // EDI√á√ÉO DE OP
        function editarOP(maqId, index) {
            const op = maquinas[maqId-1].fila[index]
            document.getElementById('edit-maq-id').value = maqId
            document.getElementById('edit-op-index').value = index
            
            document.getElementById('edit-op-num').value = op.numero
            document.getElementById('edit-op-qtd').value = op.qtdMeta
            document.getElementById('edit-op-cliente').value = op.cliente || ''
            document.getElementById('edit-op-produto').value = op.produto || ''
            document.getElementById('edit-op-material').value = op.material || ''
            document.getElementById('edit-op-material-qtd').value = op.qtdMaterial || ''
            document.getElementById('edit-op-pigmento').value = op.pigmento || ''
            document.getElementById('edit-op-porcentagem').value = op.porcentagem || ''
            document.getElementById('edit-op-caixa').value = op.caixa || ''
            document.getElementById('edit-op-saco').value = op.saco || ''
            document.getElementById('edit-op-operador').value = op.operador || ''
            
            renderizarSelectProdutos(); // Garante lista atualizada
            renderizarSelectOperadores(); // Garante lista atualizada

            document.getElementById('modal-editar-op').style.display = 'flex'
        }

        function salvarEdicaoOP() {
            const maqId = document.getElementById('edit-maq-id').value
            const index = document.getElementById('edit-op-index').value
            const fila = maquinas[maqId-1].fila
            
            fila[index].numero = document.getElementById('edit-op-num').value
            fila[index].qtdMeta = document.getElementById('edit-op-qtd').value
            fila[index].cliente = document.getElementById('edit-op-cliente').value
            fila[index].produto = document.getElementById('edit-op-produto').value
            fila[index].material = document.getElementById('edit-op-material').value
            fila[index].qtdMaterial = document.getElementById('edit-op-material-qtd').value
            fila[index].pigmento = document.getElementById('edit-op-pigmento').value
            fila[index].porcentagem = document.getElementById('edit-op-porcentagem').value
            fila[index].caixa = document.getElementById('edit-op-caixa').value
            fila[index].saco = document.getElementById('edit-op-saco').value
            fila[index].operador = document.getElementById('edit-op-operador').value
            
            salvarAutomatico()
            renderListaOPs()
            document.getElementById('modal-editar-op').style.display = 'none'
        }

        // HIST√ìRICO
        function renderHistorico() {
            const lista = document.getElementById('lista-historico')
            lista.innerHTML = ''
            
            const termo = document.getElementById('busca-historico-op').value.toLowerCase()
            const dataFiltro = document.getElementById('busca-historico-data').value
            
            const filtrados = historico.filter(op => {
                const matchTexto = op.numero.toLowerCase().includes(termo) || op.cliente?.toLowerCase().includes(termo)
                let matchData = true
                if(dataFiltro && op.fim) {
                    matchData = op.fim.startsWith(dataFiltro)
                }
                return matchTexto && matchData
            })

            filtrados.forEach((op, index) => {
                const row = document.createElement('tr')
                row.className = 'hover:bg-slate-50 border-b border-slate-100 transition-colors'
                const dataFim = op.fim ? new Date(op.fim).toLocaleDateString('pt-BR') : '-'
                
                row.innerHTML = `
                    <td class="p-3 text-slate-400 font-normal">${dataFim}</td>
                    <td class="p-3"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] uppercase font-bold">CONCLU√çDO</span></td>
                    <td class="p-3 text-slate-500">MAQ ??</td> <td class="p-3 text-blue-600">${op.numero}</td>
                    <td class="p-3">${op.cliente || '-'}</td>
                    <td class="p-3">${op.produto || '-'}</td>
                    <td class="p-3">${op.qtdMeta}</td> <td class="p-3 text-right">
                        <button onclick="removerHistorico(${index})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `
                lista.appendChild(row)
            })
        }

        function limparBuscaHistorico() {
            document.getElementById('busca-historico-op').value = ''
            document.getElementById('busca-historico-data').value = ''
            renderHistorico()
        }
        
        function removerHistorico(index) {
            if(confirm('Apagar este registro permanentemente?')) {
                historico.splice(index, 1)
                salvarAutomatico()
                renderHistorico()
            }
        }

        // === ABA PRODUTOS (L√ìGICA) ===

        function salvarNovoProduto() {
            const nome = document.getElementById('cad-nome').value;
            if(!nome) return alert("Digite o nome do produto!");

            const novoProduto = {
                id: Date.now(),
                nome: nome,
                material: document.getElementById('cad-material').value,
                pigmentoTipo: document.getElementById('cad-pig-tipo').value,
                peso: parseFloat(document.getElementById('cad-peso').value) || 0,
                ciclo: parseFloat(document.getElementById('cad-ciclo').value) || 0,
                cavidades: parseFloat(document.getElementById('cad-cav').value) || 1,
                porcPigmento: parseFloat(document.getElementById('cad-pig-porc').value) || 0,
                saquinho: document.getElementById('cad-saquinho').value,
                qtdCaixa: parseFloat(document.getElementById('cad-cx').value) || 0
            };

            // Adiciona na lista global e salva
            if(!produtosGlobais) produtosGlobais = [];
            produtosGlobais.push(novoProduto);
            
            salvarAutomatico();
            renderizarTabelaProdutos();
            
            // Limpa campos
            document.getElementById('cad-nome').value = '';
            document.getElementById('cad-peso').value = '';
            showToast("Produto Cadastrado!");
        }

        function renderizarTabelaProdutos() {
            const tbody = document.getElementById('tabela-produtos-lista');
            
            // Prote√ß√£o contra o erro "null": se a aba n√£o existir, ele para e n√£o trava o sistema
            if (!tbody) return; 

            tbody.innerHTML = ''; // Limpa a tabela antes de desenhar

            // Se a lista estiver vazia ou inv√°lida, cria uma lista vazia
            if (!produtosGlobais || !Array.isArray(produtosGlobais)) {
                produtosGlobais = [];
            }

            produtosGlobais.forEach((p, index) => {
                // Garante que n√£o apare√ßa "undefined" se o campo estiver vazio
                const nome = p.nome || 'Sem Nome';
                const material = p.material || '-';
                const peso = p.peso || 0;
                const ciclo = p.ciclo || 0;
                const pig = p.porcPigmento || 0;
                const saquinho = p.saquinho || '-';
                const caixa = p.qtdCaixa || '-';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                tr.innerHTML = `
                    <td class="p-4">
                        <div class="font-bold text-slate-800">${nome}</div>
                        <div class="text-xs text-slate-500">${material}</div>
                    </td>
                    <td class="p-4 hidden md:table-cell">
                        <div class="text-xs">
                            <span class="font-bold text-blue-600">Peso:</span> ${peso}g <br>
                            <span class="font-bold text-blue-600">Ciclo:</span> ${ciclo}s <br>
                            <span class="font-bold text-orange-500">Pig:</span> ${pig}%
                        </div>
                    </td>
                    <td class="p-4 hidden md:table-cell text-xs">
                        Sac: <b>${saquinho}</b><br>
                        Cx: <b>${caixa}</b>
                    </td>
                    <td class="p-4 text-right">
                        <button onclick="excluirProduto(${index})" class="text-red-400 hover:text-red-600 font-bold text-xs uppercase">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function excluirProduto(index) {
            if(confirm("Tem certeza?")) {
                produtosGlobais.splice(index, 1);
                salvarAutomatico();
                renderizarTabelaProdutos();
            }
        }
        
        // === ABA OPERADORES (L√ìGICA) ===
        function renderizarListaOperadores() {
             const lista = document.getElementById('lista-operadores');
             if(!lista) return;
             lista.innerHTML = '';
             
             operadoresGlobais.forEach((op, index) => {
                 const li = document.createElement('li');
                 li.className = "px-6 py-4 flex items-center justify-between hover:bg-slate-50 transition-colors";
                 li.innerHTML = `
                     <div class="flex items-center gap-3">
                         <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-black text-xs">
                             ${op.substring(0,2).toUpperCase()}
                         </div>
                         <span class="font-bold text-slate-700">${op}</span>
                     </div>
                     <button onclick="removerOperador(${index})" class="text-slate-300 hover:text-red-500 transition-colors">
                         <i class="fas fa-trash-alt"></i>
                     </button>
                 `;
                 lista.appendChild(li);
             });
        }

        function adicionarOperador() {
            const nomeInput = document.getElementById('novo-operador-nome');
            const nome = nomeInput.value.trim();
            if(!nome) return alert("Digite um nome!");
            
            operadoresGlobais.push(nome);
            salvarAutomatico();
            renderizarListaOperadores();
            nomeInput.value = '';
            showToast("Operador Adicionado");
        }

        function removerOperador(index) {
            if(confirm("Remover este operador?")) {
                operadoresGlobais.splice(index, 1);
                salvarAutomatico();
                renderizarListaOperadores();
            }
        }
        
        // === L√ìGICA DA CALCULADORA T√âCNICA ===
        function calcularPrevisao() {
            try {
                // Pega a Quantidade da OP (usando o ID f-qtd que acabamos de criar)
                const elQtd = document.getElementById('f-qtd');
                const qtdMeta = elQtd ? (parseFloat(elQtd.value) || 0) : 0;

                // Pega os dados t√©cnicos
                const pesoPeca = parseFloat(document.getElementById('tec-peso').value) || 0; 
                const ciclo = parseFloat(document.getElementById('tec-ciclo').value) || 0;            
                const cavidades = parseFloat(document.getElementById('tec-cav').value) || 1;   
                const porcentagem = parseFloat(document.getElementById('tec-pig-porc').value) || 0; 

                // Se faltar dado essencial, limpa tudo
                if (qtdMeta <= 0 || pesoPeca <= 0) {
                    document.getElementById('out-tempo').innerText = "-";
                    document.getElementById('out-material').innerText = "-";
                    document.getElementById('out-pigmento').innerText = "-";
                    return; 
                }

                // --- C√ÅLCULOS ---
                
                // 1. Material (kg) = (Qtd * Peso) / 1000
                const pesoTotalMaterial = (qtdMeta * pesoPeca) / 1000;

                // 2. Pigmento (kg) = Material * %
                const pesoPigmento = pesoTotalMaterial * (porcentagem / 100);

                // 3. Tempo = (Qtd / Cavidades) * Ciclo
                const totalSegundos = (qtdMeta / cavidades) * ciclo;
                const h = Math.floor(totalSegundos / 3600);
                const m = Math.round((totalSegundos % 3600) / 60);
                
                // --- ATUALIZA TELA ---
                document.getElementById('out-tempo').innerText = (ciclo > 0) ? `${h}h ${m}m` : "-";
                
                // Formata n√∫meros (Ex: 1.200,50)
                document.getElementById('out-material').innerText = pesoTotalMaterial.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + " kg";
                document.getElementById('out-pigmento').innerText = pesoPigmento.toLocaleString('pt-BR', {minimumFractionDigits: 3});

            } catch (err) {
                console.error("Erro no c√°lculo:", err);
            }
        }

        // UTILIT√ÅRIOS GLOBAIS
        function atualizarRelogio() {
            const agora = new Date()
            document.getElementById('relogio').innerText = agora.toLocaleTimeString('pt-BR')
        }

        function showToast(msg) {
            const t = document.getElementById('toast-notification')
            document.getElementById('toast-msg').innerText = msg
            t.classList.remove('toast-hide')
            t.classList.add('toast-show')
            setTimeout(() => {
                t.classList.remove('toast-show')
                t.classList.add('toast-hide')
            }, 3000)
        }

        async function salvarAutomatico() { 
            document.getElementById('status-nuvem').innerText = "‚è≥"; 
            if(saveTimeout) clearTimeout(saveTimeout); 
            // Salva e depois sanitiza novamente pra garantir
            saveTimeout = setTimeout(async () => { await salvarGeral(); document.getElementById('status-nuvem').innerText = "‚òÅÔ∏è"; }, 1000); 
        }

        async function salvarGeral() { 
            await sb.from('sistema').update({ 
                conteudo: { 
                    maquinas, 
                    cores: coresGlobais, 
                    operadores: operadoresGlobais, 
                    produtos: produtosGlobais, 
                    historico, 
                    dadosMensais, 
                    modoHoraExtra, 
                    lastUpdateTimestamp: Date.now() 
                } 
            }).eq('id', 1); // SALVA TUDO
            
            // ATUALIZA TIMESTAMP LOCAL PARA EVITAR AUTO-REFRESH NO PR√ìPRIO DISPOSITIVO QUE SALVOU
            dadosLocaisLastUpdate = Date.now();
            // showToast("DADOS SALVOS"); // Opcional, para n√£o ficar apitando toda hora
        }

        function atualizarResumoGlobalNumeros() {
            const total = dadosMensais.horasTrabalhadas
            document.getElementById('horas-trabalhadas-mes').innerText = total.toFixed(1) + 'h'
            const meta = 1628
            const porc = (total / meta) * 100
            document.getElementById('meta-global').innerText = porc.toFixed(1) + '%'
            
            // Se gr√°ficos estiverem vis√≠veis, atualiza eles
            if(document.getElementById('aba-graficos').classList.contains('aba-ativa')) {
                iniciarGraficos();
            }
        }
        
        function resetarMes() {
            if(confirm("Zerar horas do m√™s?")) {
                dadosMensais.horasTrabalhadas = 0
                salvarAutomatico()
                atualizarResumoGlobalNumeros()
            }
        }
        
        function iniciarGraficos() {
             // Mockup simples para evitar erro se chart.js falhar
             const ctx1 = document.getElementById('graficoProducao');
             const ctx2 = document.getElementById('graficoMaquinas');
             const ctx3 = document.getElementById('graficoOperadores');
             
             if(chartProducao) chartProducao.destroy();
             if(chartMaquinas) chartMaquinas.destroy();
             if(chartOperadores) chartOperadores.destroy();
             
             if(ctx1) {
                 chartProducao = new Chart(ctx1, {
                     type: 'bar',
                     data: {
                         labels: ['06h','08h','10h','12h','14h','16h','18h','20h'],
                         datasets: [{ label: 'Pe√ßas/Hora', data: [120, 150, 180, 90, 160, 200, 190, 140], backgroundColor: '#3b82f6', borderRadius: 4 }]
                     },
                     options: { responsive: true, maintainAspectRatio: false }
                 });
             }
             
             if(ctx2) {
                 chartMaquinas = new Chart(ctx2, {
                     type: 'doughnut',
                     data: {
                         labels: ['Maq 01', 'Maq 02', 'Maq 03'],
                         datasets: [{ data: [30, 50, 20], backgroundColor: ['#3b82f6', '#f97316', '#22c55e'] }]
                     },
                     options: { responsive: true, maintainAspectRatio: false }
                 });
             }
        }
        
        function toggleHoraExtra() {
            modoHoraExtra = !modoHoraExtra
            const btn = document.getElementById('btn-extra')
            if(modoHoraExtra) {
                btn.classList.remove('text-white')
                btn.classList.add('bg-red-600', 'text-white', 'animate-pulse')
            } else {
                btn.classList.remove('bg-red-600', 'animate-pulse')
                btn.classList.add('text-white')
            }
            salvarAutomatico()
        }
        
        function togglePause() {
            alert("Fun√ß√£o Pausa Global em desenvolvimento")
        }
        
        function mudarTurnoManual(val) {
            alert("Turno alterado para simula√ß√£o: " + val)
        }

    </script>
</body>
</html>
