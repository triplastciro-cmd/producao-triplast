<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triplast - Sistema Savant v8.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { background-color: #add8e6; font-family: 'Inter', sans-serif; color: #333; }
        
        .aba-conteudo { display: none; }
        .aba-ativa { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilo dos Cart√µes Savant */
        .card-producao {
            background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 10px solid #cbd5e1; transition: all 0.3s ease;
        }
        .status-produzindo { border-left-color: #22c55e; background-color: #f0fdf4; }
        .status-parada { border-left-color: #ef4444; background-color: #fef2f2; }
        .status-alerta { border-left-color: #f59e0b; background-color: #fffbeb; }

        .info-badge {
            background: #f1f5f9; padding: 4px 10px; border-radius: 8px;
            font-weight: 800; font-size: 0.75rem; border: 1px solid #e2e8f0;
        }

        .tab-btn {
            background: white; padding: 8px 18px; border-radius: 20px;
            font-weight: 600; font-size: 13px; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-btn.active { background: #3b82f6; color: white; }

        .header-meta {
            background: linear-gradient(to bottom, #f59e0b, #d97706);
            color: white; padding: 12px; border-radius: 12px;
            font-weight: 800; font-size: 1.4rem; box-shadow: 0 4px 0 #b45309;
        }
        
        input, select { border: 1px solid #ddd !important; padding: 8px; border-radius: 8px; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-7xl mx-auto mb-6">
        <div class="header-meta flex justify-center items-center gap-4">
            <span>üöÄ Alcan√ßamos</span>
            <span class="bg-black/20 px-4 py-1 rounded-lg border border-white/30" id="txt-meta-global">0%</span>
            <span>da meta! üöÄ</span>
        </div>
    </div>

    <nav class="max-w-7xl mx-auto mb-6 flex gap-2 overflow-x-auto pb-2">
        <button onclick="trocarAba('painel')" id="tab-painel" class="tab-btn active">Painel</button>
        <button onclick="trocarAba('lista')" id="tab-lista" class="tab-btn">Lista</button>
        <button onclick="trocarAba('paradas')" id="tab-paradas" class="tab-btn">Paradas</button>
        <button onclick="trocarAba('rastreio')" id="tab-rastreio" class="tab-btn">Rastreio O.S</button>
        <button onclick="trocarAba('apontamento')" id="tab-apontamento" class="tab-btn">Apontamento</button>
        <button onclick="salvarGeral()" class="ml-auto bg-green-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-green-700 transition-all shadow-lg">üíæ SALVAR NUVEM</button>
    </nav>

    <main id="aba-painel" class="aba-conteudo aba-ativa max-w-7xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="grid-maquinas"></div>
    </main>

    <main id="aba-lista" class="aba-conteudo max-w-4xl mx-auto bg-white p-8 rounded-3xl shadow-xl">
        <h2 class="text-2xl font-black mb-6 flex items-center gap-2">üìù Programar Nova O.P</h2>
        <div class="grid grid-cols-2 gap-4">
            <select id="f-maquina" class="col-span-2 w-full font-bold text-lg"></select>
            <input type="text" id="f-op" placeholder="N¬∫ da O.P" class="font-bold">
            <input type="text" id="f-cliente" placeholder="Cliente">
            <input type="text" id="f-produto" placeholder="Produto/Molde" class="col-span-2">
            <input type="text" id="f-cor" placeholder="Cor da Pe√ßa">
            <input type="number" id="f-qtd" placeholder="Quantidade Total">
            <input type="number" id="f-padrao" placeholder="Padr√£o/Embalagem">
            <input type="date" id="f-prazo">
            <button onclick="adicionarFila()" class="col-span-2 bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-lg hover:bg-blue-700">Adicionar √† Fila de Produ√ß√£o</button>
        </div>
    </main>

    <main id="aba-paradas" class="aba-conteudo max-w-5xl mx-auto">
        <div class="bg-white p-10 rounded-3xl shadow-2xl flex flex-col md:flex-row items-center gap-10">
            <div class="w-full md:w-1/2">
                <canvas id="chartOEE"></canvas>
            </div>
            <div class="w-full md:w-1/2">
                <h2 class="text-3xl font-black mb-6">Efici√™ncia da F√°brica</h2>
                <div id="legenda-viva" class="space-y-4 text-xl font-bold"></div>
            </div>
        </div>
    </main>

    <main id="aba-rastreio" class="aba-conteudo max-w-7xl mx-auto bg-white p-6 rounded-3xl shadow-lg">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black">Rastreio de O.S</h2>
            <input type="text" id="buscaOS" onkeyup="filtrarOS()" placeholder="Pesquisar O.P ou Produto..." class="w-64">
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-100 text-[10px] uppercase font-black text-slate-500">
                        <th class="p-4">Finalizada em</th><th class="p-4">M√°quina</th><th class="p-4">O.P</th><th class="p-4">Produto</th><th class="p-4">Boas</th><th class="p-4 text-red-500">Refugo</th>
                    </tr>
                </thead>
                <tbody id="lista-rastreio" class="font-bold text-sm text-slate-700"></tbody>
            </table>
        </div>
    </main>

    <main id="aba-apontamento" class="aba-conteudo max-w-7xl mx-auto bg-white p-6 rounded-3xl shadow-lg">
        <h2 class="text-2xl font-black mb-6">Apontamentos por Turno</h2>
        <div id="container-turnos" class="grid grid-cols-1 gap-8"></div>
    </main>

    <script>
        const S_URL = 'https://hgqnlqtvjiyuwnwypxxh.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhncW5scXR2aml5dXdud3lweHhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjE1MDcsImV4cCI6MjA4NjQzNzUwN30.njSVfWDpIJK49IpRSgyMf6e5MEmJ-AROVT7-nOTZD9Y';
        const sb = window.supabase.createClient(S_URL, S_KEY);

        let maquinas = [];
        let historico = [];
        let meuGrafico = null;

        async function carregar() {
            const { data } = await sb.from('sistema').select('*').eq('id', 1).single();
            if (data) {
                maquinas = data.conteudo.maquinas;
                historico = data.conteudo.historico || [];
                // Compatibilidade com c√≥digo antigo
                maquinas.forEach(m => { if(!m.refugo) m.refugo = 0; if(!m.turno) m.turno = "Turno 1"; });
            }
            document.getElementById('f-maquina').innerHTML = maquinas.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
            atualizarInterface();
        }

        function atualizarInterface() {
            renderPainel();
            renderRastreio();
            renderApontamento();
            atualizarGrafico();
            calcMetaGlobal();
        }

        function renderPainel() {
            const grid = document.getElementById('grid-maquinas');
            grid.innerHTML = maquinas.map(m => {
                const op = m.fila[0] || { op: 'OFF', cliente: '---', produto: 'SEM PROGRAMA√á√ÉO', cor: '---', qtd: 0, padrao: 1, prazo: '--/--' };
                const saldo = Math.max(0, op.qtd - m.producao);
                const volumes = Math.ceil(m.producao / (op.padrao || 1));
                
                let cssStatus = "";
                if(m.situacao === "Produzindo") cssStatus = "status-produzindo";
                else if(m.situacao === "Parada") cssStatus = "status-parada";
                else if(m.situacao === "Baixa Efici√™ncia") cssStatus = "status-alerta";

                return `
                <div class="card-producao ${cssStatus} p-5 flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                        <span class="bg-blue-600 text-white px-3 py-1 rounded-lg font-black text-xl">${m.nome}</span>
                        <div class="text-right">
                            <div class="text-[10px] font-black uppercase text-slate-400">Tempo de Status</div>
                            <div class="font-mono font-bold text-blue-600 text-lg">${m.tempo || '00:00:00'}</div>
                        </div>
                    </div>

                    <div class="border rounded-2xl p-4 bg-white/60 text-xs shadow-inner">
                        <div class="font-black text-base text-blue-800 mb-2">O.P - ${op.op}</div>
                        <div class="grid grid-cols-2 gap-y-1">
                            <div class="col-span-2"><b>Cliente:</b> ${op.cliente}</div>
                            <div class="col-span-2"><b>Produto:</b> ${op.produto}</div>
                            <div><b>Cor:</b> ${op.cor}</div>
                            <div><b>Prazo:</b> ${op.prazo}</div>
                        </div>
                        <hr class="my-3 border-slate-200">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="info-badge flex flex-col items-center">
                                <span>APONTADAS</span>
                                <span class="text-lg text-blue-700">${m.producao}</span>
                            </div>
                            <div class="info-badge flex flex-col items-center">
                                <span>SALDO</span>
                                <span class="text-lg text-red-600">${saldo}</span>
                            </div>
                            <div class="info-badge flex flex-col items-center">
                                <span>VOLUMES</span>
                                <span class="text-blue-700">${volumes}</span>
                            </div>
                            <div class="info-badge flex flex-col items-center">
                                <span>REFUGO</span>
                                <span class="text-red-700">${m.refugo}</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="addProd(${m.id}, 1)" class="bg-white border-2 border-blue-100 py-2 rounded-xl font-black text-blue-600 hover:bg-blue-50">+1</button>
                        <button onclick="addProd(${m.id}, 10)" class="bg-white border-2 border-blue-100 py-2 rounded-xl font-black text-blue-600 hover:bg-blue-50">+10</button>
                        <button onclick="addRefugo(${m.id})" class="bg-red-50 border-2 border-red-100 py-2 rounded-xl font-black text-red-600 hover:bg-red-100">SCRAP</button>
                    </div>

                    <select onchange="mudarStatus(${m.id}, this.value)" class="w-full font-bold text-sm bg-slate-50">
                        <option value="Aguardando" ${m.situacao === 'Aguardando' ? 'selected' : ''}>‚ö™ Aguardando</option>
                        <option value="Produzindo" ${m.situacao === 'Produzindo' ? 'selected' : ''}>üü¢ Produzindo</option>
                        <option value="Baixa Efici√™ncia" ${m.situacao === 'Baixa Efici√™ncia' ? 'selected' : ''}>üü° Baixa Efici√™ncia</option>
                        <option value="Parada" ${m.situacao === 'Parada' ? 'selected' : ''}>üî¥ Parada</option>
                    </select>

                    <button onclick="finalizarOP(${m.id})" class="w-full bg-slate-800 text-white py-3 rounded-xl font-black text-xs uppercase hover:bg-black transition-all">Finalizar Produ√ß√£o</button>
                </div>`;
            }).join('');
        }

        function addProd(id, val) { 
            const m = maquinas.find(x => x.id === id);
            m.producao += val; 
            atualizarInterface(); 
        }

        function addRefugo(id) { 
            const m = maquinas.find(x => x.id === id);
            m.refugo += 1; 
            atualizarInterface(); 
        }

        function mudarStatus(id, st) { 
            const m = maquinas.find(x => x.id === id);
            m.situacao = st; 
            atualizarInterface(); 
        }

        function finalizarOP(id) {
            const m = maquinas.find(x => x.id === id);
            if(m.fila.length > 0) {
                const op = m.fila[0];
                historico.push({
                    data: new Date().toLocaleString(),
                    maquina: m.nome,
                    op: op.op,
                    produto: op.produto,
                    boas: m.producao,
                    refugo: m.refugo
                });
                m.producao = 0; m.refugo = 0;
                m.fila.shift();
                atualizarInterface();
                salvarGeral();
            }
        }

        function adicionarFila() {
            const mId = parseInt(document.getElementById('f-maquina').value);
            const m = maquinas.find(x => x.id === mId);
            m.fila.push({
                op: document.getElementById('f-op').value,
                cliente: document.getElementById('f-cliente').value,
                produto: document.getElementById('f-produto').value,
                cor: document.getElementById('f-cor').value,
                qtd: parseInt(document.getElementById('f-qtd').value),
                padrao: parseInt(document.getElementById('f-padrao').value),
                prazo: document.getElementById('f-prazo').value
            });
            alert("OP Adicionada com sucesso!");
            atualizarInterface();
        }

        function renderRastreio() {
            document.getElementById('lista-rastreio').innerHTML = historico.map(h => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-4 text-slate-400">${h.data}</td>
                    <td class="p-4">${h.maquina}</td>
                    <td class="p-4 text-blue-600">#${h.op}</td>
                    <td class="p-4">${h.produto}</td>
                    <td class="p-4 text-green-600">${h.boas}</td>
                    <td class="p-4 text-red-500">${h.refugo}</td>
                </tr>
            `).reverse().join('');
        }

        function renderApontamento() {
            const cont = document.getElementById('container-turnos');
            cont.innerHTML = maquinas.map(m => `
                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                    <h3 class="text-xl font-black mb-4 text-blue-900">${m.nome} - Rendimento por Turno</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-blue-400">
                            <div class="text-xs font-black text-slate-400">TURNO 1</div>
                            <div class="text-2xl font-black">${m.turno === 'Turno 1' ? m.producao : 0} <small class="text-xs">p√ßs</small></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-green-400">
                            <div class="text-xs font-black text-slate-400">TURNO 2</div>
                            <div class="text-2xl font-black">${m.turno === 'Turno 2' ? m.producao : 0} <small class="text-xs">p√ßs</small></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-orange-400">
                            <div class="text-xs font-black text-slate-400">TURNO 3</div>
                            <div class="text-2xl font-black">${m.turno === 'Turno 3' ? m.producao : 0} <small class="text-xs">p√ßs</small></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function atualizarGrafico() {
            const statusCount = { Produzindo: 0, Parada: 0, Aguardando: 0, Alerta: 0 };
            maquinas.forEach(m => {
                if(m.situacao === "Produzindo") statusCount.Produzindo++;
                else if(m.situacao === "Parada") statusCount.Parada++;
                else if(m.situacao === "Baixa Efici√™ncia") statusCount.Alerta++;
                else statusCount.Aguardando++;
            });

            const total = maquinas.length;
            const pProd = ((statusCount.Produzindo / total) * 100).toFixed(1);
            const pPara = ((statusCount.Parada / total) * 100).toFixed(1);
            const pAguard = (((statusCount.Aguardando + statusCount.Alerta) / total) * 100).toFixed(1);

            if (meuGrafico) meuGrafico.destroy();
            const ctx = document.getElementById('chartOEE').getContext('2d');
            meuGrafico = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Produzindo', 'Parada', 'Aguardando/Efici√™ncia'],
                    datasets: [{
                        data: [statusCount.Produzindo, statusCount.Parada, statusCount.Aguardando + statusCount.Alerta],
                        backgroundColor: ['#22c55e', '#ef4444', '#3b82f6'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '70%', plugins: { legend: { display: false } } }
            });

            document.getElementById('legenda-viva').innerHTML = `
                <div class="flex justify-between border-b pb-2"><span class="text-green-600">‚óè Produzindo</span> <span>${pProd}%</span></div>
                <div class="flex justify-between border-b pb-2"><span class="text-red-600">‚óè Parada</span> <span>${pPara}%</span></div>
                <div class="flex justify-between border-b pb-2"><span class="text-blue-600">‚óè Aguardando</span> <span>${pAguard}%</span></div>
            `;
        }

        function calcMetaGlobal() {
            let produzidas = 0; let meta = 0;
            maquinas.forEach(m => {
                produzidas += m.producao;
                if(m.fila[0]) meta += m.fila[0].qtd;
            });
            const perc = meta > 0 ? Math.min(100, ((produzidas / meta) * 100).toFixed(0)) : 0;
            document.getElementById('txt-meta-global').innerText = perc + "%";
        }

        async function salvarGeral() {
            await sb.from('sistema').update({ conteudo: { maquinas, historico } }).eq('id', 1);
            alert("Sincronizado com Sucesso!");
        }

        function trocarAba(aba) {
            document.querySelectorAll('.aba-conteudo').forEach(a => a.classList.remove('aba-ativa'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('aba-' + aba).classList.add('aba-ativa');
            document.getElementById('tab-' + aba).classList.add('active');
        }

        carregar();
        setInterval(carregar, 30000); // Auto-refresh a cada 30s
    </script>
</body>
</html>
